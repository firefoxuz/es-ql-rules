#//RULE-PCI-06 â€” Unencrypted Admin Access (PCI 2.3)
#//Requirement: 2
#//Objective: Detect non-console administrative access without encryption
#//Data sources: Network logs, authentication logs
#//ECS fields used: event.category, network.protocol, destination.port, user.name
#//Tuning notes: Allowlist SSH/TLS/VPN connections; alert on cleartext admin protocols

name: "RULE-PCI-06: Unencrypted Administrative Access Detected"
description: |
  Identifies administrative access using unencrypted protocols (Telnet, HTTP, FTP)
  instead of encrypted alternatives (SSH, HTTPS, SFTP). PCI DSS 2.3 requires strong
  cryptography for all non-console administrative access. Cleartext admin sessions
  expose credentials and session data to network sniffing. Exclude console logins
  and verify SSH/TLS usage for remote administration.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-*
  - auditbeat-*
query_language: esql
query: |
  FROM filebeat-*, auditbeat-*
  | WHERE event.category == "network"
    AND network.direction == "inbound"
    AND destination.port IN (23, 80, 21, 8080)  // Telnet, HTTP, FTP
    AND event.action RLIKE "(?i)(connect|login|auth)"
  | WHERE NOT (
      network.protocol == "tls" OR network.protocol == "ssh"
      OR destination.port == 443
    )
  | STATS connection_count = COUNT(*),
          unique_users = COUNT_DISTINCT(user.name),
          sources = VALUES(source.ip),
          protocols = VALUES(network.protocol)
    BY destination.ip, destination.port, user.name
  | WHERE connection_count > 0
  | EVAL admin_likely = CASE(
      user.name RLIKE "(?i)(admin|root|sa|dba)", 1,
      destination.port == 23, 1,
      0
    )
  | WHERE admin_likely == 1
  | EVAL risk_score = CASE(
      destination.port == 23, 95,
      destination.port == 80 AND user.name IS NOT NULL, 85,
      70
    )
  | KEEP destination.ip, destination.port, user.name, connection_count, sources, protocols, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - pci_dss
  - requirement_2
  - network
  - encryption
  - administrative_access
severity: high
risk_score: 85
references:
  - "PCI DSS v3.1 Requirement 2.3"
nist: ["SC-8"]
gdpr: ["Article 32"]
pci_dss: ["2.3"]
mitre_attack:
  TA0001: 
    T1040: []