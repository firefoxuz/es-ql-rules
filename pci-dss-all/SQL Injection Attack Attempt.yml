rule_id: bd93f2b0-1bf7-44ba-b432-15d8069925ae
#//RULE-PCI-17 â€” SQL Injection Attempt (PCI 6.5.1)
#//Requirement: 6
#//Objective: Detect SQL injection attacks against web applications
#//Data sources: Web access logs (nginx), WAF logs
#//ECS fields used: event.original, event.original, event.original, source.ip
#//Tuning notes: Monitor for SQL syntax in parameters; correlate with WAF blocks

name: "SQL Injection Attack Attempt"
description: |
  Identifies potential SQL injection attempts in web requests by detecting SQL
  syntax patterns in URL parameters and POST bodies. PCI DSS 6.5.1 requires
  addressing injection flaws in application development. Common patterns include
  UNION SELECT, OR 1=1, comment syntax (--), and blind injection techniques.
  Tune to reduce false positives from legitimate queries and correlate with WAF
  and application error logs.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*
  | WHERE event.category == "web"
    AND (
      event.original RLIKE "(?i).*(union.*select|or.*1.*=.*1|;.*drop|;.*exec|'.*or.*'|\".*or.*\"|--|\/\*|xp_cmdshell|waitfor.*delay|benchmark|sleep\(|pg_sleep|extractvalue|updatexml|0x[0-9a-f]+|%27|%22|%2527).*"
      OR event.original RLIKE "(?i).*(union.*select|or.*1.*=.*1|;.*drop|;.*exec|'.*or.*'|\".*or.*\"|--|\/\*|xp_cmdshell|waitfor.*delay|benchmark|sleep\(|pg_sleep|extractvalue|updatexml|0x[0-9a-f]+|%27|%22|%2527).*"
      OR event.original RLIKE ".*('|%27|%2527|\"|%22).*"
    )
  | STATS attempt_count = COUNT(*),
          unique_ips = COUNT_DISTINCT(source.ip),
          urls = VALUES(event.original),
          queries = VALUES(event.original),
          user_agents = VALUES(event.original)
    BY source.ip, event.original
  | WHERE attempt_count > 0
  | EVAL injection_type = CASE(
      queries RLIKE "(?i).*(waitfor|benchmark|sleep|pg_sleep).*", "Time-Based Blind SQLi",
      queries RLIKE "(?i).*(union.*select).*", "UNION-Based SQLi",
      queries RLIKE "(?i).*(extractvalue|updatexml).*", "XML-Based SQLi",
      queries RLIKE "(?i).*(or.*1.*=.*1|'.*or.*').*", "Boolean-Based SQLi",
      queries RLIKE "(?i).*;.*(drop|exec|delete).*", "Stacked Query SQLi",
      "Generic SQLi Attempt"
    )
  | EVAL risk_score = CASE(
      attempt_count > 10, 100,
      queries RLIKE "(?i).*(union.*select|drop.*table|exec.*cmd).*", 95,
      injection_type == "Time-Based Blind SQLi", 90,
      attempt_count > 3, 85,
      70
    )
  | KEEP agent_id, source.ip, event.original, attempt_count, unique_ips, injection_type, queries, user_agents, risk_score
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - pci_dss
  - requirement_6
  - web
  - sql_injection
  - attack
severity: critical
risk_score: 95
references:
  - "PCI DSS v3.1 Requirement 6.5.1"
  - "OWASP Top 10 A1:2017"
nist: ["SI-10"]
gdpr: ["32"]
pci_dss: ["6.5.1"]
mitre_attack:
  TA0001:
    T1190: []
