rule_id: 407d5490-dfbf-471c-a993-2e125feea679
#//RULE-PCI-09 â€” Unmasked PAN Display (PCI 3.3)
#//Requirement: 3
#//Objective: Detect display of full unmasked PAN to unauthorized users
#//Data sources: Application logs, web access logs
#//ECS fields used: event.original, http.response.body, user.name, event.original
#//Field validation: Verify these fields exist in your indices before enabling
#//Tuning notes: Monitor API responses and UI logs; allowlist authorized roles with business need

name: "Unmasked PAN Displayed to User"
description: |
  Detects application responses or logs showing full unmasked Primary Account Numbers
  (more than first 6 + last 4 digits) in web interfaces or API responses. PCI DSS 3.3
  limits PAN display to authorized personnel with legitimate business need. This rule
  searches for digit sequences in HTTP responses and application logs. Exclude
  authorized payment admin interfaces and tokenization APIs.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - filebeat-nginx-access-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*
  | WHERE event.category == "web"
    AND (
      http.response.body RLIKE ".*[3-6][0-9]{15,18}.*"
      OR event.original RLIKE ".*\\b[3-6][0-9]{15,18}\\b.*"
    )
  | WHERE NOT (
      event.original RLIKE ".*/admin/payment/.*"
      OR user.name RLIKE "(?i).*(admin|payment[_]?support).*"
    )
  | STATS display_count = COUNT(*),
          users = VALUES(user.name),
          urls = VALUES(event.original),
          sources = VALUES(source.ip)
    BY host.name, event.original
  | WHERE display_count > 0
  | EVAL risk_score = CASE(
      user.name IS NULL OR user.name == "anonymous", 95,
      display_count > 5, 85,
      70
    )
  | KEEP agent_id, host.name, event.original, users, display_count, sources, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - pci_dss
  - requirement_3
  - data_protection
  - pan
  - web
severity: high
risk_score: 80
references:
  - "PCI DSS v3.1 Requirement 3.3"
nist: ["SC-28"]
gdpr: ["32"]
pci_dss: ["3.3"]
mitre_attack:
  TA0009: 
    T1213: []
