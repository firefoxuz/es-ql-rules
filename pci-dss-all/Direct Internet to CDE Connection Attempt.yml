rule_id: b1ccaf8e-6635-4ed1-95c0-4b200f579579
#//RULE-PCI-03 â€” Direct Internet Access to CDE (PCI 1.3.3)
#//Requirement: 1
#//Objective: Detect direct connections between Internet and cardholder data environment
#//Data sources: Network logs, firewall logs
#//ECS fields used: source.ip, event.original, event.original, event.category
#//Field validation: Verify these fields exist in your indices before enabling
#//Tuning notes: Define CDE IP ranges; allowlist authorized DMZ traffic

name: "Direct Internet to CDE Connection Attempt"
description: |
  Detects network connections originating from public Internet IP addresses directly
  to systems in the cardholder data environment, bypassing DMZ controls. PCI DSS 1.3.3
  prohibits direct connections between Internet and CDE. This indicates firewall
  misconfiguration or network segmentation failure. Configure CDE IP ranges and
  exclude authorized DMZ/proxy traffic patterns.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-*
query_language: esql
query: |
  FROM filebeat-*
  | WHERE event.category == "network" 
    AND event.original == "inbound"
    AND source.ip IS NOT NULL
    AND event.original IS NOT NULL
  | WHERE NOT CIDR_MATCH(source.ip, "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "127.0.0.0/8")
    AND CIDR_MATCH(event.original, "10.100.0.0/16", "192.168.10.0/24")  
  | STATS connection_count = COUNT(*),
          unique_sources = COUNT_DISTINCT(source.ip),
          unique_destinations = COUNT_DISTINCT(event.original),
          ports = VALUES(event.original),
          protocols = VALUES(event.original)
    BY source.ip, event.original
  | WHERE connection_count > 0
  | EVAL risk_level = CASE(
      event.original IN (3306, 1433, 5432, 1521), 95,  
      event.original IN (22, 3389), 85, 
      unique_destinations > 5, 80,
      70
    )
  | KEEP agent_id, source.ip, event.original, connection_count, ports, protocols, risk_level
  | SORT risk_level DESC
enabled: false
tags:
  - pci_dss
  - requirement_1
  - network
  - segmentation
  - cde_access
severity: critical
risk_score: 90
references:
  - "PCI DSS v3.1 Requirement 1.3.3"
nist: ["SC-7"]
gdpr: ["32"]
pci_dss: ["1.3.3", "1.3.1", "1.3.2"]
mitre_attack: 
  TA0001: 
    T1190: []
