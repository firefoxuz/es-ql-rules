rule_id: 7cdb3604-bd99-4dc9-9d8e-4afcfa34145d
#//EVIDENCE-PCI-07 — Access Control Policies & Systems (PCI 7.1.4, 7.2, 7.3)
#//Requirement: 7
#//Objective: Documentation of access needs, approval processes, and deny-all policies
#//Why not detectable: Requires review of access control matrices defining role-based
#//permissions, approval workflows for access requests, default-deny ACL configurations,
#//and documented security policies. ES|QL cannot validate policy documentation or
#//system configuration baselines. Verified through policy review, access control
#//system audit, and approval ticket sampling.
#//RULE-PCI-22 — Password Brute Force Attack (PCI 8.1.6)
#//Requirement: 8
#//Objective: Detect repeated failed login attempts indicating brute force
#//Data sources: Windows Event Logs, Linux auditd, application logs
#//ECS fields used: event.category, event.outcome, user.name, source.ip
#//Tuning notes: Threshold 6 failures per 30min window; monitor account lockout events

name: "Password Brute Force Attack Detected"
description: |
  Identifies multiple failed authentication attempts from single source indicating
  password brute force or credential stuffing attack. PCI DSS 8.1.6 requires lockout
  after not more than 6 failed attempts. Exceeding threshold suggests automated
  attack or compromised credentials. Correlate with account lockout events and
  monitor for successful login after failures (credential validation).
type: esql
params: '{}'
schedule_interval: 5m
index:
  - winlogbeat-*
  - auditbeat-*
query_language: esql
query: |
  FROM winlogbeat-*, auditbeat-*
  | WHERE event.category == "authentication"
    AND @timestamp > NOW() - 30 MINUTES
  | EVAL time_bucket = DATE_TRUNC(5 minutes, @timestamp)
  | EVAL is_failure = CASE(event.outcome == "failure", 1, 0)
  | EVAL is_success = CASE(event.outcome == "success", 1, 0)
  | STATS failure_count = SUM(is_failure),
          success_count = SUM(is_success),
          unique_users = COUNT_DISTINCT(user.name),
          users_targeted = VALUES(user.name),
          first_attempt = MIN(@timestamp),
          last_attempt = MAX(@timestamp)
    BY time_bucket, source.ip, host.name
  | WHERE failure_count > 6
  | EVAL attack_type = CASE(
      unique_users > 10, "Credential Spray",
      unique_users > 3, "Multi-User Brute Force",
      "Single User Brute Force"
    )
  | EVAL credential_validated = CASE(
      success_count > 0, true,
      false
    )
  | EVAL risk_score = CASE(
      success_count > 0 AND failure_count > 10, 100,
      failure_count > 50, 95,
      unique_users > 10, 95,
      failure_count > 20, 90,
      failure_count > 10, 80,
      70
    )
  | KEEP agent_id, time_bucket, source.ip, host.name, failure_count, success_count, unique_users, attack_type, credential_validated, users_targeted, first_attempt, last_attempt, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - pci_dss
  - requirement_8
  - authentication
  - brute_force
  - credential_access
severity: high
risk_score: 85
references:
  - "PCI DSS v3.1 Requirement 8.1.6"
nist: ["AC-7"]
gdpr: ["32"]
pci_dss: ["8.1.6", "8.1.7"]
mitre_attack:
  TA0006:
    T1110: ["T1110.001"]
