rule_id: 83ad228c-674f-451b-a127-2d0ffdd7ce12

#//RULE-PCI-31 â€” Privileged Command Execution (PCI 10.2.2)
#//Requirement: 10
#//Objective: Detect and log all actions by root/administrator accounts
#//Data sources: Windows Event Logs, Linux auditd
#//ECS fields used: event.category, user.name, process.name, event.action
#//Field validation: Verify these fields exist in your indices before enabling
#//Tuning notes: Monitor sudo/runas commands; track privileged process executions

name: "Privileged Command Execution by Administrator"
description: |
  Identifies execution of privileged commands and processes by root, Administrator,
  or sudo-elevated users. PCI DSS 10.2.2 requires logging all actions by users with
  root/administrative privileges for accountability and forensic investigation.
  High-risk commands include user management, firewall changes, service modifications,
  and file system alterations. Baseline normal admin activity and alert on anomalies.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - winlogbeat-*
  - auditbeat-*
query_language: esql
query: |
  FROM winlogbeat-*, auditbeat-*
  | WHERE (
      (process.name == "sudo" 
       AND event.action IN ("executed", "process_started"))
      OR
      (user.name RLIKE "(?i).*(administrator|admin|root).*"
       AND event.category == "process"
       AND process.name IN ("net.exe", "sc.exe", "reg.exe", "wmic.exe", "powershell.exe"))
      OR
      (event.category == "iam"
       AND user.name RLIKE "(?i).*(root|administrator|admin).*"
       AND event.action RLIKE "(?i).*(add|delete|modify|change).*")
    )
  | STATS command_count = COUNT(*),
          commands = VALUES(process.command_line),
          processes = VALUES(process.name),
          actions = VALUES(event.action)
    BY user.name, host.name
  | WHERE command_count > 0
  | EVAL high_risk_action = CASE(
      processes RLIKE "(?i).*(net|sc|reg|wmic).*", 1,
      commands RLIKE "(?i).*(userdel|usermod|iptables|firewall).*", 1,
      0
    )
  | WHERE high_risk_action == 1
  | EVAL risk_score = CASE(
      commands RLIKE "(?i).*(passwd|shadow|sudoers).*", 90,
      command_count > 20, 85,
      70
    )
  | KEEP agent_id, user.name, host.name, command_count, processes, commands, risk_score
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - pci_dss
  - requirement_10
  - logging
  - privileged_access
  - monitoring
severity: medium
risk_score: 70
references:
  - "PCI DSS v3.1 Requirement 10.2.2"
nist: ["AU-12"]
gdpr: []
pci_dss: ["10.2.2"]
mitre_attack:
  TA0002:
    T1059: []