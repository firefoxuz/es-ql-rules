rule_id: 0203de95-be6f-46b4-aeb7-2d2d00e2b72f
name: "PCI DSS 1.3.3 - Direct Internet to CDE Connection Allowed (Palo Alto)"
description: |
  Detects traffic ALLOWED directly from Internet zone to internal CDE network,
  bypassing DMZ - a critical violation of PCI DSS Requirement 1.3.3 which prohibits
  any direct connections inbound or outbound between Internet and CDE.
  If traffic is being ALLOWED from untrusted zones directly to CDE-tagged destinations,
  this indicates a misconfigured or overly permissive firewall rule.
  Trigger: Any ALLOW action from internet/untrust zone to known CDE destination.
  False positives: Legitimate DMZ-hosted services that are incorrectly zoned as CDE.
  Triage: IMMEDIATELY review the firewall rule that allowed this traffic,
  identify if the destination is truly a CDE system, escalate to firewall admin.
  NOTE: Update destination CDE zone names to match your actual zone configuration.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-paloalto*
query_language: esql
query: |
  FROM filebeat-paloalto*
  | WHERE event.dataset == "panw.panos"
    AND event.action IN ("allow", "allowed")
    AND event.outcome == "success"
    AND network.direction == "ingress"
    -- Internet/untrusted source zones (update to match your zone names)
    AND observer.ingress.zone IN ("untrust", "internet", "external", "wan", "outside")
    -- CDE destination zones (update to match your CDE zone names)
    AND observer.egress.zone IN ("cde", "cardholder", "pci", "secure", "internal-cde")
  | STATS
      allowed_connections    = COUNT(*),
      unique_sources         = COUNT_DISTINCT(source.ip),
      unique_destinations    = COUNT_DISTINCT(destination.ip),
      source_ips             = VALUES(source.ip),
      destination_ips        = VALUES(destination.ip),
      destination_ports      = VALUES(destination.port),
      applications_allowed   = VALUES(network.application),
      permitting_rules       = VALUES(rule.name)
    BY observer.hostname,
       rule.name,
       bucket = DATE_TRUNC(5 minutes, @timestamp)
  | EVAL severity_level = CASE(
      allowed_connections >= 100, "critical",
      allowed_connections >= 10,  "critical",
      "critical"
    )
  | EVAL risk_score = 99
  | KEEP bucket, observer.hostname, rule.name, allowed_connections,
         unique_sources, unique_destinations, source_ips,
         destination_ips, destination_ports, applications_allowed,
         permitting_rules, severity_level, risk_score
  | SORT allowed_connections DESC
enabled: false
tags:
  - pci_dss
  - firewall_misconfiguration
  - direct_access
  - critical
  - palo_alto
severity: critical
risk_score: 99
references:
  - "PCI DSS v3.2.1 Requirement 1.3.3: Do not allow direct connections inbound or outbound between Internet and CDE"
  - "PCI DSS v3.2.1 Requirement 1.3: Prohibit direct public access between Internet and CDE"
pci_dss: ["1.3.3", "1.3", "1.3.1"]
mitre_attack:
  - "T1133"
  - "T1190"