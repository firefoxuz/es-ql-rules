rule_id: aa03a790-87e0-49fd-bf58-e03dd41c7053
#//EVIDENCE-PCI-11 — Vulnerability Scans, Penetration Testing, IDS/IPS (PCI 11.2, 11.3, 11.4, 11.6)
#//Requirement: 11
#//Objective: Evidence of vulnerability scanning, penetration testing, intrusion detection deployment
#//Why not detectable: Requires review of quarterly internal/external vulnerability
#//scan reports (ASV scans), annual penetration test results, network/application
#//pen test documentation, segmentation testing, IDS/IPS deployment verification,
#//signature update logs, and security testing procedures. ES|QL cannot validate
#//scan completeness, test methodology, or control effectiveness. Verified through
#//scan report audit, penetration test documentation review, and IDS/IPS configuration
#//assessment.
#//RULE-PCI-39 — Unapproved Remote Access Connection (PCI 12.3.9)
#//Requirement: 12
#//Objective: Detect vendor/partner remote access not following activation procedures
#//Data sources: VPN logs, remote access logs, authentication logs
#//ECS fields used: event.category, user.name, source.ip, event.action
#//Field validation: Verify these fields exist in your indices before enabling
#//Tuning notes: Track vendor account usage; monitor for always-on vendor connections

name: "Vendor Remote Access Outside Approved Window"
description: |
  Identifies vendor or business partner remote access connections that remain active
  outside approved maintenance windows or without proper activation/deactivation.
  PCI DSS 12.3.9 requires vendor remote access only when needed with immediate
  deactivation after use. Persistent vendor connections increase attack surface
  and violate principle of least access. Monitor for long-duration sessions and
  off-hours vendor activity.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - winlogbeat-*
  - auditbeat-*
query_language: esql
query: |
  FROM winlogbeat-*, auditbeat-*
  | WHERE event.category == "authentication"
    AND event.outcome == "success"
    AND user.name RLIKE "(?i).*(vendor|partner|contractor|support|supplier).*"
    AND event.original == "inbound"
    AND NOT CIDR_MATCH(source.ip, "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16")
  | STATS session_count = COUNT(*),
          session_start = MIN(@timestamp),
          session_end = MAX(@timestamp),
          sources = VALUES(source.ip),
          duration_minutes = (MAX(@timestamp) - MIN(@timestamp)) / 60000
    BY user.name, source.ip
  | WHERE session_count > 0
  | EVAL risk_score = CASE(
      duration_minutes > 240, 90,
      session_count > 10, 85,
      duration_minutes > 120, 75,
      70
    )
  | KEEP agent_id, user.name, source.ip, session_count, duration_minutes, session_start, session_end, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - pci_dss
  - requirement_12
  - remote_access
  - vendor_management
  - third_party
severity: medium
risk_score: 75
references:
  - "PCI DSS v3.1 Requirement 12.3.9"
nist: ["AC-17"]
gdpr: [""]
pci_dss: ["12.3.9"]
mitre_attack:
  TA0001:
    T1133: []