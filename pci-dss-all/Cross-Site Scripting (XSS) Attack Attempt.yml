#//RULE-PCI-18 â€” Cross-Site Scripting (XSS) Attempt (PCI 6.5.7)
#//Requirement: 6
#//Objective: Detect XSS attack attempts in web requests
#//Data sources: Web access logs (nginx), WAF logs
#//ECS fields used: url.query, http.request.body, source.ip, url.path
#//Tuning notes: Monitor for script tags and JavaScript event handlers; exclude CDN

name: "RULE-PCI-18: Cross-Site Scripting (XSS) Attack Attempt"
description: |
  Detects potential Cross-Site Scripting attacks through web request parameters
  containing JavaScript code, HTML script tags, or event handlers. PCI DSS 6.5.7
  requires addressing XSS vulnerabilities in web applications. Patterns include
  <script> tags, onerror/onload handlers, and JavaScript protocol URIs. Correlate
  with application responses (reflected XSS) and user session activity.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*
  | WHERE event.category == "web"
    AND (
      url.query RLIKE "(?i).*(<script|<iframe|javascript:|onerror|onload|eval\\(|alert\\(|document\\.).*"
      OR http.request.body RLIKE "(?i).*(<script|<iframe|javascript:|onerror|onload|eval\\(|alert\\(|document\\.).*"
      OR http.request.referrer RLIKE "(?i).*(<script|javascript:).*"
    )
  | STATS attempt_count = COUNT(*),
          urls = VALUES(url.path),
          queries = VALUES(url.query),
          user_agents = VALUES(user_agent.original),
          referrers = VALUES(http.request.referrer)
    BY source.ip, url.path
  | WHERE attempt_count > 0
  | EVAL attack_type = CASE(
      queries RLIKE "(?i).*<script.*", "Script Injection",
      queries RLIKE "(?i).*javascript:.*", "JavaScript Protocol",
      queries RLIKE "(?i).*(onerror|onload).*", "Event Handler",
      "Generic XSS"
    )
  | EVAL risk_score = CASE(
      attempt_count > 5, 90,
      attack_type == "Script Injection", 85,
      70
    )
  | KEEP source.ip, url.path, attempt_count, attack_type, queries, user_agents, risk_score
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - pci_dss
  - requirement_6
  - web
  - xss
  - attack
severity: high
risk_score: 85
references:
  - "PCI DSS v3.1 Requirement 6.5.7"
  - "OWASP Top 10 A7:2017"
nist: ["SI-10"]
gdpr: ["Article 32"]
pci_dss: ["6.5.7"]
mitre_attack:
  TA0001:
    T1189: []
