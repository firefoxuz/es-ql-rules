rule_id: 36241d83-3b78-420a-b4ab-1b5574b31d87
#
#//RULE-PCI-11 â€” Unprotected PAN in Email/Messaging (PCI 4.2)
#//Requirement: 4
#//Objective: Detect unprotected PANs sent via email, IM, SMS
#//Data sources: Email logs, messaging application logs
#//ECS fields used: event.original, event.original, event.original, event.category
#//Field validation: Verify these fields exist in your indices before enabling
#//Tuning notes: Monitor mail server logs and messaging platforms; exclude encrypted email gateways

name: "Unprotected PAN Sent via End-User Messaging"
description: |
  Identifies Primary Account Numbers transmitted through email, instant messaging,
  SMS, or chat without encryption. PCI DSS 4.2 prohibits sending unprotected PANs
  via end-user messaging technologies. Detects PAN patterns in email body/subject
  and messaging logs. Exclude encrypted email systems (S/MIME, PGP) and authorized
  secure messaging platforms. High false positive risk from order confirmations.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - filebeat-*
query_language: esql
query: |
  FROM filebeat-*
  | WHERE (
      (event.dataset RLIKE ".*mail.*"
       AND (event.original RLIKE ".*[3-6][0-9]{13,18}.*"
            OR event.original RLIKE ".*[3-6][0-9]{13,18}.*"
            OR event.original RLIKE "(?i).*(card.*number|account.*number).*[3-6][0-9]{13,}.*"))
      OR
      (event.category == "web"
       AND event.original RLIKE "(?i).*(slack|teams|chat|sms|im).*"
       AND event.original RLIKE ".*[3-6][0-9]{13,18}.*")
    )
  | WHERE NOT (
      event.original RLIKE "(?i).*(encrypt|pgp|smime|secure).*"
      OR event.original RLIKE "(?i).*(token|encrypted).*"
    )
  | STATS message_count = COUNT(*),
          senders = VALUES(user.name),
          subjects = VALUES(event.original),
          recipients = VALUES(event.original)
    BY host.name, event.dataset
  | WHERE message_count > 0
  | EVAL risk_score = CASE(
      message_count > 5, 90,
      event.original IS NOT NULL, 85,
      70
    )
  | KEEP agent_id, host.name, event.dataset, message_count, senders, subjects, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - pci_dss
  - requirement_4
  - data_protection
  - messaging
  - email
severity: high
risk_score: 85
references:
  - "PCI DSS v3.1 Requirement 4.2"
nist: ["SC-8"]
gdpr: ["32"]
pci_dss: ["4.2"]
mitre_attack:
  TA0010: 
    T1048: ["T1048.003"]