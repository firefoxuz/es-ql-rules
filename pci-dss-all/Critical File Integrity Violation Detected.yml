rule_id: c5d23489-6807-4a7a-9e51-f75405ccf446
#//RULE-PCI-38 â€” File Integrity Monitoring Alert (PCI 11.5)
#//Requirement: 11
#//Objective: Detect unauthorized modifications to critical system files
#//Data sources: File integrity monitoring logs (Tripwire, AIDE, OSSEC)
#//ECS fields used: event.category, file.path, event.original, event.action
#//Tuning notes: Monitor FIM alerts; weekly file comparisons; baseline critical files

name: "Critical File Integrity Violation Detected"
description: |
  Identifies unauthorized modifications to critical system files, configuration
  files, or content files detected by file integrity monitoring tools. PCI DSS 11.5
  requires change-detection mechanisms with weekly critical file comparisons. File
  integrity violations may indicate malware, unauthorized changes, or system
  compromise. Correlate with change management records and investigate all alerts.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - auditbeat-*
  - filebeat-*
query_language: esql
query: |
  FROM auditbeat-*, filebeat-*
  | WHERE (
      event.module IN ("file_integrity", "fim", "aide", "tripwire", "ossec")
      OR
      (event.category == "file"
       AND event.action IN ("modified", "deleted", "created")
       AND file.path RLIKE ".*/(etc|bin|sbin|boot|www/html|htdocs|webapps)/.*"
       AND event.type == "change")
    )
  | WHERE NOT (
      user.name IN ("root", "system")
      AND file.path RLIKE ".*/var/log/.*"   
    )
  | STATS integrity_violations = COUNT(*),
          files_changed = VALUES(file.path),
          users = VALUES(user.name),
          hash_changes = VALUES(event.original.sha256),
          first_violation = MIN(@timestamp)
    BY host.name, file.path
  | WHERE integrity_violations > 0
  | EVAL criticality = CASE(
      files_changed RLIKE "(?i).*(passwd|shadow|sudoers|ssh.*config|httpd\\.conf|web\\.config).*", "critical",
      files_changed RLIKE "(?i).*(bin|sbin|boot).*", "high",
      "medium"
    )
  | EVAL risk_score = CASE(
      criticality == "critical", 100,
      criticality == "high", 90,
      integrity_violations > 5, 85,
      75
    )
  | KEEP agent_id, host.name, file.path, integrity_violations, files_changed, users, criticality, first_violation, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - pci_dss
  - requirement_11
  - file_integrity
  - monitoring
  - configuration_change
severity: high
risk_score: 90
references:
  - "PCI DSS v3.1 Requirement 11.5, 11.5.1"
nist: ["SI-7"]
gdpr: ["32"]
pci_dss: ["11.5", "11.5.1"]
mitre_attack:
  TA0005:
    T1222: []