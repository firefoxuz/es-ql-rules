rule_id: b316ddce-a46d-47bc-bcca-f85b6e0fe128
#//RULE-PCI-32 â€” Unauthorized Database Access Attempt (PCI 10.2.1)
#//Requirement: 10
#//Objective: Detect individual user access to cardholder data in databases
#//Data sources: Database audit logs, application logs
#//ECS fields used: event.category, user.name, event.original, event.action
#//Field validation: Verify these fields exist in your indices before enabling
#//Tuning notes: Monitor SELECT queries on CHD tables; track direct DB access

name: "Direct Database Access to Cardholder Data"
description: |
  Identifies direct database access to tables containing cardholder data by individual
  users, bypassing application layer. PCI DSS 10.2.1 requires logging all individual
  user accesses to cardholder data. Direct DB access may indicate privilege abuse,
  insider threat, or compromised DBA credentials. Correlate with authorized maintenance
  windows and data access requests.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - filebeat-*
query_language: esql
query: |
  FROM filebeat-*
  | WHERE event.category == "database"
    AND (
      event.original RLIKE "(?i).*(SELECT|UPDATE|DELETE).*FROM.*(payment|card|customer|transaction).*"
      OR event.original RLIKE "(?i).*(access.*cardholder|query.*pan|select.*cc_number).*"
    )
  | WHERE NOT user.name IN ("app_service", "etl_user", "backup_service")  
  | STATS access_count = COUNT(*),
          tables_accessed = VALUES(event.original),
          queries = VALUES(event.original),
          first_access = MIN(@timestamp),
          last_access = MAX(@timestamp)
    BY user.name, host.name
  | WHERE access_count > 0
  | EVAL risk_score = CASE(
      queries RLIKE "(?i).*(SELECT.*\\*).*", 95,  
      access_count > 10, 90,
      queries RLIKE "(?i).*(UPDATE|DELETE).*", 100,
      80
    )
  | KEEP agent_id, user.name, host.name, access_count, tables_accessed, first_access, last_access, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - pci_dss
  - requirement_10
  - logging
  - database
  - cardholder_data_access
severity: high
risk_score: 85
references:
  - "PCI DSS v3.1 Requirement 10.2.1"
nist: ["AU-12"]
gdpr: ["32"]
pci_dss: ["10.2.1", "8.7"]
mitre_attack:
  TA0009:
    T1005: []
