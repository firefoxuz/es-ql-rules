rule_id: cba81093-c2ce-4032-ba37-515dc5fb12be
name: "PCI DSS 1.3.4 - IP Spoofing / Forged Source Address Detected (Palo Alto)"
description: |
  Detects IP spoofing and forged source address attempts blocked by Palo Alto firewall.
  PCI DSS Requirement 1.3.4 mandates anti-spoofing measures to detect and block
  forged source IP addresses entering the network.
  Monitors zone protection profile actions for IP spoofing, and threat logs
  for source IP anomalies. Also detects RFC1918 (private IP) addresses arriving
  on external interfaces - a clear indicator of spoofed packets.
  Trigger: Any anti-spoofing action or private IP arriving on external/DMZ interface.
  False positives: Misconfigured NAT, asymmetric routing in complex topologies.
  Triage: Verify if anti-spoofing zone protection profiles are enabled,
  check ingress interface for the event, notify network team if persistent.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-paloalto*
query_language: esql
query: |
  FROM filebeat-paloalto*
  | WHERE event.dataset == "panw.panos"
    AND (
      -- Spoofing threat category
      (event.category LIKE "*spoof*" OR panw.panos.threat_name LIKE "*spoof*")
      OR
      -- Private IPs arriving on external interface (RFC1918 source from internet)
      (
        network.direction == "ingress"
        AND observer.ingress.zone IN ("untrust", "internet", "external", "wan")
        AND (
          CIDR_MATCH(source.ip, "10.0.0.0/8")
          OR CIDR_MATCH(source.ip, "172.16.0.0/12")
          OR CIDR_MATCH(source.ip, "192.168.0.0/16")
          OR CIDR_MATCH(source.ip, "127.0.0.0/8")
          OR CIDR_MATCH(source.ip, "169.254.0.0/16")
        )
      )
    )
  | EVAL spoof_type = CASE(
      CIDR_MATCH(source.ip, "10.0.0.0/8"),        "rfc1918_10_block",
      CIDR_MATCH(source.ip, "172.16.0.0/12"),      "rfc1918_172_block",
      CIDR_MATCH(source.ip, "192.168.0.0/16"),     "rfc1918_192_block",
      CIDR_MATCH(source.ip, "127.0.0.0/8"),        "loopback_spoofed",
      CIDR_MATCH(source.ip, "169.254.0.0/16"),     "apipa_spoofed",
      "threat_signature_spoof"
    )
  | STATS
      spoof_attempts        = COUNT(*),
      unique_sources        = COUNT_DISTINCT(source.ip),
      unique_destinations   = COUNT_DISTINCT(destination.ip),
      spoofed_ips           = VALUES(source.ip),
      target_ips            = VALUES(destination.ip),
      spoof_types           = VALUES(spoof_type),
      ingress_interfaces    = VALUES(observer.ingress.interface.name)
    BY observer.hostname,
       spoof_type,
       bucket = DATE_TRUNC(5 minutes, @timestamp)
  | EVAL severity_level = CASE(
      spoof_attempts >= 100, "critical",
      spoof_attempts >= 20,  "high",
      "medium"
    )
  | EVAL risk_score = CASE(
      spoof_attempts >= 100, 85,
      spoof_attempts >= 20,  65,
      45
    )
  | KEEP bucket, observer.hostname, spoof_type, spoof_attempts,
         unique_sources, unique_destinations, spoofed_ips,
         target_ips, ingress_interfaces, severity_level, risk_score
  | SORT spoof_attempts DESC
enabled: false
tags:
  - pci_dss
  - ip_spoofing
  - network_integrity
  - palo_alto
severity: medium
risk_score: 65
references:
  - "PCI DSS v3.2.1 Requirement 1.3.4: Implement anti-spoofing measures to detect and block forged source IP addresses"
pci_dss: ["1.3.4"]
nist: ["SC-5","SC-7","SI-3","SI-4"]
gdpr: ["5.1.f", "32"]
mitre_attack:
  TA0005:
    T1036: []
    T1562: ["T1562.004"]
