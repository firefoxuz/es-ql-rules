rule_id: 8265e18e-aed1-4f93-aa2e-0ab6fcda13ba
#//RULE-PCI-12 â€” Weak TLS/SSL Configuration (PCI 4.1, 4.1.1)
#//Requirement: 4
#//Objective: Detect weak or deprecated TLS versions and ciphers
#//Data sources: Network logs, TLS handshake metadata
#//NOTE: Requires Packetbeat with TLS inspection or network proxy logs with cipher/version details
#//ECS fields used: event.original, event.original, event.original, event.original
#//Tuning notes: Alert on TLS < 1.2, weak ciphers (RC4, DES, export); verify wireless encryption

name: "Weak or Deprecated TLS/SSL Configuration"
description: |
  Detects usage of weak TLS versions (SSL 2.0/3.0, TLS 1.0/1.1) or insecure cipher
  suites (RC4, DES, export ciphers, NULL encryption). PCI DSS 4.1 requires strong
  cryptography; deprecated protocols expose data to downgrade attacks and weak ciphers
  enable decryption. Monitor TLS handshakes for version negotiation and cipher
  selection. Exclude planned legacy system migrations with risk acceptance.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - filebeat-*
query_language: esql
query: |
  FROM filebeat-*
  | WHERE event.original RLIKE "(?i).*(tls|ssl).*"
    AND (
      event.original IN ("1.0", "1.1", "SSLv2", "SSLv3")
      OR event.original RLIKE "(?i).*(rc4|des|export|null|anon|adh).*"
    )
  | STATS connection_count = COUNT(*),
          tls_versions = VALUES(event.original),
          ciphers = VALUES(event.original),
          sources = VALUES(source.ip),
          destinations = VALUES(event.original)
    BY event.original, event.original, event.original
  | WHERE connection_count > 0
  | EVAL severity_level = CASE(
      event.original IN ("SSLv2", "SSLv3"), "critical",
      event.original RLIKE "(?i).*(null|export).*", "critical",
      event.original IN ("1.0", "1.1"), "high",
      event.original RLIKE "(?i).*(rc4|des).*", "high",
      "medium"
    )
  | EVAL risk_score = CASE(
      severity_level == "critical", 95,
      severity_level == "high", 80,
      60
    )
  | KEEP agent_id, event.original, event.original, event.original, connection_count, sources, severity_level, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - pci_dss
  - requirement_4
  - encryption
  - tls
  - network
severity: high
risk_score: 85
references:
  - "PCI DSS v3.1 Requirement 4.1"
  - "PCI SSC TLS guidance"
nist: ["SC-8"]
gdpr: ["32"]
pci_dss: ["4.1", "4.1.1"]
mitre_attack:
  TA0009: 
    T1040: []
