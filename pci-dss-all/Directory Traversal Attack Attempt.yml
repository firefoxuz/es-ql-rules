rule_id: dae34d85-ad6a-47b1-ad82-4ec2137cee16
#//RULE-PCI-19 â€” Directory Traversal Attempt (PCI 6.5.8)
#//Requirement: 6
#//Objective: Detect path traversal attacks in web requests
#//Data sources: Web access logs (nginx), application logs
#//ECS fields used: event.original, event.original, event.outcome, source.ip
#//Tuning notes: Monitor for ../ patterns and absolute paths; correlate with 404/403 errors
#
name: "Directory Traversal Attack Attempt"
description: |
  Identifies directory traversal (path traversal) attacks attempting to access
  files outside web root using ../ sequences or absolute paths. PCI DSS 6.5.8
  addresses improper access control including directory traversal. Attackers use
  these techniques to read sensitive files (passwd, config files, source code).
  Monitor for encoded variants (%2e%2e%2f) and correlate with failed access attempts.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*
  | WHERE event.category == "web"
    AND (
      event.original RLIKE ".*\\.\\.[\\/\\\\].*"
      OR event.original RLIKE ".*(etc\\/passwd|windows\\/win\\.ini|\\.ssh\\/|config\\.php|web\\.config|boot\\.ini|system32).*"
      OR event.original RLIKE "(?i).*(file=.*\\.\\.[\\/]|path=.*\\.\\.[\\/]).*"
      OR event.original RLIKE ".*%2e%2e[\\/|%2f|%5c].*"
      OR event.original RLIKE ".*%252e%252e.*"
      OR event.original RLIKE ".*\\\\\\\\.*"
      OR event.original RLIKE ".*%00.*"
    )
  | STATS attempt_count = COUNT(*),
          status_codes = VALUES(event.outcome),
          paths = VALUES(event.original),
          user_agents = VALUES(event.original)
    BY source.ip, event.original
  | WHERE attempt_count > 0
  | EVAL traversal_technique = CASE(
      paths RLIKE ".*%252e.*", "Double Encoded",
      paths RLIKE ".*%2e%2e.*", "URL Encoded",
      paths RLIKE ".*%00.*", "Null Byte Injection",
      paths RLIKE ".*\\\\\\\\.*", "UNC Path",
      "Standard Traversal"
    )
  | EVAL success_indicators = CASE(
      status_codes RLIKE ".*(200|301|302).*", 1,
      0
    )
  | EVAL risk_score = CASE(
      success_indicators == 1, 100,
      paths RLIKE "(?i).*(passwd|shadow|win\\.ini|boot\\.ini).*", 95,
      attempt_count > 5, 90,
      traversal_technique == "Double Encoded", 85,
      75
    )
  | KEEP agent_id, source.ip, event.original, attempt_count, status_codes, traversal_technique, paths, user_agents, risk_score
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - pci_dss
  - requirement_6
  - web
  - directory_traversal
  - attack
severity: high
risk_score: 85
references:
  - "PCI DSS v3.1 Requirement 6.5.8"
  - "OWASP Top 10 A5:2017"
nist: ["SI-10"]
gdpr: ["32"]
pci_dss: ["6.5.8"]
mitre_attack:
  TA0007:
    T1083: []
