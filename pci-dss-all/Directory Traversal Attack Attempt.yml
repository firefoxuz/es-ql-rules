#//RULE-PCI-19 â€” Directory Traversal Attempt (PCI 6.5.8)
#//Requirement: 6
#//Objective: Detect path traversal attacks in web requests
#//Data sources: Web access logs (nginx), application logs
#//ECS fields used: url.path, url.query, http.response.status_code, source.ip
#//Tuning notes: Monitor for ../ patterns and absolute paths; correlate with 404/403 errors
#
name: "RULE-PCI-19: Directory Traversal Attack Attempt"
description: |
  Identifies directory traversal (path traversal) attacks attempting to access
  files outside web root using ../ sequences or absolute paths. PCI DSS 6.5.8
  addresses improper access control including directory traversal. Attackers use
  these techniques to read sensitive files (passwd, config files, source code).
  Monitor for encoded variants (%2e%2e%2f) and correlate with failed access attempts.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*
  | WHERE event.category == "web"
    AND (
      url.path RLIKE ".*\\.\\.[\\/\\\\].*"
      OR url.path RLIKE ".*(etc\\/passwd|windows\\/win\\.ini|\\.ssh\\/|config\\.php|web\\.config).*"
      OR url.query RLIKE "(?i).*(file=.*\\.\\.[\\/]|path=.*\\.\\.[\\/]).*"
      OR url.path RLIKE ".*%2e%2e[\\/|%2f|%5c].*"  // Encoded ../ or ..\
    )
  | STATS attempt_count = COUNT(*),
          status_codes = VALUES(http.response.status_code),
          paths = VALUES(url.path),
          user_agents = VALUES(user_agent.original)
    BY source.ip, url.path
  | WHERE attempt_count > 0
  | EVAL success_indicators = CASE(
      status_codes RLIKE ".*(200|301|302).*", 1,
      0
    )
  | EVAL risk_score = CASE(
      success_indicators == 1, 100,
      attempt_count > 5, 90,
      paths RLIKE "(?i).*(passwd|shadow|win\\.ini).*", 95,
      75
    )
  | KEEP source.ip, url.path, attempt_count, status_codes, paths, user_agents, risk_score
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - pci_dss
  - requirement_6
  - web
  - directory_traversal
  - attack
severity: high
risk_score: 85
references:
  - "PCI DSS v3.1 Requirement 6.5.8"
  - "OWASP Top 10 A5:2017"
nist: ["SI-10"]
gdpr: ["Article 32"]
pci_dss: ["6.5.8"]
mitre_attack:
  TA0007:
    T1083: []
