name: Correlated Incident - Access + Exfil + Tamper (30min)
description: |
  Aggregates suspicious access, exfiltration, and log tampering events from same user within 30 minutes - strong breach indicator.
type: esql
params: '{}'
schedule_interval: 30m
index:
  - auditbeat-*
  - metricbeat-*
  - filebeat-*
  - winlogbeat-*
query_language: esql
query: |
  FROM auditbeat-*, metricbeat-*, filebeat-*, winlogbeat-*
  | WHERE @timestamp >= NOW() - 30 minutes
  | WHERE (event.action IN ("accessed", "read", "file_read") AND file.path RLIKE ".*sensitive.*")
      OR (process.name IN ("zip", "tar") AND network.bytes > 1048576)
      OR (event.code IN ("1102", "4725") OR message RLIKE ".*(auditd.*stopped|log.*cleared).*")
  | STATS 
      access_events = COUNT_IF(event.action IN ("accessed", "read")),
      exfil_events = COUNT_IF(process.name IN ("zip", "tar")),
      tamper_events = COUNT_IF(event.code IN ("1102", "4725"))
    BY user.name, host.name
  | WHERE access_events >= 1 AND exfil_events >= 1 AND tamper_events >= 1
  | EVAL severity = "critical"
  | KEEP @timestamp, user.name, host.name, access_events, exfil_events, tamper_events, severity
enabled: false
tags:
  - access-control
severity: critical
risk_score: 90
# MITRE ATT&CK: tactic external_id -> technique external_id -> [subtechnique external_ids]
mitre_attack: {}
nist: ["AU-9"]
gdpr: ["II.5.1.f", "IV.33", "IV.32.1"]
pci-dss: []
hipaa: []
