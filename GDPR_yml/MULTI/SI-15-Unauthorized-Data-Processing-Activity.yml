name: Unauthorized Data Processing Activity
description: |
  Detects batch processing or automated scripts accessing personal data without documented purpose.
type: esql
params: '{}'
schedule_interval: 30m
index:
  - auditbeat-*
  - filebeat-*
query_language: esql
query: |
  FROM auditbeat-*, filebeat-*
  | WHERE @timestamp >= NOW() - 30 minutes
  | WHERE (process.name IN ("python", "perl", "ruby", "node", "powershell.exe", "cmd.exe")
          AND process.args RLIKE ".*(SELECT|INSERT|UPDATE|DELETE).*")
      OR (file.path RLIKE ".*\\.(csv|xlsx|json).*" AND event.action == "created" 
          AND file.size > 10485760)
  | WHERE user.name NOT IN ("etl-service", "data-pipeline", "reporting-service")
  | STATS activity_count = COUNT(*) BY user.name, host.name, process.name
  | WHERE activity_count >= 5
  | EVAL severity = "high"
  | KEEP @timestamp, user.name, host.name, process.name, activity_count, severity
enabled: false
tags:
  - system-integrity
severity: high
risk_score: 75
# MITRE ATT&CK: tactic external_id -> technique external_id -> [subtechnique external_ids]
mitre_attack: {}
nist: []
gdpr: ["II.5.1.a", "II.6", "IV.30"]
pci-dss: []
hipaa: []
