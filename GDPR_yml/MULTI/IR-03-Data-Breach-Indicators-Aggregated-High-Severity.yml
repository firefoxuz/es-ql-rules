name: Data Breach Indicators Aggregated (High Severity)
description: |
  Aggregates all high/critical severity rules triggered by same user/host in 1 hour.
type: esql
params: '{}'
schedule_interval: 1h
index:
  - auditbeat-*
  - metricbeat-*
  - filebeat-*
  - winlogbeat-*
query_language: esql
query: |
  FROM auditbeat-*, metricbeat-*, filebeat-*, winlogbeat-*
  | WHERE @timestamp >= NOW() - 1 hour
  | WHERE (event.code IN ("4720", "4732", "1102") 
          OR process.name IN ("zip", "tar", "mysqldump")
          OR file.path RLIKE ".*\\.(encrypted|log)$" AND event.action == "deleted"
          OR event.outcome == "failure" AND event.category == "authentication")
  	| STATS 
      rule_count = COUNT(*),
      event_categories = VALUES(event.category)
    BY user.name, host.name
  | WHERE rule_count >= 3
  | EVAL severity = "critical"
  | KEEP @timestamp, user.name, host.name, rule_count, event_categories, severity
enabled: false
tags:
  - incident-response
severity: critical
risk_score: 90
# MITRE ATT&CK: tactic external_id -> technique external_id -> [subtechnique external_ids]
mitre_attack: {}
nist: []
gdpr: ["II.5.2", "IV.33"]
pci-dss: []
hipaa: []
