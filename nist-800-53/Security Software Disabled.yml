rule_id: 1f84bb7a-479a-4bc0-b4f2-1ee1c4f525fb
#//RULE-NIST-34 â€” Security Software Tampering (NIST SI-3, SI-4)
#//Control Family: SI (System and Information Integrity)
#//Objective: Detect attempts to disable or tamper with security software
#//Threat scenario: Attacker disables antivirus, EDR, or logging before deploying malware
#//Data sources: Windows Service events, process termination of security tools
#//ECS fields used: event.action, event.provider, process.name, event.code
#//Field validation: Verify all ECS fields exist in your indices before enabling
#//Tuning notes: Maintain list of protected security services, allowlist legitimate maintenance

name: "Security Software Disabled"
description: |
  Detects stopping, disabling, or termination of security services (AV, EDR, logging).
  Attackers commonly disable security controls before malware deployment or data theft.
  Service stops for Windows Defender, CrowdStrike, Carbon Black, Sysmon captured.
  False positives: Legitimate software updates, planned maintenance, system restarts.
  Triage: Verify if action during maintenance window, check if performed by authorized admin,
  hunt for malware deployment following security service stop, re-enable protections immediately.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - logs-winlog*
  - logs-audit*
query_language: esql
query: |
  FROM logs-winlog*, logs-audit*
  | WHERE (event.code IN ("7036", "7040") AND event.provider RLIKE "(?i).*(defender|windefend|sense|crowdstrike|carbonblack|sysmon|splunk|wazuh|elastic).*")
    OR (event.action == "process-terminated" AND process.name RLIKE "(?i).*(msmpeng|mssense|csagent|cb\\.exe|sysmon|winlogbeat|auditbeat).*")
    OR (event.action IN ("service-stopped", "service-disabled"))
  | EVAL security_component = CASE(
      event.provider RLIKE "(?i).*defender.*" OR process.name RLIKE "(?i).*msmpeng.*", "Windows-Defender",
      event.provider RLIKE "(?i).*crowdstrike.*" OR process.name RLIKE "(?i).*csagent.*", "CrowdStrike-EDR",
      event.provider RLIKE "(?i).*carbonblack.*" OR process.name RLIKE "(?i).*cb\\.exe.*", "CarbonBlack-EDR",
      event.provider RLIKE "(?i).*sysmon.*" OR process.name RLIKE "(?i).*sysmon.*", "Sysmon-Logging",
      event.provider RLIKE "(?i).*(elastic|beats).*", "Elastic-Agent",
      "Other-Security-Tool"
    )
  | EVAL action_type = CASE(
      event.code == "7036" OR event.action == "service-stopped", "Service-Stopped",
      event.code == "7040" OR event.action == "service-disabled", "Service-Disabled",
      event.action == "process-terminated", "Process-Terminated",
      "Security-Tampering"
    )
  | STATS 
      tampering_count = COUNT(*),
      unique_components = COUNT_DISTINCT(COALESCE(event.provider, process.name)),
      affected_services = VALUES(COALESCE(event.provider, process.name)),
      tamper_actions = VALUES(action_type),
      users = VALUES(user.name)
    BY host.name
    , bucket = DATE_TRUNC(10 minutes, @timestamp)
  | WHERE tampering_count >= 1
  | EVAL risk_score = tampering_count * 50
  | KEEP agent_id, bucket, host.name, tampering_count, unique_components, affected_services, tamper_actions, users, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - nist_800_53
  - control_SI-3
  - control_SI-4
  - family_SI
  - defense_evasion
  - impair_defenses
  - critical_incident
severity: critical
risk_score: 93
references:
  - "NIST SP 800-53 Rev.5 SI-3: Malicious Code Protection"
  - "MITRE ATT&CK T1562.001: Disable or Modify Tools"
nist: ["SI-3", "SI-4"]
gdpr: []
pci_dss: []
mitre_attack:
  TA0005:
    T1562: ["T1562.001"]