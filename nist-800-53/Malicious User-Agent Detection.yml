#//RULE-NIST-27 â€” Suspicious User-Agent Patterns (NIST SI-4, SC-7)
#//Control Family: SI (System and Information Integrity), SC (System and Communications Protection)
#//Objective: Detect automated tools and malicious user-agents
#//Threat scenario: Attacker uses scanning tools or custom scripts to probe web application
#//Data sources: Nginx access logs with user-agent analysis
#//ECS fields used: user_agent.original, source.ip, url.path
#//Tuning notes: Allowlist legitimate monitoring tools, adjust pattern matching for new tools

name: "RULE-NIST-27: Malicious User-Agent Detection"
description: |
  Detects requests with user-agents associated with attack tools, scanners, or suspicious patterns.
  Tool signatures (sqlmap, nikto, masscan), empty user-agents, or custom scripts flagged.
  Combination of suspicious user-agent with attack payloads increases confidence.
  False positives: Authorized security scanning, penetration testing, legitimate monitoring.
  Triage: Verify if source IP authorized for security testing, review requested URLs for attack patterns,
  check if legitimate security audit is scheduled.
type: esql
params: '{}'
schedule_interval: 15m
index:
  - filebeat-nginx-access-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*
  | WHERE user_agent.original IS NOT NULL
  | EVAL malicious_ua = CASE(
      user_agent.original RLIKE "(?i).*(sqlmap|nikto|nmap|masscan|metasploit|burp|acunetix|nessus|openvas|w3af|dirbuster|gobuster|wfuzz|hydra|medusa|john|aircrack).*", true,
      user_agent.original RLIKE "(?i).*(python-requests|curl|wget|libwww-perl|go-http-client|java\\/|ruby|perl|scrapy).*", true,
      user_agent.original == "-" OR LENGTH(user_agent.original) < 10, true,
      false
    )
  | WHERE malicious_ua == true
  | EVAL tool_category = CASE(
      user_agent.original RLIKE "(?i).*(sqlmap|acunetix|w3af).*", "Web-Vuln-Scanner",
      user_agent.original RLIKE "(?i).*(nikto|dirbuster|gobuster|wfuzz).*", "Web-Fuzzer",
      user_agent.original RLIKE "(?i).*(nmap|masscan|nessus|openvas).*", "Network-Scanner",
      user_agent.original RLIKE "(?i).*(metasploit|burp|hydra).*", "Exploitation-Tool",
      user_agent.original RLIKE "(?i).*(python|curl|wget|scrapy).*", "Custom-Script",
      "Unknown-Tool"
    )
  | STATS 
      request_count = COUNT(*),
      unique_paths = COUNT_DISTINCT(url.path),
      unique_uas = COUNT_DISTINCT(user_agent.original),
      paths_accessed = VALUES(url.path),
      user_agents = VALUES(user_agent.original),
      http_methods = VALUES(http.request.method)
    BY source.ip, tool_category
    , bucket = DATE_TRUNC(20 minutes, @timestamp)
  | WHERE request_count >= 5
  | EVAL risk_score = request_count * 10 + unique_paths * 5
  | WHERE risk_score >= 30
  | KEEP bucket, source.ip, tool_category, request_count, unique_paths, unique_uas, paths_accessed, user_agents, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - nist_800_53
  - control_SI-4
  - control_SC-7
  - family_SI
  - family_SC
  - reconnaissance
  - web_application
severity: medium
risk_score: 55
references:
  - "NIST SP 800-53 Rev.5 SI-4: System Monitoring"
nist: ["SI-4", "SC-7"]
pci_dss: "11.4"
mitre_attack:
  TA0043:
    T1595: []