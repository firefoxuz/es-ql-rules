<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AD Rules Dashboard â€” Elasticsearch SIEM</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      /* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      :root {
        --bg-primary: #0d1117;
        --bg-secondary: #161b22;
        --bg-card: #1c2333;
        --bg-card-hover: #222d3f;
        --bg-elevated: #21262d;
        --border: #30363d;
        --border-light: #484f58;
        --text-primary: #e6edf3;
        --text-secondary: #8b949e;
        --text-muted: #6e7681;
        --accent-blue: #58a6ff;
        --accent-purple: #bc8cff;
        --accent-green: #3fb950;
        --accent-orange: #d29922;
        --accent-red: #f85149;
        --accent-cyan: #39d2c0;
        --accent-pink: #f778ba;
        --severity-critical: #f85149;
        --severity-high: #d29922;
        --severity-medium: #58a6ff;
        --severity-low: #3fb950;
        --glow-blue: 0 0 20px rgba(88, 166, 255, 0.15);
        --glow-green: 0 0 20px rgba(63, 185, 80, 0.15);
        --glow-red: 0 0 20px rgba(248, 81, 73, 0.15);
        --radius: 12px;
        --radius-sm: 8px;
        --radius-xs: 6px;
        --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      }
      html {
        font-size: 14px;
      }
      body {
        font-family: "Inter", system-ui, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        overflow-x: hidden;
      }
      a {
        color: var(--accent-blue);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
      }
      ::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--border-light);
      }

      /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .app {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      .header {
        background: linear-gradient(
          135deg,
          #0d1117 0%,
          #161b22 50%,
          #1a1e2e 100%
        );
        border-bottom: 1px solid var(--border);
        padding: 16px 28px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 100;
        backdrop-filter: blur(12px);
      }
      .header-left {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .logo {
        width: 36px;
        height: 36px;
        border-radius: var(--radius-sm);
        background: linear-gradient(
          135deg,
          var(--accent-blue),
          var(--accent-purple)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: 800;
        color: #fff;
      }
      .header h1 {
        font-size: 1.25rem;
        font-weight: 700;
        background: linear-gradient(
          135deg,
          var(--accent-blue),
          var(--accent-purple)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .header h1 span {
        font-weight: 400;
        opacity: 0.7;
      }
      .header-right {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .es-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.8rem;
        padding: 6px 14px;
        border-radius: 20px;
        background: var(--bg-card);
        border: 1px solid var(--border);
      }
      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }
      .status-dot.connected {
        background: var(--accent-green);
        box-shadow: 0 0 8px var(--accent-green);
      }
      .status-dot.disconnected {
        background: var(--accent-red);
        box-shadow: 0 0 8px var(--accent-red);
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .main {
        flex: 1;
        padding: 24px 28px;
        max-width: 1600px;
        margin: 0 auto;
        width: 100%;
      }

      /* â”€â”€ Action Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .action-bar {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        background: var(--bg-card);
        color: var(--text-primary);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        font-family: inherit;
      }
      .btn:hover {
        background: var(--bg-card-hover);
        border-color: var(--border-light);
        transform: translateY(-1px);
      }
      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--accent-blue),
          var(--accent-purple)
        );
        border-color: transparent;
        color: #fff;
      }
      .btn-primary:hover {
        box-shadow: var(--glow-blue);
        transform: translateY(-2px);
      }
      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      .btn-danger {
        border-color: var(--severity-critical);
        color: var(--severity-critical);
      }
      .btn-danger:hover {
        background: rgba(248, 81, 73, 0.1);
      }
      .search-box {
        flex: 1;
        min-width: 200px;
        padding: 10px 16px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        background: var(--bg-card);
        color: var(--text-primary);
        font-size: 0.85rem;
        font-family: inherit;
        transition: var(--transition);
      }
      .search-box:focus {
        outline: none;
        border-color: var(--accent-blue);
        box-shadow: var(--glow-blue);
      }
      .search-box::placeholder {
        color: var(--text-muted);
      }

      /* â”€â”€ Progress Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .progress-container {
        display: none;
        margin-bottom: 24px;
        background: var(--bg-card);
        border-radius: var(--radius);
        padding: 20px;
        border: 1px solid var(--border);
      }
      .progress-container.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }
      .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      .progress-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-secondary);
      }
      .progress-count {
        font-size: 0.85rem;
        color: var(--accent-blue);
        font-weight: 700;
      }
      .progress-bar {
        height: 6px;
        background: var(--bg-elevated);
        border-radius: 3px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
        background: linear-gradient(
          90deg,
          var(--accent-blue),
          var(--accent-purple)
        );
      }
      .progress-stats {
        display: flex;
        gap: 20px;
        margin-top: 12px;
        font-size: 0.8rem;
        color: var(--text-secondary);
      }
      .progress-stats span {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .progress-stats .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        display: inline-block;
      }

      /* â”€â”€ Summary Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }
      .card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 20px 24px;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }
      .card:hover {
        border-color: var(--border-light);
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
      }
      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(
          90deg,
          var(--accent-blue),
          var(--accent-purple)
        );
      }
      .card.critical::before {
        background: linear-gradient(
          90deg,
          var(--severity-critical),
          var(--accent-orange)
        );
      }
      .card.high::before {
        background: linear-gradient(
          90deg,
          var(--severity-high),
          var(--accent-orange)
        );
      }
      .card.medium::before {
        background: linear-gradient(
          90deg,
          var(--severity-medium),
          var(--accent-cyan)
        );
      }
      .card.low::before {
        background: linear-gradient(
          90deg,
          var(--severity-low),
          var(--accent-cyan)
        );
      }
      .card-label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }
      .card-value {
        font-size: 2rem;
        font-weight: 800;
        line-height: 1.1;
      }
      .card-sub {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 6px;
      }

      /* â”€â”€ Charts Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .charts {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 24px;
      }
      @media (max-width: 900px) {
        .charts {
          grid-template-columns: 1fr;
        }
      }
      .chart-box {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 20px;
        min-height: 280px;
      }
      .chart-title {
        font-size: 0.9rem;
        font-weight: 700;
        margin-bottom: 16px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .chart-title .icon {
        font-size: 1.1rem;
      }

      /* â”€â”€ Donut Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .donut-wrap {
        display: flex;
        align-items: center;
        gap: 30px;
        justify-content: center;
        padding: 10px 0;
      }
      .donut {
        position: relative;
        width: 160px;
        height: 160px;
      }
      .donut svg {
        width: 160px;
        height: 160px;
        transform: rotate(-90deg);
      }
      .donut circle {
        fill: none;
        stroke-width: 24;
        transition: stroke-dasharray 0.6s ease;
      }
      .donut-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
      }
      .donut-center .big {
        font-size: 1.8rem;
        font-weight: 800;
        line-height: 1;
      }
      .donut-center .small {
        font-size: 0.7rem;
        color: var(--text-muted);
      }
      .legend {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.8rem;
      }
      .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      /* â”€â”€ Bar Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .bar-chart {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 8px 0;
      }
      .bar-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .bar-label {
        width: 200px;
        font-size: 0.75rem;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex-shrink: 0;
      }
      .bar-track {
        flex: 1;
        height: 20px;
        background: var(--bg-elevated);
        border-radius: 4px;
        overflow: hidden;
      }
      .bar-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
        min-width: 2px;
        display: flex;
        align-items: center;
        padding: 0 8px;
      }
      .bar-fill span {
        font-size: 0.7rem;
        font-weight: 700;
        color: #fff;
        white-space: nowrap;
      }

      /* â”€â”€ MITRE Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .mitre-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 8px 0;
      }
      .mitre-cell {
        padding: 6px 12px;
        border-radius: var(--radius-xs);
        font-size: 0.72rem;
        font-weight: 600;
        border: 1px solid var(--border);
        background: var(--bg-elevated);
        transition: var(--transition);
        cursor: default;
      }
      .mitre-cell:hover {
        border-color: var(--accent-blue);
        background: rgba(88, 166, 255, 0.08);
      }
      .mitre-cell .tactic {
        color: var(--text-muted);
        font-size: 0.65rem;
        display: block;
      }
      .mitre-cell .tech {
        color: var(--accent-blue);
      }
      .mitre-cell.has-alert {
        border-color: var(--severity-critical);
        background: rgba(248, 81, 73, 0.08);
      }
      .mitre-cell.has-alert .tech {
        color: var(--severity-critical);
      }

      /* â”€â”€ Compliance Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .compliance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }
      .compliance-panel {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 20px;
      }
      .compliance-panel h3 {
        font-size: 0.9rem;
        font-weight: 700;
        margin-bottom: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .compliance-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .compliance-tag {
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.72rem;
        font-weight: 600;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        color: var(--text-secondary);
      }
      .compliance-tag.active {
        border-color: var(--accent-blue);
        color: var(--accent-blue);
        background: rgba(88, 166, 255, 0.08);
      }
      .compliance-tag.alerted {
        border-color: var(--severity-critical);
        color: var(--severity-critical);
        background: rgba(248, 81, 73, 0.08);
      }

      /* â”€â”€ Rules Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .table-container {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
        margin-bottom: 24px;
      }
      .table-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .table-header h2 {
        font-size: 1rem;
        font-weight: 700;
      }
      .table-header .badge {
        font-size: 0.75rem;
        padding: 3px 10px;
        border-radius: 12px;
        background: var(--bg-elevated);
        color: var(--text-secondary);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th {
        padding: 10px 16px;
        text-align: left;
        font-size: 0.72rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        color: var(--text-muted);
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
      }
      th:hover {
        color: var(--text-secondary);
      }
      td {
        padding: 12px 16px;
        border-bottom: 1px solid rgba(48, 54, 61, 0.5);
        font-size: 0.82rem;
        vertical-align: middle;
      }
      tr:hover td {
        background: rgba(88, 166, 255, 0.03);
      }
      tr.has-alerts td {
        background: rgba(248, 81, 73, 0.03);
      }
      tr.has-alerts:hover td {
        background: rgba(248, 81, 73, 0.06);
      }
      .severity-badge {
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.72rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-block;
      }
      .severity-critical {
        background: rgba(248, 81, 73, 0.12);
        color: var(--severity-critical);
      }
      .severity-high {
        background: rgba(210, 153, 34, 0.12);
        color: var(--severity-high);
      }
      .severity-medium {
        background: rgba(88, 166, 255, 0.12);
        color: var(--severity-medium);
      }
      .severity-low {
        background: rgba(63, 185, 80, 0.12);
        color: var(--severity-low);
      }
      .alert-count {
        font-weight: 800;
        font-size: 0.95rem;
      }
      .alert-count.has {
        color: var(--severity-critical);
        text-shadow: 0 0 10px rgba(248, 81, 73, 0.3);
      }
      .alert-count.none {
        color: var(--text-muted);
      }
      .tag {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.68rem;
        font-weight: 600;
        background: var(--bg-elevated);
        color: var(--text-secondary);
        display: inline-block;
        margin: 1px 2px;
      }
      .status-label {
        font-size: 0.72rem;
        font-weight: 600;
      }
      .status-label.pending {
        color: var(--text-muted);
      }
      .status-label.running {
        color: var(--accent-blue);
        animation: pulse 1s infinite;
      }
      .status-label.done {
        color: var(--accent-green);
      }
      .status-label.error {
        color: var(--severity-critical);
      }
      .btn-sm {
        padding: 5px 12px;
        font-size: 0.72rem;
        border-radius: var(--radius-xs);
      }

      /* â”€â”€ Detail Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 200;
        backdrop-filter: blur(4px);
        animation: fadeIn 0.2s ease;
      }
      .modal-overlay.active {
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding: 40px 20px;
        overflow-y: auto;
      }
      .modal {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        width: 100%;
        max-width: 1100px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        animation: slideUp 0.3s ease;
      }
      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
      }
      .modal-header h2 {
        font-size: 1.1rem;
        font-weight: 700;
        line-height: 1.4;
      }
      .modal-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 4px;
        line-height: 1;
        transition: var(--transition);
      }
      .modal-close:hover {
        color: var(--text-primary);
      }
      .modal-body {
        padding: 24px;
      }
      .modal-section {
        margin-bottom: 20px;
      }
      .modal-section h3 {
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--accent-blue);
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .modal-desc {
        font-size: 0.82rem;
        line-height: 1.7;
        color: var(--text-secondary);
        white-space: pre-wrap;
        background: var(--bg-card);
        padding: 14px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
      }
      .query-block {
        background: #0d1117;
        padding: 16px;
        border-radius: var(--radius-sm);
        font-family: "JetBrains Mono", "Fira Code", monospace;
        font-size: 0.78rem;
        line-height: 1.7;
        color: var(--accent-cyan);
        overflow-x: auto;
        white-space: pre-wrap;
        border: 1px solid var(--border);
      }
      .results-table-wrap {
        overflow-x: auto;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
      }
      .results-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.78rem;
      }
      .results-table th {
        padding: 8px 12px;
        background: var(--bg-card);
        color: var(--accent-blue);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border);
        white-space: nowrap;
      }
      .results-table td {
        padding: 8px 12px;
        border-bottom: 1px solid rgba(48, 54, 61, 0.3);
        color: var(--text-secondary);
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .results-table tr:hover td {
        background: rgba(88, 166, 255, 0.03);
      }
      .meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }
      .meta-item {
        background: var(--bg-card);
        padding: 12px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
      }
      .meta-item .label {
        font-size: 0.7rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
        font-weight: 600;
      }
      .meta-item .value {
        font-size: 0.9rem;
        font-weight: 700;
      }

      /* â”€â”€ Loading Spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--border);
        border-top-color: var(--accent-blue);
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        display: inline-block;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* â”€â”€ Filter Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .filter-tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }
      .filter-tab {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        border: 1px solid var(--border);
        background: var(--bg-card);
        color: var(--text-secondary);
        cursor: pointer;
        transition: var(--transition);
      }
      .filter-tab:hover {
        border-color: var(--border-light);
        color: var(--text-primary);
      }
      .filter-tab.active {
        background: rgba(88, 166, 255, 0.1);
        border-color: var(--accent-blue);
        color: var(--accent-blue);
      }

      /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .footer {
        padding: 16px 28px;
        border-top: 1px solid var(--border);
        text-align: center;
        font-size: 0.75rem;
        color: var(--text-muted);
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <header class="header">
        <div class="header-left">
          <div class="logo">AD</div>
          <h1>AD Rules <span>Dashboard</span></h1>
        </div>
        <div class="header-right">
          <div class="es-status" id="esStatus">
            <span class="status-dot disconnected" id="statusDot"></span>
            <span id="statusText">Connectingâ€¦</span>
          </div>
          <span
            style="font-size: 0.75rem; color: var(--text-muted)"
            id="lastScan"
            >â€”</span
          >
        </div>
      </header>

      <!-- â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <main class="main">
        <!-- Action Bar -->
        <div class="action-bar">
          <button
            class="btn btn-primary"
            id="btnExecuteAll"
            onclick="executeAll()"
          >
            â–¶ Execute All Rules
          </button>
          <select class="search-box" id="timeRange" style="flex:none;width:180px;cursor:pointer">
            <option value="15m">â± Last 15 min</option>
            <option value="1h">â± Last 1 hour</option>
            <option value="6h">â± Last 6 hours</option>
            <option value="24h" selected>â± Last 24 hours</option>
            <option value="7d">â± Last 7 days</option>
            <option value="30d">â± Last 30 days</option>
            <option value="all">â± All time</option>
          </select>
          <button class="btn" onclick="loadRules()">â†» Reload Rules</button>
          <input
            class="search-box"
            id="searchBox"
            placeholder="ğŸ” Search rules by name, tag, severityâ€¦"
            oninput="filterRules()"
          />
        </div>

        <!-- Progress -->
        <div class="progress-container" id="progressContainer">
          <div class="progress-header">
            <span class="progress-label" id="progressLabel"
              >Executing rulesâ€¦</span
            >
            <span class="progress-count" id="progressCount">0 / 0</span>
          </div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              id="progressFill"
              style="width: 0%"
            ></div>
          </div>
          <div class="progress-stats">
            <span
              ><span class="dot" style="background: var(--accent-green)"></span>
              Alerts: <b id="progressAlerts">0</b></span
            >
            <span
              ><span
                class="dot"
                style="background: var(--severity-critical)"
              ></span>
              Errors: <b id="progressErrors">0</b></span
            >
            <span
              ><span class="dot" style="background: var(--accent-blue)"></span>
              Current: <b id="progressCurrent">â€”</b></span
            >
          </div>
        </div>

        <!-- Summary Cards -->
        <div class="cards" id="summaryCards">
          <div class="card">
            <div class="card-label">Total Rules</div>
            <div class="card-value" id="cardTotal">â€”</div>
            <div class="card-sub">AD detection rules loaded</div>
          </div>
          <div class="card">
            <div class="card-label">Total Alerts</div>
            <div
              class="card-value"
              id="cardAlerts"
              style="color: var(--accent-blue)"
            >
              â€”
            </div>
            <div class="card-sub">matching events found</div>
          </div>
          <div class="card critical">
            <div class="card-label">Critical / High</div>
            <div
              class="card-value"
              id="cardCritHigh"
              style="color: var(--severity-critical)"
            >
              â€”
            </div>
            <div class="card-sub">high-priority alerts</div>
          </div>
          <div class="card medium">
            <div class="card-label">Medium / Low</div>
            <div
              class="card-value"
              id="cardMedLow"
              style="color: var(--severity-medium)"
            >
              â€”
            </div>
            <div class="card-sub">informational alerts</div>
          </div>
          <div class="card low">
            <div class="card-label">Rules With Alerts</div>
            <div
              class="card-value"
              id="cardFired"
              style="color: var(--accent-green)"
            >
              â€”
            </div>
            <div class="card-sub">rules triggered</div>
          </div>
          <div class="card">
            <div class="card-label">Errors</div>
            <div
              class="card-value"
              id="cardErrors"
              style="color: var(--severity-critical)"
            >
              â€”
            </div>
            <div class="card-sub">query failures</div>
          </div>
        </div>

        <!-- Charts -->
        <div class="charts" id="chartsSection" style="display: none">
          <div class="chart-box">
            <div class="chart-title">
              <span class="icon">ğŸ¯</span> Severity Distribution
            </div>
            <div class="donut-wrap" id="donutChart"></div>
          </div>
          <div class="chart-box">
            <div class="chart-title">
              <span class="icon">ğŸ“Š</span> Top Alerting Rules
            </div>
            <div class="bar-chart" id="barChart"></div>
          </div>
          <div class="chart-box">
            <div class="chart-title">
              <span class="icon">ğŸ›¡ï¸</span> MITRE ATT&CK Coverage
            </div>
            <div class="mitre-grid" id="mitreGrid"></div>
          </div>
          <div class="chart-box">
            <div class="chart-title">
              <span class="icon">ğŸ“‹</span> Compliance Coverage
            </div>
            <div
              id="complianceChart"
              style="display: flex; flex-direction: column; gap: 16px"
            ></div>
          </div>
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs" id="filterTabs">
          <div
            class="filter-tab active"
            data-filter="all"
            onclick="setFilter('all', this)"
          >
            All
          </div>
          <div
            class="filter-tab"
            data-filter="alerts"
            onclick="setFilter('alerts', this)"
          >
            ğŸ”´ With Alerts
          </div>
          <div
            class="filter-tab"
            data-filter="critical"
            onclick="setFilter('critical', this)"
          >
            Critical
          </div>
          <div
            class="filter-tab"
            data-filter="high"
            onclick="setFilter('high', this)"
          >
            High
          </div>
          <div
            class="filter-tab"
            data-filter="medium"
            onclick="setFilter('medium', this)"
          >
            Medium
          </div>
          <div
            class="filter-tab"
            data-filter="low"
            onclick="setFilter('low', this)"
          >
            Low
          </div>
          <div
            class="filter-tab"
            data-filter="errors"
            onclick="setFilter('errors', this)"
          >
            âš  Errors
          </div>
        </div>

        <!-- Rules Table -->
        <div class="table-container">
          <div class="table-header">
            <h2>Detection Rules</h2>
            <span class="badge" id="tableCount">0 rules</span>
          </div>
          <div style="overflow-x: auto">
            <table>
              <thead>
                <tr>
                  <th onclick="sortTable('name')"># Name â†•</th>
                  <th onclick="sortTable('severity')" style="width: 90px">
                    Severity â†•
                  </th>
                  <th onclick="sortTable('risk_score')" style="width: 70px">
                    Risk â†•
                  </th>
                  <th onclick="sortTable('hit_count')" style="width: 80px">
                    Alerts â†•
                  </th>
                  <th style="width: 90px">Status</th>
                  <th style="width: 200px">Tags</th>
                  <th style="width: 80px">Took</th>
                  <th style="width: 100px">Actions</th>
                </tr>
              </thead>
              <tbody id="rulesBody"></tbody>
            </table>
          </div>
        </div>
      </main>

      <footer class="footer">
        AD Rules Dashboard Â· Powered by Elasticsearch ES|QL Â·
        <span id="footerTime"></span>
      </footer>
    </div>

    <!-- â”€â”€ Detail Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div
      class="modal-overlay"
      id="modalOverlay"
      onclick="if (event.target === this) closeModal();"
    >
      <div class="modal">
        <div class="modal-header">
          <div>
            <h2 id="modalTitle">Rule Detail</h2>
            <div style="margin-top: 6px">
              <span class="severity-badge" id="modalSeverity"></span>
              <span
                style="
                  font-size: 0.8rem;
                  color: var(--text-muted);
                  margin-left: 8px;
                "
                id="modalRisk"
              ></span>
            </div>
          </div>
          <button class="modal-close" onclick="closeModal()">âœ•</button>
        </div>
        <div class="modal-body">
          <div class="modal-section">
            <h3>Description</h3>
            <div class="modal-desc" id="modalDesc"></div>
          </div>
          <div class="modal-section">
            <h3>Metadata</h3>
            <div class="meta-grid" id="modalMeta"></div>
          </div>
          <div class="modal-section">
            <h3>ES|QL Query</h3>
            <div class="query-block" id="modalQuery"></div>
          </div>
          <div class="modal-section">
            <h3>
              Execution Results
              <span
                id="modalHitCount"
                style="font-size: 0.8rem; margin-left: 8px"
              ></span>
            </h3>
            <div class="results-table-wrap" id="modalResults">
              <p style="padding: 16px; color: var(--text-muted)">
                Not executed yet. Click "Execute" to run this rule.
              </p>
            </div>
          </div>
          <div style="margin-top: 16px; display: flex; gap: 10px">
            <button
              class="btn btn-primary"
              id="modalExecuteBtn"
              onclick="executeFromModal()"
            >
              â–¶ Execute Rule
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      /* â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      let allRules = [];
      let ruleResults = {};
      let currentFilter = "all";
      let currentSort = { key: "name", asc: true };
      let currentModalRuleId = null;
      let isExecuting = false;

      /* â”€â”€ Tactic names â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      const TACTICS = {
        TA0001: "Initial Access",
        TA0002: "Execution",
        TA0003: "Persistence",
        TA0004: "Privilege Escalation",
        TA0005: "Defense Evasion",
        TA0006: "Credential Access",
        TA0007: "Discovery",
        TA0008: "Lateral Movement",
        TA0009: "Collection",
        TA0010: "Exfiltration",
        TA0011: "Command & Control",
        TA0040: "Impact",
        TA0042: "Resource Development",
        TA0043: "Reconnaissance",
      };

      /* â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      document.addEventListener("DOMContentLoaded", () => {
        checkStatus();
        loadRules();
        document.getElementById("footerTime").textContent =
          new Date().toLocaleString();
      });

      async function checkStatus() {
        try {
          const r = await fetch("/api/status");
          const d = await r.json();
          const dot = document.getElementById("statusDot");
          const txt = document.getElementById("statusText");
          if (d.connected) {
            dot.className = "status-dot connected";
            txt.textContent = `${d.cluster_name} v${d.version}`;
          } else {
            dot.className = "status-dot disconnected";
            txt.textContent = "Disconnected";
          }
        } catch (e) {
          document.getElementById("statusDot").className =
            "status-dot disconnected";
          document.getElementById("statusText").textContent = "Error";
        }
      }

      async function loadRules() {
        try {
          const r = await fetch("/api/rules");
          allRules = await r.json();
          document.getElementById("cardTotal").textContent = allRules.length;
          renderTable();
        } catch (e) {
          console.error("Failed to load rules:", e);
        }
      }

      /* â”€â”€ Execute All (SSE) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      function executeAll() {
        if (isExecuting) return;
        isExecuting = true;
        ruleResults = {};
        const btn = document.getElementById("btnExecuteAll");
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Executingâ€¦';

        const pc = document.getElementById("progressContainer");
        pc.classList.add("active");
        document.getElementById("progressFill").style.width = "0%";
        document.getElementById("progressCount").textContent =
          `0 / ${allRules.length}`;

        const timeRange = document.getElementById("timeRange").value;
        const es = new EventSource(
          "/api/execute_all?time_range=" + encodeURIComponent(timeRange),
        );
        es.onmessage = (evt) => {
          const data = JSON.parse(evt.data);
          if (data.done) {
            es.close();
            isExecuting = false;
            btn.disabled = false;
            btn.innerHTML = "â–¶ Execute All Rules";
            document.getElementById("progressLabel").textContent =
              "Execution complete!";
            document.getElementById("lastScan").textContent =
              "Last scan: " + new Date().toLocaleTimeString();
            if (data.results) {
              data.results.forEach((r) => {
                ruleResults[r.rule_id] = r;
              });
            }
            updateSummary(data.summary);
            renderTable();
            renderCharts();
            return;
          }
          const { progress, total, result, summary } = data;
          ruleResults[result.rule_id] = result;

          // Update progress
          const pct = Math.round((progress / total) * 100);
          document.getElementById("progressFill").style.width = pct + "%";
          document.getElementById("progressCount").textContent =
            `${progress} / ${total}`;
          document.getElementById("progressAlerts").textContent =
            summary.alerts;
          document.getElementById("progressErrors").textContent =
            summary.errors;
          document.getElementById("progressCurrent").textContent =
            result.rule_name.substring(0, 40);

          // Live update table row
          updateTableRow(result.rule_id);
        };
        es.onerror = () => {
          es.close();
          isExecuting = false;
          btn.disabled = false;
          btn.innerHTML = "â–¶ Execute All Rules";
          document.getElementById("progressLabel").textContent =
            "Execution interrupted";
        };
      }

      function updateSummary(s) {
        if (!s) return;
        document.getElementById("cardAlerts").textContent =
          s.alerts.toLocaleString();
        const critHigh =
          (s.by_severity.critical || 0) + (s.by_severity.high || 0);
        const medLow = (s.by_severity.medium || 0) + (s.by_severity.low || 0);
        document.getElementById("cardCritHigh").textContent =
          critHigh.toLocaleString();
        document.getElementById("cardMedLow").textContent =
          medLow.toLocaleString();
        const fired = Object.values(ruleResults).filter(
          (r) => r.hit_count > 0,
        ).length;
        document.getElementById("cardFired").textContent = fired;
        document.getElementById("cardErrors").textContent = s.errors;
      }

      /* â”€â”€ Table Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      function renderTable() {
        const tbody = document.getElementById("rulesBody");
        let rules = getFilteredRules();
        rules = sortRules(rules);

        document.getElementById("tableCount").textContent =
          rules.length + " rules";
        tbody.innerHTML = rules
          .map((rule, i) => {
            const res = ruleResults[rule.id];
            const hits = res ? res.hit_count : null;
            const hasAlerts = hits !== null && hits > 0;
            const status = !res ? "pending" : res.error ? "error" : "done";
            const statusLabel = !res
              ? "â³ Pending"
              : res.error
                ? "âš  Error"
                : "âœ“ Done";
            const took = res ? res.took_ms + "ms" : "â€”";
            const tags = (rule.tags || [])
              .slice(0, 3)
              .map((t) => `<span class="tag">${esc(t)}</span>`)
              .join("");

            return `<tr class="${hasAlerts ? "has-alerts" : ""}" onclick="openModal('${rule.id}')" style="cursor:pointer">
      <td><span style="color:var(--text-muted);margin-right:6px;font-size:.7rem">${i + 1}.</span> ${esc(rule.name)}</td>
      <td><span class="severity-badge severity-${rule.severity}">${rule.severity}</span></td>
      <td style="font-weight:700">${rule.risk_score}</td>
      <td><span class="alert-count ${hasAlerts ? "has" : "none"}">${hits !== null ? hits : "â€”"}</span></td>
      <td><span class="status-label ${status}">${statusLabel}</span></td>
      <td>${tags}</td>
      <td style="color:var(--text-muted);font-size:.78rem">${took}</td>
      <td><button class="btn btn-sm" onclick="event.stopPropagation();executeSingle('${rule.id}',this)">â–¶ Run</button></td>
    </tr>`;
          })
          .join("");
      }

      function updateTableRow(ruleId) {
        // Quick re-render of entire table (simple approach)
        renderTable();
      }

      function getFilteredRules() {
        const search = document.getElementById("searchBox").value.toLowerCase();
        return allRules.filter((r) => {
          if (search) {
            const haystack = (
              r.name +
              " " +
              r.severity +
              " " +
              (r.tags || []).join(" ")
            ).toLowerCase();
            if (!haystack.includes(search)) return false;
          }
          const res = ruleResults[r.id];
          switch (currentFilter) {
            case "alerts":
              return res && res.hit_count > 0;
            case "errors":
              return res && res.error;
            case "critical":
              return r.severity === "critical";
            case "high":
              return r.severity === "high";
            case "medium":
              return r.severity === "medium";
            case "low":
              return r.severity === "low";
            default:
              return true;
          }
        });
      }

      function sortRules(rules) {
        const k = currentSort.key;
        const dir = currentSort.asc ? 1 : -1;
        return [...rules].sort((a, b) => {
          let va = a[k],
            vb = b[k];
          if (k === "hit_count") {
            va = ruleResults[a.id] ? ruleResults[a.id].hit_count : -1;
            vb = ruleResults[b.id] ? ruleResults[b.id].hit_count : -1;
          }
          if (typeof va === "string") return va.localeCompare(vb) * dir;
          return ((va || 0) - (vb || 0)) * dir;
        });
      }

      function sortTable(key) {
        if (currentSort.key === key) currentSort.asc = !currentSort.asc;
        else {
          currentSort.key = key;
          currentSort.asc = true;
        }
        renderTable();
      }

      function setFilter(f, el) {
        currentFilter = f;
        document
          .querySelectorAll(".filter-tab")
          .forEach((t) => t.classList.remove("active"));
        el.classList.add("active");
        renderTable();
      }

      function filterRules() {
        renderTable();
      }

      /* â”€â”€ Single Execute â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      async function executeSingle(ruleId, btn) {
        if (btn) {
          btn.innerHTML = '<span class="spinner"></span>';
          btn.disabled = true;
        }
        try {
          const timeRange = document.getElementById("timeRange").value;
          const r = await fetch(
            `/api/execute/${ruleId}?time_range=${encodeURIComponent(timeRange)}`,
          );
          const data = await r.json();
          ruleResults[ruleId] = data;
          renderTable();
          // Update modal if open
          if (currentModalRuleId === ruleId) renderModalResults(data);
        } catch (e) {
          console.error(e);
        }
        if (btn) {
          btn.innerHTML = "â–¶ Run";
          btn.disabled = false;
        }
      }

      /* â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      function renderCharts() {
        document.getElementById("chartsSection").style.display = "grid";
        renderDonut();
        renderBars();
        renderMitre();
        renderCompliance();
      }

      function renderDonut() {
        const counts = { critical: 0, high: 0, medium: 0, low: 0 };
        Object.values(ruleResults).forEach((r) => {
          if (r.hit_count > 0) {
            const s = r.severity?.toLowerCase() || "medium";
            if (counts[s] !== undefined) counts[s] += r.hit_count;
          }
        });
        const total = Object.values(counts).reduce((a, b) => a + b, 0);
        if (total === 0) {
          document.getElementById("donutChart").innerHTML =
            '<p style="color:var(--text-muted);text-align:center;width:100%">No alerts to display</p>';
          return;
        }

        const colors = {
          critical: "var(--severity-critical)",
          high: "var(--severity-high)",
          medium: "var(--severity-medium)",
          low: "var(--severity-low)",
        };
        const r = 68,
          C = 2 * Math.PI * r;
        let offset = 0;
        let circles = "";
        let legend = "";
        for (const [sev, count] of Object.entries(counts)) {
          if (count === 0) continue;
          const pct = count / total;
          const dash = pct * C;
          circles += `<circle cx="80" cy="80" r="${r}" stroke="${colors[sev]}"
      stroke-dasharray="${dash} ${C - dash}" stroke-dashoffset="${-offset}"
      opacity="0.85"/>`;
          offset += dash;
          legend += `<div class="legend-item"><span class="legend-dot" style="background:${colors[sev]}"></span>
      ${sev.charAt(0).toUpperCase() + sev.slice(1)}: <b>${count}</b> (${Math.round(pct * 100)}%)</div>`;
        }
        document.getElementById("donutChart").innerHTML = `
    <div class="donut"><svg viewBox="0 0 160 160">${circles}</svg>
      <div class="donut-center"><div class="big">${total}</div><div class="small">Total Alerts</div></div>
    </div>
    <div class="legend">${legend}</div>`;
      }

      function renderBars() {
        const items = Object.values(ruleResults)
          .filter((r) => r.hit_count > 0)
          .sort((a, b) => b.hit_count - a.hit_count)
          .slice(0, 10);
        if (items.length === 0) {
          document.getElementById("barChart").innerHTML =
            '<p style="color:var(--text-muted)">No alerts to display</p>';
          return;
        }
        const max = items[0].hit_count;
        const colors = {
          critical: "linear-gradient(90deg,#f85149,#da3633)",
          high: "linear-gradient(90deg,#d29922,#bb8009)",
          medium: "linear-gradient(90deg,#58a6ff,#388bfd)",
          low: "linear-gradient(90deg,#3fb950,#2ea043)",
        };
        document.getElementById("barChart").innerHTML = items
          .map((item) => {
            const pct = Math.max((item.hit_count / max) * 100, 5);
            const bg = colors[item.severity] || colors.medium;
            return `<div class="bar-row">
      <div class="bar-label" title="${esc(item.rule_name)}">${esc(item.rule_name)}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${bg}">
        <span>${item.hit_count}</span></div></div>
    </div>`;
          })
          .join("");
      }

      function renderMitre() {
        const mitreMap = {};
        allRules.forEach((rule) => {
          const res = ruleResults[rule.id];
          const hasAlert = res && res.hit_count > 0;
          if (rule.mitre_attack) {
            for (const [tactic, techs] of Object.entries(rule.mitre_attack)) {
              for (const [tech, subs] of Object.entries(techs)) {
                const key = `${tactic}/${tech}`;
                if (!mitreMap[key])
                  mitreMap[key] = {
                    tactic,
                    tech,
                    subs: new Set(),
                    alert: false,
                  };
                (subs || []).forEach((s) => mitreMap[key].subs.add(s));
                if (hasAlert) mitreMap[key].alert = true;
              }
            }
          }
        });
        const grid = document.getElementById("mitreGrid");
        const entries = Object.values(mitreMap).sort((a, b) =>
          a.tactic.localeCompare(b.tactic),
        );
        if (entries.length === 0) {
          grid.innerHTML =
            '<p style="color:var(--text-muted)">No MITRE data</p>';
          return;
        }
        grid.innerHTML = entries
          .map((e) => {
            const subsStr =
              e.subs.size > 0 ? ` (${[...e.subs].join(", ")})` : "";
            return `<div class="mitre-cell ${e.alert ? "has-alert" : ""}">
      <span class="tactic">${TACTICS[e.tactic] || e.tactic}</span>
      <span class="tech">${e.tech}${subsStr}</span>
    </div>`;
          })
          .join("");
      }

      function renderCompliance() {
        const frameworks = {
          "NIST 800-53": { field: "nist", color: "var(--accent-blue)" },
          "PCI-DSS": { field: "pci_dss", color: "var(--accent-purple)" },
          GDPR: { field: "gdpr", color: "var(--accent-green)" },
        };
        const container = document.getElementById("complianceChart");
        let html = "";
        for (const [name, cfg] of Object.entries(frameworks)) {
          const controlMap = {};
          allRules.forEach((rule) => {
            const res = ruleResults[rule.id];
            const hasAlert = res && res.hit_count > 0;
            (rule[cfg.field] || []).forEach((c) => {
              if (!controlMap[c]) controlMap[c] = { count: 0, alert: false };
              controlMap[c].count++;
              if (hasAlert) controlMap[c].alert = true;
            });
          });
          const sorted = Object.entries(controlMap).sort(
            (a, b) => b[1].count - a[1].count,
          );
          html += `<div><h4 style="font-size:.8rem;font-weight:700;margin-bottom:8px;color:${cfg.color}">${name}</h4>
      <div class="compliance-tags">${sorted
        .map(
          ([ctrl, info]) =>
            `<span class="compliance-tag ${info.alert ? "alerted" : "active"}" title="${info.count} rules">${ctrl}</span>`,
        )
        .join("")}</div></div>`;
        }
        container.innerHTML = html;
      }

      /* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      function openModal(ruleId) {
        currentModalRuleId = ruleId;
        const rule = allRules.find((r) => r.id === ruleId);
        if (!rule) return;

        document.getElementById("modalTitle").textContent = rule.name;
        document.getElementById("modalSeverity").className =
          `severity-badge severity-${rule.severity}`;
        document.getElementById("modalSeverity").textContent = rule.severity;
        document.getElementById("modalRisk").textContent =
          `Risk Score: ${rule.risk_score}`;
        document.getElementById("modalDesc").textContent =
          rule.description || "No description";
        document.getElementById("modalQuery").textContent = rule.query;

        // Metadata
        const meta = document.getElementById("modalMeta");
        const items = [
          { label: "File", value: rule.file },
          { label: "Schedule", value: rule.schedule_interval },
          { label: "Index", value: (rule.index || []).join(", ") },
          { label: "Enabled", value: rule.enabled ? "Yes" : "No" },
        ];
        // Add MITRE
        if (rule.mitre_attack) {
          const mitreStr = Object.entries(rule.mitre_attack)
            .map(([t, techs]) =>
              Object.entries(techs)
                .map(
                  ([tech, subs]) =>
                    `${t}/${tech}${subs.length ? " (" + subs.join(",") + ")" : ""}`,
                )
                .join(", "),
            )
            .join("; ");
          items.push({ label: "MITRE ATT&CK", value: mitreStr || "â€”" });
        }
        if (rule.nist?.length)
          items.push({ label: "NIST", value: rule.nist.join(", ") });
        if (rule.pci_dss?.length)
          items.push({ label: "PCI-DSS", value: rule.pci_dss.join(", ") });
        if (rule.gdpr?.length)
          items.push({ label: "GDPR", value: rule.gdpr.join(", ") });

        meta.innerHTML = items
          .map(
            (i) => `<div class="meta-item">
    <div class="label">${i.label}</div><div class="value">${esc(String(i.value))}</div>
  </div>`,
          )
          .join("");

        // Results
        const res = ruleResults[ruleId];
        if (res) renderModalResults(res);
        else
          document.getElementById("modalResults").innerHTML =
            '<p style="padding:16px;color:var(--text-muted)">Not executed yet.</p>';
        document.getElementById("modalHitCount").textContent = res
          ? `(${res.hit_count} results)`
          : "";

        document.getElementById("modalOverlay").classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function renderModalResults(res) {
        const wrap = document.getElementById("modalResults");
        document.getElementById("modalHitCount").textContent =
          `(${res.hit_count} results, ${res.took_ms}ms)`;
        if (res.error) {
          wrap.innerHTML = `<div style="padding:16px;color:var(--severity-critical);background:rgba(248,81,73,.05);
      border-radius:var(--radius-sm);border:1px solid rgba(248,81,73,.2)">âš  ${esc(res.error)}</div>`;
          return;
        }
        if (!res.values || res.values.length === 0) {
          wrap.innerHTML =
            '<p style="padding:16px;color:var(--accent-green)">âœ“ No matching events â€” rule did not trigger.</p>';
          return;
        }
        let html = '<table class="results-table"><thead><tr>';
        res.columns.forEach((c) => {
          html += `<th>${esc(c)}</th>`;
        });
        html += "</tr></thead><tbody>";
        res.values.slice(0, 100).forEach((row) => {
          html += "<tr>";
          row.forEach((cell) => {
            let v = cell;
            if (v === null || v === undefined) v = "â€”";
            else if (Array.isArray(v)) v = v.join(", ");
            else if (typeof v === "object") v = JSON.stringify(v);
            html += `<td title="${esc(String(v))}">${esc(String(v))}</td>`;
          });
          html += "</tr>";
        });
        html += "</tbody></table>";
        if (res.values.length > 100)
          html += `<p style="padding:8px 12px;color:var(--text-muted);font-size:.75rem">Showing first 100 of ${res.values.length} results</p>`;
        wrap.innerHTML = html;
      }

      function closeModal() {
        document.getElementById("modalOverlay").classList.remove("active");
        document.body.style.overflow = "";
        currentModalRuleId = null;
      }

      function executeFromModal() {
        if (!currentModalRuleId) return;
        const btn = document.getElementById("modalExecuteBtn");
        btn.innerHTML = '<span class="spinner"></span> Executingâ€¦';
        btn.disabled = true;
        executeSingle(currentModalRuleId).then(() => {
          btn.innerHTML = "â–¶ Execute Rule";
          btn.disabled = false;
        });
      }

      /* â”€â”€ Util â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      function esc(s) {
        const d = document.createElement("div");
        d.textContent = s;
        return d.innerHTML;
      }

      /* â”€â”€ Keyboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
      });
    </script>
  </body>
</html>
