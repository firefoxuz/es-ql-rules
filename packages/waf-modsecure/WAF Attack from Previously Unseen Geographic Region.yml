rule_id: cd517394-d7dd-4dd0-b9a0-439b02a73e36
name: WAF Attack from Previously Unseen Geographic Region
description: |
  Odatda hujumlar kuzatilmagan yangi geografik mintaqadan (mamlakat yoki kontinent)
  WAF qoidalari ishga tushdi. Bu yangi hujum kampaniyasining boshlanishini yoki
  VPN/proxy orqali manzilni yashirishga urinayotgan hujumchini ko'rsatishi mumkin.
  SOC triage bosqichlari:
  - `source.geo.continent_name` va `source.geo.country_name` ni tashkilotning
    odatdagi foydalanuvchi bazasi bilan solishtiring.
  - `source.geo.timezone` asosida hujum vaqtining mahalliy ish vaqtiga to'g'ri
    kelmasligi (kechasi, bayram) ni tekshiring.
  - Ushbu mamlakatdan boshqa tizimlar (VPN gateway, email, auth) ga kirish
    urinishlari bor-yo'qligini korrelyatsiya qiling.
  - Geo-blocking policy mavjud bo'lsa, bu mintaqadan trafik WAF ga yetib kelmasligi kerak edi â€” policy tekshiring.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-nginx.waf*
query_language: esql
query: |
  FROM logs-nginx.waf*
  | WHERE @timestamp >= NOW() - 15 minutes
  | WHERE event.category == "intrusion_detection"
  | WHERE source.geo.continent_name IN ("Africa", "South America", "Oceania")
     OR source.geo.country_iso_code IN ("KP", "IR", "SY", "CU", "VE", "BY")
  | STATS
      attack_count       = COUNT(*),
      unique_sources     = COUNT_DISTINCT(source.ip),
      source_ips         = VALUES(source.ip),
      unique_rules       = COUNT_DISTINCT(rule.id),
      triggered_rules    = VALUES(rule.id),
      rule_descriptions  = VALUES(rule.description),
      targeted_domains   = VALUES(url.domain),
      timezones          = VALUES(source.geo.timezone),
      postal_codes       = VALUES(source.geo.postal_code),
      match_data         = VALUES(nginx.modsecurity.match_data),
      first_seen         = MIN(@timestamp),
      last_seen          = MAX(@timestamp)
    BY source.geo.country_name, source.geo.country_iso_code,
       source.geo.continent_name, source.geo.region_name,
       bucket = DATE_TRUNC(10 minutes, @timestamp)
  | WHERE attack_count >= 1
  | KEEP agent_id, bucket, source.geo.country_name, source.geo.country_iso_code,
        source.geo.continent_name, source.geo.region_name,
        attack_count, unique_sources, source_ips, unique_rules,
        triggered_rules, rule_descriptions, targeted_domains,
        timezones, postal_codes, match_data, first_seen, last_seen
  | SORT attack_count DESC
  | LIMIT 200
enabled: true
tags:
  - attack.initial-access
  - attack.t1190
  - attack.t1133
  - detection.medium
severity: medium
risk_score: 65
nist: ["SI-4", "AU-6", "AC-17"]
pci_dss: ["11.4", "8.3.9"]
gdpr: ["32.1.a"]
mitre_attack:
  TA0001:
    T1190: []
    T1133: []