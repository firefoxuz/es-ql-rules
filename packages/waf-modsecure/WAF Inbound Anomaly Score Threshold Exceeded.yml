rule_id: 396fe86a-fbac-444e-abd7-011252d25125
name: WAF Inbound Anomaly Score Threshold Exceeded
description: |
  OWASP CRS ning anomaly scoring mexanizmi (rule 949110) bir so'rov uchun
  belgilangan threshold (score >= 5) dan oshishini aniqladi.
  Bu bir so'rovda bir nechta attack signallarining birlashishi â€” ya'ni murakkab,
  ko'p qatlamli hujum urinishini ko'rsatishi mumkin.
  SOC triage bosqichlari:
  - `event.id` asosida tegishli barcha WAF eventlarini korrelyatsiya qiling.
  - `rule.description` va `nginx.modsecurity.match_data` maydonlarini o'rganib
    qaysi attack vektorlari ishtirok etganini aniqlab oling.
  - `source.ip` va `source.geo` asosida manbaning legitimligini baholang.
  - Agar bir xil IP bir nechta domenlarni nishonlayotgan bo'lsa, keng ko'lamli
    scan kampaniyasi haqida xulosa chiqaring.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - logs-nginx.waf*
query_language: esql
query: |
  FROM logs-nginx.waf*
  | WHERE @timestamp >= NOW() - 10 minutes
  | WHERE event.category == "intrusion_detection"
  | WHERE rule.id == "949110"
  | STATS
      block_count      = COUNT(*),
      unique_sources   = COUNT_DISTINCT(source.ip),
      source_ips       = VALUES(source.ip),
      unique_domains   = COUNT_DISTINCT(url.domain),
      domains          = VALUES(url.domain),
      countries        = VALUES(source.geo.country_name),
      continents       = VALUES(source.geo.continent_name),
      event_ids        = VALUES(event.id),
      reasons          = VALUES(event.reason),
      first_seen       = MIN(@timestamp),
      last_seen        = MAX(@timestamp)
    BY url.domain, bucket = DATE_TRUNC(5 minutes, @timestamp)
  | WHERE block_count >= 2
  | KEEP agent_id, bucket, url.domain, block_count, unique_sources, source_ips,
        unique_domains, domains, countries, continents, event_ids,
        reasons, first_seen, last_seen
  | SORT block_count DESC
  | LIMIT 200
enabled: true
tags:
  - attack.initial-access
  - attack.t1190
  - attack.defense-evasion
  - detection.high
severity: high
risk_score: 75
nist: ["SI-4", "SC-7", "AU-6"]
pci_dss: ["6.4.1", "11.4"]
gdpr: ["32.1.a"]
mitre_attack:
  TA0001:
    T1190: []