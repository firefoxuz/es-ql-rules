rule_id: 1c8f6545-77be-4d9c-8d08-7f24a470c6e6
#//RULE-NIST-24 â€” Web Application Attack Patterns (NIST SC-7, SI-4, AC-14)
#//Control Family: SC (System and Communications Protection), SI (System and Information Integrity)
#//Objective: Detect common web application attacks (SQLi, XSS, traversal)
#//Threat scenario: Attacker exploits web vulnerabilities for unauthorized access or data theft
#//Data sources: Nginx access logs via filebeat
#//ECS fields used: event.original, event.original, event.action, event.original, source.ip
#//Field validation: Verify all ECS fields exist in your indices before enabling
#//Tuning notes: Adjust pattern matching for application-specific parameters, allowlist scanners

name: "Web Application Attack Detection"
description: |
  Detects malicious payloads in HTTP requests indicating SQLi, XSS, command injection, or path traversal.
  URL parameters containing SQL keywords, script tags, shell commands, or directory traversal sequences flagged.
  Focus on POST/PUT requests with suspicious payloads or unusual user-agents.
  False positives: Legitimate application functionality, security scanners, penetration testing.
  Triage: Review full request details, check if source IP is known scanner,
  verify if application is vulnerable to detected attack type, block malicious sources.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - filebeat-nginx-access-*
query_language: esql
query: |
  FROM logs-nginx*
  | WHERE event.original IS NOT NULL
  | EVAL attack_pattern = CASE(
      event.original RLIKE "(?i).*(union.*select|insert.*into|update.*set|delete.*from|drop.*table|exec\\(|execute\\().*", "SQL-Injection",
      event.original RLIKE "(?i).*(\\<script|javascript:|onerror=|onload=|\\<iframe).*", "XSS-Attempt",
      /* Fixed the Path Traversal regex escaping below */
      event.original RLIKE "(?i).*(\\.\\.\\/|\\.\\.\\\\|etc\\/passwd|boot\\.ini|win\\.ini).*", "Path-Traversal",
      event.original RLIKE "(?i).*(;\\s*(ls|cat|whoami|wget|curl|bash|sh|cmd|powershell)).*", "Command-Injection",
      event.original RLIKE "(?i).*(admin|backup|config|phpinfo|shell|webshell|upload).*", "Admin-Panel-Probe",
      "Unknown"
    )
  | WHERE attack_pattern != "Unknown"
  | EVAL suspicious_user_agent = CASE(
      /* Standardizing regex for scanners */
      event.original RLIKE "(?i).*(sqlmap|nikto|nmap|metasploit|burp|acunetix|nessus|openvas).*", true,
      event.original == "-" OR event.original IS NULL, true,
      false
    )
  | STATS 
      attack_count = COUNT(*),
      unique_payloads = COUNT_DISTINCT(event.original),
      attack_paths = VALUES(event.original),
      scanner_detected = SUM(CASE(suspicious_user_agent == true, 1, 0))
    BY source.ip, attack_pattern, bucket = DATE_TRUNC(15 minutes, @timestamp)
  | WHERE attack_count >= 3
  | EVAL risk_score = attack_count * 15 + scanner_detected * 20
  | WHERE risk_score >= 45
  | KEEP agent_id, bucket, source.ip, attack_pattern, attack_count, unique_payloads, attack_paths, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - nist_800_53
  - control_SC-7
  - control_SI-4
  - control_AC-14
  - family_SC
  - family_SI
  - family_AC
  - initial_access
  - web_application
  - exploitation
severity: high
risk_score: 81
references:
  - "NIST SP 800-53 Rev.5 SC-7: Boundary Protection"
  - "OWASP Top 10"
  - "MITRE ATT&CK T1190: Exploit Public-Facing Application"
nist: ["SC-7", "SI-4", "AC-14"]
pci_dss: "6.5"
mitre_attack:
  TA0001:
    T1190: []