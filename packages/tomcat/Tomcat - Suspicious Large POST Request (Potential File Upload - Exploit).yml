rule_id: a4f6c6a2-3165-4fcf-a9dc-7fbda7e2152e
name: Tomcat - Suspicious Large POST Request (Potential File Upload / Exploit)
description: |
  Ushbu qoida g'ayrioddiy katta hajmdagi POST so'rovlarini aniqlaydi.
  Bu webshell upload, exploit payload yoki data exfiltration belgisi 
  bo'lishi mumkin (T1505.003, T1190).
  Qonuniy holatlar: fayl upload funksiyasi, API'ga katta JSON/XML yuborish.
  SOC triage bosqichlari:
  - Target endpoint'ni tekshiring (/upload, /api, /admin?)
  - Content-Type header'ini tekshiring (multipart/form-data?)
  - Manba IP'ni tekshiring
  - Serverda yangi fayllar paydo bo'lganligini tekshiring
  - Response code'ni tekshiring (200 = muhim!)
type: esql
params: '{}'
schedule_interval: 10m
index:
  - filebeat-tomcat-*
query_language: esql
query: |
  FROM filebeat-tomcat-*
  | WHERE @timestamp >= NOW() - 30 minutes
  | WHERE data_stream.dataset == "tomcat.access"
  | WHERE rsa.web.p_web_method == "POST"
  | WHERE rsa.network.packet_length > 10485760
  | STATS
      event_count = COUNT(*),
      target_urls = VALUES(rsa.web.urlpage),
      content_types = VALUES(rsa.misc.content_type),
      response_codes = VALUES(rsa.misc.result_code),
      max_size = MAX(rsa.network.packet_length),
      avg_size = AVG(rsa.network.packet_length)
    BY source.ip, bucket = DATE_TRUNC(10 minutes, @timestamp)
  | WHERE event_count >= 3
  | KEEP agent_id, bucket, source.ip, event_count, target_urls, content_types, response_codes, max_size, avg_size
  | SORT max_size DESC
  | LIMIT 50
enabled: true
tags:
  - attack.persistence
  - attack.t1505.003
  - attack.initial-access
  - attack.t1190
  - tomcat
  - webshell
  - file-upload
severity: high
risk_score: 80
references:
  - "https://attack.mitre.org/techniques/T1505/003/"
  - "https://attack.mitre.org/techniques/T1190/"
nist: ["SI-3", "CM-7"]
pci_dss: ["6.5.1", "6.5.8"]
gdpr: ["32.1"]
mitre_attack:
  TA0003:
    T1505: ["T1505.003"]