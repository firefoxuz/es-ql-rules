rule_id: 377b237f-2caf-4901-9f46-cf3838b3db44
name: AD Explicit Credential Logon Attempt (4648)
description: |
  Ushbu qoida credential access va lateral movement texnikalariga mos bo'lib, explicit credential bilan ishga tushirilgan jarayonlarni aniqlaydi.
  Hujumchi o'g'irlangan parol/hashlardan foydalanib RunAs yoki boshqa mexanizm orqali boshqa akkaunt nomidan autentikatsiya qilishi mumkin, bu AD bo'ylab tez harakatlanishga olib keladi.
  Qonuniy holatlar: admin runas ishlatishi, avtomatlashtirish skriptlari, servis integratsiyasi uchun credential delegation.
  SOC triage bosqichlari:
  - `actor`, `target_user` va jarayon kontekstini aniqlang.
  - Ushbu kirish usuli ruxsat etilgan operational jarayon ekanini ticket orqali tekshiring.
  - `src_ip` va host manbasini, ayniqsa noodatiy endpointlarni tekshiring.
  - Target akkauntning guruh a'zoligi va imtiyozlarini ko'rib chiqing.
  - Tasdiqlanmasa credentiallarni rotatsiya qiling, sessiyalarni yoping va komprometatsiya indikatorlarini chuqur qidiring.
type: esql
params: '{}'
schedule_interval: 10m
index:
- logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | WHERE @timestamp >= NOW() - 15 minutes
  | WHERE winlog.channel == "Security"
  | EVAL hostn = winlog.computer_name
  | EVAL actor = COALESCE(winlog.event_data.SubjectUserName, winlog.event_data.SubjectUserName)
  | EVAL target_user = COALESCE(winlog.event_data.TargetUserName, winlog.event_data.SamAccountName)
  | EVAL src_ip = COALESCE(winlog.event_data.IpAddress, winlog.event_data.IpAddress)
  | EVAL proc = COALESCE(winlog.event_data.ProcessName, winlog.event_data.ProcessName, "")
  | WHERE hostn RLIKE "(?i)(WINDC|ADDC|-DC|DOMAINCONTROLLER)"
  | WHERE event.code == "4648"
  | WHERE actor IS NOT NULL
  | WHERE NOT actor RLIKE ".*\\$$"
  | STATS event_count = COUNT(*) BY hostn, actor, target_user, src_ip, proc
  | WHERE event_count >= 2
  | EVAL dyn_risk = CASE(target_user RLIKE "(?i)^(Administrator|krbtgt|svc_.*|backup_.*|sqlsvc.*)$", 92, event_count >= 5, 88, 81)
  | KEEP agent_id, hostn, actor, target_user, src_ip, proc, event_count, dyn_risk
  | SORT dyn_risk DESC, event_count DESC
  | LIMIT 200
enabled: false
tags:
  - AD
  - Authentication
  - Credential Access
severity: high
risk_score: 81
references:
  - "https://attack.mitre.org/techniques/T1550/"
mitre_attack:
  TA0008:
    T1550: [T1550.002]
nist: ["AU-2", "AU-12", "AC-7", "IA-2"]
pci_dss: ["10.2.4", "10.2.5", "8.1.6"]
gdpr: ["32.1.a", "32.2"]
