rule_id: 5f735244-4d3b-415c-bc28-410a7566fafc
name: AD Service Installed on Domain Controller (7045)
description: |
  Ushbu qoida persistence va lateral movement texnikalariga bog'liq bo'lib, DC'da yangi servis o'rnatilishini aniqlaydi.
  Yangi servis o'rnatish hujumchiga doimiy ishga tushish nuqtasi beradi va ko'pincha masofadan buyruq bajarish yoki payloadni yashirish uchun ishlatiladi.
  Qonuniy holatlar: rasmiy agent o'rnatilishi (backup/EDR/monitoring), patch management yoki servis modernizatsiyasi.
  SOC triage bosqichlari:
  - Servisni o'rnatgan `actor`, servis nomi va `hostn` ni aniqlang.
  - O'rnatish uchun change ticket/deployment task mavjudligini tekshiring.
  - `src_ip` manbasi va o'rnatish boshlangan hostni tekshirib, noodatiy manbalarni ajrating.
  - Servis bilan bog'liq akkauntning guruh a'zoligi va huquqlarini tekshiring.
  - Noqonuniy holatda servisni to'xtating/o'chiring, aktorni cheklang va DC'da persistence artefaktlarini tozalang.
type: esql
params: '{}'
schedule_interval: 10m
index:
- logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | WHERE @timestamp >= NOW() - 15 minutes
  | WHERE winlog.channel == "Security"
  | EVAL hostn = winlog.computer_name
  | EVAL actor = COALESCE(winlog.event_data.SubjectUserName, winlog.event_data.SubjectUserName, winlog.event_data.AccountName)
  | EVAL target_user = COALESCE(winlog.event_data.ServiceName, winlog.event_data.TargetUserName, winlog.event_data.SamAccountName)
  | EVAL src_ip = COALESCE(winlog.event_data.IpAddress, winlog.event_data.IpAddress)
  | EVAL service_path = COALESCE(winlog.event_data.ImagePath, "")
  | WHERE hostn RLIKE "(?i)(WINDC|ADDC|-DC|DOMAINCONTROLLER)"
  | WHERE event.code == "7045"
  | WHERE actor IS NOT NULL
  | WHERE NOT actor RLIKE ".*\\$$"
  | STATS install_count = COUNT(*) BY hostn, actor, target_user, src_ip, service_path
  | WHERE install_count >= 1
  | EVAL dyn_risk = CASE(service_path RLIKE "(?i)(temp|appdata|users\\\\public|powershell|cmd\\.exe)", 93, install_count >= 2, 88, 84)
  | KEEP agent_id, hostn, actor, target_user, src_ip, service_path, install_count, dyn_risk
  | SORT dyn_risk DESC, install_count DESC
  | LIMIT 200
enabled: false
tags:
  - AD
  - Persistence
  - Service Creation
severity: high
risk_score: 84
references:
  - "https://attack.mitre.org/techniques/T1543/003/"
mitre_attack:
  TA0003:
    T1543: [T1543.003]
nist: ["SI-4", "AU-12", "CM-7"]
pci_dss: ["10.2.7", "11.4"]
gdpr: ["32.1.a"]
