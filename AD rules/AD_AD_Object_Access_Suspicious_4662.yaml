rule_id: 03caa539-48c9-45c1-bf51-9a4ae8e68e9d
name: AD Suspicious Directory Object Access (4662)
description: |
  Ushbu qoida credential access va privilege escalation xavfini ifodalovchi AD obyektlariga shubhali kirishlarni aniqlaydi.
  4662 orqali ACL, maxfiy atributlar yoki kritik obyektlarga kirish kuzatiladi; bu hujumchining AD recon yoki huquq oshirish bosqichida ekanini ko'rsatishi mumkin.
  Qonuniy holatlar: backup agentlar, identity sync platformalari, audit skanerlari va ruxsatli admin skriptlari.
  SOC triage bosqichlari:
  - `actor`, kirilgan obyekt (`target_user`) va access turi (`props`) ni aniqlang.
  - Tegishli operatsiya uchun change ticket/deployment ruxsatini tekshiring.
  - `src_ip` manbasi hamda shu hostning avvalgi AD access profilini tekshiring.
  - Akkauntning guruh a'zoligi va ortiqcha imtiyozlari mavjudligini baholang.
  - Shubhali holatda akkaunt huquqlarini cheklang, tokenlarni bekor qiling va obyektlarga kirishni vaqtincha himoyalang.
type: esql
params: '{}'
schedule_interval: 10m
index:
- logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | WHERE @timestamp >= NOW() - 15 minutes
  | WHERE winlog.channel == "Security"
  | EVAL hostn = winlog.computer_name
  | EVAL actor = COALESCE(winlog.event_data.SubjectUserName, winlog.event_data.SubjectUserName)
  | EVAL target_user = COALESCE(winlog.event_data.ObjectName, winlog.event_data.TargetUserName)
  | EVAL src_ip = COALESCE(winlog.event_data.IpAddress, winlog.event_data.IpAddress)
  | EVAL props = COALESCE(winlog.event_data.Operation, "")
  | EVAL access_mask = COALESCE(winlog.event_data.Operation, "")
  | WHERE hostn RLIKE "(?i)(WINDC|ADDC|-DC|DOMAINCONTROLLER)"
  | WHERE event.code == "4662"
  | WHERE actor IS NOT NULL
  | WHERE NOT actor RLIKE ".*\\$$"
  | WHERE props RLIKE "(?i)(WriteDacl|WriteOwner|Control Access|Reset Password|msDS-KeyCredentialLink)" OR access_mask IN ("0x100", "0x200", "0x40000")
  | WHERE NOT props RLIKE "(?i)(Replicating Directory Changes)"
  | STATS access_count = COUNT(*), unique_objects = COUNT_DISTINCT(target_user) BY hostn, actor, src_ip, props, access_mask
  | WHERE access_count >= 3 OR unique_objects >= 2
  | EVAL dyn_risk = CASE(access_count >= 20 OR unique_objects >= 8, 92, access_count >= 10, 87, 83)
  | KEEP agent_id, hostn, actor, src_ip, props, access_mask, access_count, unique_objects, dyn_risk
  | SORT dyn_risk DESC, access_count DESC
  | LIMIT 200
enabled: false
tags:
  - AD
  - Directory Changes
  - Credential Access
severity: high
risk_score: 83
references:
  - "https://attack.mitre.org/techniques/T1222/"
mitre_attack:
  TA0005:
    T1222: [T"1222.001"]
nist: ["AC-6", "AU-12", "AC-2"]
pci_dss: ["7.1", "7.2", "10.2.2"]
gdpr: ["32.1.a", "32.1.b"]
