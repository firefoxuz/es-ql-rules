rule_id: b06c75fd-2ccd-4915-83e5-7bd70b2ba3c2
name: AD Kerberos Ticket Anomaly on Domain Controller (4768/4769)
description: |
  Ushbu qoida credential access va lateral movement bilan bog'liq bo'lib, Kerberos TGT/TGS jarayonidagi noodatiy xatti-harakatlarni aniqlaydi.
  Juda ko'p ticket so'rovi yoki zaif shifrlash (masalan RC4) Golden/Silver ticket, Kerberoasting yoki service abuse holatlarini ko'rsatishi mumkin.
  Qonuniy holatlar: legacy tizimlar, yirik servis restarti, patchdan keyingi qayta autentikatsiya to'lqini.
  SOC triage bosqichlari:
  - `actor`, `target_user`, event turi va ticket parametrlarini aniqlang.
  - Change ticket asosida rejalashtirilgan servis o'zgarishi borligini tekshiring.
  - `src_ip` manbasi va KDC so'rovlarining tarqalishini tekshiring.
  - Nishon akkaunt/service principal guruh a'zoligi hamda imtiyozlarini tekshiring.
  - Shubhali bo'lsa tegishli xizmat credentiallarini rotatsiya qiling, hujum manbasini bloklang va Kerberos auditini chuqurlashtiring.
type: esql
params: '{}'
schedule_interval: 10m
index:
- logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | WHERE @timestamp >= NOW() - 15 minutes
  | WHERE winlog.channel == "Security"
  | EVAL hostn = winlog.computer_name
  | EVAL actor = COALESCE(winlog.event_data.SubjectUserName, winlog.event_data.TargetUserName, winlog.event_data.SubjectUserName)
  | EVAL target_user = COALESCE(winlog.event_data.TargetUserName, winlog.event_data.ServiceName, winlog.event_data.SamAccountName)
  | EVAL src_ip = COALESCE(winlog.event_data.IpAddress, winlog.event_data.IpAddress, winlog.event_data.ClientAddress)
  | EVAL enc_type = COALESCE(winlog.event_data.TicketEncryptionType, "")
  | EVAL svc = COALESCE(winlog.event_data.ServiceName, "")
  | WHERE hostn RLIKE "(?i)(WINDC|ADDC|-DC|DOMAINCONTROLLER)"
  | WHERE event.code IN ("4768", "4769")
  | WHERE actor IS NOT NULL
  | WHERE NOT actor RLIKE ".*\\$$"
  | STATS ticket_count = COUNT(*), unique_services = COUNT_DISTINCT(svc) BY hostn, src_ip, actor, enc_type, event.code
  | WHERE ticket_count >= 20 OR unique_services >= 8 OR enc_type IN ("0x17", "0x18")
  | EVAL dyn_risk = CASE(enc_type == "0x17", 92, ticket_count >= 80 OR unique_services >= 20, 90, 84)
  | KEEP agent_id, hostn, src_ip, actor, enc_type, event.code, ticket_count, unique_services, dyn_risk
  | SORT dyn_risk DESC, ticket_count DESC
  | LIMIT 200
enabled: false
tags:
  - AD
  - Authentication
  - Kerberos
severity: high
risk_score: 84
references:
  - "https://attack.mitre.org/techniques/T1558/"
mitre_attack:
  TA0006:
    T1558: [T1558.003]
nist: ["AU-2", "AU-12", "AC-7", "IA-2"]
pci_dss: ["10.2.4", "10.2.5", "8.1.6"]
gdpr: ["32.1.a", "32.2"]
