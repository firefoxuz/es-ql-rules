rule_id: 03a068c6-f314-487c-b8ef-1341732d35e1
name: AD Suspicious Successful Logon to Domain Controller (4624)
description: |
  Ushbu qoida lateral movement va privilege escalation holatlarini aniqlash uchun DC'ga muvaffaqiyatli logonlarni tahlil qiladi.
  Noodatiy IP yoki kam uchraydigan akkaunt orqali DC'ga muvaffaqiyatli kirish hujumchining boshlang'ich foothold'dan Tier-0 muhitiga o'tganini ko'rsatishi mumkin.
  Qonuniy holatlar: adminlar tomonidan masofaviy boshqaruv, patch/deployment oynasi, zaxira yoki monitoring xizmatlari.
  SOC triage bosqichlari:
  - `actor`, `target_user`, logon turi va `hostn` ni aniqlang.
  - Kirish rejalashtirilgan ishga mos keladimi, change ticket orqali tasdiqlang.
  - `src_ip` manzili odatiy admin segmentidan ekanini va oldingi faoliyatini tekshiring.
  - Akkauntning imtiyozli guruh a'zoligini tekshirib, ortiqcha huquq bor-yo'qligini baholang.
  - Shubhali bo'lsa sessiyani uzing, akkaunt credentialini yangilang va kirish manbasini izolyatsiya qiling.
type: esql
params: '{}'
schedule_interval: 10m
index:
- logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | WHERE @timestamp >= NOW() - 15 minutes
  | WHERE winlog.channel == "Security"
  | EVAL hostn = winlog.computer_name
  | EVAL actor = COALESCE(winlog.event_data.SubjectUserName, winlog.event_data.TargetUserName, winlog.event_data.SubjectUserName)
  | EVAL target_user = COALESCE(winlog.event_data.TargetUserName, winlog.event_data.SamAccountName)
  | EVAL src_ip = COALESCE(winlog.event_data.IpAddress, winlog.event_data.IpAddress)
  | EVAL logon_type = COALESCE(winlog.event_data.LogonType, "")
  | EVAL auth_pkg = COALESCE(winlog.event_data.AuthenticationPackageName, "")
  | WHERE hostn RLIKE "(?i)(WINDC|ADDC|-DC|DOMAINCONTROLLER)"
  | WHERE event.code == "4624"
  | WHERE actor IS NOT NULL
  | WHERE NOT actor RLIKE ".*\\$$"
  | WHERE logon_type IN ("3", "10")
  | WHERE src_ip IS NOT NULL AND src_ip NOT IN ("-", "::1", "127.0.0.1")
  | STATS success_count = COUNT(*) BY hostn, actor, target_user, src_ip, logon_type, auth_pkg
  | WHERE success_count >= 3
  | EVAL dyn_risk = CASE(logon_type == "10", 92, success_count >= 10, 88, 82)
  | KEEP agent_id, hostn, actor, target_user, src_ip, logon_type, auth_pkg, success_count, dyn_risk
  | SORT dyn_risk DESC, success_count DESC
  | LIMIT 200
enabled: false
tags:
  - AD
  - Authentication
  - Lateral Movement
severity: high
risk_score: 82
references:
  - "https://attack.mitre.org/techniques/T1021/"
mitre_attack:
  TA0008:
    T1021: ["T1021.001"]
nist: ["AC-6", "AU-12", "AC-2"]
pci_dss: ["7.1", "7.2", "10.2.2"]
gdpr: ["32.1.a", "32.1.b"]
