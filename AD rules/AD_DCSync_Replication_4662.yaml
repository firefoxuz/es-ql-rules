rule_id: fbf4e673-61ef-47f4-948c-cb7215bd3434
name: AD DCSync Replication Rights Abuse Detection (4662)
description: |
  Ushbu qoida credential access va privilege escalation uchun eng kritik indikatorlardan biri bo'lgan DCSync faoliyatini aniqlaydi.
  `Replicating Directory Changes` huquqlari bilan 4662 hodisalari hujumchiga NTDS credentiallarni masofadan olish imkonini beradi va bu to'liq domen komprometatsiyasiga olib kelishi mumkin.
  Qonuniy holatlar: Azure AD Connect, ruxsatli identity sync xizmatlari yoki maxsus backup/recovery yechimlari.
  SOC triage bosqichlari:
  - `actor`, ta'sirlangan obyekt va huquq turi (`props`) ni aniq aniqlang.
  - Ushbu replication access uchun change ticket yoki xizmat ro'yxatida ruxsat borligini tasdiqlang.
  - `src_ip` manzili haqiqiy sync serverga tegishlimi, tekshiring.
  - Akkauntning imtiyozli guruh a'zoligi va delegatsiya huquqlarini tekshiring.
  - Tasdiqlanmagan bo'lsa darhol akkauntni bloklang, krbtgt rotatsiya rejasini tayyorlang va Tier-0 containmentni boshlang.
type: esql
params: '{}'
schedule_interval: 10m
index:
- logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | WHERE @timestamp >= NOW() - 15 minutes
  | WHERE winlog.channel == "Security"
  | EVAL hostn = winlog.computer_name
  | EVAL actor = COALESCE(winlog.event_data.SubjectUserName, winlog.event_data.SubjectUserName)
  | EVAL target_user = COALESCE(winlog.event_data.ObjectName, winlog.event_data.TargetUserName)
  | EVAL src_ip = COALESCE(winlog.event_data.IpAddress, winlog.event_data.IpAddress)
  | EVAL props = COALESCE(winlog.event_data.Operation, "")
  | WHERE hostn RLIKE "(?i)(WINDC|ADDC|-DC|DOMAINCONTROLLER)"
  | WHERE event.code == "4662"
  | WHERE actor IS NOT NULL
  | WHERE NOT actor RLIKE ".*\\$$"
  | WHERE props RLIKE "(?i)(Replicating Directory Changes|Replicating Directory Changes All|Replicating Directory Changes In Filtered Set)"
  | STATS dcsync_count = COUNT(*), unique_objects = COUNT_DISTINCT(target_user) BY hostn, actor, src_ip, props
  | WHERE dcsync_count >= 1
  | EVAL dyn_risk = CASE(dcsync_count >= 3, 99, unique_objects >= 2, 97, 95)
  | KEEP agent_id, hostn, actor, src_ip, props, dcsync_count, unique_objects, dyn_risk
  | SORT dyn_risk DESC, dcsync_count DESC
  | LIMIT 200
enabled: false
tags:
  - AD
  - Directory Changes
  - DCSync
severity: high
risk_score: 95
references:
  - "https://attack.mitre.org/techniques/T1003/006/"
mitre_attack:
  TA0006:
    T1003: [T1003.006]
nist: ["AC-6", "AU-12", "AC-2"]
pci_dss: ["7.1", "7.2", "10.2.2"]
gdpr: ["32.1.a", "32.1.b"]
