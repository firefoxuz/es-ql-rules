rule_id: 3720c33a-3549-4539-93f1-8123aafb9230
name: AD Password Spray Against Domain Controller (4625)
description: |
  Ushbu qoida credential access texnikasiga tegishli bo'lib, bitta manbadan ko'p akkauntga muvaffaqiyatsiz kirish urinishlarini aniqlaydi.
  Password spray AD uchun xavfli, chunki past shovqinli usul bilan ko'plab akkauntlardan birini egallab olish va keyin lateral movement boshlash mumkin.
  Qonuniy holatlar: noto'g'ri konfiguratsiyalangan ilova, eski credential bilan ishlayotgan servis, ommaviy parol yangilashdan keyingi sinxronizatsiya muammosi.
  SOC triage bosqichlari:
  - Hujumchi sifatida ko'rinayotgan manbani (`src_ip`) va urinishlar aktorini aniqlang.
  - Change ticket yoki rejalashtirilgan authentication testi mavjudligini tekshiring.
  - `src_ip` reputatsiyasi, geolokatsiyasi va tarmoq segmentini tekshiring.
  - Nishonga olingan akkauntlarning guruh a'zoligi, ayniqsa privileged hisoblarni tekshiring.
  - Tasdiqlansa manba IP ni bloklash, ta'sirlangan akkauntlarni reset qilish va qo'shimcha MFA/conditional policy ni kuchaytirish choralarini ko'ring.
type: esql
params: '{}'
schedule_interval: 10m
index:
- logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | WHERE @timestamp >= NOW() - 15 minutes
  | WHERE winlog.channel == "Security"
  | EVAL hostn = winlog.computer_name
  | EVAL actor = COALESCE(winlog.event_data.SubjectUserName, winlog.event_data.SubjectUserName, winlog.event_data.TargetUserName)
  | EVAL target_user = COALESCE(winlog.event_data.TargetUserName, winlog.event_data.SamAccountName)
  | EVAL src_ip = COALESCE(winlog.event_data.IpAddress, winlog.event_data.IpAddress)
  | EVAL logon_type = COALESCE(winlog.event_data.LogonType, "")
  | WHERE hostn RLIKE "(?i)(WINDC|ADDC|-DC|DOMAINCONTROLLER)"
  | WHERE event.code == "4625"
  | WHERE src_ip IS NOT NULL
  | WHERE src_ip NOT IN ("-", "::1", "127.0.0.1")
  | STATS fail_count = COUNT(*), distinct_users = COUNT_DISTINCT(target_user) BY src_ip, hostn, logon_type
  | WHERE fail_count >= 20 AND distinct_users >= 8
  | EVAL dyn_risk = CASE(fail_count >= 100 OR distinct_users >= 30, 95, fail_count >= 50 OR distinct_users >= 15, 90, 85)
  | KEEP agent_id, src_ip, hostn, logon_type, fail_count, distinct_users, dyn_risk
  | SORT dyn_risk DESC, fail_count DESC, distinct_users DESC
  | LIMIT 200
enabled: false
tags:
  - AD
  - Authentication
  - Credential Access
severity: high
risk_score: 85
references:
  - "https://attack.mitre.org/techniques/T1110/003/"
mitre_attack:
  TA0006:
    T1110: [T1110.003]
nist: ["AC-6", "AU-12", "AC-2"]
pci_dss: ["7.1", "7.2", "10.2.2"]
gdpr: ["32.1.a", "32.1.b"]
