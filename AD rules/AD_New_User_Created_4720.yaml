rule_id: a4af85c3-f5f2-440f-8d14-5942fa9494da
name: AD New User Created on Domain Controller (4720)
description: |
  Ushbu qoida persistence va privilege escalation texnikalariga bog'liq bo'lib, AD muhitida yangi foydalanuvchi yaratilishini aniqlaydi.
  Domain Controller'da yangi akkaunt ochilishi hujumchi uchun uzoq muddatli kirish nuqtasi yaratishi, keyinchalik guruh a'zoliklari orqali yuqori huquqlarga chiqishi mumkinligi sababli xavfli hisoblanadi.
  Qonuniy holatlarda HR onboarding, avtomatlashtirilgan IAM provisioning yoki migratsiya jarayonlari sabab bo'lishi mumkin.
  SOC triage bosqichlari:
  - Aktor va target obyektni aniqlang (`actor`, `target_user`, `hostn`).
  - O'zgarish uchun change ticket yoki rasmiy deployment mavjudligini tasdiqlang.
  - Hodisa manbasi bo'lgan `src_ip` va unga tegishli hostni tekshiring.
  - Yaratilgan akkauntning guruh a'zoligini, ayniqsa imtiyozli guruhlarni tekshiring.
  - Tasdiqlanmagan bo'lsa akkauntni vaqtincha bloklang, sessiyalarni bekor qiling va DC bo'yicha containment choralarini boshlang.
type: esql
params: '{}'
schedule_interval: 10m
index:
- logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | WHERE @timestamp >= NOW() - 15 minutes
  | WHERE winlog.channel == "Security"
  | EVAL hostn = winlog.computer_name
  | EVAL actor = COALESCE(winlog.event_data.SubjectUserName, winlog.event_data.SubjectUserName)
  | EVAL target_user = COALESCE(winlog.event_data.TargetUserName, winlog.event_data.SamAccountName)
  | EVAL src_ip = COALESCE(winlog.event_data.IpAddress, winlog.event_data.IpAddress)
  | WHERE hostn RLIKE "(?i)(WINDC|ADDC|-DC|DOMAINCONTROLLER)"
  | WHERE event.code == "4720"
  | WHERE actor IS NOT NULL
  | WHERE NOT actor RLIKE ".*\\$$"
  | STATS event_count = COUNT(*), unique_targets = COUNT_DISTINCT(target_user) BY hostn, actor, src_ip
  | WHERE event_count >= 1
  | EVAL dyn_risk = CASE(event_count >= 5, 90, event_count >= 2, 82, 75)
  | KEEP agent_id, hostn, actor, src_ip, event_count, unique_targets, dyn_risk
  | SORT event_count DESC, unique_targets DESC
  | LIMIT 200
enabled: false
tags:
  - AD
  - Account Lifecycle
  - Persistence
severity: high
risk_score: 75
references:
  - "https://attack.mitre.org/techniques/T1136/002/"
mitre_attack:
  TA0003:
    T1136: [T1136.002]
nist: ["AC-6", "AU-12", "AC-2"]
pci_dss: ["7.1", "7.2", "10.2.2"]
gdpr: ["32.1.a", "32.1.b"]
