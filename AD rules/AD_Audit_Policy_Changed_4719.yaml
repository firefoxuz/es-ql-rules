rule_id: 8e271369-53f4-494e-912d-43350c044280
name: AD Audit Policy Changed on Domain Controller (4719)
description: |
  Ushbu qoida defense evasion va persistence texnikalariga mos bo'lib, audit policy o'zgarishlarini aniqlaydi.
  Audit siyosatini o'zgartirish hujumchiga log yozuvlarini kamaytirish yoki yashirish imkonini beradi, natijada AD ichidagi zararli faoliyat kech aniqlanadi.
  Qonuniy holatlar: GPO hardening, compliance sozlamalari, audit optimizatsiyasi bo'yicha rejalashtirilgan ishlar.
  SOC triage bosqichlari:
  - O'zgarishni bajargan `actor` va ta'sirlangan DC (`hostn`) ni aniqlang.
  - Change ticket/deployment hujjati bilan policy o'zgarishini tasdiqlang.
  - `src_ip` manbasi va boshqaruv kanalining legitimligini tekshiring.
  - O'zgarishdan keyingi imtiyozli guruhlar monitoringi pasaymaganini tekshiring.
  - Noqonuniy bo'lsa policy'ni oldingi holatga qaytaring, aktorni cheklang va qo'shimcha audit collectionni yoqing.
type: esql
params: '{}'
schedule_interval: 10m
index:
- logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | WHERE @timestamp >= NOW() - 15 minutes
  | WHERE winlog.channel == "Security"
  | EVAL hostn = winlog.computer_name
  | EVAL actor = COALESCE(winlog.event_data.SubjectUserName, winlog.event_data.SubjectUserName)
  | EVAL target_user = COALESCE(winlog.event_data.TargetUserName, winlog.event_data.SamAccountName)
  | EVAL src_ip = COALESCE(winlog.event_data.IpAddress, winlog.event_data.IpAddress)
  | EVAL subcat = COALESCE(winlog.event_data.Operation, "")
  | WHERE hostn RLIKE "(?i)(WINDC|ADDC|-DC|DOMAINCONTROLLER)"
  | WHERE event.code == "4719"
  | WHERE actor IS NOT NULL
  | WHERE NOT actor RLIKE ".*\\$$"
  | STATS change_count = COUNT(*) BY hostn, actor, src_ip, subcat
  | WHERE change_count >= 1
  | EVAL dyn_risk = CASE(change_count >= 5, 94, change_count >= 2, 90, 88)
  | KEEP agent_id, hostn, actor, src_ip, subcat, change_count, dyn_risk
  | SORT dyn_risk DESC, change_count DESC
  | LIMIT 200
enabled: false
tags:
  - AD
  - Policy Change
  - Defense Evasion
severity: high
risk_score: 88
references:
  - "https://attack.mitre.org/techniques/T1562/002/"
mitre_attack:
  TA0005:
    T1562: [T1562.002]
nist: ["AC-17", "AU-6", "AU-12", "CM-6"]
pci_dss: ["10.2.7", "10.2", "2.2"]
gdpr: ["32.1.a"]
