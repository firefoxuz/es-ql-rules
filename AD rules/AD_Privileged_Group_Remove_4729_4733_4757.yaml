rule_id: 18f06be8-e2dc-4b85-83f6-d7b6092dba42
name: AD Privileged Group Membership Removed (4729/4733/4757)
description: |
  Ushbu qoida privilege escalation va defense evasion bilan bog'liq bo'lib, imtiyozli guruhlardan a'zoni olib tashlash hodisasini nazorat qiladi.
  Hujumchi boshqa adminlarni guruhdan chiqarib yuborib nazoratni monopolizatsiya qilishi yoki izlarni yashirish uchun a'zolikni tezda rollback qilishi mumkin.
  Qonuniy holatlar: rejalashtirilgan access review, vaqtinchalik rol muddati tugashi, IAM governance jarayonlari.
  SOC triage bosqichlari:
  - `actor`, chiqarilgan `target_user` va `group_name` ni aniqlang.
  - O'zgarish uchun change ticket/deployment ruxsatnomasi borligini tasdiqlang.
  - `src_ip` manbasi va ish stansiya kontekstini tekshiring.
  - Ta'sirlangan foydalanuvchi/guruhning qolgan a'zoliklarini tekshirib, privilege chain buzilishini baholang.
  - Noqonuniy bo'lsa a'zolikni tiklang, aktor huquqlarini cheklang va zarur containmentni bajaring.
type: esql
params: '{}'
schedule_interval: 10m
index:
- logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | WHERE @timestamp >= NOW() - 15 minutes
  | WHERE winlog.channel == "Security"
  | EVAL hostn = winlog.computer_name
  | EVAL actor = COALESCE(winlog.event_data.SubjectUserName, winlog.event_data.SubjectUserName)
  | EVAL target_user = COALESCE(winlog.event_data.MemberName, winlog.event_data.TargetUserName, winlog.event_data.SamAccountName)
  | EVAL group_name = COALESCE(winlog.event_data.TargetUserName, winlog.event_data.SamAccountName)
  | EVAL src_ip = COALESCE(winlog.event_data.IpAddress, winlog.event_data.IpAddress)
  | WHERE hostn RLIKE "(?i)(WINDC|ADDC|-DC|DOMAINCONTROLLER)"
  | WHERE event.code IN ("4729", "4733", "4757")
  | WHERE actor IS NOT NULL
  | WHERE NOT actor RLIKE ".*\\$$"
  | WHERE group_name RLIKE "(?i)(Domain Admins|Enterprise Admins|Schema Admins|Administrators|Account Operators|Backup Operators|Server Operators|DnsAdmins|Cert Publishers|Remote Desktop Users)"
  | STATS remove_count = COUNT(*) BY hostn, actor, target_user, group_name, src_ip
  | WHERE remove_count >= 1
  | EVAL dyn_risk = CASE(group_name RLIKE "(?i)(Domain Admins|Enterprise Admins|Schema Admins)", 93, remove_count >= 3, 88, 82)
  | KEEP agent_id, hostn, actor, target_user, group_name, src_ip, remove_count, dyn_risk
  | SORT dyn_risk DESC, remove_count DESC
  | LIMIT 200
enabled: false
tags:
  - AD
  - Privilege Escalation
  - Defense Evasion
severity: high
risk_score: 82
references:
  - "https://attack.mitre.org/techniques/T1078/"
mitre_attack:
  TA0004:
    T1078: []
nist: ["AC-6", "AU-12", "AC-2"]
pci_dss: ["7.1", "7.2", "10.2.2"]
gdpr: ["32.1.a", "32.1.b"]
