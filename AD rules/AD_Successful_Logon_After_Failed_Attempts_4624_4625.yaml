rule_id: 929d5e88-02d9-4c03-9e36-43ab7886697c
name: AD Successful Logon After Multiple Failed Attempts (4624/4625)
description: |
  Ushbu qoida credential access va lateral movement texnikalariga bog'liq bo'lib, bir xil manbadan ketma-ket muvaffaqiyatsiz urinishlardan keyin muvaffaqiyatli kirishni aniqlaydi.
  4625 hodisalari ortidan 4624 paydo bo'lishi brute-force yoki credential stuffing muvaffaqiyatga erishganini ko'rsatishi mumkin, bu AD ichida hujumchiga haqiqiy akkaunt bilan harakatlanish imkonini beradi.
  Qonuniy holatlar sifatida foydalanuvchining parolni bir necha marta noto'g'ri kiritishi, saqlangan eski credentiallar yoki servis konfiguratsiyasi xatolari uchrashi mumkin.
  SOC triage bosqichlari:
  - `actor` va `target_user` ni, shuningdek qaysi `hostn` va `src_ip` da hodisa bo'lganini aniqlang.
  - Ushbu kirishlar rejalashtirilgan test, deployment yoki change ticket bilan bog'liqligini tasdiqlang.
  - `src_ip` manbasi, tarmoq segmenti va tarixiy faoliyatini chuqur tekshiring.
  - Ta'sirlangan akkauntlarning guruh a'zoligi, ayniqsa Domain Admins/Enterprise Admins bilan bog'liqligini tekshiring.
  - Shubhali bo'lsa manba IP ni cheklang, akkaunt credentiallarini reset qiling va komprometatsiya doirasini containment qiling.
type: esql
params: '{}'
schedule_interval: 10m
index:
- logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | WHERE @timestamp >= NOW() - 15 minutes
  | WHERE winlog.channel == "Security"
  | EVAL hostn = winlog.computer_name
  | EVAL actor = COALESCE(winlog.event_data.SubjectUserName, winlog.event_data.SubjectUserName)
  | EVAL target_user = COALESCE(winlog.event_data.TargetUserName, winlog.event_data.SamAccountName)
  | EVAL src_ip = COALESCE(winlog.event_data.IpAddress, winlog.event_data.IpAddress)
  | WHERE hostn RLIKE "(?i)(WINDC|ADDC|-DC|DOMAINCONTROLLER)"
  | WHERE event.code IN ("4624", "4625")
  | WHERE actor IS NOT NULL
  | WHERE NOT actor RLIKE ".*\\$$"
  | WHERE src_ip IS NOT NULL AND src_ip NOT IN ("-", "::1", "127.0.0.1")
  | EVAL is_success = CASE(event.code == "4624", 1, 0)
  | EVAL is_failure = CASE(event.code == "4625", 1, 0)
  | STATS total_events = COUNT(*), success_count = SUM(is_success), failure_count = SUM(is_failure), first_seen = MIN(@timestamp), last_seen = MAX(@timestamp), users = VALUES(target_user), logon_types = VALUES(winlog.event_data.LogonType) BY src_ip, hostn, bucket = DATE_TRUNC(15 minutes, @timestamp)
  | WHERE failure_count >= 5 AND success_count >= 1
  | EVAL dyn_risk = CASE(failure_count >= 25 AND success_count >= 2, 90, failure_count >= 15, 84, 78)
  | KEEP agent_id, src_ip, hostn, bucket, @timestamp), total_events, success_count, failure_count, first_seen, last_seen, users, logon_types, dyn_risk
  | SORT dyn_risk DESC, failure_count DESC
  | LIMIT 200
enabled: false
tags:
  - AD
  - Authentication
  - Credential Access
severity: high
risk_score: 78
references:
  - "https://attack.mitre.org/techniques/T1110/"
mitre_attack:
  TA0006:
    T1110: []
nist: ["AU-2", "AU-12", "AC-7", "IA-2"]
pci_dss: ["10.2.4", "10.2.5", "8.1.6"]
gdpr: ["32.1.a", "32.2"]
