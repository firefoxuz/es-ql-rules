rule_id: 32e83f5d-9756-4a9e-95a0-58ccad2dfc19
name: AD Kerberos Pre-Authentication Failure Spike (4771)
description: |
  Ushbu qoida credential access (brute-force/password spray) faoliyatini aniqlash uchun Kerberos pre-auth xatolarining keskin oshishini kuzatadi.
  4771 ko'payishi hujumchining parollarni taxmin qilish yoki foydalanuvchi enumeratsiyasi orqali AD hisoblarini nishonga olayotganini anglatishi mumkin.
  Qonuniy holatlar: noto'g'ri saqlangan credentiallar, parol almashinuvidan keyingi servis nosozligi, vaqt sinxronizatsiyasi muammolari.
  SOC triage bosqichlari:
  - `src_ip`, `actor` va ta'sirlangan `target_user` larni aniqlang.
  - Change ticket orqali shu vaqt oralig'ida auth-related deployment bo'lgan-bo'lmaganini tekshiring.
  - Manba `src_ip` tarmoq joylashuvi va oldingi xavf indikatorlarini tekshiring.
  - Nishonga olingan akkauntlarning guruh a'zoligi hamda Tier-0 ta'sirini baholang.
  - Hujum tasdiqlansa manbani bloklash, akkaunt reset va qo'shimcha himoya siyosatlarini joriy eting.
type: esql
params: '{}'
schedule_interval: 10m
index:
- logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | WHERE @timestamp >= NOW() - 15 minutes
  | WHERE winlog.channel == "Security"
  | EVAL hostn = winlog.computer_name
  | EVAL actor = COALESCE(winlog.event_data.SubjectUserName, winlog.event_data.TargetUserName, winlog.event_data.SubjectUserName)
  | EVAL target_user = COALESCE(winlog.event_data.TargetUserName, winlog.event_data.SamAccountName)
  | EVAL src_ip = COALESCE(winlog.event_data.IpAddress, winlog.event_data.IpAddress, winlog.event_data.ClientAddress)
  | EVAL fail_code = COALESCE(winlog.event_data.Status, "")
  | WHERE hostn RLIKE "(?i)(WINDC|ADDC|-DC|DOMAINCONTROLLER)"
  | WHERE event.code == "4771"
  | WHERE src_ip IS NOT NULL AND src_ip NOT IN ("-", "::1", "127.0.0.1")
  | STATS fail_count = COUNT(*), distinct_users = COUNT_DISTINCT(target_user) BY hostn, src_ip, fail_code
  | WHERE fail_count >= 15 OR distinct_users >= 7
  | EVAL dyn_risk = CASE(fail_count >= 60 OR distinct_users >= 20, 93, fail_count >= 30 OR distinct_users >= 12, 88, 83)
  | KEEP agent_id, hostn, src_ip, fail_code, fail_count, distinct_users, dyn_risk
  | SORT dyn_risk DESC, fail_count DESC
  | LIMIT 200
enabled: false
tags:
  - AD
  - Authentication
  - Credential Access
severity: high
risk_score: 83
references:
  - "https://attack.mitre.org/techniques/T1110/"
mitre_attack:
  TA0006:
    T1110: []
nist: ["AU-2", "AU-12", "AC-7", "IA-2"]
pci_dss: ["10.2.4", "10.2.5", "8.1.6"]
gdpr: ["32.1.a", "32.2"]
