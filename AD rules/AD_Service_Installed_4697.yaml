rule_id: a2bb4211-4b48-4809-b524-0a2370dc40cb
name: AD Service Installed via Security Log (4697)
description: |
  Ushbu qoida persistence texnikalariga tegishli bo'lib, xavfsizlik jurnalida yangi servis yaratilishini aniqlaydi.
  4697 orqali zararli servis o'rnatilishi hujumchiga rebootdan keyin ham saqlanib qoladigan kirish nuqtasi beradi va AD ichida yashirin ijroni ta'minlaydi.
  Qonuniy holatlar: ruxsatli dastur agentlari, patching jarayoni, backup/monitoring vositalari o'rnatilishi.
  SOC triage bosqichlari:
  - `actor`, servis nomi (`target_user`) va `hostn` ni aniq belgilang.
  - O'rnatish amali rasmiy change ticket/deploymentga mosligini tekshiring.
  - `src_ip` manzili va boshqaruv hostining odatiy admin yo'li ekanini tekshiring.
  - Servisni ishga tushirayotgan akkauntning guruh a'zoligi hamda imtiyozlarini baholang.
  - Tasdiqlanmagan bo'lsa servisni o'chiring, akkauntni cheklang va persistence indikatorlari bo'yicha keng ko'lamli tekshiruv o'tkazing.
type: esql
params: '{}'
schedule_interval: 10m
index:
- logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | WHERE @timestamp >= NOW() - 15 minutes
  | WHERE winlog.channel == "Security"
  | EVAL hostn = winlog.computer_name
  | EVAL actor = COALESCE(winlog.event_data.SubjectUserName, winlog.event_data.SubjectUserName)
  | EVAL target_user = COALESCE(winlog.event_data.ServiceName, winlog.event_data.TargetUserName, winlog.event_data.SamAccountName)
  | EVAL src_ip = COALESCE(winlog.event_data.IpAddress, winlog.event_data.IpAddress)
  | EVAL service_file = COALESCE(winlog.event_data.ServiceName, "")
  | WHERE hostn RLIKE "(?i)(WINDC|ADDC|-DC|DOMAINCONTROLLER)"
  | WHERE event.code == "4697"
  | WHERE actor IS NOT NULL
  | WHERE NOT actor RLIKE ".*\\$$"
  | STATS install_count = COUNT(*) BY hostn, actor, target_user, src_ip, service_file
  | WHERE install_count >= 1
  | EVAL dyn_risk = CASE(service_file RLIKE "(?i)(temp|appdata|powershell|cmd\\.exe|\\\\users\\\\public)", 92, install_count >= 2, 87, 83)
  | KEEP agent_id, hostn, actor, target_user, src_ip, service_file, install_count, dyn_risk
  | SORT dyn_risk DESC, install_count DESC
  | LIMIT 200
enabled: false
tags:
  - AD
  - Persistence
  - Service Creation
severity: high
risk_score: 83
references:
  - "https://attack.mitre.org/techniques/T1543/003/"
mitre_attack:
  TA0003:
    T1543: [T1543.003]
nist: ["SI-4", "AU-12", "CM-7"]
pci_dss: ["10.2.7", "11.4"]
gdpr: ["32.1.a"]
