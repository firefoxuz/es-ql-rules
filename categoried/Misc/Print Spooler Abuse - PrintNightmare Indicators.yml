rule_id: 02e0ad05-bb06-45e5-8a7d-03bb21da59be

name: "Print Spooler Abuse - PrintNightmare Indicators"
description: |
  This rule detects potential Print Spooler exploitation (PrintNightmare CVE-2021-1675, CVE-2021-34527) by identifying suspicious spoolsv.exe child processes or DLL loading from unusual paths. Adversaries exploit Print Spooler to achieve privilege escalation or remote code execution.
  
#  Print Spooler vulnerabilities are critical privilege escalation vectors. Detecting exploitation attempts prevents SYSTEM-level compromise.
#  
#  False positives may occur with legitimate printer driver installations or print-related software. Focus on unusual DLL paths or unexpected child processes.
#  
#  Triage steps: (1) Identify the spoolsv.exe child process or loaded DLL, (2) Check if the DLL path is unusual (temp, user-writable locations), (3) Verify if print driver installation was authorized, (4) Patch Print Spooler vulnerabilities immediately.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - winlogbeat-*
  - auditbeat-*
query_language: esql
query: |
  FROM winlogbeat-*, auditbeat-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL userp = COALESCE(user.name, winlog.event_data.SubjectUserName)
  | EVAL parentproc = COALESCE(process.parent.name, winlog.event_data.ParentProcessName)
  | EVAL procname = COALESCE(process.name, winlog.event_data.NewProcessName)
  | EVAL cmd = COALESCE(process.command_line, winlog.event_data.CommandLine, event.original)
  // Look for suspicious spoolsv.exe child processes or DLL loads
  | WHERE parentproc RLIKE "(?i)spoolsv\\.exe"
         AND procname RLIKE "(?i)(rundll32|regsvr32|powershell|cmd|mshta)"
  // Or DLL loading from suspicious paths
  | WHERE event.original RLIKE "(?i)(spoolsv.*\\\\Windows\\\\Temp|spoolsv.*\\\\Users\\\\.*\\\\AppData)"
  | STATS 
      exploit_count = COUNT(*),
      sample_commands = VALUES(SUBSTRING(cmd, 0, 160))
    BY hostn, userp, procname
  | WHERE exploit_count >= 1
  | EVAL risk_score = CASE(
      exploit_count >= 3, 98,
      exploit_count >= 2, 95,
      92
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - Print Spooler
  - PrintNightmare
  - Privilege Escalation
  - Exploitation
severity: critical
risk_score: 95
references:
  - "https://attack.mitre.org/techniques/T1068/"
  - "https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527"
nist: ["AU-6", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["6.2"]
mitre_attack:
  TA0004:
    T1068: []