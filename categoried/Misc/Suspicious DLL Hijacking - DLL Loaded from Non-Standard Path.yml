rule_id: 9c02c151-9c40-4afa-9b9d-40064f62373f
name: "Suspicious DLL Hijacking - DLL Loaded from Non-Standard Path"
description: |
  This rule detects potential DLL hijacking by identifying DLL loads from unusual paths such as user-writable directories, temp folders, or current working directories. Adversaries exploit DLL search order vulnerabilities to execute malicious code.
  
#  DLL hijacking is a common persistence and privilege escalation technique. Monitoring DLL load locations helps detect exploitation attempts.
#  
#  False positives may occur with portable applications, development environments, or specific software installations. Focus on system processes loading DLLs from unexpected locations.
#  
#  Triage steps: (1) Identify the process loading the suspicious DLL and the DLL path, (2) Check if the DLL is signed and legitimate, (3) Verify if the application is designed to load DLLs from that location, (4) Remove malicious DLLs and investigate for malware.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - winlogbeat-*
query_language: esql
query: |
  FROM winlogbeat-*
  | WHERE @timestamp >= NOW() - 15 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL procname = COALESCE(process.name, winlog.event_data.NewProcessName)
  | EVAL dllpath = COALESCE(file.path, event.original)
  // Look for DLL loads from suspicious paths (Event ID 7 in Sysmon)
  | WHERE event.code == "7" OR event.original RLIKE "(?i)(dll.*load|image.*load)"
  // Filter for suspicious DLL paths
  | WHERE dllpath RLIKE "(?i)(\\\\Temp\\\\|\\\\AppData\\\\Local\\\\Temp|\\\\Users\\\\Public\\\\|\\\\ProgramData\\\\(?!Microsoft)|Downloads\\\\)"
  | STATS 
      dll_count = COUNT(*),
      sample_dlls = VALUES(SUBSTRING(dllpath, 0, 160))
    BY hostn, procname
  | WHERE dll_count >= 2
  | EVAL risk_score = CASE(
      dll_count >= 5, 90,
      dll_count >= 3, 80,
      70
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - DLL Hijacking
  - Persistence
  - Privilege Escalation
  - DLL Load
severity: high
risk_score: 78
references:
  - "https://attack.mitre.org/techniques/T1574/001/"
nist: ["AU-6", "IR-4", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["6.5"]
mitre_attack:
  TA0003:
    T1574: ["T1574.001"]