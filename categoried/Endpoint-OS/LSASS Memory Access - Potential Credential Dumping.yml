rule_id: b1656937-8069-4f2a-bc51-96c850286c7a
name: "LSASS Memory Access - Potential Credential Dumping"
description: |
  This rule detects attempts to access the LSASS (Local Security Authority Subsystem Service) process memory, which is a common technique for credential dumping. Adversaries use tools like Mimikatz, ProcDump, or Comsvcs.dll to extract credentials from LSASS memory.
  
#  LSASS credential dumping is a critical credential access technique that provides adversaries with plaintext passwords, NTLM hashes, and Kerberos tickets. Detecting LSASS access is essential for preventing credential theft.
#  
#  False positives may occur with legitimate security tools, antivirus scans, or system diagnostics. Document authorized LSASS access and whitelist known tools.
#  
#  Triage steps: (1) Identify the process accessing LSASS and the user, (2) Check if the tool is authorized (e.g., EDR, AV), (3) Review the command line for credential dumping indicators, (4) Force password resets for all users on affected system.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - winlogbeat-*
  - auditbeat-*
query_language: esql
query: |
  FROM winlogbeat-*, auditbeat-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL userp = COALESCE(user.name, winlog.event_data.SubjectUserName)
  | EVAL procname = COALESCE(process.name, winlog.event_data.NewProcessName)
  | EVAL cmd = COALESCE(process.command_line, winlog.event_data.CommandLine, event.original)
  // Look for LSASS access patterns
  | WHERE cmd RLIKE "(?i)(lsass|procdump.*lsass|comsvcs.*MiniDump|sekurlsa|logonpasswords|mimikatz)"
         OR procname RLIKE "(?i)(procdump|mimikatz|dumpert|lsassy)"
         OR (event.action RLIKE "(?i)(process.*access|open.*process)" AND cmd RLIKE "(?i)lsass")
  | STATS 
      access_count = COUNT(*),
      sample_commands = VALUES(SUBSTRING(cmd, 0, 160))
    BY hostn, userp, procname
  | WHERE access_count >= 1
  | EVAL risk_score = CASE(
      access_count >= 3, 95,
      access_count >= 2, 90,
      85
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - LSASS
  - Credential Dumping
  - Credential Access
  - Mimikatz
severity: critical
risk_score: 92
references:
  - "https://attack.mitre.org/techniques/T1003/001/"
nist: ["AU-6", "SI-4"]
gdpr: ["Article 32", "Article 33"]
pci_dss: ["10.2"]
mitre_attack:
  TA0006:
    T1003: ["T1003.001"]