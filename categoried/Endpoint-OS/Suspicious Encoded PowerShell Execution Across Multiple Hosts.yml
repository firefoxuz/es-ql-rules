rule_id: 76c93776-ccc1-4b5f-8449-7fe941b355b3
name: "Suspicious Encoded PowerShell Execution Across Multiple Hosts"
description: |
  This rule detects encoded PowerShell commands (-EncodedCommand, -enc, -e) executed across multiple hosts within a short time window. This pattern suggests automated malware deployment, lateral movement, or coordinated attack campaigns using obfuscated payloads.
  
#  Encoded PowerShell is commonly used to hide malicious commands from simple string-based detection. When seen across multiple hosts simultaneously, it indicates widespread compromise or automated attack tooling.
#  
#  False positives may occur with legitimate automation scripts, GPO deployments, or management tools. Focus on unexpected users, unusual timing, or unknown encoded payloads.
#  
#  Triage steps: (1) Decode the Base64 payload to reveal the actual command, (2) Identify the source/initiator of the PowerShell execution, (3) Check for common attack patterns (download cradles, reverse shells), (4) Isolate affected hosts and hunt for additional compromised systems.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - winlogbeat-*
  - auditbeat-*
query_language: esql
query: |
  FROM winlogbeat-*, auditbeat-*
  | WHERE @timestamp >= NOW() - 15 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL userp = COALESCE(user.name, winlog.event_data.SubjectUserName)
  | EVAL procname = COALESCE(process.name, winlog.event_data.NewProcessName)
  | EVAL cmd = COALESCE(process.command_line, winlog.event_data.CommandLine, event.original)
  // Look for encoded PowerShell commands
  | WHERE procname RLIKE "(?i)powershell\\.exe"
         AND cmd RLIKE "(?i)(-enc|-encodedcommand|-e\\s+[A-Za-z0-9+/=]{50,})"
  | STATS 
      execution_count = COUNT(*),
      unique_hosts = COUNT_DISTINCT(hostn),
      unique_users = COUNT_DISTINCT(userp),
      sample_commands = VALUES(SUBSTRING(cmd, 0, 160))
    BY cmd
  // Threshold: same encoded command on 3+ hosts suggests lateral movement/campaign
  | WHERE unique_hosts >= 3
  | EVAL risk_score = CASE(
      unique_hosts >= 5, 95,
      unique_hosts >= 4, 90,
      85
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - PowerShell
  - Encoded Command
  - Lateral Movement
  - Malware Deployment
severity: critical
risk_score: 92
references:
  - "https://attack.mitre.org/techniques/T1059/001/"
  - "https://attack.mitre.org/techniques/T1027/"
nist: ["AU-6", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["10.2"]
mitre_attack:
  TA0002:
    T1059: ["T1059.001"]