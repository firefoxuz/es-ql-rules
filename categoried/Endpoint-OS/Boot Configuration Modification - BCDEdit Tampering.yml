rule_id: 4952f779-b6ac-462f-b31f-0c02a6717288
name: "Boot Configuration Modification - BCDEdit Tampering"
description: |
  This rule detects modifications to Windows boot configuration using bcdedit.exe, which ransomware and destructive malware use to disable recovery options, prevent safe mode access, or modify boot behavior. Common indicators include disabling recovery mode, ignoring failures, or modifying boot status policy.
  
#  Boot configuration tampering is a critical ransomware indicator that prevents system recovery. This technique ensures victims cannot easily restore their systems, increasing pressure to pay ransom.
#  
#  False positives may occur during legitimate system maintenance, Windows updates, or troubleshooting by IT administrators. Correlate with change management records.
#  
#  Triage steps: (1) Identify the user and command line arguments, (2) Verify if the modification is documented maintenance, (3) Check for other ransomware indicators (shadow copy deletion, file encryption), (4) Immediately isolate the host if malicious.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - winlogbeat-*
  - auditbeat-*
query_language: esql
query: |
  FROM winlogbeat-*, auditbeat-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL userp = COALESCE(user.name, winlog.event_data.SubjectUserName)
  | EVAL procname = COALESCE(process.name, winlog.event_data.NewProcessName)
  | EVAL cmd = COALESCE(process.command_line, winlog.event_data.CommandLine, event.original)
  // Look for bcdedit with suspicious parameters
  | WHERE procname RLIKE "(?i)bcdedit\\.exe"
         OR cmd RLIKE "(?i)bcdedit.*(recoveryenabled.*no|bootstatuspolicy.*ignoreallfailures|set.*safeboot|delete)"
  | STATS 
      bcdedit_count = COUNT(*),
      sample_commands = VALUES(SUBSTRING(cmd, 0, 160))
    BY hostn, userp
  | WHERE bcdedit_count >= 1
  | EVAL risk_score = CASE(
      bcdedit_count >= 3, 95,
      bcdedit_count >= 2, 90,
      85
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - BCDEdit
  - Boot Configuration
  - Ransomware
  - Impact
severity: critical
risk_score: 90
references:
  - "https://attack.mitre.org/techniques/T1490/"
nist: ["AU-6", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["10.2"]
mitre_attack:
  TA0040:
    T1490: []