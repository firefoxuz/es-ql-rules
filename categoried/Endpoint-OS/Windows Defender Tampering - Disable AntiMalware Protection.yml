rule_id: aaed31ac-d633-4231-9af4-ea5e29aa4d94
name: "Windows Defender Tampering - Disable AntiMalware Protection"
description: |
  This rule detects attempts to disable or tamper with Windows Defender antimalware protection using PowerShell Set-MpPreference cmdlets, sc.exe service control, or registry modifications. Adversaries disable security controls to evade detection before deploying malware.
  
#  Disabling endpoint protection is a critical defense evasion technique that precedes malware deployment. Early detection allows security teams to prevent the attack before malicious payloads execute.
#  
#  False positives may occur with legitimate administrative activities, GPO deployments, or authorized security software installations. Verify with IT security team.
#  
#  Triage steps: (1) Identify the user and process disabling Defender, (2) Verify if the action is documented and approved, (3) Check for malware deployment attempts following the disable action, (4) Re-enable Defender and scan the host immediately.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - winlogbeat-*
  - auditbeat-*
query_language: esql
query: |
  FROM winlogbeat-*, auditbeat-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL userp = COALESCE(user.name, winlog.event_data.SubjectUserName)
  | EVAL cmd = COALESCE(process.command_line, winlog.event_data.CommandLine, event.original)
  // Look for Defender disable patterns
  | WHERE cmd RLIKE "(?i)(Set-MpPreference.*(DisableReal.*true|DisableIOAVProtection.*true|DisableBehaviorMonitoring.*true)|sc.*stop.*WinDefend|sc.*config.*WinDefend.*disabled|Add-MpPreference.*-ExclusionPath)"
  | STATS 
      tampering_count = COUNT(*),
      sample_commands = VALUES(SUBSTRING(cmd, 0, 160))
    BY hostn, userp
  | WHERE tampering_count >= 1
  | EVAL risk_score = CASE(
      tampering_count >= 3, 95,
      tampering_count >= 2, 90,
      85
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - Windows Defender
  - Defense Evasion
  - AntiMalware
  - Tampering
severity: critical
risk_score: 92
references:
  - "https://attack.mitre.org/techniques/T1562/001/"
nist: ["AU-6", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["5.1"]
mitre_attack:
  TA0005:
    T1562: ["T1562.001"]