rule_id: 1dd1daec-5d7c-4292-bcf9-feec56f940d6
name: "Windows LOLBin Suspicious Chain Execution"
description: |
  This rule detects abuse of Windows "Living Off The Land" binaries (LOLBins) - legitimate Windows utilities weaponized by attackers. It identifies suspicious execution chains of PowerShell, WMIC, reg.exe, sc.exe, rundll32.exe with high-risk arguments such as encoded commands, remote execution flags, registry manipulation, service creation, or DLL execution. The rule triggers when 3+ LOLBin executions with suspicious patterns occur on a single host within 20 minutes.

#  **Why it matters:**
#  LOLBin abuse allows attackers to operate stealthily using trusted system binaries:
#  - MITRE ATT&CK T1218/T1059 document extensive LOLBin abuse techniques
#  - NIST SP 800-53 SI-4 requires monitoring for malicious use of authorized utilities
#  - These techniques evade signature-based detection and application whitelisting
#
#  **False Positives:**
#  - Legitimate administrative scripts using PowerShell for automation
#  - System management tools (SCCM, GPO) deploying configurations via WMIC or reg.exe
#  - Authorized rundll32 usage for Windows component operations
#  - IT helpdesk performing troubleshooting with command-line utilities
#
#  **Triage Steps:**
#  1. Review the full command line arguments for each LOLBin execution
#  2. Identify the parent process - was it spawned by cmd.exe, another script, or user action?
#  3. Check the user context - is it a standard user, admin, or SYSTEM account?
#  4. Correlate with process creation timeline to identify execution chains
#  5. Search for indicators of lateral movement, credential dumping, or persistence
#  6. Investigate the working directory and any files created during execution
type: esql
params: '{}'
schedule_interval: 20m
index:
  - winlogbeat-*
query_language: esql
query: |
  FROM winlogbeat-*
  // Time window: last 20 minutes
  | WHERE @timestamp >= NOW() - 20 minutes
  // Process creation events
  | WHERE event.code == "4688" OR event.code == "1"
  // Extract command line
  | EVAL cmd = COALESCE(process.command_line, winlog.event_data.CommandLine, event.original)
  | EVAL procname = COALESCE(process.name, winlog.event_data.NewProcessName)
  | EVAL hostname = COALESCE(host.name, winlog.computer_name)
  | WHERE cmd IS NOT NULL AND hostname IS NOT NULL
  // LOLBin detection
  | WHERE (
      (procname RLIKE ".*powershell.*" AND cmd RLIKE ".*( -enc | -nop | -w hidden| -ep bypass| IEX| Invoke-Expression| DownloadString| FromBase64String).*") OR
      (procname RLIKE ".*wmic.*" AND cmd RLIKE ".*(process call create|node.*process).*") OR
      (procname RLIKE ".*reg\\.exe.*" AND cmd RLIKE ".*(add|delete).*\\\\(Run|RunOnce|CurrentVersion\\\\Windows|Services).*") OR
      (procname RLIKE ".*sc\\.exe.*" AND cmd RLIKE ".*(create|config).*") OR
      (procname RLIKE ".*rundll32.*" AND cmd RLIKE ".*(javascript:|vbscript:|http:|\\\\\\\\).*")
    )
  // Aggregate by host
  | STATS 
      lolbin_count = COUNT(*),
      unique_lolbins = COUNT_DISTINCT(procname),
      sample_commands = VALUES(SUBSTRING(cmd, 0, 150))
    BY hostname
  // Threshold: 3+ LOLBin executions
  | WHERE lolbin_count >= 3
  // Risk scoring
  | EVAL risk_score = CASE(
      lolbin_count >= 10, 95,
      lolbin_count >= 5, 85,
      75
    )
  | KEEP hostname, lolbin_count, unique_lolbins, risk_score, sample_commands
enabled: false
tags:
  - LOLBins
  - Defense Evasion
  - Execution
  - Windows
  - Lateral Movement
severity: high
risk_score: 80
references:
  - "https://attack.mitre.org/techniques/T1218/"
  - "https://lolbas-project.github.io/"
  - "https://attack.mitre.org/techniques/T1059/001/"
nist: ["AU-2", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["10.2.2", "10.2.7"]
mitre_attack:
  TA0005:
    T1218: ["T1218.011"]
  TA0002:
    T1059: ["T1059.001"]