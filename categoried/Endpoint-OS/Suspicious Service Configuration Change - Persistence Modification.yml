rule_id: 271c8428-791f-4cd6-b03e-a7b4d55aab3e
name: "Suspicious Service Configuration Change - Persistence Modification"
description: |
  This rule detects modifications to existing Windows service configurations using sc.exe config or Set-Service cmdlets. Adversaries may modify legitimate services to execute malicious payloads, change service accounts, or alter startup types for persistence.
  
#  Service modification is stealthier than creating new services and can leverage trusted service names for defense evasion. Detecting configuration changes helps identify persistence attempts.
#  
#  False positives occur with legitimate service management, updates, or hardening activities. Focus on changes to critical services or modifications by unexpected users.
#  
#  Triage steps: (1) Identify which service was modified and what changed, (2) Verify if the modification is documented, (3) Check the new service binary path or account, (4) Restore original configuration if unauthorized.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - winlogbeat-*
  - auditbeat-*
query_language: esql
query: |
  FROM winlogbeat-*, auditbeat-*
  | WHERE @timestamp >= NOW() - 15 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL userp = COALESCE(user.name, winlog.event_data.SubjectUserName)
  | EVAL cmd = COALESCE(process.command_line, winlog.event_data.CommandLine, event.original)
  // Look for service configuration changes
  | WHERE cmd RLIKE "(?i)(sc\\.exe.*config|Set-Service.*(BinaryPathName|StartType|Credential))"
  | STATS 
      config_count = COUNT(*),
      sample_commands = VALUES(SUBSTRING(cmd, 0, 160))
    BY hostn, userp
  | WHERE config_count >= 1
  | EVAL risk_score = CASE(
      config_count >= 5, 85,
      config_count >= 3, 75,
      70
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - Service Configuration
  - Persistence
  - Defense Evasion
  - Service Modification
severity: medium
risk_score: 70
references:
  - "https://attack.mitre.org/techniques/T1543/003/"
nist: ["IA-1", "IA-12", "IA-2", "IA-4", "IA-5", "IA-8", "PE-2", "PS-3", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["10.2"]
mitre_attack:
  TA0003:
    T1543: ["T1543.003"]