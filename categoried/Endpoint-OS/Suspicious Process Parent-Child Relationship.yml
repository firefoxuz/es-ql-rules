rule_id: 0b5b149d-3e99-44c5-ada7-eaeedd8f59e0
name: "Suspicious Process Parent-Child Relationship"
description: |
  This rule identifies anomalous process parent-child relationships that indicate exploitation or malicious activity. It detects scenarios such as Office applications (Word, Excel, PowerPoint) spawning cmd.exe or PowerShell, web browsers launching scripting engines, or system binaries like explorer.exe spawning unusual child processes. These relationships often indicate macro-based malware, browser exploits, or user-initiated execution of malicious payloads.

#  **Why it matters:**
#  Abnormal process trees are strong indicators of initial access and execution:
#  - MITRE ATT&CK T1566/T1204 document user execution vectors through Office and browser
#  - NIST SP 800-53 SI-4 requires monitoring of system behavior for anomalies
#  - Process relationship analysis is critical for detecting zero-day exploits
#
#  **False Positives:**
#  - Legitimate Office macros or VBA scripts used for business automation
#  - Browser extensions or plugins spawning helper processes
#  - IT support using remote assistance tools that modify process trees
#  - Software installers launched from browser downloads
#
#  **Triage Steps:**
#  1. Identify the parent process and verify if it should spawn the observed child
#  2. Review process command lines for both parent and child - what was executed?
#  3. Check file hash reputation for the child process executable
#  4. Investigate user context - was this a standard user or privileged account?
#  5. Correlate with email logs if Office apps were involved (possible phishing)
#  6. Search for subsequent lateral movement or privilege escalation attempts
type: esql
params: '{}'
schedule_interval: 15m
index:
  - winlogbeat-*
query_language: esql
query: |
  FROM winlogbeat-*
  // Time window: last 15 minutes
  | WHERE @timestamp >= NOW() - 15 minutes
  // Process creation events
  | WHERE event.code == "4688" OR event.code == "1"
  // Extract process and parent process info
  | EVAL procname = COALESCE(process.name, winlog.event_data.NewProcessName)
  | EVAL parentname = COALESCE(process.parent.name, winlog.event_data.ParentProcessName)
  | EVAL cmd = COALESCE(process.command_line, winlog.event_data.CommandLine)
  | EVAL hostname = COALESCE(host.name, winlog.computer_name)
  | WHERE procname IS NOT NULL AND parentname IS NOT NULL AND hostname IS NOT NULL
  // Suspicious parent-child relationships
  | WHERE (
      (parentname RLIKE ".*(WINWORD|EXCEL|POWERPNT|OUTLOOK).*" AND procname RLIKE ".*(cmd\\.exe|powershell|wscript|cscript|mshta).*") OR
      (parentname RLIKE ".*(chrome|firefox|iexplore|msedge).*" AND procname RLIKE ".*(powershell|cmd\\.exe|wscript|rundll32).*") OR
      (parentname RLIKE ".*explorer\\.exe.*" AND procname RLIKE ".*(powershell|cmd\\.exe|wmic|reg\\.exe|net\\.exe).*")
    )
  // Aggregate by host
  | STATS 
      suspicious_spawns = COUNT(*),
      parent_child_pairs = COUNT_DISTINCT(CONCAT(parentname, "->", procname)),
      sample_commands = VALUES(SUBSTRING(cmd, 0, 150))
    BY hostname
  // Threshold: 3+ suspicious spawns
  | WHERE suspicious_spawns >= 3
  // Risk scoring
  | EVAL risk_score = CASE(
      suspicious_spawns >= 10, 90,
      suspicious_spawns >= 5, 80,
      70
    )
  | KEEP hostname, suspicious_spawns, parent_child_pairs, risk_score, sample_commands
enabled: false
tags:
  - Process Execution
  - Malware
  - Office Macros
  - Browser Exploit
  - Initial Access
severity: high
risk_score: 80
references:
  - "https://attack.mitre.org/techniques/T1204/"
  - "https://attack.mitre.org/techniques/T1566/001/"
nist: ["SI-3", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["5.1", "10.2.7"]
mitre_attack:
  TA0002:
    T1204: ["T1204.002"]
  TA0001:
    T1566: ["T1566.001"]