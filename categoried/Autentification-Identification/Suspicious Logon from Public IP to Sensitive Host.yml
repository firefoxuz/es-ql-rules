rule_id: ba6b3c98-6009-4390-8b25-bb5d9aee38f9
name: "Suspicious Logon from Public IP to Sensitive Host"
description: |
  This rule identifies authentication attempts from public (non-RFC1918) IP addresses to hosts with sensitive naming patterns (e.g., DC, SQL, PROD, FIN, HR keywords). It focuses on detecting external threat actors or compromised external systems attempting to access critical internal infrastructure. The rule triggers when 3+ authentication attempts occur from public IPs to sensitive hosts within a 30-minute window.

#**Why it matters:**
#Direct external access to sensitive systems indicates security control failures:
#- NIST SP 800-53 AC-3/AC-17 require restricted remote access to critical systems
#- PCI DSS 1.3.1/1.3.2 mandate network segmentation preventing direct external access
#- GDPR Article 32 requires appropriate access controls for systems processing personal data#
#**False Positives:**
#- Legitimate remote access through VPN split-tunneling (shows public IP)
#- Cloud-based management tools accessing on-premise infrastructure
#- Authorized third-party vendor access for maintenance or support
#- Mobile users on cellular networks accessing permitted systems#
#**Triage Steps:**
#1. Identify the source IP and check geolocation and reputation
#2. Verify if the target host is actually sensitive and should not accept external connections
#3. Review firewall and network security group rules - should this connection be blocked?
#4. Check if authentication succeeded and investigate all post-authentication activity
#5. Validate whether VPN or bastion host should have been used instead
#6. Review similar connections from the same source IP to other systems
type: esql
params: '{}'
schedule_interval: 30m
index:
  - winlogbeat-*
query_language: esql
query: |
  FROM winlogbeat-*
  // Time window: last 30 minutes
  | WHERE @timestamp >= NOW() - 30 minutes
  // Logon events
  | WHERE event.code IN ("4624", "4625") AND event.provider == "Microsoft-Windows-Security-Auditing"
  // Extract fields
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  | EVAL hostname = COALESCE(host.name, winlog.computer_name)
  | EVAL username = COALESCE(user.target.name, winlog.event_data.TargetUserName)
  | WHERE srcip IS NOT NULL AND hostname IS NOT NULL
  // Exclude RFC1918 private IPs (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16)
  | WHERE NOT (
      srcip RLIKE "^10\\..*" OR 
      srcip RLIKE "^172\\.(1[6-9]|2[0-9]|3[0-1])\\..*" OR 
      srcip RLIKE "^192\\.168\\..*"
    )
  // Sensitive host patterns
  | WHERE hostname RLIKE ".*(DC|DOMAIN|SQL|DB|PROD|FIN|FINANCE|HR|PAYROLL|PCI).*"
  // Aggregate by source IP and target host
  | STATS 
      attempt_count = COUNT(*),
      failed_count = COUNT(*) WHERE event.code == "4625",
      success_count = COUNT(*) WHERE event.code == "4624",
      users_targeted = COUNT_DISTINCT(username),
      sample_users = VALUES(username)
    BY srcip, hostname
  // Threshold: 3+ attempts to sensitive hosts from public IP
  | WHERE attempt_count >= 3
  // Risk scoring
  | EVAL risk_score = CASE(
      success_count >= 1, 95,
      attempt_count >= 10, 85,
      users_targeted >= 5, 80,
      70
    )
  | KEEP srcip, hostname, attempt_count, failed_count, success_count, users_targeted, sample_users, risk_score
enabled: false
tags:
  - Authentication
  - External Access
  - Lateral Movement
  - Sensitive Systems
severity: high
risk_score: 75
references:
  - "https://attack.mitre.org/techniques/T1078/"
nist: ["AC-17", "AC-3", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["1.3.1", "1.3.2", "8.1.5"]
mitre_attack:
  TA0001:
    T1078: []
  TA0008:
    T1021: []