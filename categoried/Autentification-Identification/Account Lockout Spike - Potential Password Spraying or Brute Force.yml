rule_id: 79d0d600-d6c4-4622-ac9e-d68267667e79

name: "Account Lockout Spike - Potential Password Spraying or Brute Force"
description: |
  This rule detects multiple account lockouts across different user accounts within a short time window, indicating potential password spraying or distributed brute force attacks. Adversaries may attempt low-and-slow credential guessing to avoid per-user lockout thresholds.
  
#  Password spraying is a common initial access technique. Detecting lockout spikes helps identify credential attacks before successful compromise.
#  
#  False positives may occur during password policy changes, system migrations, or user onboarding. Correlate with change management schedules.
#  
#  Triage steps: (1) Identify the source IPs causing lockouts, (2) Check if lockouts are across multiple users or focused on specific accounts, (3) Review failed login events preceding lockouts, (4) Block source IPs if malicious.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - winlogbeat-*
query_language: esql
query: |
  FROM winlogbeat-*
  | WHERE @timestamp >= NOW() - 15 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL usert = COALESCE(user.target.name, winlog.event_data.TargetUserName)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Event ID 4740 = account lockout
  | WHERE winlog.event_id == "4740" OR event.code == "4740"
  | STATS 
      lockout_count = COUNT(*),
      unique_users = COUNT_DISTINCT(usert),
      affected_users = VALUES(usert),
      source_ips = VALUES(SUBSTRING(TO_STRING(srcip), 0, 50))
    BY hostn
  // Threshold: 5+ unique users locked out in 15 min
  | WHERE unique_users >= 5
  | EVAL risk_score = CASE(
      unique_users >= 10, 90,
      unique_users >= 7, 80,
      70
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - Account Lockout
  - Password Spraying
  - Brute Force
  - Initial Access
severity: high
risk_score: 78
references:
  - "https://attack.mitre.org/techniques/T1110/003/"
nist: ["AC-14", "IA-1", "IA-10", "IA-11", "IA-2", "IA-3", "IA-5", "IA-8", "IA-9", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["8.2"]
mitre_attack:
  TA0001:
    T1110: ["T1110.003"]