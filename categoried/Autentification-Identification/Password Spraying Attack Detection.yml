rule_id: a7d5ea70-0a17-48c5-abc7-f884e03acb4c
name: "Password Spraying Attack Detection"
description: |
  This rule identifies password spraying attacks where an adversary attempts authentication against many user accounts using a small set of common passwords. Unlike traditional brute force attacks that target a single account with many passwords, password spraying distributes authentication attempts across multiple accounts to evade account lockout policies. The detection triggers when a single source IP attempts to authenticate as 10+ distinct users within a 10-minute window with a high failure rate (>70%).

#**Why it matters:**
#Password spraying is a critical precursor to account compromise and is explicitly covered under:
#- GDPR Article 32 (Security of Processing) - requires detection of unauthorized access attempts
#- NIST SP 800-53 AC-7 (Unsuccessful Login Attempts) - mandates monitoring and response
#- PCI DSS 8.1.6/8.1.8 - requires detection of authentication anomalies#
#**False Positives:**
#- Shared workstation environments where multiple users authenticate from the same IP
#- SSO/federation services performing health checks or batch authentication
#- Automated testing environments with legitimate multi-account testing
#- Load balancers or proxies masquerading multiple users behind a single IP#
#**Triage Steps:**
#1. Verify source IP reputation and geolocation - is it expected for your organization?
#2. Check if targeted usernames are valid accounts or non-existent (reconnaissance indicator)
#3. Review temporal pattern - is it automated (uniform timing) or manual?
#4. Investigate any successful authentications from the same source within Â±1 hour
#5. Check for subsequent lateral movement or privilege escalation from compromised accounts
#6. Correlate with threat intelligence feeds for known attack infrastructure
type: esql
params: '{}'
schedule_interval: 10m
index:
  - winlogbeat-*
query_language: esql
query: |
  FROM winlogbeat-*
  // Time window: last 10 minutes
  | WHERE @timestamp >= NOW() - 10 minutes
  // Focus on authentication events (Windows Logon events)
  | WHERE event.code IN ("4625", "4624") AND event.provider == "Microsoft-Windows-Security-Auditing"
  // Extract source IP and username
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  | EVAL username = COALESCE(user.target.name, winlog.event_data.TargetUserName)
  | WHERE srcip IS NOT NULL AND username IS NOT NULL
  // Aggregate by source IP
  | STATS 
      total_attempts = COUNT(*),
      unique_users = COUNT_DISTINCT(username),
      failed_attempts = COUNT(*) WHERE event.code == "4625",
      success_attempts = COUNT(*) WHERE event.code == "4624",
      sample_users = VALUES(username)
    BY srcip
  // Threshold: 10+ users, >70% failure rate
  | WHERE unique_users >= 10 AND (failed_attempts * 1.0 / total_attempts) > 0.7
  // Calculate risk score
  | EVAL risk_score = CASE(
      unique_users >= 50, 95,
      unique_users >= 30, 85,
      unique_users >= 20, 75,
      65
    )
  | KEEP srcip, unique_users, total_attempts, failed_attempts, success_attempts, risk_score, sample_users
enabled: false
tags:
  - Authentication
  - Password Spraying
  - Brute Force
  - Account Takeover
  - Initial Access
severity: high
risk_score: 75
references:
  - "https://attack.mitre.org/techniques/T1110/003/"
  - "https://www.microsoft.com/security/blog/password-spray-detection"
nist: ["AC-7", "AU-6", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["8.1.6", "8.1.8", "10.2.4"]
mitre_attack:
  TA0006:
    T1110: ["T1110.003"]