rule_id: b36cea49-fd0f-41b9-ae64-0573a21f11a7
name: "Kerberos TGT/TGS Ticket Request Spike - Potential Kerberoasting or Silver Ticket"
description: |
  This rule detects anomalous spikes in Kerberos service ticket (TGS) requests (Event ID 4769) from a single source, which may indicate Kerberoasting attacks where adversaries request service tickets for cracking offline. High volumes of TGT requests (4768) may also indicate Golden Ticket attacks or automated reconnaissance.
  
#  Kerberoasting is a common credential access technique that allows attackers to extract service account password hashes for offline cracking. Detection is critical to prevent privilege escalation.
#  
#  False positives may occur in environments with heavy service-to-service authentication or scheduled tasks using service accounts. Baseline normal ticket request volumes per host.
#  
#  Triage steps: (1) Identify the requesting user and host, (2) Review requested service principal names (SPNs), (3) Check if the user account is a known service account, (4) Correlate with other Kerberos events (RC4 encryption downgrade).
type: esql
params: '{}'
schedule_interval: 10m
index:
  - winlogbeat-*
query_language: esql
query: |
  FROM winlogbeat-*
  | WHERE @timestamp >= NOW() - 15 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL userp = COALESCE(user.name, winlog.event_data.SubjectUserName)
  | EVAL usert = COALESCE(user.target.name, winlog.event_data.TargetUserName)
  // Event ID 4769 = Kerberos TGS request, 4768 = TGT request
  | WHERE winlog.event_id IN ("4769", "4768")
  | STATS 
      ticket_count = COUNT(*),
      unique_targets = COUNT_DISTINCT(usert),
      sample_events = VALUES(SUBSTRING(event.original, 0, 160))
    BY hostn, userp, winlog.event_id
  // Spike threshold: more than 50 tickets in 15 min from one source
  | WHERE ticket_count >= 50
  | EVAL risk_score = CASE(
      ticket_count >= 100, 90,
      ticket_count >= 75, 80,
      70
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - Kerberos
  - Credential Access
  - Kerberoasting
  - Golden Ticket
severity: high
risk_score: 80
references:
  - "https://attack.mitre.org/techniques/T1558/003/"
  - "https://adsecurity.org/?p=2293"
nist: ["AU-6", "IR-4", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["10.2"]
mitre_attack:
  TA0006:
    T1558: ["T1558.003"]