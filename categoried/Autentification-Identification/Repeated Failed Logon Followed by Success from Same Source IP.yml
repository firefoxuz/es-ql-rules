rule_id: a8d6e91e-a8cc-4f4b-a252-14caec36c0c6
name: "Repeated Failed Logon Followed by Success from Same Source IP"
description: |
  This rule detects multiple failed logon attempts from the same source IP followed by a successful logon, indicating potential credential brute forcing or password guessing. This pattern suggests an attacker eventually guessed or cracked valid credentials.
  
#  Successful brute force attacks represent immediate credential compromise. Early detection allows for rapid response to block further access.
#  
#  False positives may occur with users who mistype passwords repeatedly. Focus on high failure counts and unfamiliar source IPs.
#  
#  Triage steps: (1) Verify the source IP geolocation and reputation, (2) Check if the successful user account matches the failed attempts, (3) Review post-authentication activity, (4) Force password reset for affected accounts.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - winlogbeat-*
  - auditbeat-*
query_language: esql
query: |
  FROM winlogbeat-*, auditbeat-*
  | WHERE @timestamp >= NOW() - 20 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL usert = COALESCE(user.target.name, winlog.event_data.TargetUserName)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Focus on authentication events: 4624 = success, 4625 = failure
  | WHERE event.category == "authentication" OR winlog.event_id IN ("4624", "4625")
  | EVAL outcome_normalized = COALESCE(event.outcome, "unknown")
  | STATS 
      total_attempts = COUNT(*),
      failure_count = COUNT_DISTINCT(CASE(outcome_normalized == "failure", @timestamp, null)),
      success_count = COUNT_DISTINCT(CASE(outcome_normalized == "success", @timestamp, null)),
      sample_users = VALUES(usert)
    BY srcip, hostn
  // Pattern: many failures followed by at least one success
  | WHERE failure_count >= 10 AND success_count >= 1
  | EVAL risk_score = CASE(
      failure_count >= 25, 90,
      failure_count >= 15, 80,
      70
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - Brute Force
  - Authentication
  - Initial Access
  - Credential Access
severity: high
risk_score: 80
references:
  - "https://attack.mitre.org/techniques/T1110/001/"
nist: ["AC-14", "IA-1", "IA-10", "IA-11", "IA-2", "IA-3", "IA-5", "IA-8", "IA-9", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["8.2"]
mitre_attack:
  TA0006:
    T1110: ["T1110.001"]