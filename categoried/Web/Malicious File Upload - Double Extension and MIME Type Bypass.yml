rule_id: c149fa02-812c-48cc-adbe-97f299788052

name: "Malicious File Upload - Double Extension and MIME Type Bypass"
description: |
  This rule detects malicious file upload attempts using double extensions (file.php.jpg), MIME type mismatches, or uploads of executable content disguised as images. Attackers use these techniques to bypass file upload validation and upload webshells.
  
#  File upload vulnerabilities are common entry points for webshells and remote code execution. Detecting bypass techniques helps prevent server compromise.
#  
#  False positives may occur with legitimate files having multiple extensions or unusual naming conventions. Focus on executable extensions in unexpected positions.
#  
#  Triage steps: (1) Identify the uploaded filename and MIME type, (2) Check file contents for executable code, (3) Search upload directories for suspicious files, (4) Implement proper file validation including content inspection and safe file naming.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Look for file upload endpoints with suspicious patterns
  | WHERE event.original RLIKE "(?i)(/upload|multipart/form-data|filename=)"
  // Check for double extensions or executable disguised as images
  | WHERE event.original RLIKE "(?i)(filename=.*\\.(php|asp|aspx|jsp|jspx|war|exe|sh|pl|py|rb)\\.(jpg|jpeg|png|gif|txt|pdf))"
  // Also catch null byte injection
  | WHERE event.original RLIKE "(?i)(filename=.*%00|filename=.*\\.php%00)"
  | STATS 
      upload_count = COUNT(*),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  | WHERE upload_count >= 1
  | EVAL risk_score = CASE(
      upload_count >= 5, 95,
      upload_count >= 3, 90,
      85
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - File Upload
  - Webshell
  - MIME Type Bypass
  - Double Extension
severity: critical
risk_score: 90
references:
  - "https://attack.mitre.org/techniques/T1505/003/"
  - "https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload"
nist: ["AU-6", "SI-4"]
gdpr: ["Article 32", "Article 33"]
pci_dss: ["6.5"]
mitre_attack:
  TA0003:
    T1505: ["T1505.003"]