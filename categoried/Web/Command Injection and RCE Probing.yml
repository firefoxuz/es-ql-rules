rule_id: eb5c18ba-97ee-4406-a6b5-7fdc9ca8ce21
name: "Command Injection and RCE Probing"
description: |
  This rule identifies command injection and remote code execution (RCE) attempts in HTTP requests. It detects shell metacharacters and command chaining operators (;, |, &&, ||), command substitution ($(), backticks), common shell binaries (/bin/sh, /bin/bash, cmd.exe), and PowerShell execution patterns (powershell -enc, -nop, -w hidden). The rule triggers when 5+ distinct command injection indicators are detected from a single source IP within 10 minutes.

 # **Why it matters:**
 # Command injection enables complete server compromise and is a top exploitation target:
 # - OWASP Top 10 #3 (Injection) - OS command injection leads to system takeover
 # - PCI DSS 6.5.1 requires protection against injection attacks
 # - NIST SP 800-53 SI-10 mandates input validation to prevent code injection
#
 # **False Positives:**
 # - Security scanning tools performing authorized RCE detection tests
 # - Legitimate application features allowing controlled command execution (admin panels)
 # - Development/staging environments with debugging functionality enabled
 # - CI/CD pipelines or deployment tools executing commands through web interfaces
#
 # **Triage Steps:**
 # 1. Verify source IP reputation and whether it's from authorized testing
 # 2. Identify targeted endpoints and parameters accepting command input
 # 3. Review application error logs for evidence of command execution
 # 4. Check web server logs for successful execution (200 OK with unusual response times)
 # 5. Investigate any outbound network connections from web servers post-exploitation
 # 6. Conduct security code review and implement input sanitization
type: esql
params: '{}'
schedule_interval: 10m
index:
  - filebeat-nginx-access-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*
  // Time window: last 10 minutes
  | WHERE @timestamp >= NOW() - 10 minutes
  // Extract request data
  | EVAL srcip = COALESCE(source.ip, "")
  | EVAL uri = event.original
  | WHERE srcip IS NOT NULL AND uri IS NOT NULL
  // Command injection pattern detection
  | WHERE uri RLIKE ".*(;|\\||&&|\\|\\||`|\\$\\(|/bin/sh|/bin/bash|cmd\\.exe|powershell|pwsh| -enc | -nop | -w hidden| IEX\\(| Invoke-Expression).*"
  // Aggregate by source IP
  | STATS 
      request_count = COUNT(*),
      unique_patterns = COUNT_DISTINCT(SUBSTRING(uri, 0, 160)),
      sample_requests = VALUES(SUBSTRING(uri, 0, 160))
    BY srcip
  // Threshold: 5+ command injection patterns
  | WHERE unique_patterns >= 5
  // Risk scoring
  | EVAL risk_score = CASE(
      request_count >= 30, 95,
      request_count >= 15, 85,
      75
    )
  | KEEP srcip, request_count, unique_patterns, risk_score, sample_requests
enabled: false
tags:
  - Web Security
  - Command Injection
  - RCE
  - OWASP
  - Code Execution
severity: critical
risk_score: 85
references:
  - "https://owasp.org/www-community/attacks/Command_Injection"
  - "https://attack.mitre.org/techniques/T1059/"
nist: ["SI-10", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["6.5.1", "11.4"]
mitre_attack:
  TA0002:
    T1059: ["T1059.001", "T1059.003"]