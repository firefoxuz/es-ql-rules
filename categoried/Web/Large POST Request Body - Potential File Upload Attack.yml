rule_id: c6d3a78e-24e6-4f14-8892-ebe572262d7f

name: "Large POST Request Body - Potential File Upload Attack"
description: |
  This rule detects unusually large HTTP POST request bodies which may indicate malicious file upload attempts, webshell uploads, or data exfiltration via POST. While exact content-length may not be available, high POST request counts or specific patterns can serve as heuristics.
  
#  Large POST requests to upload endpoints can indicate webshell uploads, malware uploads, or attempts to exploit file upload vulnerabilities. Monitoring POST behavior helps detect exploitation.
#  
#  False positives are common with legitimate file uploads, form submissions, or API usage. Baseline normal upload sizes and focus on unexpected endpoints or external sources.
#  
#  Triage steps: (1) Identify the source IP and target upload endpoint, (2) Review uploaded files on the server, (3) Check for webshells or malicious files in upload directories, (4) Implement file upload validation and scanning.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 15 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Heuristic: look for POST requests with upload-related paths
  | WHERE event.original RLIKE "(?i)(\\sPOST\\s)"
         AND event.original RLIKE "(?i)(upload|file|attachment|media|content|multipart)"
  | STATS 
      post_count = COUNT(*),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  // Multiple POSTs to upload endpoints from same source
  | WHERE post_count >= 5
  | EVAL risk_score = CASE(
      post_count >= 15, 85,
      post_count >= 10, 75,
      65
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - File Upload
  - POST Request
  - Webshell Upload
  - Exploitation
severity: medium
risk_score: 72
references:
  - "https://attack.mitre.org/techniques/T1505/003/"
  - "https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload"
nist: ["AU-6", "IR-4", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["6.5"]
mitre_attack:
  TA0001:
    T1190: []