rule_id: 3b2bf9fb-d135-452d-86c4-58217d3f5c7a
name: "GraphQL Introspection and Injection Attacks"
description: |
  This rule detects GraphQL introspection queries and injection attempts by identifying __schema, __type introspection queries, deeply nested queries, batched queries, and injection payloads in GraphQL requests.
  
#  GraphQL introspection can reveal the entire API schema to attackers, enabling targeted attacks. Deeply nested or batched queries can cause denial of service. Injection attacks in GraphQL can bypass traditional WAF rules.
#  
#  False positives may occur with legitimate development tools, GraphQL clients, or API documentation systems. Baseline normal GraphQL usage patterns.
#  
#  Triage steps: (1) Identify the source IP and GraphQL query, (2) Check if introspection should be enabled for this client, (3) Review query complexity and depth limits, (4) Disable introspection in production, implement query depth limiting, and validate all GraphQL inputs.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Look for GraphQL introspection and attacks
  | WHERE event.original RLIKE "(?i)(__schema|__type|IntrospectionQuery|query.*\\{.*\\{.*\\{.*\\{|mutation.*delete|mutation.*drop)"
  // Also check for GraphQL injection patterns
  | WHERE event.original RLIKE "(?i)(\\{.*\\}.*\\{.*\\}.*\\{|or\\s*1\\s*=\\s*1|union.*select.*from)"
  | STATS 
      graphql_count = COUNT(*),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  | WHERE graphql_count >= 3
  | EVAL risk_score = CASE(
      graphql_count >= 10, 85,
      graphql_count >= 5, 75,
      65
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - GraphQL
  - Introspection
  - API Security
  - Injection
severity: medium
risk_score: 72
references:
  - "https://attack.mitre.org/techniques/T1190/"
  - "https://cheatsheetseries.owasp.org/cheatsheets/GraphQL_Cheat_Sheet.html"
nist: ["AU-12", "AU-6", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["6.5"]
mitre_attack:
  TA0007:
    T1190: []