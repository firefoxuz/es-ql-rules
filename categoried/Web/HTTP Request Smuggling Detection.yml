rule_id: b431be8c-c2c3-47b0-94d0-14121c14dfd8
name: "HTTP Request Smuggling Detection"
description: |
  This rule detects potential HTTP request smuggling attempts by identifying conflicting Content-Length and Transfer-Encoding headers, multiple Content-Length headers, or suspicious chunked encoding patterns that can desynchronize front-end and back-end servers.
  
#  HTTP request smuggling exploits discrepancies in how front-end and back-end servers parse HTTP requests, allowing attackers to bypass security controls, poison caches, or hijack other users' requests.
#  
#  False positives may occur with legitimate HTTP/1.1 clients or proxies. Investigate carefully as this attack is complex and impactful.
#  
#  Triage steps: (1) Identify the source IP and request headers, (2) Check for discrepancies between Content-Length and Transfer-Encoding, (3) Review application behavior for request desynchronization, (4) Update HTTP parsers and implement strict request validation.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Look for request smuggling indicators
  | WHERE event.original RLIKE "(?i)(transfer-encoding:.*chunked.*content-length:|content-length:.*transfer-encoding:.*chunked)"
  // Check for multiple Content-Length headers
  | WHERE event.original RLIKE "(?i)(content-length:.*content-length:)"
  // Also catch malformed chunked encoding
  | WHERE event.original RLIKE "(?i)(transfer-encoding:.*chunked.*transfer-encoding:|\\r\\n0\\r\\n\\r\\n.*POST)"
  | STATS 
      smuggle_count = COUNT(*),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  | WHERE smuggle_count >= 1
  | EVAL risk_score = CASE(
      smuggle_count >= 3, 95,
      smuggle_count >= 2, 90,
      85
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - HTTP Request Smuggling
  - Protocol Manipulation
  - Cache Poisoning
  - Security Bypass
severity: critical
risk_score: 88
references:
  - "https://attack.mitre.org/techniques/T1190/"
  - "https://portswigger.net/web-security/request-smuggling"
nist: ["CM-7", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["6.5"]
mitre_attack:
  TA0005:
    T1190: []