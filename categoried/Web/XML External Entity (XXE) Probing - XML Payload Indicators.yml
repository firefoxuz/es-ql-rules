rule_id: d6b023e5-f6ac-4487-b50d-25aea9c0b681

name: "XML External Entity (XXE) Probing - XML Payload Indicators"
description: |
  This rule detects potential XML External Entity (XXE) injection attempts by identifying XML-related keywords in request payloads, particularly DOCTYPE declarations, ENTITY definitions, or file:// protocol references commonly used in XXE exploitation.
  
#  XXE attacks allow adversaries to read local files, perform SSRF, or cause denial of service. Detecting XXE probing helps prevent information disclosure and system compromise.
#  
#  False positives may occur with legitimate XML API usage or SOAP services. Focus on unusual entity declarations or suspicious file/protocol references.
#  
#  Triage steps: (1) Identify the source IP and request payload, (2) Check if the application processes XML input, (3) Review application logs for successful XXE exploitation indicators, (4) Implement XML parser hardening to disable external entities.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 15 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Look for XXE indicators in request bodies (URL-encoded or plain)
  | WHERE event.original RLIKE "(?i)(!DOCTYPE|!ENTITY|SYSTEM|file://|php://|expect://|%3C%21DOCTYPE|%3C%21ENTITY)"
  | STATS 
      xxe_count = COUNT(*),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  | WHERE xxe_count >= 1
  | EVAL risk_score = CASE(
      xxe_count >= 5, 95,
      xxe_count >= 3, 90,
      85
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - XXE
  - XML Injection
  - Exploitation
  - Information Disclosure
severity: critical
risk_score: 88
references:
  - "https://attack.mitre.org/techniques/T1190/"
  - "https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing"
nist: ["CM-7", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["6.5"]
mitre_attack:
  TA0001:
    T1190: []