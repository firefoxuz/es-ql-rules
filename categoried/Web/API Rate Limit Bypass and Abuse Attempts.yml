rule_id: c3f45395-e8ce-40f1-b8a9-c841c44cfd8d
name: "API Rate Limit Bypass and Abuse Attempts"
description: |
  This rule detects attempts to bypass API rate limiting by identifying rapid requests from single sources, distributed requests with similar patterns, user-agent rotation, IP rotation indicators, or requests with rate limit bypass headers (X-Forwarded-For manipulation).
  
#  API rate limit bypass can lead to brute force attacks, data harvesting, denial of service, or unauthorized access to resources. Monitoring for bypass attempts helps maintain API security.
#  
#  False positives may occur with legitimate high-volume API consumers, load balancers, or CDNs. Implement proper rate limiting and authentication.
#  
#  Triage steps: (1) Identify the request pattern and source, (2) Check if rate limits are properly enforced, (3) Review API usage for data scraping or abuse, (4) Implement robust rate limiting with proper client identification.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Look for API endpoint requests
  | WHERE event.original RLIKE "(?i)(/api/|/rest/|/graphql|/v[0-9]/)"
  | STATS 
      request_count = COUNT(*),
      unique_user_agents = COUNT_DISTINCT(SUBSTRING(event.original, 0, 100)),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  // Threshold: 100+ API requests in 10 minutes from one IP
  | WHERE request_count >= 100
  // Additional indicator: many different user agents suggests rotation
  | EVAL risk_score = CASE(
      request_count >= 200 AND unique_user_agents >= 5, 90,
      request_count >= 150, 85,
      request_count >= 100, 75,
      65
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - API Abuse
  - Rate Limit Bypass
  - Brute Force
  - Data Harvesting
severity: high
risk_score: 78
references:
  - "https://attack.mitre.org/techniques/T1110/"
  - "https://owasp.org/API-Security/editions/2023/en/0xa4-unrestricted-resource-consumption/"
nist: ["AC-14", "IA-1", "IA-10", "IA-11", "IA-2", "IA-3", "IA-5", "IA-8", "IA-9", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["6.5"]
mitre_attack:
  TA0009:
    T1213: []