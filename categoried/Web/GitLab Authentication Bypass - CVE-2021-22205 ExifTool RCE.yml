rule_id: fb012c97-9c9e-42e9-839f-57f6f441bfad
name: "GitLab Authentication Bypass - CVE-2021-22205 ExifTool RCE"
description: |
  This rule detects attempts to exploit GitLab authentication bypass and RCE vulnerability (CVE-2021-22205) through malicious image upload with crafted EXIF data. Attackers exploit ExifTool to achieve unauthenticated remote code execution.
  
#  This vulnerability affects GitLab Community and Enterprise editions and has been exploited in ransomware attacks and cryptocurrency mining campaigns.
#  
#  False positives may occur with legitimate image uploads or security testing. Monitor for suspicious file upload patterns.
#  
#  Triage steps: (1) Identify the source IP and uploaded file, (2) Check GitLab version for vulnerability, (3) Search for webshells or backdoors in GitLab directories, (4) Update GitLab to patched version, (5) Review repositories for unauthorized access or data theft.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Look for GitLab upload endpoints with suspicious patterns
  | WHERE event.original RLIKE "(?i)(/uploads/|/api/v4/projects.*upload|multipart/form-data)"
  // Check for ExifTool exploitation indicators
  | WHERE event.original RLIKE "(?i)(DjVu|AT&TFORM|image/svg\\+xml|eval.*\\(|system\\(|exec\\()"
  | STATS 
      upload_count = COUNT(*),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  | WHERE upload_count >= 1
  | EVAL risk_score = CASE(
      upload_count >= 5, 95,
      upload_count >= 3, 92,
      88
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - GitLab
  - CVE-2021-22205
  - ExifTool
  - RCE
  - Critical
severity: critical
risk_score: 93
references:
  - "https://attack.mitre.org/techniques/T1190/"
  - "https://nvd.nist.gov/vuln/detail/CVE-2021-22205"
  - "https://about.gitlab.com/releases/2021/04/14/security-release-gitlab-13-10-3-released/"
nist: ["AU-6", "SI-4"]
gdpr: ["Article 32", "Article 33"]
pci_dss: ["6.2"]
mitre_attack:
  TA0001:
    T1190: []