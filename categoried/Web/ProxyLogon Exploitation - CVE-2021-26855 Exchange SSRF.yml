rule_id: c34d40cd-24f7-413c-aed7-711bfd55389b
name: "ProxyLogon Exploitation - CVE-2021-26855 Exchange SSRF"
description: |
  This rule detects attempts to exploit ProxyLogon vulnerabilities (CVE-2021-26855, CVE-2021-26857, CVE-2021-26858, CVE-2021-27065) in Microsoft Exchange Server by identifying suspicious EWS, OAB, and ECP requests with SSRF patterns.
  
#  ProxyLogon allows unauthenticated attackers to perform SSRF attacks against Exchange servers, leading to authentication bypass and remote code execution. It was heavily exploited by nation-state actors.
#  
#  False positives are minimal. Any detection requires immediate investigation.
#  
#  Triage steps: (1) Identify the source IP and target endpoint, (2) Check for webshells in Exchange virtual directories, (3) Review Exchange logs for suspicious mailbox access, (4) Patch Exchange servers immediately, (5) Hunt for persistence mechanisms and lateral movement.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Look for ProxyLogon SSRF patterns
  | WHERE event.original RLIKE "(?i)(/owa/auth/.*\\.js|/ecp/.*DDI.*SetObject|X-AnonResource-Backend:|X-BEResource:|autodiscover.*xml.*GetFederationInformation)"
  // Also check for cookie manipulation patterns
  | WHERE event.original RLIKE "(?i)(Cookie:.*X-AnonResource|Cookie:.*X-BEResource)"
  | STATS 
      exploit_count = COUNT(*),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  | WHERE exploit_count >= 1
  | EVAL risk_score = CASE(
      exploit_count >= 3, 98,
      exploit_count >= 2, 95,
      92
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - ProxyLogon
  - CVE-2021-26855
  - Exchange Server
  - SSRF
  - Critical
severity: critical
risk_score: 97
references:
  - "https://attack.mitre.org/techniques/T1190/"
  - "https://nvd.nist.gov/vuln/detail/CVE-2021-26855"
  - "https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/"
nist: ["AU-6", "SI-4"]
gdpr: ["Article 32", "Article 33"]
pci_dss: ["6.2"]
mitre_attack:
  TA0001:
    T1190: []