rule_id: 868e0b22-5051-44a3-a71a-1412a90e1a79

name: "Apache HTTP Server Path Traversal - CVE-2021-41773"
description: |
  This rule detects attempts to exploit Apache HTTP Server path traversal and RCE vulnerabilities (CVE-2021-41773, CVE-2021-42013) by identifying encoded path traversal sequences and CGI execution attempts in URI paths.
  
#  These vulnerabilities allow unauthenticated attackers to read arbitrary files or execute commands on Apache servers with specific configurations (mod_cgi enabled).
#  
#  False positives may occur with legitimate file access patterns or security scanning. Focus on encoded traversal attempts and CGI execution.
#  
#  Triage steps: (1) Identify the source IP and requested path, (2) Check Apache version and mod_cgi configuration, (3) Review access logs for successful file disclosure or command execution, (4) Update Apache to patched version, (5) Disable mod_cgi if not required.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Look for encoded path traversal patterns
  | WHERE event.original RLIKE "(?i)(\\.\\./|%2e%2e/|%2e%2e%2f|\\.\\.%2f)"
  // Check for CGI execution attempts
  | WHERE event.original RLIKE "(?i)(/cgi-bin/.*\\.\\./|/icons/.*\\.\\./|echo;|/bin/(sh|bash)|POST.*\\.\\./)"
  | STATS 
      exploit_count = COUNT(*),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  | WHERE exploit_count >= 2
  | EVAL risk_score = CASE(
      exploit_count >= 5, 95,
      exploit_count >= 3, 90,
      85
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - Apache HTTP Server
  - CVE-2021-41773
  - Path Traversal
  - RCE
  - Critical
severity: critical
risk_score: 92
references:
  - "https://attack.mitre.org/techniques/T1190/"
  - "https://nvd.nist.gov/vuln/detail/CVE-2021-41773"
  - "https://httpd.apache.org/security/vulnerabilities_24.html"
nist: ["AU-6", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["6.2"]
mitre_attack:
  TA0001:
    T1190: []
