rule_id: 578e04f5-2490-4135-94b6-2aa0fd907b2e
name: "NoSQL Injection - MongoDB and Other NoSQL Databases"
description: |
  This rule detects NoSQL injection attempts targeting MongoDB and other NoSQL databases by identifying operator injection patterns ($ne, $gt, $where, etc.), JavaScript injection in queries, and authentication bypass attempts specific to NoSQL syntax.
  
#  NoSQL injection can bypass authentication, extract sensitive data, or execute arbitrary JavaScript code on database servers. It affects MongoDB, CouchDB, and other NoSQL platforms.
#  
#  False positives may occur with legitimate NoSQL queries in API parameters or JSON payloads. Baseline normal query patterns.
#  
#  Triage steps: (1) Identify the source IP and injection payload, (2) Check if the application uses NoSQL databases, (3) Review database logs for successful injection or data extraction, (4) Implement input validation and use parameterized queries for NoSQL.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Look for NoSQL injection patterns
  | WHERE event.original RLIKE "(?i)(\\$ne:|\\$gt:|\\$lt:|\\$gte:|\\$lte:|\\$in:|\\$nin:|\\$where:|\\$regex:|\\$exists:)"
  // Also check for authentication bypass patterns
  | WHERE event.original RLIKE "(?i)(password.*\\[\\$ne\\]|username.*\\[\\$ne\\]|\\{\\s*\\$ne\\s*:|\\{\\s*\\$gt\\s*:)"
  | STATS 
      nosql_count = COUNT(*),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  | WHERE nosql_count >= 2
  | EVAL risk_score = CASE(
      nosql_count >= 5, 90,
      nosql_count >= 3, 85,
      75
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - NoSQL Injection
  - MongoDB
  - Authentication Bypass
  - Database Attack
severity: high
risk_score: 85
references:
  - "https://attack.mitre.org/techniques/T1190/"
  - "https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/05.6-Testing_for_NoSQL_Injection"
nist: ["CM-7", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["6.5"]
mitre_attack:
  TA0001:
    T1190: []