rule_id: 5aec10ab-1bfd-468c-8f6a-70d3d8cd3754
name: "Shellshock Exploitation - CVE-2014-6271 Bash CGI Attack"
description: |
  This rule detects attempts to exploit the Shellshock vulnerability (CVE-2014-6271) in Bash through CGI scripts by identifying malicious function definitions in HTTP headers, particularly User-Agent, Referer, and custom headers. The vulnerability allows command injection through environment variables.
  
#  Despite being an older vulnerability, Shellshock remains exploited against legacy systems and IoT devices. It provides immediate remote code execution on vulnerable systems.
#  
#  False positives are rare and typically limited to security scanning or research. Treat all detections seriously.
#  
#  Triage steps: (1) Identify the source IP and targeted CGI script, (2) Check if the system uses vulnerable Bash versions, (3) Review system logs for successful command execution, (4) Patch Bash immediately, (5) Disable unused CGI scripts.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Look for Shellshock exploitation patterns in headers
  | WHERE event.original RLIKE "(?i)(\\(\\)\\s*\\{|%28%29%20%7B|\\(\\)\\s*%7B.*:;|\\}\\s*;|bash.*-c)"
  // Catch common Shellshock payloads
  | WHERE event.original RLIKE "(?i)(/bin/(bash|sh).*-c|/bin/wget|/bin/curl|cat\\s+/etc/passwd)"
  | STATS 
      exploit_count = COUNT(*),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  | WHERE exploit_count >= 1
  | EVAL risk_score = CASE(
      exploit_count >= 3, 95,
      exploit_count >= 2, 90,
      85
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - Shellshock
  - CVE-2014-6271
  - Bash
  - CGI
  - RCE
severity: critical
risk_score: 90
references:
  - "https://attack.mitre.org/techniques/T1190/"
  - "https://nvd.nist.gov/vuln/detail/CVE-2014-6271"
  - "https://www.cisa.gov/news-events/alerts/2014/09/26/bash-shellshock-vulnerability"
nist: ["AU-6", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["6.2"]
mitre_attack:
  TA0001:
    T1190: []