rule_id: 5fdfff7c-dea1-4209-85a5-7b9aa4f3f1d3
name: "Excessive 5xx Server Errors After External Access - Application Crash"
description: |
  This rule detects a spike in HTTP 5xx server errors (500, 502, 503) from external sources, particularly following probing or exploitation attempts. High 5xx rates may indicate successful denial of service, application crashes from exploitation, or resource exhaustion.
  
#  Server error spikes after external access can indicate successful exploitation causing application instability or deliberate DoS attacks. Monitoring error rates helps detect impact.
#  
#  False positives may occur during legitimate traffic spikes, deployments, or infrastructure issues. Correlate with application health metrics and deployment schedules.
#  
#  Triage steps: (1) Identify the source IPs causing errors and the affected endpoints, (2) Review application logs for crash causes, (3) Check for exploitation attempts preceding the errors, (4) Investigate for DoS attacks or resource exhaustion.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 15 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Heuristic: look for 5xx status codes in event.original
  | WHERE event.original RLIKE "(?i)(\\s50[0-9]\\s|status.*50[0-9]|internal.*server.*error|bad.*gateway|service.*unavailable)"
  | STATS 
      error_count = COUNT(*),
      unique_endpoints = COUNT_DISTINCT(SUBSTRING(event.original, 0, 100)),
      sample_errors = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  // Threshold: 10+ server errors from external source
  | WHERE error_count >= 10
  | EVAL risk_score = CASE(
      error_count >= 30, 90,
      error_count >= 20, 80,
      70
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - HTTP 5xx
  - Server Error
  - DoS
  - Application Crash
severity: high
risk_score: 76
references:
  - "https://attack.mitre.org/techniques/T1499/"
nist: ["AU-6", "IR-4", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["10.6"]
mitre_attack:
  TA0040:
    T1499: []
