rule_id: f91a86dc-81b8-4f33-9f62-35cc63a31f64

name: "ProxyShell Exploitation - CVE-2021-34473 Exchange Server Attack"
description: |
  This rule detects attempts to exploit ProxyShell vulnerabilities (CVE-2021-34473, CVE-2021-34523, CVE-2021-31207) in Microsoft Exchange Server by identifying suspicious autodiscover requests with path traversal and PowerShell remoting patterns.
  
#  ProxyShell is a chain of vulnerabilities allowing unauthenticated attackers to execute arbitrary code on Exchange servers. It has been widely exploited for ransomware deployment and data theft.
#  
#  False positives are rare and typically limited to security scanning. Any detection should be treated as high priority.
#  
#  Triage steps: (1) Identify the source IP and request path, (2) Check Exchange server logs for successful exploitation, (3) Search for webshells in Exchange directories (OAB, aspnet_client), (4) Apply Exchange security updates immediately, (5) Review for data exfiltration or lateral movement.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Look for ProxyShell exploitation patterns
  | WHERE event.original RLIKE "(?i)(/autodiscover/autodiscover\\.json.*\\.\\./|/autodiscover/.*Email=autodiscover/autodiscover|/mapi/nspi|X-Rps-CAT:|powershell.*remoting)"
  | STATS 
      exploit_count = COUNT(*),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  | WHERE exploit_count >= 1
  | EVAL risk_score = CASE(
      exploit_count >= 3, 98,
      exploit_count >= 2, 95,
      92
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - ProxyShell
  - CVE-2021-34473
  - Exchange Server
  - RCE
  - Critical
severity: critical
risk_score: 96
references:
  - "https://attack.mitre.org/techniques/T1190/"
  - "https://nvd.nist.gov/vuln/detail/CVE-2021-34473"
  - "https://www.microsoft.com/en-us/security/blog/2021/08/05/proxyshell-vulnerabilities-and-your-exchange-server/"
nist: ["AU-6", "SI-4"]
gdpr: ["Article 32", "Article 33"]
pci_dss: ["6.2"]
mitre_attack:
  TA0001:
    T1190: []