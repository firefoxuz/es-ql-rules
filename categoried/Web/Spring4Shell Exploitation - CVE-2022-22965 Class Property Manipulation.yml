rule_id: f7efe8d2-6f9a-40eb-a43e-2ed80ae3157e

name: "Spring4Shell Exploitation - CVE-2022-22965 Class Property Manipulation"
description: |
  This rule detects attempts to exploit the Spring4Shell vulnerability (CVE-2022-22965) in Spring Framework by identifying suspicious class property manipulation patterns in HTTP parameters. Attackers use class.module.classLoader.resources.context parameters to achieve remote code execution on Tomcat servers.
  
#  Spring4Shell is a critical RCE vulnerability affecting Spring Framework applications running on Tomcat. It allows attackers to write webshells and execute arbitrary code.
#  
#  False positives may occur with legitimate Spring Framework parameter binding or security testing. Focus on external sources and unusual parameter combinations.
#  
#  Triage steps: (1) Identify the source IP and request parameters, (2) Check if the application uses vulnerable Spring Framework versions, (3) Search for webshells in application directories, (4) Update Spring Framework to patched versions, (5) Review access logs for successful exploitation.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Look for Spring4Shell exploitation patterns
  | WHERE event.original RLIKE "(?i)(class\\.module\\.classLoader|class\\.classLoader|classLoader\\.resources|tomcatLogPath|suffix=\\.jsp|pattern=%25|AccessLogValve)"
  | STATS 
      exploit_count = COUNT(*),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  | WHERE exploit_count >= 1
  | EVAL risk_score = CASE(
      exploit_count >= 3, 98,
      exploit_count >= 2, 95,
      92
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - Spring4Shell
  - CVE-2022-22965
  - RCE
  - Spring Framework
  - Critical
severity: critical
risk_score: 95
references:
  - "https://attack.mitre.org/techniques/T1190/"
  - "https://nvd.nist.gov/vuln/detail/CVE-2022-22965"
  - "https://spring.io/blog/2022/03/31/spring-framework-rce-early-announcement"
nist: ["AU-6", "SI-4"]
gdpr: ["Article 32", "Article 33"]
pci_dss: ["6.2"]
mitre_attack:
  TA0001:
    T1190: []