rule_id: 41c891f4-c1f4-4b86-a645-6d4f6a0bac40
name: "Log4Shell Exploitation Attempt - CVE-2021-44228 JNDI Injection"
description: |
  This rule detects attempts to exploit the Log4Shell vulnerability (CVE-2021-44228) in Apache Log4j by identifying JNDI lookup syntax in HTTP requests. The vulnerability allows remote code execution through specially crafted JNDI strings in log messages. Common patterns include ${jndi:ldap://}, ${jndi:rmi://}, ${jndi:dns://}, and obfuscated variants.
  
#  Log4Shell is one of the most critical vulnerabilities in recent history, affecting millions of systems worldwide. It allows unauthenticated remote code execution with minimal effort. Early detection prevents complete system compromise.
#  
#  False positives are rare but may occur with security scanning, penetration testing, or discussions of the vulnerability in documentation. Focus on external sources and production systems.
#  
#  Triage steps: (1) Identify the source IP and target endpoint, (2) Check if the application uses Log4j and is vulnerable, (3) Review subsequent activity for successful exploitation (reverse shells, data exfiltration), (4) Immediately patch Log4j to version 2.17.1 or higher, (5) Block the source IP and investigate for IoCs.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Look for JNDI injection patterns in requests (URL-encoded and plain)
  | WHERE event.original RLIKE "(?i)(\\$\\{jndi:|%24%7Bjndi:|\\$%7Bjndi|jndi:ldap://|jndi:rmi://|jndi:dns://|jndi:ldaps://|jndi:iiop://|jndi:corba://|jndi:nis://|jndi:nds://)"
  // Also catch obfuscated variants: ${${::-j}ndi:, ${${lower:j}ndi:, etc.
  | WHERE event.original RLIKE "(?i)(\\$\\{\\$\\{.*j.*n.*d.*i|\\$\\{lower:|\\$\\{upper:|\\$\\{::-|\\$\\{env:|\\$\\{sys:)"
  | STATS 
      exploit_count = COUNT(*),
      unique_payloads = COUNT_DISTINCT(SUBSTRING(event.original, 0, 100)),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  | WHERE exploit_count >= 1
  | EVAL risk_score = CASE(
      exploit_count >= 5, 100,
      exploit_count >= 3, 98,
      95
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - Log4Shell
  - CVE-2021-44228
  - RCE
  - JNDI Injection
  - Critical
severity: critical
risk_score: 100
references:
  - "https://attack.mitre.org/techniques/T1190/"
  - "https://nvd.nist.gov/vuln/detail/CVE-2021-44228"
  - "https://www.lunasec.io/docs/blog/log4j-zero-day/"
nist: ["AU-6", "CA-7", "IR-4", "IR-5", "PE-6", "RA-5", "SI-4"]
gdpr: ["Article 32", "Article 33"]
pci_dss: ["6.2", "11.4"]
mitre_attack:
  TA0001:
    T1190: []
