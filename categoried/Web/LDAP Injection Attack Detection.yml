rule_id: 3b1ed4da-86f3-42ac-b222-0db005f10e7d

name: "LDAP Injection Attack Detection"
description: |
  This rule detects LDAP injection attempts by identifying LDAP filter metacharacters and injection patterns in HTTP parameters. Attackers use LDAP injection to bypass authentication, extract sensitive directory information, or modify LDAP entries.
  
#  LDAP injection can lead to authentication bypass, privilege escalation, and sensitive data disclosure from directory services like Active Directory.
#  
#  False positives may occur with legitimate LDAP queries or special characters in user input. Focus on injection patterns and authentication bypass attempts.
#  
#  Triage steps: (1) Identify the source IP and injection payload, (2) Check if the application uses LDAP for authentication or queries, (3) Review authentication logs for bypass attempts, (4) Implement parameterized LDAP queries and input validation.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Look for LDAP injection patterns
  | WHERE event.original RLIKE "(?i)(\\*\\)\\(|\\*\\)\\(\\||\\)\\(\\||%2A%29%28|%2A%29%28%7C|objectClass=\\*)"
  // Also check for LDAP filter bypass patterns
  | WHERE event.original RLIKE "(?i)(\\(cn=\\*\\)|\\(uid=\\*\\)|\\(mail=\\*\\)|\\)\\(&|admin\\)\\(|\\)\\)\\))"
  | STATS 
      ldap_count = COUNT(*),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  | WHERE ldap_count >= 2
  | EVAL risk_score = CASE(
      ldap_count >= 5, 90,
      ldap_count >= 3, 80,
      70
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - LDAP Injection
  - Authentication Bypass
  - Directory Services
  - Injection
severity: high
risk_score: 82
references:
  - "https://attack.mitre.org/techniques/T1190/"
  - "https://owasp.org/www-community/attacks/LDAP_Injection"
nist: ["CM-7", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["6.5"]
mitre_attack:
  TA0006:
    T1078: []