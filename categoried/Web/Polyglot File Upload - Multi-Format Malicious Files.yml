rule_id: f93c69af-b59b-4083-9e43-1f6f80d93cba
name: "Polyglot File Upload - Multi-Format Malicious Files"
description: |
  This rule detects uploads of polyglot files that are valid in multiple formats (e.g., valid JPEG and PHP simultaneously) by identifying suspicious file headers, magic bytes manipulation, or files combining image and executable formats.
  
#  Polyglot files bypass simple file type validation by appearing legitimate while containing malicious code. They are commonly used to upload webshells disguised as images.
#  
#  False positives are rare but may occur with corrupted files or specialized file formats. Investigate all detections.
#  
#  Triage steps: (1) Analyze the uploaded file structure and contents, (2) Check for embedded PHP, ASP, or other executable code in image files, (3) Scan with multiple antivirus engines, (4) Implement deep content inspection for file uploads.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Look for upload requests with polyglot indicators
  | WHERE event.original RLIKE "(?i)(/upload|multipart/form-data)"
  // Check for suspicious patterns: image headers mixed with code
  | WHERE event.original RLIKE "(?i)(GIF89.*<\\?php|JFIF.*<\\?php|PNG.*<\\?php|FFD8FF.*eval\\()"
  // Also catch common polyglot techniques
  | WHERE event.original RLIKE "(?i)(__halt_compiler\\(\\)|<?php.*GIF89|<?php.*FFD8)"
  | STATS 
      polyglot_count = COUNT(*),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  | WHERE polyglot_count >= 1
  | EVAL risk_score = CASE(
      polyglot_count >= 3, 95,
      polyglot_count >= 2, 92,
      88
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - Polyglot File
  - File Upload
  - Webshell
  - Advanced Evasion
severity: critical
risk_score: 92
references:
  - "https://attack.mitre.org/techniques/T1027/"
  - "https://github.com/Polydet/polyglot-database"
nist: ["AU-6", "SI-4"]
gdpr: ["Article 32", "Article 33"]
pci_dss: ["6.5"]
mitre_attack:
  TA0005:
    T1027: []