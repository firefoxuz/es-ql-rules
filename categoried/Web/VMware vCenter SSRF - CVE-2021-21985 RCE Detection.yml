rule_id: e403ac43-3ec2-44d6-b0d5-fd0e1c86fd3c

name: "VMware vCenter SSRF - CVE-2021-21985 RCE Detection"
description: |
  This rule detects attempts to exploit VMware vCenter Server SSRF vulnerabilities (CVE-2021-21985, CVE-2021-22005) by identifying suspicious requests to vCenter API endpoints with SSRF or deserialization patterns. These vulnerabilities allow unauthenticated RCE on vCenter servers.
  
#  vCenter exploitation provides attackers with complete control over virtual infrastructure, making it a critical target for ransomware and espionage operations.
#  
#  False positives may occur with legitimate vCenter API usage or monitoring tools. Focus on external sources and unusual request patterns.
#  
#  Triage steps: (1) Identify the source IP and API endpoint, (2) Check vCenter logs for successful authentication bypass, (3) Search for webshells or backdoors on vCenter appliance, (4) Apply VMware security patches immediately, (5) Review virtual infrastructure for unauthorized changes.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Look for vCenter exploitation patterns
  | WHERE event.original RLIKE "(?i)(/ui/vropspluginui/rest/services/|/ui/h5-vsan/rest/|/analytics/telemetry/ph/api/)"
  // Also check for deserialization payloads
  | WHERE event.original RLIKE "(?i)(java\\.lang\\.ProcessBuilder|java\\.lang\\.Runtime|rO0AB|aced0005)"
  | STATS 
      exploit_count = COUNT(*),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  | WHERE exploit_count >= 1
  | EVAL risk_score = CASE(
      exploit_count >= 3, 98,
      exploit_count >= 2, 95,
      92
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - VMware vCenter
  - CVE-2021-21985
  - SSRF
  - RCE
  - Critical
severity: critical
risk_score: 96
references:
  - "https://attack.mitre.org/techniques/T1190/"
  - "https://nvd.nist.gov/vuln/detail/CVE-2021-21985"
  - "https://www.vmware.com/security/advisories/VMSA-2021-0010.html"
nist: ["AU-6", "SI-4"]
gdpr: ["Article 32", "Article 33"]
pci_dss: ["6.2"]
mitre_attack:
  TA0001:
    T1190: []