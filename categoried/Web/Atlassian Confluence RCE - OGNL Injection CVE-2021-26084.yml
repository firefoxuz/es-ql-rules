rule_id: 1617d50f-cc90-46db-8d49-dafe1bf0f973

name: "Atlassian Confluence RCE - OGNL Injection CVE-2021-26084"
description: |
  This rule detects attempts to exploit Atlassian Confluence OGNL injection vulnerability (CVE-2021-26084) by identifying OGNL expressions in requests to vulnerable endpoints, particularly in createpage.action and other Confluence WebWork actions.
  
#  This vulnerability allows unauthenticated attackers to execute arbitrary code on Confluence servers and has been actively exploited for cryptocurrency mining, ransomware, and data theft.
#  
#  False positives are minimal. Any detection on Confluence servers should be investigated immediately.
#  
#  Triage steps: (1) Identify the source IP and request payload, (2) Check Confluence version for vulnerability, (3) Search for webshells in Confluence directories, (4) Update Confluence to patched version, (5) Review for unauthorized page creation or data access.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Look for Confluence OGNL injection patterns
  | WHERE event.original RLIKE "(?i)(/pages/createpage\\.action|/pages/doenterpagelayout\\.action|queryString=.*ognl)"
  // Check for OGNL payload indicators
  | WHERE event.original RLIKE "(?i)(@java\\.lang|ProcessBuilder|Runtime\\.getRuntime|Class\\.forName|\\$\\{.*\\})"
  | STATS 
      exploit_count = COUNT(*),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  | WHERE exploit_count >= 1
  | EVAL risk_score = CASE(
      exploit_count >= 3, 98,
      exploit_count >= 2, 95,
      92
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - Confluence
  - CVE-2021-26084
  - OGNL Injection
  - RCE
  - Critical
severity: critical
risk_score: 94
references:
  - "https://attack.mitre.org/techniques/T1190/"
  - "https://nvd.nist.gov/vuln/detail/CVE-2021-26084"
  - "https://confluence.atlassian.com/doc/confluence-security-advisory-2021-08-25-1077906215.html"
nist: ["AU-6", "SI-4"]
gdpr: ["Article 32", "Article 33"]
pci_dss: ["6.2"]
mitre_attack:
  TA0001:
    T1190: []