rule_id: ea219fe0-d0a2-458a-9cdf-556a95f05f2f
name: "HTML5 PostMessage Origin Validation Bypass"
description: |
  This rule detects potential HTML5 postMessage exploitation attempts by identifying JavaScript code injection in parameters that could be reflected in postMessage handlers, or requests attempting to load malicious iframes for postMessage exploitation.
  
#  Improper postMessage origin validation can allow attackers to inject malicious JavaScript, steal sensitive data, or perform actions on behalf of users through cross-origin communication vulnerabilities.
#  
#  False positives may occur with legitimate cross-origin integrations, widgets, or embedded content. Review postMessage usage carefully.
#  
#  Triage steps: (1) Identify the source and injection payload, (2) Check if the application uses postMessage for cross-origin communication, (3) Review origin validation implementation, (4) Implement strict origin validation for postMessage handlers.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - filebeat-nginx-access-*
  - filebeat-nginx-error-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-nginx-error-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  // Look for postMessage-related patterns and JavaScript injection
  | WHERE event.original RLIKE "(?i)(postMessage|window\\.parent\\.postMessage|window\\.opener\\.postMessage)"
  // Check for JavaScript injection in parameters
  | WHERE event.original RLIKE "(?i)(<script|<iframe|javascript:|data:text/html|eval\\(|setTimeout\\()"
  | STATS 
      postmsg_count = COUNT(*),
      sample_requests = VALUES(SUBSTRING(event.original, 0, 160))
    BY srcip, hostn
  | WHERE postmsg_count >= 2
  | EVAL risk_score = CASE(
      postmsg_count >= 5, 80,
      postmsg_count >= 3, 70,
      60
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - PostMessage
  - HTML5
  - Cross-Origin
  - JavaScript Injection
severity: medium
risk_score: 68
references:
  - "https://attack.mitre.org/techniques/T1189/"
  - "https://portswigger.net/web-security/dom-based/postmessage"
nist: ["AU-12", "AU-6", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["6.5"]
mitre_attack:
  TA0001:
    T1189: []