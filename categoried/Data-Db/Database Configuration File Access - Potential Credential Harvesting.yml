rule_id: ddd1d527-62bb-4982-8082-ef150de5adb0

name: "Database Configuration File Access - Potential Credential Harvesting"
description: |
  This rule detects access to database configuration files (my.cnf, postgresql.conf, tnsnames.ora, mongod.conf, etc.) which often contain database credentials, connection strings, or sensitive settings. Adversaries may read these files to harvest credentials.
  
#  Configuration files are high-value targets for credential access. Monitoring file access helps detect reconnaissance and credential harvesting attempts.
#  
#  False positives may occur with legitimate administrative activities or configuration management tools. Focus on unexpected users or processes.
#  
#  Triage steps: (1) Identify the user and process accessing the file, (2) Verify if access is documented and authorized, (3) Check if credentials in the file have been changed recently, (4) Rotate credentials if unauthorized access occurred.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - auditbeat-*
  - winlogbeat-*
query_language: esql
query: |
  FROM auditbeat-*, winlogbeat-*
  | WHERE @timestamp >= NOW() - 15 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL userp = COALESCE(user.name, winlog.event_data.SubjectUserName)
  | EVAL filepath = COALESCE(file.path, event.original)
  | EVAL procname = COALESCE(process.name, winlog.event_data.NewProcessName)
  // Look for database config file access
  | WHERE filepath RLIKE "(?i)(my\\.cnf|postgresql\\.conf|pg_hba\\.conf|tnsnames\\.ora|mongod\\.conf|redis\\.conf|cassandra\\.yaml|mssql.*\\.conf)"
         OR event.original RLIKE "(?i)(my\\.cnf|postgresql\\.conf|tnsnames\\.ora|mongod\\.conf|redis\\.conf)"
  // Filter for file access events
  | WHERE event.action RLIKE "(?i)(read|open|access|view)" OR event.category == "file"
  | STATS 
      access_count = COUNT(*),
      unique_users = COUNT_DISTINCT(userp),
      sample_files = VALUES(SUBSTRING(filepath, 0, 160))
    BY hostn, userp, procname
  | WHERE access_count >= 1
  | EVAL risk_score = CASE(
      access_count >= 5, 85,
      access_count >= 3, 75,
      70
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - Database
  - Configuration File
  - Credential Access
  - Discovery
severity: high
risk_score: 76
references:
  - "https://attack.mitre.org/techniques/T1552/001/"
nist: ["AC-4", "AC-5", "AC-6", "AU-13", "PE-19", "PS-6", "SC-7", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["8.2"]
mitre_attack:
  TA0006:
    T1552: ["T1552.001"]