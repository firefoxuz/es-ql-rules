rule_id: 5b34321e-508a-4625-ae61-6fbba5577c35
name: "Large Data Export from Database - Bulk Query Indicators"
description: |
  This rule identifies bulk data export operations from databases that could indicate exfiltration. It detects commands like "SELECT INTO OUTFILE", "COPY TO", "pg_dump", "mysqldump", "bcp", or export utilities being executed. The rule also flags large result set queries (SELECT with broad wildcards on sensitive tables). The rule triggers when 3+ data export indicators are detected within 15 minutes.

#  **Why it matters:**
#  Bulk data exports are the final stage of data theft operations:
#  - GDPR Article 33 requires breach notification for personal data exfiltration
#  - PCI DSS 10.2.1 mandates detection of cardholder data access and export
#  - NIST SP 800-53 AU-6 requires analysis of audit records for signs of data theft
#
#  **False Positives:**
#  - Scheduled database backups using legitimate export utilities
#  - Business intelligence teams exporting data for analysis or reporting
#  - Data warehouse ETL processes performing bulk data transfers
#  - Database migration or replication activities
#
#  **Triage Steps:**
#  1. Identify the user or service account performing the export
#  2. Determine what data was exported - table names, record counts, data types
#  3. Check destination paths for export files - local storage or remote shares?
#  4. Verify if export was authorized through change management or data access request
#  5. Review network logs for file transfers or uploads following the export
#  6. Classify data sensitivity and initiate breach response if unauthorized
type: esql
params: '{}'
schedule_interval: 15m
index:
  - auditbeat-*
  - winlogbeat-*
query_language: esql
query: |
  FROM auditbeat-*, winlogbeat-*
  // Time window: last 15 minutes
  | WHERE @timestamp >= NOW() - 15 minutes
  // Process execution or database activity
  | WHERE event.code == "4688" OR event.category == "database" OR event.action RLIKE ".*(exec|executed).*"
  // Extract command
  | EVAL cmd = COALESCE(process.command_line, winlog.event_data.CommandLine, event.original)
  | EVAL hostname = COALESCE(host.name, winlog.computer_name)
  | EVAL username = COALESCE(user.name, winlog.event_data.SubjectUserName)
  | WHERE cmd IS NOT NULL AND hostname IS NOT NULL
  // Data export patterns
  | WHERE cmd RLIKE ".*(SELECT.*INTO OUTFILE|COPY.*TO '|pg_dump|mysqldump|bcp |sqlcmd.*-o |BACKUP DATABASE|EXPORT DATA|SELECT \\* FROM.*(users|customers|payments|personal)).*"
  // Aggregate by user and host
  | STATS 
      export_ops = COUNT(*),
      sample_commands = VALUES(SUBSTRING(cmd, 0, 150))
    BY username, hostname
  // Threshold: 3+ export operations
  | WHERE export_ops >= 3
  // Risk scoring
  | EVAL risk_score = CASE(
      export_ops >= 10, 95,
      export_ops >= 5, 85,
      75
    )
  | KEEP username, hostname, export_ops, risk_score, sample_commands
enabled: false
tags:
  - Data Exfiltration
  - Database
  - Data Export
  - Privacy
  - Insider Threat
severity: high
risk_score: 85
references:
  - "https://attack.mitre.org/techniques/T1048/"
  - "https://attack.mitre.org/techniques/T1567/"
nist: ["AC-3", "AU-6", "SI-4"]
gdpr: ["Article 32", "Article 33"]
pci_dss: ["10.2.1", "10.3"]
mitre_attack:
  TA0010:
    T1048: []