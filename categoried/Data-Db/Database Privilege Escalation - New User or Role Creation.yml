rule_id: 30065423-c566-4e37-b04d-b080af04456f
name: "Database Privilege Escalation - New User or Role Creation"
description: |
  This rule detects creation of new database users or roles with elevated privileges. It looks for database administrative commands like CREATE USER, GRANT ALL, ALTER ROLE, or similar privilege assignment operations in audit logs. The detection focuses on identifying unauthorized privilege escalation within database management systems. The rule triggers when 2+ database user/role modification events occur within 10 minutes.

#  **Why it matters:**
#  Unauthorized database privilege escalation can lead to data breaches:
#  - NIST SP 800-53 AC-2/AC-6 require monitoring of account and privilege management
#  - PCI DSS 7.1/7.2 mandate strict control over privileged database access
#  - GDPR Article 32 requires safeguards against unauthorized privilege elevation
#
#  **False Positives:**
#  - Database administrators creating legitimate user accounts or roles
#  - Application deployment scripts provisioning database access
#  - Automated user provisioning systems integrated with identity management
#  - Database maintenance or migration activities requiring temporary privileges
#
#  **Triage Steps:**
#  1. Identify who created the new user/role and their authorization level
#  2. Review the specific privileges granted - full admin or limited access?
#  3. Check if the action was logged in change management or ticketing systems
#  4. Verify if the new account/role has been used and what data it accessed
#  5. Review database audit logs for other suspicious activities from the same user
#  6. Revoke unauthorized privileges and investigate compromise scope
type: esql
params: '{}'
schedule_interval: 10m
index:
  - auditbeat-*
query_language: esql
query: |
  FROM auditbeat-*
  // Time window: last 10 minutes
  | WHERE @timestamp >= NOW() - 10 minutes
  // Database audit events or command execution
  | WHERE event.category == "database" OR event.action RLIKE ".*(query|executed).*"
  // Extract command from logs
  | EVAL cmd = COALESCE(event.original, "")
  | EVAL hostname = COALESCE(host.name, "")
  | EVAL username = COALESCE(user.name, "")
  | WHERE hostname IS NOT NULL
  // Database privilege operations
  | WHERE cmd RLIKE ".*(CREATE USER|CREATE ROLE|GRANT ALL|GRANT SELECT|ALTER ROLE|ALTER USER|ADD USER|sp_addrolemember|db_owner|sysadmin).*"
  // Aggregate by host and user
  | STATS 
      priv_ops = COUNT(*),
      sample_commands = VALUES(SUBSTRING(cmd, 0, 150))
    BY username, hostname
  // Threshold: 2+ privilege operations
  | WHERE priv_ops >= 2
  // Risk scoring
  | EVAL risk_score = CASE(
      priv_ops >= 5, 90,
      priv_ops >= 3, 80,
      70
    )
  | KEEP username, hostname, priv_ops, risk_score, sample_commands
enabled: false
tags:
  - Database Security
  - Privilege Escalation
  - Access Control
  - Data Protection
severity: high
risk_score: 80
references:
  - "https://attack.mitre.org/techniques/T1098/"
nist: ["AC-2", "AC-6", "AU-2"]
gdpr: ["Article 32"]
pci_dss: ["7.1", "7.2", "10.2.5"]
mitre_attack:
  TA0004:
    T1098: []