rule_id: f17ca290-01ae-4bf8-a6ca-538307e32606

name: "Database Backup or Dump Tool Execution - pg_dump, mysqldump, sqlcmd"
description: |
  This rule detects execution of database backup or dump utilities such as pg_dump, mysqldump, sqlcmd, or similar tools from process command lines. While legitimate for backups, adversaries may use these tools to exfiltrate entire databases.
  
#  Database dump tools executed by unauthorized users or from unexpected hosts can indicate data theft in progress. Monitoring tool execution helps detect exfiltration attempts.
#  
#  False positives are common in environments with scheduled backups or DBA operations. Baseline normal backup activity and focus on unexpected users or hosts.
#  
#  Triage steps: (1) Identify the user executing the dump tool, (2) Verify if a backup is scheduled or authorized, (3) Check the destination path/output location, (4) Review network connections for potential data transfer.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - auditbeat-*
  - winlogbeat-*
query_language: esql
query: |
  FROM auditbeat-*, winlogbeat-*
  | WHERE @timestamp >= NOW() - 15 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL userp = COALESCE(user.name, winlog.event_data.SubjectUserName)
  | EVAL procname = COALESCE(process.name, winlog.event_data.NewProcessName)
  | EVAL cmd = COALESCE(process.command_line, winlog.event_data.CommandLine, event.original)
  // Look for database dump tool process names or command patterns
  | WHERE procname RLIKE "(?i)(pg_dump|mysqldump|sqlcmd|bcp|mongodump|pgdump|postgres.*dump)"
         OR cmd RLIKE "(?i)(pg_dump|mysqldump|sqlcmd.*-Q|bcp.*out|mongodump|backup.*database)"
  | STATS 
      dump_count = COUNT(*),
      unique_users = COUNT_DISTINCT(userp),
      sample_commands = VALUES(SUBSTRING(cmd, 0, 160))
    BY hostn, userp
  | WHERE dump_count >= 1
  | EVAL risk_score = CASE(
      dump_count >= 5, 85,
      dump_count >= 3, 75,
      65
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - Database
  - Data Exfiltration
  - Backup Tool
  - Collection
severity: medium
risk_score: 70
references:
  - "https://attack.mitre.org/techniques/T1560/"
nist: ["AU-6", "IR-4", "SI-4"]
gdpr: ["Article 32", "Article 33"]
pci_dss: ["10.2"]
mitre_attack:
  TA0009:
    T1560: ["T1560.001"]