rule_id: c0182868-6113-4722-9015-015b0b4b8e2e

name: "Bulk Data Export - Large Result Set Queries"
description: |
  This rule detects database queries that may return large result sets, indicated by keywords like "LIMIT 10000", "TOP 100000", or absence of LIMIT/WHERE clauses combined with SELECT *. Adversaries may exfiltrate data by running broad queries.
  
#  Large data exports can indicate data theft or reconnaissance. Monitoring query patterns helps detect exfiltration attempts before data leaves the environment.
#  
#  False positives may occur with legitimate reporting, ETL jobs, or analytics queries. Baseline normal query patterns and focus on unexpected users or timing.
#  
#  Triage steps: (1) Identify the user running the query, (2) Review the query details and target tables, (3) Check if the query is part of scheduled reporting, (4) Monitor network activity for data transfer.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - auditbeat-*
  - metricbeat-*
  - winlogbeat-*
query_language: esql
query: |
  FROM auditbeat-*, metricbeat-*, winlogbeat-*
  | WHERE @timestamp >= NOW() - 15 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL userp = COALESCE(user.name, winlog.event_data.SubjectUserName)
  | EVAL cmd = COALESCE(process.command_line, winlog.event_data.CommandLine, event.original)
  // Heuristic: SELECT statements with large limits or SELECT * without WHERE
  | WHERE cmd RLIKE "(?i)select.*(limit\\s+[1-9][0-9]{4,}|top\\s+[1-9][0-9]{4,})"
         OR cmd RLIKE "(?i)select\\s+\\*.*from(?!.*where)"
  // Filter for database-related activity
  | WHERE event.dataset RLIKE "(?i)(mysql|postgres|mssql|oracle|mongo|db)"
         OR cmd RLIKE "(?i)(mysql|postgres|mssql|sqlcmd|oracle|mongo)"
  | STATS 
      query_count = COUNT(*),
      sample_queries = VALUES(SUBSTRING(cmd, 0, 160))
    BY hostn, userp
  | WHERE query_count >= 3
  | EVAL risk_score = CASE(
      query_count >= 10, 85,
      query_count >= 5, 75,
      65
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - Database
  - Data Exfiltration
  - Bulk Query
  - Collection
severity: medium
risk_score: 70
references:
  - "https://attack.mitre.org/techniques/T1530/"
nist: ["AU-6", "IR-4", "SI-4"]
gdpr: ["Article 32", "Article 33"]
pci_dss: ["10.2"]
mitre_attack:
  TA0009:
    T1530: []