rule_id: fd2723ac-9ace-44b8-91bd-2df3286226ec
name: "Beaconing Heuristic - Periodic Outbound Connections to Same Destination"
description: |
  This rule detects potential command-and-control (C2) beaconing by identifying periodic outbound connections to the same external destination IP within consistent time intervals. This pattern suggests malware calling home for instructions.
  
#  C2 beaconing is a hallmark of persistent malware. Detecting periodic connection patterns helps identify compromised hosts before data exfiltration or lateral movement occurs.
#  
#  False positives may occur with legitimate applications that poll external services (update checkers, monitoring agents, cloud sync). Baseline normal periodic connections.
#  
#  Triage steps: (1) Identify the destination IP and domain, check reputation, (2) Determine which process is making the connections, (3) Review the connection payloads if available, (4) Isolate the host and perform malware analysis.
type: esql
params: '{}'
schedule_interval: 15m
index:
  - auditbeat-*
  - metricbeat-*
query_language: esql
query: |
  FROM auditbeat-*, metricbeat-*
  | WHERE @timestamp >= NOW() - 30 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  | EVAL dstip = event.original
  // Focus on outbound network connections (heuristic via event patterns)
  | WHERE event.category == "network" OR event.type == "connection"
  // Extract destination IP from event.original (heuristic - adjust regex as needed)
  | WHERE event.original RLIKE "\\b(?:[0-9]{1,3}\\.){3}[0-9]{1,3}\\b"
  // Exclude internal destinations
  | WHERE NOT event.original RLIKE "(?i)(10\\.|172\\.(1[6-9]|2[0-9]|3[01])\\.|192\\.168\\.)"
  | STATS 
      connection_count = COUNT(*),
      first_seen = MIN(@timestamp),
      last_seen = MAX(@timestamp),
      sample_events = VALUES(SUBSTRING(event.original, 0, 160))
    BY hostn, srcip
  // Heuristic: many connections over 30 min window suggests periodic activity
  | WHERE connection_count >= 20
  | EVAL time_span_minutes = (last_seen - first_seen) / 60000
  // Connections should span significant time (not all at once)
  | WHERE time_span_minutes >= 15
  | EVAL risk_score = CASE(
      connection_count >= 40, 90,
      connection_count >= 30, 80,
      70
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - C2 Beaconing
  - Command and Control
  - Persistence
  - Network
severity: high
risk_score: 82
references:
  - "https://attack.mitre.org/techniques/T1071/"
  - "https://attack.mitre.org/techniques/T1095/"
nist: ["AU-6", "IR-4", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["10.6"]
mitre_attack:
  TA0011:
    T1071: ["T1071.001"]