rule_id: 523688da-d2b0-4dd8-856e-ff0f2ff5ccd7

name: "Unusual Outbound Connection to Non-Standard High Port"
description: |
  This rule detects outbound connections to non-standard high ports (above 49152) which are often used by malware for C2 communication or data exfiltration to evade firewall rules focused on well-known ports.
  
#  Malware frequently uses high/ephemeral ports for C2 to blend with normal traffic. Monitoring unusual high-port connections helps detect stealthy communication channels.
#  
#  False positives are common with legitimate applications using dynamic ports (P2P, gaming, video conferencing). Baseline normal high-port usage per environment.
#  
#  Triage steps: (1) Identify the destination IP and port, (2) Determine which process initiated the connection, (3) Check destination IP reputation, (4) Analyze the connection payload if available.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - auditbeat-*
  - metricbeat-*
query_language: esql
query: |
  FROM auditbeat-*, metricbeat-*
  | WHERE @timestamp >= NOW() - 15 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  | EVAL dstport = COALESCE(source.port, winlog.event_data.IpPort)
  // Focus on outbound network connections
  | WHERE event.category == "network" OR event.type == "connection"
  // Heuristic: look for high ports in event.original if dstport not available
  | WHERE (dstport IS NOT NULL AND TO_LONG(dstport) > 49152)
         OR event.original RLIKE "(?i)port\\s+(4915[2-9]|49[2-9][0-9]{2}|[5-9][0-9]{4}|6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-5])"
  // Exclude internal destinations
  | WHERE NOT event.original RLIKE "(?i)(10\\.|172\\.(1[6-9]|2[0-9]|3[01])\\.|192\\.168\\.)"
  | STATS 
      connection_count = COUNT(*),
      unique_ports = COUNT_DISTINCT(dstport),
      sample_events = VALUES(SUBSTRING(event.original, 0, 160))
    BY hostn, srcip
  // Threshold: 10+ connections to high ports
  | WHERE connection_count >= 10
  | EVAL risk_score = CASE(
      connection_count >= 25, 85,
      connection_count >= 15, 75,
      65
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - High Port
  - C2 Communication
  - Command and Control
  - Network
severity: medium
risk_score: 70
references:
  - "https://attack.mitre.org/techniques/T1071/"
nist: ["AU-12", "AU-6", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["1.3"]
mitre_attack:
  TA0011:
    T1071: []