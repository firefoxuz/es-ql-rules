rule_id: 78e4f7bf-c66a-4a24-b117-61df50fbf871

name: "Suspicious Inbound Connection Attempts to Administrative Ports"
description: |
  This rule detects multiple inbound connection attempts to administrative ports (22-SSH, 3389-RDP, 5985-WinRM, 445-SMB) from external or unexpected sources. This pattern suggests reconnaissance or brute force attacks targeting remote administration services.
  
#  Administrative port scanning is a common precursor to brute force attacks and lateral movement. Monitoring inbound connections to these ports helps detect initial access attempts.
#  
#  False positives may occur with legitimate remote administration from known management hosts or VPNs. Whitelist authorized sources and focus on external IPs.
#  
#  Triage steps: (1) Identify the source IP and check geolocation/reputation, (2) Verify if connections are from authorized management networks, (3) Block unauthorized sources at firewall, (4) Review authentication logs for brute force indicators.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - auditbeat-*
  - metricbeat-*
  - winlogbeat-*
query_language: esql
query: |
  FROM auditbeat-*, metricbeat-*, winlogbeat-*
  | WHERE @timestamp >= NOW() - 15 minutes
  | EVAL hostn = COALESCE(host.name, winlog.computer_name)
  | EVAL srcip = COALESCE(source.ip, winlog.event_data.IpAddress)
  | EVAL dstport = COALESCE(source.port, winlog.event_data.IpPort)
  // Focus on network connection events
  | WHERE event.category == "network" OR event.type == "connection"
  // Filter for administrative ports
  | WHERE dstport IN ("22", "3389", "5985", "5986", "445", "139", "23")
         OR event.original RLIKE "(?i)(port\\s+(22|3389|5985|445|139|23))"
  // Exclude internal IPs (focus on external or unexpected internal sources)
  | WHERE NOT srcip RLIKE "^(10\\.|172\\.(1[6-9]|2[0-9]|3[01])\\.|192\\.168\\.)"
  | STATS 
      connection_count = COUNT(*),
      unique_hosts = COUNT_DISTINCT(hostn),
      sample_ports = VALUES(TO_STRING(dstport))
    BY srcip
  // Threshold: 5+ connection attempts from external source
  | WHERE connection_count >= 5
  | EVAL risk_score = CASE(
      connection_count >= 15, 90,
      connection_count >= 10, 80,
      70
    )
  | SORT risk_score DESC
  | LIMIT 100
enabled: false
tags:
  - Inbound Connection
  - Administrative Port
  - Reconnaissance
  - Brute Force
severity: high
risk_score: 80
references:
  - "https://attack.mitre.org/techniques/T1046/"
  - "https://attack.mitre.org/techniques/T1021/"
nist: ["AC-10", "AC-4", "SC-10", "SC-20", "SC-7", "SI-4"]
gdpr: ["Article 32"]
pci_dss: ["1.3"]
mitre_attack:
  TA0001:
    T1046: []