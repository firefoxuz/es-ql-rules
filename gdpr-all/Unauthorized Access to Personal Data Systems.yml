rule_id: 93dbba9d-95be-4635-94a2-120ff90ca9ec
#//RULE-GDPR-10 — Inadequate Access Controls to Personal Data (GDPR Article 32(1)(b))
#//Requirement: Article 32
#//Objective: Detect unauthorized access to personal data systems
#//Data sources: Authentication logs, database logs, file access logs
#//ECS fields used: event.category, user.name, event.outcome, source.ip
#//GDPR field validation: Verify personal data fields exist (user.email, geo.country, etc.)
#//Tuning notes: Monitor unauthorized access attempts; track privilege escalation

name: "Unauthorized Access to Personal Data Systems"
description: |
  Identifies unauthorized access attempts or successful unauthorized access to
  systems processing personal data, violating GDPR Article 32(1)(b) requirement
  for ensuring ongoing confidentiality. Detects failed authentication to HR/CRM
  databases, privilege escalation to data admin roles, and access from unexpected
  geographic locations. Unauthorized access indicates inadequate security controls
  and potential data breach. Correlate with user behavior baselines and geolocation.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - winlogbeat-*
  - auditbeat-*
query_language: esql
query: |
    // Oxirgi 5 daqiqa
    FROM winlogbeat-*, auditbeat-*
    | WHERE @timestamp >= NOW() - 5 minutes
  
    // Authentication eventlar
    | WHERE event.category == "authentication"
  
    // source.ip bo‘lmasa korelyatsiya qiyin
    | WHERE source.ip IS NOT NULL
  
    // "Sensitive system"ni ECS-only holatda host naming/dataset orqali taxmin qilamiz:
    // (masalan hr/crm/pii/payroll/customer kabi hostlar)
    | WHERE host.name RLIKE "(?i).*(hr|crm|payroll|customer|profile|pii|identity|idm|db|sql).*"
  
    // Failure va Success flag
    | EVAL is_success = CASE(event.outcome == "success", 1, 0)
    | EVAL is_failure = CASE(event.outcome == "failure", 1, 0)
  
    // Public IP success flag (RFC1918 emas)
    | EVAL success_from_public = CASE(
        event.outcome == "success"
        AND NOT CIDR_MATCH(source.ip, "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16"),
        1, 0
      )
  
    // IP+user bo‘yicha agregatsiya (credential stuffing/bruteforce uchun juda yaxshi)
    | STATS
        attempts = COUNT(*),
        success_count = SUM(is_success),
        failure_count = SUM(is_failure),
        public_success = SUM(success_from_public),
        hosts = VALUES(host.name),
        actions = VALUES(event.action)
      BY user.name, source.ip
  
    // Trigger:
    // 1) 5 daqiqada 8+ urinish va kamida 1 ta success => bruteforce + success
    // 2) Public IP dan success bo‘lsa va urinishlar ko‘p bo‘lsa
    | WHERE (attempts >= 8 AND success_count >= 1)
        OR (public_success >= 1 AND attempts >= 3)
        OR (failure_count >= 15)
  
    | EVAL risk_score = CASE(
        public_success >= 1 AND success_count >= 1, 100,
        success_count >= 1 AND failure_count >= 10, 95,
        failure_count >= 25, 90,
        success_count >= 1, 85,
        75
      )
  
    | KEEP agent_id, user.name, source.ip, attempts, success_count, failure_count, public_success, hosts, actions, risk_score
    | SORT risk_score DESC
enabled: false
tags:
  - gdpr
  - article_32
  - access_control
  - confidentiality
  - security
severity: high
risk_score: 85
references:
  - "GDPR Article 32(1)(b) - Confidentiality, Integrity, Availability"
  - "GDPR Article 32(2) - Risk Assessment"
nist: ["AC-3"]
gdpr: ["32.1.b"]
pci_dss: ["7.1"]
mitre_attack:
  TA0001: 
    T1078: []


