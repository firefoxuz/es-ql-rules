rule_id: 3255269b-4e8b-4c19-bc42-41c1d5efa235
name: "GDPR Art.33(2) - Third-Party Vendor or Processor Account Anomaly"
description: |
  Detects anomalous activity from third-party vendor or processor accounts that may indicate
  a breach at the processor level, triggering GDPR Article 33(2) obligation for processors
  to notify controllers without undue delay after becoming aware of a breach.
  Monitors vendor/service account logins at unusual hours, from unexpected locations,
  accessing systems they don't normally access, or performing bulk operations.
  Vendor account compromise is a high-risk vector for personal data breaches as
  processors often have broad access to controller's data systems.
  Trigger: Vendor account login from new IP/country, or >3x normal access volume,
  or access to systems not in vendor's normal access pattern.
  False positives: Vendor staff changes, vendor IP range changes, legitimate incident response.
  Triage: Contact the vendor/processor immediately to verify legitimacy of access,
  check if vendor has reported any security incidents on their side (Art.33(2) obligation),
  suspend vendor account if unverified, assess scope of personal data accessible.
  NOTE: Tag vendor/processor accounts in your directory with a group or naming convention
  and update the user.name filter below accordingly (e.g. svc_vendor_*, ext_*, etc.).
type: esql
params: '{}'
schedule_interval: 15m
index:
  - logs-winlog*
  - logs-audit*
query_language: esql
query: |
  FROM logs-winlog*, logs-audit*
  | WHERE event.outcome == "success"
    AND event.code IN ("4624", "4648")
    AND (
      -- Filter to vendor/service accounts - update naming pattern to match your org
      winlog.event_data.TargetUserName LIKE "svc_*"
      OR winlog.event_data.TargetUserName LIKE "vendor_*"
      OR winlog.event_data.TargetUserName LIKE "ext_*"
      OR winlog.event_data.TargetUserName LIKE "*_svc"
      OR winlog.event_data.TargetUserName LIKE "3p_*"
    )
    AND NOT winlog.event_data.TargetUserName LIKE "*$"
  | STATS
      vendor_logins         = COUNT(*),
      unique_vendors        = COUNT_DISTINCT(winlog.event_data.TargetUserName),
      unique_source_ips     = COUNT_DISTINCT(source.ip),
      unique_hosts_accessed = COUNT_DISTINCT(host.name),
      vendor_accounts       = VALUES(winlog.event_data.TargetUserName),
      source_ip_list        = VALUES(source.ip),
      source_countries      = VALUES(source.geo.country_iso_code),
      hosts_accessed        = VALUES(host.name),
      logon_types           = VALUES(winlog.event_data.LogonType)
    BY winlog.event_data.TargetUserName,
       bucket = DATE_TRUNC(15 minutes, @timestamp)
  | EVAL anomaly_indicators =
      CASE(unique_source_ips >= 3, 3, 0)
      + CASE(unique_hosts_accessed >= 5, 3, 0)
      + CASE(vendor_logins >= 20, 2, 0)
      + CASE(ARRAY_LENGTH(source_countries) >= 2, 4, 0)
  | WHERE anomaly_indicators >= 2
  | EVAL risk_narrative = CASE(
      ARRAY_LENGTH(source_countries) >= 2,
        "CRITICAL - Vendor account logging in from multiple countries simultaneously",
      unique_source_ips >= 3,
        "HIGH - Vendor account using multiple source IPs - possible account sharing or compromise",
      unique_hosts_accessed >= 5,
        "HIGH - Vendor accessing unusual number of systems - verify scope of processor agreement",
      "MEDIUM - Vendor account access volume anomaly requires verification"
    )
  | EVAL gdpr_33_2_action = CASE(
      anomaly_indicators >= 7,
        "URGENT: Suspend vendor account. Contact processor per Art.33(2). Assess personal data access scope.",
      anomaly_indicators >= 4,
        "HIGH: Contact vendor to verify access. Review DPA agreement scope. Monitor for exfiltration.",
      "MEDIUM: Verify with vendor team. Review Art.28 processor access controls."
    )
  | EVAL severity_level = CASE(
      anomaly_indicators >= 7, "critical",
      anomaly_indicators >= 4, "high",
      "medium"
    )
  | EVAL risk_score = CASE(
      anomaly_indicators >= 7, 90,
      anomaly_indicators >= 4, 70,
      45
    )
  | KEEP bucket, winlog.event_data.TargetUserName, vendor_logins,
         unique_vendors, unique_source_ips, unique_hosts_accessed,
         source_ip_list, source_countries, hosts_accessed,
         anomaly_indicators, risk_narrative, gdpr_33_2_action,
         severity_level, risk_score
  | SORT anomaly_indicators DESC
enabled: false
tags:
  - gdpr
  - third_party
  - processor
  - vendor_access
  - art33
severity: high
risk_score: 70
references:
  - "GDPR Article 33(2): Processor shall notify controller without undue delay after becoming aware of breach"
  - "GDPR Article 28: Processor obligations and data processing agreements"
  - "GDPR Article 28(3)(h): Processor must provide information necessary for audits"
gdpr: ["33.2", "28.1", "28.3.b", "5.1.f"]
nist: ["SA-9", "IR-6", "AC-17", "AU-12"]
pci_dss: ["12.8.4", "8.1.5"]
mitre_attack:
  TA0001:
    T1078: []
    T1133: []
  TA0006:
    T1110: []