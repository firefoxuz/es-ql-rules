rule_id: bdbe3c21-f1e7-4d7e-898b-dba43047facb
name: "GDPR Art.25(1) - Data Protection by Design Controls Failure"
description: |
  Detects failures or absence of technical data-protection-by-design controls required
  by GDPR Article 25(1), which mandates appropriate technical measures to implement
  data protection principles effectively at the time of processing design.
  Specifically monitors: (1) audit logging gaps - hosts not sending logs for >30 min,
  (2) firewall/security controls generating zero events (silent failure),
  (3) absence of expected authentication events on critical systems.
  A host that stops sending security events may have its controls disabled or compromised.
  Trigger: Any monitored host with zero security events for 30+ minute window.
  False positives: Host reboots, agent upgrades, planned maintenance windows.
  Triage: Verify agent health in Fleet, check if host is reachable, confirm if maintenance
  was scheduled, escalate if unplanned - potential attacker disabling security controls.
type: esql
params: '{}'
schedule_interval: 30m
index:
  - logs-winlog*
  - logs-audit*
query_language: esql
query: |
  FROM logs-winlog*, logs-audit*
  | WHERE @timestamp >= NOW() - 1 hour
  | STATS
      event_count          = COUNT(*),
      last_seen            = MAX(@timestamp),
      first_seen           = MIN(@timestamp),
      event_types          = COUNT_DISTINCT(event.code),
      datasets_reporting   = COUNT_DISTINCT(event.dataset)
    BY host.name,
       bucket = DATE_TRUNC(30 minutes, @timestamp)
  | EVAL minutes_since_last_event = DATE_DIFF("minutes", last_seen, NOW())
  | EVAL coverage_gap_minutes     = DATE_DIFF("minutes", first_seen, last_seen)
  | WHERE event_count < 5
    OR minutes_since_last_event > 30
  | EVAL control_status = CASE(
      event_count == 0,                      "no_events_received",
      event_count < 5 AND event_types <= 1,  "minimal_coverage_anomaly",
      minutes_since_last_event > 60,         "long_silence_critical",
      minutes_since_last_event > 30,         "silence_warning",
      "sparse_event_coverage"
    )
  | EVAL gdpr_implication = CASE(
      control_status == "no_events_received",    "Art.25 VIOLATION - no evidence of technical controls operating",
      control_status == "long_silence_critical", "Art.25 HIGH RISK - data protection controls may be disabled",
      control_status == "silence_warning",       "Art.25 WARNING - data protection controls may be degraded",
      "Art.25 NOTICE - reduced control visibility requires investigation"
    )
  | EVAL severity_level = CASE(
      control_status == "no_events_received",    "critical",
      control_status == "long_silence_critical", "high",
      control_status == "silence_warning",       "medium",
      "low"
    )
  | EVAL risk_score = CASE(
      control_status == "no_events_received",    95,
      control_status == "long_silence_critical", 75,
      control_status == "silence_warning",       50,
      30
    )
  | KEEP bucket, host.name, event_count, last_seen,
         minutes_since_last_event, event_types, datasets_reporting,
         control_status, gdpr_implication, severity_level, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - gdpr
  - data_protection_by_design
  - control_monitoring
  - log_gap
severity: high
risk_score: 75
references:
  - "GDPR Article 25(1): Data protection by design - implement appropriate technical measures"
  - "GDPR Article 25(2): Data protection by default"
  - "GDPR Article 32(1)(d): Process for regularly testing and evaluating effectiveness of measures"
gdpr: ["25.1", "25.2", "32.1.d", "30.1.g"]
nist: ["AU-5", "CA-7", "SI-4"]
pci_dss: ["10.5", "10.7"]
mitre_attack:
  TA0005:
    T1562: ["T1562.001", "T1562.002"]