rule_id: aa37ff90-81c9-4348-a36a-fc3fd81916e3
#//RULE-GDPR-03 â€” Unencrypted Personal Data at Rest (GDPR Article 32(1)(a) - Encryption)
#//Requirement: Article 32
#//Objective: Detect unencrypted storage of personal data
#//Data sources: File system monitoring, database configuration logs
#//ECS fields used: file.path, file.extension, event.category
#//GDPR field validation: Verify personal data fields exist (user.email, geo.country, etc.)
#//Tuning notes: Scan for plaintext PII files; validate database encryption status

name: "Unencrypted Personal Data Storage Detected"
description: |
  Identifies files and databases storing personal data without encryption at rest,
  violating GDPR Article 32(1)(a) requirement for pseudonymisation and encryption.
  Detects plaintext CSV/JSON/XML files containing PII patterns (emails, phone numbers,
  names with addresses) and databases without TDE/encryption. Unencrypted storage
  increases breach impact and violates security-by-design. Exclude encrypted volumes
  and tokenized data systems.
type: esql
params: '{}'
schedule_interval: 1h
index:
  - auditbeat-*
query_language: esql
query: |
  FROM auditbeat-*
  | WHERE event.category == "file"
    AND file.extension IN ("csv", "txt", "json", "xml", "sql", "xls", "xlsx")
    AND file.path NOT RLIKE "(?i).*(encrypt|vault|secure|protected).*"
  | WHERE event.original > 10240
  | STATS file_count = COUNT(*),
          total_size_mb = SUM(event.original) / 1048576,
          files = VALUES(file.path),
          directories = VALUES(file.directory)
    BY host.name, file.directory
  | WHERE file_count > 5 OR total_size_mb > 10
  | EVAL risk_score = CASE(
      total_size_mb > 1000, 100,
      file_count > 100, 95,
      total_size_mb > 100, 85,
      75
    )
  | KEEP agent_id, host.name, file.directory, file_count, total_size_mb, files, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - gdpr
  - article_32
  - encryption
  - data_protection
  - security
severity: critical
risk_score: 90
references:
  - "GDPR Article 32(1)(a) - Encryption and Pseudonymisation"
  - "GDPR Article 5(1)(f) - Integrity and Confidentiality"
nist: ["SC-28"]
gdpr: ["32.1.a"]
pci_dss: ["3", "3.4"]
mitre_attack:
  TA0009:
    T1005: []
