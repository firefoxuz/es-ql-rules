rule_id: 707d5bd5-09c6-4400-9cdc-e89ef8cb724d
name: "GDPR Art.32(1)(b) - Confidentiality and Integrity of Processing Systems Compromised"
description: |
  Detects events indicating loss of confidentiality or integrity of systems processing
  personal data, as required by GDPR Article 32(1)(b) to ensure ongoing confidentiality,
  integrity, availability and resilience of processing systems and services.
  Aggregates high-severity security events: privilege escalation, account takeover indicators,
  critical file modifications, and audit policy changes across Windows and Linux hosts.
  A combination of these events on the same host within a short window strongly indicates
  an active compromise of a personal data processing system.
  Trigger: 3+ distinct high-severity event types on single host within 10 minutes.
  False positives: Concurrent legitimate admin activities during maintenance windows.
  Triage: Identify all event types on the affected host, correlate with change management,
  isolate host if compromise confirmed, initiate GDPR breach assessment process immediately.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
  - logs-audit*
query_language: esql
query: |
  FROM logs-winlog*, logs-audit*
  | WHERE (
      -- Windows: privilege escalation, account changes, audit tampering, lateral movement
      event.code IN ("4672", "4720", "4728", "4732", "1102", "4719", "4624", "4648")
      OR
      -- Linux: sudo abuse, file tampering, authentication anomalies
      (event.dataset == "auditd.log" AND event.action IN (
        "sudo", "user-cmd", "changed-file-attributes-of",
        "opened-file", "user-login"
      ))
    )
    AND event.outcome IN ("success", "failure")
  | EVAL event_category = CASE(
      event.code == "4672",                                "privilege_escalation",
      event.code IN ("4720", "4728", "4732"),              "account_manipulation",
      event.code IN ("1102", "4719"),                      "audit_tampering",
      event.code == "4648",                                "explicit_credential_use",
      event.code == "4624" AND winlog.event_data.LogonType == "3", "network_logon",
      event.action == "sudo" OR event.action == "user-cmd","linux_privilege_escalation",
      event.action LIKE "changed-file*",                   "file_integrity_violation",
      "other_security_event"
    )
  | STATS
      total_events          = COUNT(*),
      distinct_threat_types = COUNT_DISTINCT(event_category),
      threat_types_seen     = VALUES(event_category),
      involved_users        = VALUES(user.name),
      event_codes_seen      = VALUES(event.code),
      source_ips            = VALUES(source.ip)
    BY host.name,
       bucket = DATE_TRUNC(10 minutes, @timestamp)
  | WHERE distinct_threat_types >= 2
  | EVAL compromise_likelihood = CASE(
      distinct_threat_types >= 4, "CRITICAL - active compromise highly likely",
      distinct_threat_types >= 3, "HIGH - multiple attack indicators on single host",
      "MEDIUM - correlated security events require investigation"
    )
  | EVAL gdpr_obligation = CASE(
      distinct_threat_types >= 4,
        "Art.32 BREACH - integrity of personal data processing system at severe risk. Art.33 clock may be running.",
      distinct_threat_types >= 3,
        "Art.32 HIGH RISK - assess personal data exposure immediately.",
      "Art.32 NOTICE - investigate to rule out personal data processing impact."
    )
  | EVAL severity_level = CASE(
      distinct_threat_types >= 4, "critical",
      distinct_threat_types >= 3, "high",
      "medium"
    )
  | EVAL risk_score = CASE(
      distinct_threat_types >= 4, 95,
      distinct_threat_types >= 3, 75,
      55
    )
  | KEEP bucket, host.name, total_events, distinct_threat_types,
         threat_types_seen, involved_users, source_ips,
         compromise_likelihood, gdpr_obligation, severity_level, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - gdpr
  - integrity
  - confidentiality
  - system_compromise
  - personal_data
severity: high
risk_score: 75
references:
  - "GDPR Article 32(1)(b): Ongoing confidentiality, integrity, availability and resilience"
  - "GDPR Article 33: 72-hour breach notification to supervisory authority"
  - "GDPR Article 34: Communication of breach to data subjects at high risk"
gdpr: ["32.1.b", "32.2", "33.1", "34.1"]
nist: ["IR-4", "SI-4", "AU-6"]
pci_dss: ["10.2.2", "10.2.5", "11.4"]
mitre_attack:
  TA0003:
    T1098: []
    T1136: ["T1136.001"]
  TA0004:
    T1078: ["T1078.002"]
    T1548: ["T1548.003"]
  TA0005:
    T1070: ["T1070.001"]
    T1562: ["T1562.002"]
