rule_id: 83d69f1e-6fc8-41fb-a83e-1b4767447ffd
name: "GDPR Art.30(1)(g) - Security Measures Record Completeness Failure"
description: |
  Detects conditions that undermine the ability to maintain accurate records of technical
  and organisational security measures as required by GDPR Article 30(1)(g), which mandates
  that records of processing activities include a general description of security measures.
  Monitors: (1) new hosts appearing in logs without prior registration (undocumented systems
  processing personal data), (2) new event sources/datasets appearing unexpectedly
  (unknown processing activities), (3) significant changes in the set of systems reporting
  events (scope creep in personal data processing environment).
  Undocumented systems processing personal data violate Art.30 record-keeping and
  Art.25 (data protection by design) simultaneously.
  Trigger: New host.name seen in security logs that was not present in prior 7-day baseline.
  False positives: Legitimate new server deployments, renamed hosts, cloud auto-scaling.
  Triage: Identify the new system, verify if it processes personal data, update Art.30
  Records of Processing Activities (RoPA) if legitimate, investigate if unauthorized
  system deployment, check if DPIA (Art.35) was conducted for new processing activity.
type: esql
params: '{}'
schedule_interval: 1h
index:
  - logs-winlog*
  - logs-audit*
query_language: esql
query: |
  FROM logs-winlog*, logs-audit*
  | WHERE @timestamp >= NOW() - 2 hours
  | STATS
      event_count           = COUNT(*),
      event_types           = COUNT_DISTINCT(event.code),
      datasets              = COUNT_DISTINCT(event.dataset),
      first_seen_in_window  = MIN(@timestamp),
      last_seen_in_window   = MAX(@timestamp),
      os_types              = VALUES(host.os.type),
      ip_addresses          = VALUES(host.ip),
      event_categories      = VALUES(event.category)
    BY host.name,
       bucket = DATE_TRUNC(1 hour, @timestamp)
  | EVAL hours_in_window = DATE_DIFF("hours", first_seen_in_window, last_seen_in_window)
  | WHERE event_count >= 5
    AND hours_in_window <= 2
  | EVAL discovery_type = CASE(
      event_count >= 100 AND event_types >= 5,
        "new_host_fully_operational",
      event_count >= 20 AND event_types >= 2,
        "new_host_partially_operational",
      event_count >= 5,
        "new_host_initial_activity",
      "minimal_new_host_activity"
    )
  | EVAL gdpr_30_implication = CASE(
      discovery_type == "new_host_fully_operational",
        "HIGH - Undocumented system appears to be processing data. Update Art.30 RoPA immediately. Verify DPIA conducted.",
      discovery_type == "new_host_partially_operational",
        "MEDIUM - New system detected. Verify if personal data is processed. Update Art.30 records if confirmed.",
      "LOW - New/renamed host detected. Confirm identity and update Art.30 asset inventory if processing personal data."
    )
  | EVAL severity_level = CASE(
      discovery_type == "new_host_fully_operational",   "high",
      discovery_type == "new_host_partially_operational","medium",
      "low"
    )
  | EVAL risk_score = CASE(
      discovery_type == "new_host_fully_operational",    70,
      discovery_type == "new_host_partially_operational", 45,
      20
    )
  | KEEP bucket, host.name, event_count, event_types,
         datasets, os_types, ip_addresses, hours_in_window,
         event_categories, discovery_type, gdpr_30_implication,
         severity_level, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - gdpr
  - record_keeping
  - art30
  - asset_discovery
  - processing_inventory
severity: medium
risk_score: 45
references:
  - "GDPR Article 30(1)(g): Records of processing must include description of security measures"
  - "GDPR Article 30(1): Controller must maintain record of processing activities"
  - "GDPR Article 35(1): DPIA required for new high-risk processing activities"
  - "GDPR Article 25(1): Data protection by design for new processing systems"
gdpr: ["30.1.g", "30.1.b", "25.1", "35.1"]
nist: ["CM-8", "CM-3", "PL-1", "CA-7"]
pci_dss: ["2.4", "11.1"]
mitre_attack:
  TA0003:
    T1136: []
  TA0005:
    T1036: []