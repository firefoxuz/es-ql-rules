rule_id: 6db3bf71-845c-4e46-9e23-c597f0f329b7
name: "Microsoft Office Trusted Location Updated"
description: |
  Detects registry modifications that add or update Microsoft Office Trusted Locations.
  Attackers may add malicious directories as trusted locations to bypass Office macro
  security controls and execute macro-enabled documents without warnings.
  False positives: Common during Office installation, upgrades, Click-to-Run operations,
  or legitimate administrative configuration.
  Triage: Identify the Office application/version affected, review the added trusted path,
  verify the modifying process and user, and correlate with subsequent Office document
  execution, macro activity, or suspicious child processes.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
 FROM logs-winlog*
  | EVAL raw = COALESCE(event.original, "")
  /* Selection: Trusted Location registry path ending with \Path */
  | WHERE raw LIKE "*Security\\\\Trusted Locations\\\\Location*"
    AND raw LIKE "*\\\\Path*"
  /* Filters: exclude common Office installers and Office apps */
  | WHERE NOT (
      winlog.event_data.ProcessName LIKE "*\\\\Program Files\\\\Common Files\\\\Microsoft Shared\\\\ClickToRun\\\\OfficeClickToRun.exe" OR
      winlog.event_data.ProcessName LIKE "*\\\\Program Files\\\\Microsoft Office\\\\*" OR
      winlog.event_data.ProcessName LIKE "*\\\\Program Files (x86)\\\\Microsoft Office\\\\*"
    )
  | EVAL hour_of_day = DATE_EXTRACT("hour", @timestamp)
  | EVAL is_after_hours = CASE(hour_of_day < 7 OR hour_of_day > 20, true, false)
  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      processes = VALUES(winlog.event_data.ProcessName),
      executables = VALUES(winlog.event_data.ProcessName),
      parent_processes = VALUES(winlog.event_data.CallerProcessName),
      originals = VALUES(raw),
      after_hours_hits = SUM(CASE(is_after_hours == true, 1, 0))
    BY host.name, bucket = DATE_TRUNC(20 minutes, @timestamp)
  | WHERE event_count >= 1
  | EVAL risk_score = event_count * 25 + after_hours_hits * 20
  | WHERE risk_score >= 25
  | KEEP agent_id, bucket, host.name, event_count, users, processes, executables, parent_processes, after_hours_hits, risk_score, originals
  | SORT risk_score DESC
enabled: false
tags:
  - attack.defense-evasion
  - attack.persistence
  - attack.t1112
  - detection.threat-hunting
severity: medium
risk_score: 55
references:
  - "https://admx.help/?Category=Office2016&Policy=excel16.Office.Microsoft.Policies.Windows::L_TrustedLoc01"
nist: ["AU-6", "SI-4", "CM-6"]
pci_dss: ["10.2"]
mitre_attack:
  TA0005:
    T1112: []
