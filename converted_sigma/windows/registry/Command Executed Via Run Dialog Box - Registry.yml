rule_id: 0f21a291-70ec-4b06-870d-468ddaa5342a
name: "Command Executed Via Run Dialog Box - Registry"
description: |
  Detects potential command execution via the Windows Run dialog by monitoring writes to the
  Explorer RunMRU registry key. This technique has been used in social engineering campaigns
  (e.g., fake CAPTCHA “paste this command”) to trick users into executing malicious commands.
  False positives: Likely (RunMRU is normal user behavior). This is best used for hunting and
  should be tuned by filtering benign commands and correlating with suspicious child processes,
  downloads, or follow-on persistence.
  Triage: Extract the entered Run command from event.original, identify the user session, and
  correlate with process creation shortly after (cmd/powershell/mshta/rundll32/wscript/certutil),
  network connections, and file writes to Temp/AppData/Downloads.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | EVAL raw = COALESCE(event.original, "")
  | WHERE raw LIKE "*\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RunMRU*"
  | WHERE NOT (raw LIKE "*\\MRUList*")
  
  /* New: Identify potentially malicious PowerShell flags */
  | EVAL is_suspicious_ps = RLIKE(raw, "(?i)powershell.*(-enc|-e |-w hidden|-nop|-noni)")
  
  /* Filter out common noise */
  | WHERE NOT (raw RLIKE "(?i)\\b(ping|calc|dxdiag|explorer|gpedit\\.msc|mmc|notepad|regedit|services\\.msc|winver)\\\\1\\b")
  
  /* Enhanced Temporal Analysis (Hours + Weekends) */
  | EVAL hour = DATE_EXTRACT("hour", @timestamp)
  | EVAL dow = DATE_EXTRACT("day_of_week", @timestamp)
  | EVAL is_after_hours = CASE(hour < 7 OR hour > 20 OR dow == 1 OR dow == 7, true, false)
  
  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      cmdlines = VALUES(winlog.event_data.CommandLine),
      suspicious_ps_count = SUM(CASE(is_suspicious_ps == true, 1, 0)),
      after_hours_hits = SUM(CASE(is_after_hours == true, 1, 0))
    BY host.name, bucket = DATE_TRUNC(20 minutes, @timestamp)
    
  /* Updated Risk Scoring: PowerShell obfuscation is a massive red flag */
  | EVAL risk_score = (event_count * 5) + (after_hours_hits * 15) + (suspicious_ps_count * 50)
  | WHERE risk_score >= 10
  | KEEP agent_id, bucket, host.name, users, risk_score, event_count, suspicious_ps_count, cmdlines
  | SORT risk_score DESC
enabled: false
tags:
  - detection.threat-hunting
  - attack.execution
severity: low
risk_score: 20
references:
  - "https://www.forensafe.com/blogs/runmrukey.html"
  - "https://medium.com/@shaherzakaria8/downloading-trojan-lumma-infostealer-through-capatcha-1f25255a0e71"
  - "https://redcanary.com/blog/threat-intelligence/intelligence-insights-october-2024/"
nist: ["AU-6", "SI-4"]
pci_dss: ["10.2"]
mitre_attack:
  TA0002:
    T1059: []
