rule_id: c2f4b96a-7ed9-448d-b63f-387d7406d490
name: "Service Binary in User Controlled Folder"
description: |
  Detects registry modifications to Windows service ImagePath values where the configured service binary
  points to user-controlled locations such as ProgramData or user AppData (Local/Roaming). Attackers often
  stage payloads in these directories and then configure a service to execute them for persistence or
  privilege escalation.
  Notes: ProgramData is user-writable by default, but some vendors apply restrictive ACLs; tune by filtering
  known-good service names/paths if noisy.
  False positives: Possible (poorly written software, some installers/updaters, vendor services).
  Triage: Identify the service name/key modified, validate the binary signature and owner, check parent process
  performing the registry write, and correlate with service creation/start events, new binaries in the referenced
  directory, and suspicious network connections.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | EVAL raw = COALESCE(event.original, "")
  /* selection: ControlSet + \Services\ + endswith \ImagePath + Details contains user-controlled folders */
  | WHERE raw LIKE "*ControlSet*\\\\Services\\\\*"
    AND raw LIKE "*\\\\ImagePath*"
    AND (
      raw RLIKE "(?i):\\\\ProgramData\\\\" OR
      raw RLIKE "(?i)\\\\AppData\\\\Local\\\\" OR
      raw RLIKE "(?i)\\\\AppData\\\\Roaming\\\\"
    )
  /* filter_main_windefend: exclude Windows Defender service paths */
  | WHERE NOT (
      (raw LIKE "*\\\\Services\\\\WinDefend\\\\*" OR raw LIKE "*\\\\Services\\\\MpKs*")
      AND raw LIKE "*C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\*"
    )
  /* filter_optional_zoom */
  | WHERE NOT (
      raw LIKE "*\\\\Services\\\\ZoomCptService*"
      AND raw LIKE "*C:\\\\Program Files\\\\Common Files\\\\Zoom\\\\Support\\\\CptService.exe*"
    )
  /* filter_optional_mbami */
  | WHERE NOT (
      raw LIKE "*\\\\Services\\\\MBAMInstallerService*"
      AND raw LIKE "*C:\\\\Users\\\\*"
      AND raw LIKE "*AppData\\\\Local\\\\Temp\\\\MBAMInstallerService.exe*"
    )
  | EVAL hour_of_day = DATE_EXTRACT("hour", @timestamp)
  | EVAL is_after_hours = CASE(hour_of_day < 7 OR hour_of_day > 20, true, false)
  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      target_users = VALUES(winlog.event_data.TargetUserName),
      processes = VALUES(winlog.event_data.ProcessName),
      executables = VALUES(winlog.event_data.ProcessName),
      parent_processes = VALUES(winlog.event_data.CallerProcessName),
      cmdlines = VALUES(winlog.event_data.CommandLine),
      originals = VALUES(raw),
      after_hours_hits = SUM(CASE(is_after_hours == true, 1, 0))
    BY host.name, bucket = DATE_TRUNC(20 minutes, @timestamp)
  | WHERE event_count >= 1
  | EVAL risk_score = event_count * 25 + after_hours_hits * 20
  | WHERE risk_score >= 25
  | KEEP agent_id, bucket, host.name, event_count, users, target_users, processes, executables, parent_processes, cmdlines, after_hours_hits, risk_score, originals
  | SORT risk_score DESC
enabled: false
tags:
  - attack.defense-evasion
  - attack.persistence
  - attack.t1112
  - detection.threat-hunting
severity: medium
risk_score: 55
references:
  - "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1562.001/T1562.001.md"
nist: ["AU-6", "SI-4", "CM-6"]
pci_dss: ["10.2"]
mitre_attack:
  TA0005:
    T1112: []
