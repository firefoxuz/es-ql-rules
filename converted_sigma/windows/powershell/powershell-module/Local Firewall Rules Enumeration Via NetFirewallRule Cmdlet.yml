rule_id: 420224b1-69ae-4530-8521-69d79f5b713d
name: "Local Firewall Rules Enumeration Via NetFirewallRule Cmdlet"
description: |
  Detects PowerShell module logging events indicating execution of Get-NetFirewallRule or Show-NetFirewallRule,
  which enumerate local Windows Firewall rules. This is commonly used for administration, but attackers can use it
  during discovery to understand allowed inbound/outbound paths and plan lateral movement or C2.
  False positives: Legitimate admin scripts, endpoint management tooling, compliance scans.
  Triage: Confirm the initiating user/context, review parent process chain, check for follow-on actions such as
  firewall rule modification (New/Set-NetFirewallRule), remote service creation, suspicious network connections,
  or execution from unusual hosts/accounts.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | EVAL raw = COALESCE(event.original, "")
  // Filter for specific Firewall discovery cmdlets with proper ES|QL escaping
  | WHERE raw RLIKE "(?i).*\\\\b(Get-NetFirewallRule|Show-NetFirewallRule)\\\\b.*"
  | EVAL cmdlet = CASE(
      raw RLIKE "(?i).*\\\\bGet-NetFirewallRule\\\\b.*", "Get-NetFirewallRule",
      raw RLIKE "(?i).*\\\\bShow-NetFirewallRule\\\\b.*", "Show-NetFirewallRule",
      "NetFirewallRule-Enum"
    )
  | EVAL hour_of_day = DATE_EXTRACT("hour", @timestamp)
  | EVAL is_after_hours = CASE(hour_of_day < 7 OR hour_of_day > 20, true, false)
  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      target_users = VALUES(winlog.event_data.TargetUserName),
      processes = VALUES(winlog.event_data.ProcessName),
      executables = VALUES(winlog.event_data.ProcessName),
      cmdlines = VALUES(winlog.event_data.CommandLine),
      originals = VALUES(raw),
      after_hours_hits = SUM(CASE(is_after_hours == true, 1, 0))
    BY 
      host.name, 
      cmdlet, 
      bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  // Risk calculation: baseline 10 points, plus 10 if performed after hours
  | EVAL risk_score = event_count * 10 + after_hours_hits * 10
  | WHERE risk_score >= 10
  | KEEP 
      agent_id, bucket, host.name, cmdlet, event_count, users, processes, executables, 
      cmdlines, after_hours_hits, risk_score, originals
  | SORT risk_score DESC
enabled: false
tags:
  - detection.threat-hunting
  - attack.discovery
  - attack.t1518.001
  - attack.t1016
severity: low
risk_score: 20
references:
  - "https://learn.microsoft.com/en-us/powershell/module/netsecurity/get-netfirewallrule?view=windowsserver2022-ps"
  - "https://learn.microsoft.com/en-us/powershell/module/netsecurity/show-netfirewallrule?view=windowsserver2022-ps"
nist: ["AU-6", "SI-4"]
pci_dss: ["10.2"]
mitre_attack:
  TA0007:
    T1518: ["T1518.001"]
  TA0007_2:
    T1016: []
