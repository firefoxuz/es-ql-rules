rule_id: b33810d7-5b77-4141-92a4-8541a719c890
name: "New Windows Firewall Rule Added Via New-NetFirewallRule Cmdlet - ScriptBlock"
description: |
  Detects PowerShell Script Block Logging events where a script invokes New-NetFirewallRule with an Allow action.
  Attackers may add permissive firewall rules to enable inbound access, lateral movement, or persistence, or to
  facilitate ransomware operations.
  Requirements: PowerShell Script Block Logging must be enabled.
  False positives: Administrator scripts, endpoint management tooling, legitimate application installation.
  Triage: Review the full script block for rule parameters (Direction, LocalPort, RemoteAddress, Program/Service),
  identify the initiating user and parent process, and correlate with other firewall changes (Set/Remove-NetFirewallRule),
  new listening services, suspicious network connections, or post-exploitation activity.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | EVAL raw = COALESCE(event.original, winlog.event_data.CommandLine, winlog.event_data.CommandLine, "")
  // Match New-NetFirewallRule and ensure 'Allow' action is present
  | WHERE raw RLIKE "(?i).*\\\\bNew-NetFirewallRule\\\\b.*" 
    AND raw RLIKE "(?i).*\\\\-Action\\\\s*Allow\\\\b.*"
  | EVAL hour_of_day = DATE_EXTRACT("hour", @timestamp)
  | EVAL is_after_hours = CASE(hour_of_day < 7 OR hour_of_day > 20, true, false)
  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      target_users = VALUES(winlog.event_data.TargetUserName),
      processes = VALUES(winlog.event_data.ProcessName),
      executables = VALUES(winlog.event_data.ProcessName),
      cmdlines = VALUES(winlog.event_data.CommandLine),
      originals = VALUES(COALESCE(event.original, "")),
      after_hours_hits = SUM(CASE(is_after_hours == true, 1, 0))
    BY 
      host.name, 
      bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  // Risk: High base score (20) because rule creation is rare for standard users
  | EVAL risk_score = event_count * 20 + after_hours_hits * 15
  | WHERE risk_score >= 20
  | KEEP 
      agent_id, bucket, host.name, event_count, users, processes, executables, 
      cmdlines, after_hours_hits, risk_score, originals
  | SORT risk_score DESC
enabled: false
tags:
  - attack.defense-evasion
  - attack.t1562.004
  - detection.threat-hunting
severity: low
risk_score: 35
references:
  - "https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1562.004/T1562.004.md#atomic-test-24---set-a-firewall-rule-using-new-netfirewallrule"
  - "https://malware.news/t/the-rhysida-ransomware-activity-analysis-and-ties-to-vice-society/72170"
  - "https://cybersecuritynews.com/rhysida-ransomware-attacking-windows/"
nist: ["SC-7", "CM-6", "AU-6", "SI-4"]
pci_dss: ["1.1", "10.2"]
mitre_attack:
  TA0005:
    T1562: ["T1562.004"]
