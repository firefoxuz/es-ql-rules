rule_id: 265f20c5-dea5-4c0e-990d-442866d3804a
name: "SMB over QUIC Via PowerShell Script"
description: |
  Detects PowerShell Script Block Logging events indicating a Windows SMB share mapping over QUIC
  (New-SmbMapping with -TransportType QUIC). In many enterprise environments SMB over QUIC is uncommon,
  and its use may indicate suspicious lateral movement or covert file access over QUIC/UDP 443.
  Requirements: PowerShell Script Block Logging must be enabled.
  False positives: Possible (string matching in script blocks; legitimate testing or approved SMB over QUIC deployments).
  Triage: Review the script block for the target share/server, credentials usage, and follow-on file operations.
  Correlate with network telemetry for QUIC/UDP 443 to the target, authentication events, and other discovery/lateral activity.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | EVAL raw = COALESCE(event.original, winlog.event_data.CommandLine, winlog.event_data.CommandLine, "")
  // Match New-SmbMapping with the specific QUIC transport type
  | WHERE raw RLIKE "(?i).*\\\\bNew-SmbMapping\\\\b.*"
    AND raw RLIKE "(?i).*\\\\-TransportType\\\\s+QUIC\\\\b.*"
  | EVAL hour_of_day = DATE_EXTRACT("hour", @timestamp)
  | EVAL is_after_hours = CASE(hour_of_day < 7 OR hour_of_day > 20, true, false)
  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      target_users = VALUES(winlog.event_data.TargetUserName),
      processes = VALUES(winlog.event_data.ProcessName),
      executables = VALUES(winlog.event_data.ProcessName),
      cmdlines = VALUES(winlog.event_data.CommandLine),
      originals = VALUES(COALESCE(event.original, "")),
      after_hours_hits = SUM(CASE(is_after_hours == true, 1, 0))
    BY 
      host.name, 
      bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  // Risk Score: Baseline 25 (Rarely used in standard office setups); bonus for after-hours
  | EVAL risk_score = event_count * 25 + after_hours_hits * 20
  | WHERE risk_score >= 25
  | KEEP 
      agent_id, bucket, host.name, event_count, users, processes, executables, 
      cmdlines, after_hours_hits, risk_score, originals
  | SORT risk_score DESC
enabled: false
tags:
  - attack.lateral-movement
  - attack.t1570
  - detection.threat-hunting
severity: medium
risk_score: 55
references:
  - "https://github.com/redcanaryco/atomic-red-team/blob/74438b0237d141ee9c99747976447dc884cb1a39/atomics/T1570/T1570.md"
  - "https://learn.microsoft.com/en-us/powershell/module/smbshare/new-smbmapping?view=windowsserver2022-ps"
  - "https://www.trustedsec.com/blog/making-smb-accessible-with-ntlmquic/"
nist: ["AU-6", "SI-4", "AC-6"]
pci_dss: ["10.2"]
mitre_attack:
  TA0008:
    T1570: []
