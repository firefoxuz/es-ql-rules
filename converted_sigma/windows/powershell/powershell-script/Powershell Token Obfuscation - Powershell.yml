rule_id: 27297a34-0360-4c46-be99-737ba74ffcee
name: "Powershell Token Obfuscation - Powershell"
description: |
  Detects common token-obfuscation patterns frequently produced by Invoke-Obfuscation and similar techniques
  in PowerShell Script Block Logging. This is intended as a threat-hunting baseline to identify obfuscated
  scripts (backticks inserted into tokens, string-format placeholder reconstruction, and obfuscated ${env:path}).
  Requirements: PowerShell Script Block Logging must be enabled.
  Exclusions: Known benign cases (plain ${env:path}, Chocolatey install scripts, Exchange servicecontrol.ps1 patterns).
  False positives: Possible (heavy legitimate string formatting or intentionally obfuscated admin scripts).
  Triage: Review the full script block for download/execute patterns (IEX, DownloadString, FromBase64String),
  suspicious network/URL usage, and correlate with parent process, user context, and follow-on persistence actions.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | EVAL raw = COALESCE(event.original, winlog.event_data.CommandLine, winlog.event_data.CommandLine, "")
  // Selection: Identify token obfuscation patterns
  | WHERE (
      /* Backtick-in-token: matches i`n`v`o`k`e style patterns */
      raw RLIKE "(?i).*\\\\w+`(\\\\w+|\\\\-|\\\\.)`[\\\\w\\\\s\\\\+\\\\|].*" OR
      /* String-format reconstruction: "{0}{1}" -f ... */
      raw RLIKE ".*\\\"(\\\\{\\\\d\\\\\\}){2,}\\\"\\\\s*\\\\-f.*" OR
      /* Obfuscated environment path: ${e`n`v:p`a`t`h} */
      raw RLIKE "(?i).*\\\\$\\\\{`?e`?n`?v`?:`?p`?a`?t`?h`?\\\\}.*"
    )
  // Filters: Exclude known benign activity
  | WHERE NOT (
      /* Plain environment path usage */
      raw LIKE "*${env:path}*" OR
      /* Chocolatey installer noise */
      raw LIKE "*it will return true or false instead*" OR
      raw LIKE "*The function also prevents `Get-ItemProperty` from failing*" OR
      /* Specific Microsoft Exchange service control script noise */
      (winlog.event_data.OriginalFileName RLIKE "(?i)^C:\\\\\\\\Program Files\\\\\\\\Microsoft\\\\\\\\Exchange Server\\\\\\\\.*\\\\\\\\bin\\\\\\\\servicecontrol\\\\.ps1$" AND raw LIKE "*`r`n*")
    )
  | EVAL hour_of_day = DATE_EXTRACT("hour", @timestamp)
  | EVAL is_after_hours = CASE(hour_of_day < 7 OR hour_of_day > 20, true, false)
  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      processes = VALUES(winlog.event_data.ProcessName),
      executables = VALUES(winlog.event_data.ProcessName),
      cmdlines = VALUES(winlog.event_data.CommandLine),
      script_paths = VALUES(winlog.event_data.OriginalFileName),
      originals = VALUES(COALESCE(event.original, "")),
      after_hours_hits = SUM(CASE(is_after_hours == true, 1, 0))
    BY 
      host.name, 
      bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  | EVAL risk_score = event_count * 25 + after_hours_hits * 20
  | WHERE risk_score >= 25
  | KEEP 
      agent_id, bucket, host.name, event_count, users, processes, executables, 
      cmdlines, script_paths, after_hours_hits, risk_score, originals
  | SORT risk_score DESC
enabled: false
tags:
  - attack.defense-evasion
  - attack.t1027.009
  - detection.threat-hunting
severity: medium
risk_score: 55
references:
  - "https://github.com/danielbohannon/Invoke-Obfuscation"
nist: ["AU-6", "SI-4"]
pci_dss: ["10.2"]
mitre_attack:
  TA0005:
    T1027: ["T1027.009"]
