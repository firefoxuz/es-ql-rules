rule_id: 74e2aebe-fb75-40cd-a7ec-2e0533e860f9
name: "Compress-Archive Cmdlet Execution"
description: |
  Detects PowerShell Script Block Logging events where the Compress-Archive cmdlet is used to compress
  files/folders. Adversaries may stage collected data into archives before exfiltration to reduce size
  and simplify transfer.
  Requirements: PowerShell Script Block Logging must be enabled.
  False positives: Likely (legitimate admin/dev scripts, backups, packaging tasks).
  Triage: Review script content and output path, look for sensitive directory targets (Users, Desktop,
  Documents, browser/profile folders), unusual archive destinations (Temp, Public, ProgramData),
  and correlate with subsequent network activity (uploads, new outbound connections) or file writes.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | EVAL raw = COALESCE(event.original, winlog.event_data.CommandLine, "")
  // Filter for Compress-Archive with proper ES|QL regex escaping
  | WHERE raw RLIKE "(?i).*\\\\bCompress-Archive\\\\b.*"
  | EVAL hour_of_day = DATE_EXTRACT("hour", @timestamp)
  | EVAL is_after_hours = CASE(hour_of_day < 7 OR hour_of_day > 20, true, false)
  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      target_users = VALUES(winlog.event_data.TargetUserName),
      processes = VALUES(winlog.event_data.ProcessName),
      executables = VALUES(winlog.event_data.ProcessName),
      cmdlines = VALUES(winlog.event_data.CommandLine),
      originals = VALUES(COALESCE(event.original, "")),
      after_hours_hits = SUM(CASE(is_after_hours == true, 1, 0))
    BY 
      host.name, 
      bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  // Risk: 10 points per event + 10 points for after-hours activity
  | EVAL risk_score = event_count * 10 + after_hours_hits * 10
  | WHERE risk_score >= 10
  | KEEP 
      agent_id, bucket, host.name, event_count, users, processes, executables, 
      cmdlines, after_hours_hits, risk_score, originals
  | SORT risk_score DESC
enabled: false
tags:
  - attack.exfiltration
  - attack.collection
  - attack.t1560
  - detection.threat-hunting
severity: low
risk_score: 20
references:
  - "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1560/T1560.md"
nist: ["AU-6", "SI-4"]
pci_dss: ["10.2"]
mitre_attack:
  TA0010:
    T1560: []
  TA0009:
    T1560_2: []
