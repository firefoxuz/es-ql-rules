rule_id: e149cb3d-9e71-42b4-93f4-999f7103d9b8
name: "Use Of Remove-Item to Delete File - ScriptBlock"
description: |
  Detects PowerShell Script Block Logging events where file or directory deletion is performed
  using Remove-Item or its common aliases (del, erase, rd, ri, rm, rmdir) with the -Path parameter.
  Adversaries may delete files or folders to remove evidence, clear artifacts, or disrupt recovery
  (defense evasion).
  Requirements: PowerShell Script Block Logging must be enabled.
  False positives: Legitimate administrative or maintenance scripts, cleanup jobs.
  Triage: Review the full script block to identify deleted paths, check for use of -Recurse/-Force,
  validate the user and execution context, and correlate with other defense-evasion behaviors
  (log clearing, shadow copy deletion, tool cleanup).
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | EVAL raw = COALESCE(event.original, winlog.event_data.CommandLine, winlog.event_data.CommandLine, "")
  // Match Remove-Item and common aliases with a mandatory -Path parameter
  | WHERE raw RLIKE "(?i).*\\\\b(Remove-Item|del|erase|rd|ri|rm|rmdir)\\\\b\\\\s+\\\\-Path\\\\b.*"
  | EVAL hour_of_day = DATE_EXTRACT("hour", @timestamp)
  | EVAL is_after_hours = CASE(hour_of_day < 7 OR hour_of_day > 20, true, false)
  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      target_users = VALUES(winlog.event_data.TargetUserName),
      processes = VALUES(winlog.event_data.ProcessName),
      executables = VALUES(winlog.event_data.ProcessName),
      cmdlines = VALUES(winlog.event_data.CommandLine),
      originals = VALUES(COALESCE(event.original, "")),
      after_hours_hits = SUM(CASE(is_after_hours == true, 1, 0))
    BY 
      host.name, 
      bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  // Risk calculation: 10 points per event, plus 10 if performed after hours
  | EVAL risk_score = event_count * 10 + after_hours_hits * 10
  | WHERE risk_score >= 10
  | KEEP 
      agent_id, bucket, host.name, event_count, users, processes, executables, 
      cmdlines, after_hours_hits, risk_score, originals
  | SORT risk_score DESC
enabled: false
tags:
  - attack.defense-evasion
  - attack.t1070.004
  - detection.threat-hunting
severity: low
risk_score: 20
references:
  - "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1070.004/T1070.004.md"
  - "https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/Remove-Item?view=powershell-5.1&viewFallbackFrom=powershell-7"
nist: ["AU-6", "SI-4"]
pci_dss: ["10.2"]
mitre_attack:
  TA0005:
    T1070: ["T1070.004"]
