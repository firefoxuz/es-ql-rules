rule_id: f7253dce-328a-4536-97d9-d75a8d62bd5e
name: "WinAPI Function Calls Via PowerShell Scripts"
description: |
  Detects PowerShell Script Block Logging events referencing common WinAPI / low-level function names frequently
  used in offensive tradecraft (P/Invoke, reflection, in-memory execution, process injection, token manipulation,
  credential dumping). Attackers may call these APIs from PowerShell to evade detections focused on standard cmdlets.
  This is primarily a threat-hunting baseline and can generate noise; tune using execution context (script path,
  parent process, user, host role) and add allowlists for known tooling.
  Requirements: PowerShell Script Block Logging must be enabled.
  False positives: Expected (legit security tools, admin frameworks, red team tooling, some installers).
  Triage: Look for Add-Type / DllImport / Marshal / reflection usage, suspicious parent processes (Office, browsers,
  wscript/cscript, mshta), unsigned script locations (Temp/Downloads/Public), and correlate with injection indicators,
  LSASS access, new services/tasks, and outbound C2.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | EVAL raw = COALESCE(event.original, winlog.event_data.CommandLine, winlog.event_data.CommandLine, "")
  // Hunt for WinAPI function names using robust regex word boundaries
  | WHERE raw RLIKE "(?i).*\\\\b(AddSecurityPackage|AdjustTokenPrivileges|CloseHandle|CreateProcessWithToken|CreateRemoteThread|CreateThread|CreateUserThread|DangerousGetHandle|DuplicateTokenEx|EnumerateSecurityPackages|FreeLibrary|GetDelegateForFunctionPointer|GetLogonSessionData|GetModuleHandle|GetProcAddress|GetProcessHandle|GetTokenInformation|ImpersonateLoggedOnUser|LoadLibrary|memcpy|MiniDumpWriteDump|OpenDesktop|OpenProcess|OpenProcessToken|OpenThreadToken|OpenWindowStation|QueueUserApc|ReadProcessMemory|RevertToSelf|RtlCreateUserThread|SetThreadToken|VirtualAlloc|VirtualFree|VirtualProtect|WaitForSingleObject|WriteInt32|WriteProcessMemory|ZeroFreeGlobalAllocUnicode)\\\\b.*"
  | EVAL hour_of_day = DATE_EXTRACT("hour", @timestamp)
  | EVAL is_after_hours = CASE(hour_of_day < 7 OR hour_of_day > 20, true, false)
  // Context signal: Check if the script is running from a common staging directory
  | EVAL suspicious_script_path = CASE(
      winlog.event_data.OriginalFileName RLIKE "(?i).*\\\\\\\\(Users\\\\\\\\.*\\\\\\\\(Downloads|AppData\\\\\\\\Local\\\\\\\\Temp)|Windows\\\\\\\\Temp|ProgramData|Users\\\\\\\\Public)\\\\\\\\.*", true,
      false
    )
  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      processes = VALUES(winlog.event_data.ProcessName),
      executables = VALUES(winlog.event_data.ProcessName),
      cmdlines = VALUES(winlog.event_data.CommandLine),
      script_paths = VALUES(winlog.event_data.OriginalFileName),
      originals = VALUES(COALESCE(event.original, "")),
      after_hours_hits = SUM(CASE(is_after_hours == true, 1, 0)),
      suspicious_path_hits = SUM(CASE(suspicious_script_path == true, 1, 0))
    BY 
      host.name, 
      bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  // Risk Scoring: 20 per event + 15 for night activity + 10 for suspicious paths
  | EVAL risk_score = event_count * 20 + after_hours_hits * 15 + suspicious_path_hits * 10
  | WHERE risk_score >= 25
  | KEEP 
      agent_id, bucket, host.name, event_count, users, processes, executables, 
      cmdlines, script_paths, after_hours_hits, suspicious_path_hits, risk_score, originals
  | SORT risk_score DESC
enabled: false
tags:
  - attack.execution
  - attack.t1059.001
  - attack.t1106
  - detection.threat-hunting
severity: medium
risk_score: 55
references:
  - "https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse"
nist: ["AU-6", "SI-4"]
pci_dss: ["10.2"]
mitre_attack:
  TA0002:
    T1059: ["T1059.001"]
  TA0002_2:
    T1106: []
