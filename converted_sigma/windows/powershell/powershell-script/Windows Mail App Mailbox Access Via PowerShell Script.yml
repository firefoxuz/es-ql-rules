rule_id: 3f28c4d4-d07b-4202-8624-87fc0b654dcc
name: "Windows Mail App Mailbox Access Via PowerShell Script"
description: |
  Detects PowerShell Script Block Logging events that reference the Windows Mail app mailbox storage path
  (\Comms\Unistore\data). Access to this path can indicate manipulation of, collection of, or attempted
  exfiltration/deletion of stored user emails from the default Windows Mail app (Mail/Calendar).
  Requirements: PowerShell Script Block Logging must be enabled.
  False positives: Unknown (may occur with legitimate mail troubleshooting or backup tooling, depending on environment).
  Triage: Review script content for file copy/delete/search actions, confirm the user context, check the parent process
  and execution origin (interactive vs. scheduled/remote), and correlate with file access (if available), archive creation,
  or outbound network activity shortly after.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | EVAL raw = COALESCE(event.original, winlog.event_data.CommandLine, winlog.event_data.CommandLine, "")
  // Target the Unistore data directory where local emails and contacts are stored
  | WHERE raw LIKE "*\\\\Comms\\\\Unistore\\\\data*"
  | EVAL hour_of_day = DATE_EXTRACT("hour", @timestamp)
  | EVAL is_after_hours = CASE(hour_of_day < 7 OR hour_of_day > 20, true, false)
  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      target_users = VALUES(winlog.event_data.TargetUserName),
      processes = VALUES(winlog.event_data.ProcessName),
      executables = VALUES(winlog.event_data.ProcessName),
      cmdlines = VALUES(winlog.event_data.CommandLine),
      originals = VALUES(COALESCE(event.original, "")),
      after_hours_hits = SUM(CASE(is_after_hours == true, 1, 0))
    BY 
      host.name, 
      bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  // Risk: High base (25) because this directory is rarely touched by anything but system background tasks
  | EVAL risk_score = event_count * 25 + after_hours_hits * 20
  | WHERE risk_score >= 25
  | KEEP 
      agent_id, bucket, host.name, event_count, users, processes, executables, 
      cmdlines, after_hours_hits, risk_score, originals
  | SORT risk_score DESC
enabled: false
tags:
  - attack.defense-evasion
  - attack.t1070.008
  - detection.threat-hunting
severity: medium
risk_score: 55
references:
  - "https://github.com/redcanaryco/atomic-red-team/blob/02cb591f75064ffe1e0df9ac3ed5972a2e491c97/atomics/T1070.008/T1070.008.md"
nist: ["AU-6", "SI-4"]
pci_dss: ["10.2"]
mitre_attack:
  TA0005:
    T1070: ["T1070.008"]
