rule_id: e8850e68-4424-494e-b79b-a5c8592da26c
name: "WinAPI Library Calls Via PowerShell Scripts"
description: |
  Detects PowerShell Script Block Logging events referencing common WinAPI libraries (Advapi32.dll, kernel32.dll,
  KernelBase.dll, ntdll.dll, secur32.dll, user32.dll). Attackers often call WinAPI via .NET interop / Add-Type /
  P/Invoke to perform actions that may evade detections focused on typical PowerShell cmdlets/functions.
  Use this as a hunting baseline and tune for your environment.
  Requirements: PowerShell Script Block Logging must be enabled.
  False positives: Carbon PowerShell Module, Chocolatey scripts, and other legitimate automation that uses WinAPI.
  Triage: Review the script block for Add-Type / DllImport / Marshal usage, suspicious API functions (VirtualAlloc,
  WriteProcessMemory, CreateRemoteThread, OpenProcess, MiniDumpWriteDump), and correlate with process injection,
  credential dumping, or unusual child processes/network activity.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | EVAL raw = COALESCE(event.original, winlog.event_data.CommandLine, winlog.event_data.CommandLine, "")
  // Selection: Identify references to critical Windows Native Libraries
  | WHERE raw RLIKE "(?i).*\\\\b(Advapi32\\\\.dll|kernel32\\\\.dll|KernelBase\\\\.dll|ntdll\\\\.dll|secur32\\\\.dll|user32\\\\.dll)\\\\b.*"
  /* Filters: exclude known benign frameworks/installers */
  | WHERE NOT (
      raw RLIKE "(?i).*\\\\b(Carbon|chocolatey|choco)\\\\b.*"
    )
  | EVAL library_hit = CASE(
      raw RLIKE "(?i).*\\\\bAdvapi32\\\\.dll\\\\b.*", "Advapi32.dll",
      raw RLIKE "(?i).*\\\\bkernel32\\\\.dll\\\\b.*", "kernel32.dll",
      raw RLIKE "(?i).*\\\\bKernelBase\\\\.dll\\\\b.*", "KernelBase.dll",
      raw RLIKE "(?i).*\\\\bntdll\\\\.dll\\\\b.*", "ntdll.dll",
      raw RLIKE "(?i).*\\\\bsecur32\\\\.dll\\\\b.*", "secur32.dll",
      raw RLIKE "(?i).*\\\\buser32\\\\.dll\\\\b.*", "user32.dll",
      "WinAPI"
    )
  | EVAL hour_of_day = DATE_EXTRACT("hour", @timestamp)
  | EVAL is_after_hours = CASE(hour_of_day < 7 OR hour_of_day > 20, true, false)
  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      processes = VALUES(winlog.event_data.ProcessName),
      executables = VALUES(winlog.event_data.ProcessName),
      cmdlines = VALUES(winlog.event_data.CommandLine),
      script_paths = VALUES(winlog.event_data.OriginalFileName),
      libs = VALUES(library_hit),
      originals = VALUES(COALESCE(event.original, "")),
      after_hours_hits = SUM(CASE(is_after_hours == true, 1, 0))
    BY 
      host.name, 
      bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  // Risk: High base (25) for direct DLL referencing; significant bonus for after-hours activity
  | EVAL risk_score = event_count * 25 + after_hours_hits * 20
  | WHERE risk_score >= 25
  | KEEP 
      agent_id, bucket, host.name, libs, event_count, users, processes, executables, 
      cmdlines, script_paths, after_hours_hits, risk_score, originals
  | SORT risk_score DESC
enabled: false
tags:
  - attack.execution
  - attack.t1059.001
  - attack.t1106
  - detection.threat-hunting
severity: medium
risk_score: 55
references:
  - "https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse"
nist: ["AU-6", "SI-4"]
pci_dss: ["10.2"]
mitre_attack:
  TA0002:
    T1059: ["T1059.001"]
  TA0002_2:
    T1106: []
