rule_id: 12cc81d7-d54b-4299-9f35-dca0c8864493
name: "Potential Data Exfiltration Over SMTP Via Send-MailMessage Cmdlet"
description: |
  Detects PowerShell Script Block Logging events where Send-MailMessage is used with the -Attachments flag.
  This may indicate potential data exfiltration via email (SMTP), especially when used from endpoints that do not
  normally send mail directly or when combined with prior data staging (Compress-Archive) and suspicious recipients.
  Requirements: PowerShell Script Block Logging must be enabled.
  False positives: Unknown (could be legitimate automation/alerts depending on environment).
  Triage: Review the full script block for recipient domains, SMTP server, attachment paths, and credentials usage.
  Correlate with recent file collection/staging activity, archive creation, and outbound network connections to
  SMTP ports (25/465/587) or unexpected mail servers.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | EVAL raw = COALESCE(event.original, winlog.event_data.CommandLine, winlog.event_data.CommandLine, "")
  // Match Send-MailMessage and the use of the -Attachments parameter
  | WHERE raw RLIKE "(?i).*\\\\bSend-MailMessage\\\\b.*" 
    AND raw RLIKE "(?i).*\\\\-Attachments\\\\b.*"
  | EVAL hour_of_day = DATE_EXTRACT("hour", @timestamp)
  | EVAL is_after_hours = CASE(hour_of_day < 7 OR hour_of_day > 20, true, false)
  | STATS
    event_count = COUNT(*),
    users = VALUES(winlog.event_data.TargetUserName),
    target_users = VALUES(winlog.event_data.TargetUserName),
    processes = VALUES(winlog.event_data.ProcessName),
    executables = VALUES(winlog.event_data.ProcessName),
    cmdlines = VALUES(winlog.event_data.CommandLine),
    originals = VALUES(COALESCE(event.original, "")),
    after_hours_hits = SUM(CASE(is_after_hours == true, 1, 0))
  BY 
    host.name, 
    bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  // Risk: High base (25) because SMTP from endpoints is rare; bonus for night activity
  | EVAL risk_score = event_count * 25 + after_hours_hits * 20
  | WHERE risk_score >= 25
  | KEEP 
    agent_id, bucket, host.name, event_count, users, processes, executables, 
    cmdlines, after_hours_hits, risk_score, originals
  | SORT risk_score DESC
enabled: false
tags:
  - attack.exfiltration
  - attack.t1048.003
  - detection.threat-hunting
severity: medium
risk_score: 55
references:
  - "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1048.003/T1048.003.md#atomic-test-5---exfiltration-over-alternative-protocol---smtp"
  - "https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/send-mailmessage?view=powershell-7.4"
  - "https://www.ietf.org/rfc/rfc2821.txt"
nist: ["AU-6", "SI-4", "SC-7"]
pci_dss: ["10.2"]
mitre_attack:
  TA0010:
    T1048: ["T1048.003"]
