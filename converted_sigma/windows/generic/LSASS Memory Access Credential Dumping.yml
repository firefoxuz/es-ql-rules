rule_id: a96e2055-8d90-44d2-b4d7-1c9d2f91d86b
#//RULE-NIST-20 â€” Credential Dumping Detection (NIST IR-4, IA-5)
#//Control Family: IR (Incident Response), IA (Identification and Authentication)
#//Objective: Detect attempts to dump credentials from memory or registry
#//Threat scenario: Attacker extracts passwords/hashes for credential theft
#//Data sources: Windows Security 4656 (lsass.exe access), process creation patterns
#//ECS fields used: event.code, winlog.event_data.ProcessName, event.original, winlog.event_data.OriginalFileName
#//Field validation: Verify all ECS fields exist in your indices before enabling
# REQUIRES: Sysmon with process monitoring configuration
#//Tuning notes: Allowlist legitimate security tools, LAPS, password managers

name: "LSASS Memory Access Credential Dumping"
description: |
  Detects unauthorized access to lsass.exe process memory, typical of credential dumping tools.
  Tools like Mimikatz, ProcDump, Comsvcs.dll abuse open process handles to extract credentials.
  Direct file access to SAM/SYSTEM registry hives or NTDS.dit also captured.
  False positives: Legitimate security tools, EDR agents, password management utilities.
  Triage: Check process signature and path legitimacy, review parent process, 
  immediately reset potentially compromised credentials, hunt for credential reuse.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | WHERE 
    // 1. LSASS jarayoniga kirish yoki handle (Sleshlar to'g'rilandi: \\. )
    (winlog.event_id == "4656" AND winlog.event_data.ProcessName RLIKE "(?i).*lsass\\.exe")
    OR (winlog.event_id == "10" AND winlog.event_data.ProcessName RLIKE "(?i).*lsass\\.exe")
    
    // 2. Shubhali protsesslar ishga tushishi
    OR (winlog.event_id IN ("4688", "1") 
        AND (
          winlog.event_data.CommandLine RLIKE "(?i).*(sekurlsa|logonpasswords|procdump|comsvcs|MiniDump).*"
          OR winlog.event_data.CommandLine RLIKE "(?i).*(sekurlsa|logonpasswords|procdump|comsvcs|MiniDump).*"
        )
    )
    
    OR (winlog.event_id IN ("4656", "4663") 
        AND winlog.event_data.ObjectName RLIKE "(?i).*(SAM$|SYSTEM$|SECURITY$|ntds\\\\.dit).*")

  | EVAL attack_method = CASE(
    (winlog.event_data.CommandLine RLIKE "(?i).*sekurlsa.*" OR winlog.event_data.CommandLine RLIKE "(?i).*sekurlsa.*"), "Mimikatz-Dump",
    (winlog.event_data.CommandLine RLIKE "(?i).*procdump.*" OR winlog.event_data.CommandLine RLIKE "(?i).*procdump.*"), "ProcDump-LSASS",
    (winlog.event_data.CommandLine RLIKE "(?i).*comsvcs.*" OR winlog.event_data.CommandLine RLIKE "(?i).*comsvcs.*"), "Comsvcs-Dump",
    (winlog.event_data.ObjectName RLIKE "(?i).*ntds\\\\.dit.*"), "NTDS-Extraction",
    winlog.event_id == "4656", "LSASS-Handle-Request",
    "Credential-Access-Attempt"
  )

  | STATS 
    event_count = COUNT(*),
    processes = VALUES(winlog.event_data.ProcessName),
    commands = VALUES(winlog.event_data.CommandLine),
    parent_processes = VALUES(winlog.event_data.CallerProcessName)
  BY winlog.computer_name, winlog.event_data.SubjectUserName, attack_method, 
     bucket = DATE_TRUNC(10 minutes, @timestamp)

  | WHERE event_count >= 1

  | EVAL risk_score = CASE(
    attack_method IN ("Mimikatz-Dump", "NTDS-Extraction"), event_count * 60,
    event_count * 40
  )

  | KEEP agent_id, bucket, winlog.computer_name, winlog.event_data.SubjectUserName, attack_method, event_count, processes, commands, parent_processes, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - nist_800_53
  - control_IR-4
  - control_IA-5
  - family_IR
  - family_IA
  - credential_access
  - defense_evasion
  - critical_incident
severity: critical
risk_score: 92
references:
  - "NIST SP 800-53 Rev.5 IR-4: Incident Handling"
  - "MITRE ATT&CK T1003.001: LSASS Memory"
nist: ["IR-4", "IA-5"]
gdpr: []
pci_dss: []
mitre_attack:
  TA0006:
    T1003: ["T1003.001"]