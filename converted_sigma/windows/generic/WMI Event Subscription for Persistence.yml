rule_id: 4782a1a7-344e-461e-9976-9234391a5c95
name: WMI Event Subscription for Persistence
description: |
  Detects creation of WMI event subscriptions (Event ID 5861, 5859) which can be used for persistence and execution. Monitors for WMI event consumers, filters, and bindings that execute on specific triggers.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - winlogbeat-*
query_language: esql
query: |
  FROM winlogbeat-*
  | WHERE event.code IN ("5859", "5860", "5861")
  | EVAL 
      creator = COALESCE(user.name, winlog.event_data.SubjectUserName, "Unknown"),
      operation = COALESCE(winlog.event_data.Operation, "Unknown"),
      namespace = COALESCE(winlog.event_data.Namespace, "Unknown"),
      event_type = CASE(
        event.code == "5859", "WMI Filter Activity",
        event.code == "5860", "WMI Consumer Activity", 
        event.code == "5861", "WMI Binding Activity",
        "Unknown"
      )
  /* Filter for creation operations */
  | WHERE operation RLIKE "(?i)(Created|Modification|Binding)"
  | STATS 
      wmi_operations = COUNT(*),
      operations = VALUES(operation),
      event_types = VALUES(event_type),
      namespaces = VALUES(namespace),
      first_operation = MIN(@timestamp),
      last_operation = MAX(@timestamp)
    BY host.name, creator, bucket = DATE_TRUNC(1 hour, @timestamp)
  | WHERE wmi_operations >= 1
  | KEEP bucket, host.name, creator, wmi_operations, operations,
      event_types, namespaces, first_operation, last_operation
  | SORT wmi_operations DESC
enabled: true
tags:
  - attack.persistence
  - attack.execution
  - attack.t1546.003
  - detection.emerging-threats
severity: high
risk_score: 75
mitre_attack:
  TA0003:
    T1546: ["T1546.003"]
  TA0002:
    T1047: []
