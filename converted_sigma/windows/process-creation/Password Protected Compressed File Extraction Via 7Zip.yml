rule_id: 26293172-59b7-4af6-a4b5-a985ad1dffb0
name: "Password Protected Compressed File Extraction Via 7Zip"
description: |
  Detects usage of 7-Zip command-line utilities (7z.exe/7za.exe/7zr.exe) to extract password-protected archives.
  Adversaries often deliver or stage payloads inside encrypted archives to bypass content inspection and AV scanning.
  This is a hunting rule because legitimate password-protected extraction can be common in some environments.
  Triage: Review the archive source and destination (-o), check parent process (email client, browser, Office),
  validate where the extracted files landed (Temp/Downloads/AppData), and correlate with subsequent execution of
  dropped binaries/scripts.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  // Filter for process creation events
  | WHERE event.category == "process" 
     OR event.dataset RLIKE "(?i).*process.*" 
     OR event.code IN ("1", "4688")
  // Selection: Identify 7-Zip variants via name, path, or metadata
  | WHERE winlog.event_data.ProcessName RLIKE "(?i).*\\\\(7z|7za|7zr)\\\\.exe$"
     OR winlog.event_data.ProcessName IN ("7z.exe", "7za.exe", "7zr.exe")
     OR (COALESCE(event.original, "") LIKE "*7-Zip*")
  // Selection: Command line contains extract (x), password (-p), and output (-o)
  | EVAL cmd = COALESCE(winlog.event_data.CommandLine, winlog.event_data.CommandLine, "")
  | WHERE cmd RLIKE "(?i).*\\\\sx\\\\s.*"
    AND cmd RLIKE "(?i).*\\\\s-p.*"
    AND cmd RLIKE "(?i).*\\\\s-o.*"
  | EVAL hour_of_day = DATE_EXTRACT("hour", @timestamp)
  | EVAL is_after_hours = CASE(hour_of_day < 7 OR hour_of_day > 20, true, false)
  // Flag parents that commonly drop or execute second-stage payloads
  | EVAL suspicious_parent = CASE(
      winlog.event_data.CallerProcessName RLIKE "(?i)^(outlook|winword|excel|powerpnt|acrord32|chrome|msedge|firefox)\\\\.exe$", true,
      false
    )
  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      parents = VALUES(winlog.event_data.CallerProcessName),
      parent_cmdlines = VALUES(winlog.event_data.CommandLine),
      cmdlines = VALUES(cmd),
      executables = VALUES(winlog.event_data.ProcessName),
      pids = VALUES(winlog.event_data.ProcessPid),
      after_hours_hits = SUM(CASE(is_after_hours == true, 1, 0)),
      suspicious_parent_hits = SUM(CASE(suspicious_parent == true, 1, 0))
    BY 
      host.name, 
      bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  // Risk Scoring: 5 base + 10 for after-hours + 10 for suspicious parent
  | EVAL risk_score = event_count * 5 + after_hours_hits * 10 + suspicious_parent_hits * 10
  | WHERE risk_score >= 5
  | KEEP 
      agent_id, bucket, host.name, event_count, users, parents, cmdlines, executables, 
      after_hours_hits, suspicious_parent_hits, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - attack.collection
  - attack.t1560.001
  - detection.threat-hunting
severity: low
risk_score: 20
references:
  - "https://blog.cyble.com/2022/06/07/bumblebee-loader-on-the-rise/"
nist: ["AU-6", "SI-4"]
pci_dss: ["10.2"]
gdpr: ["32.1.a"]
mitre_attack:
  TA0009:
    T1560: ["T1560.001"]
