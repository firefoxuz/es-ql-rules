rule_id: 49a4275f-4e0c-42b6-b618-db09180dbfcf
name: "Potential Proxy Execution Via Explorer.EXE From Shell Process"
description: |
  Detects explorer.exe being spawned from a shell host process (cmd.exe, powershell.exe, pwsh.exe)
  with a command line containing "explorer.exe". Adversaries may proxy execution through explorer.exe
  to evade defensive controls. This behavior can be legitimate; use as a hunting baseline.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  // Filter for process creation events
  | WHERE event.category == "process" 
     OR event.code IN ("1", "4688") 
     OR event.dataset RLIKE "(?i).*process.*"
  // Selection: Shell spawning Explorer (Abnormal lineage)
  | WHERE (winlog.event_data.CallerProcessName IN ("cmd.exe", "powershell.exe", "pwsh.exe") 
           OR winlog.event_data.CallerProcessName RLIKE "(?i).*\\\\(cmd|powershell|pwsh)\\\\.exe$")
  // Selection: Child is explorer.exe
  | WHERE (winlog.event_data.ProcessName == "explorer.exe" 
           OR winlog.event_data.ProcessName RLIKE "(?i).*\\\\explorer\\\\.exe$")
  | EVAL cmd = COALESCE(winlog.event_data.CommandLine, winlog.event_data.CommandLine, "")
  | WHERE cmd LIKE "*explorer.exe*"
  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      parents = VALUES(winlog.event_data.CallerProcessName),
      parent_cmdlines = VALUES(winlog.event_data.CommandLine),
      children = VALUES(winlog.event_data.ProcessName),
      child_executables = VALUES(winlog.event_data.ProcessName),
      child_cmdlines = VALUES(cmd),
      pids = VALUES(winlog.event_data.ProcessPid)
    BY 
      host.name, 
      bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  | KEEP agent_id, bucket, host.name, event_count, users, parents, parent_cmdlines, children, child_executables, child_cmdlines, pids
  | SORT event_count DESC
enabled: false
tags:
  - attack.defense-evasion
  - attack.t1218
  - detection.threat-hunting
severity: low
risk_score: 20
references:
  - "https://twitter.com/CyberRaiju/status/1273597319322058752"
  - "https://app.any.run/tasks/9a8fd563-4c54-4d0a-9ad8-1fe08339cbc3/"
nist: ["SI-4", "AU-12"]
pci_dss: ["10.2"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0005:
    T1218: []
