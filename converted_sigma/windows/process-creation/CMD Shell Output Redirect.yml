name: "CMD Shell Output Redirect"
description: |
  Detects execution of cmd.exe with output redirection using the ">" operator.
  Adversaries may redirect the output of reconnaissance commands (e.g., hostname, whoami, dir)
  to files for later collection or exfiltration.
  False positives: Common in scripting and administration; use as a hunting baseline and
  tune by excluding known scripts and benign parent processes.
  Triage: Review the full command line to identify redirected output files, verify the parent
  process and user context, and correlate with subsequent file access, compression, or exfiltration.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - winlogbeat-*
query_language: esql
query: |
  FROM winlogbeat-*
  /* Process creation events */
  | WHERE event.category == "process" OR event.code IN ("1", "4688") OR event.dataset RLIKE "(?i)process"
  /* selection_cmd: cmd.exe */
  | WHERE process.name == "cmd.exe"
     OR process.executable RLIKE "(?i)\\\\cmd\\.exe$"
     OR COALESCE(event.original, "") RLIKE "(?i)OriginalFileName\\s*[:=]\\s*Cmd\\.Exe"
  /* selection_cli: output redirection */
  | EVAL cmd = COALESCE(process.command_line, winlog.event_data.CommandLine, "")
  | WHERE cmd LIKE "* > *"
  /* filter_optional_idm_extension */
  | WHERE NOT (
      cmd LIKE "*\\Program Files (x86)\\Internet Download Manager\\IDMMsgHost.exe*" OR
      cmd LIKE "*chrome-extension://*" OR
      cmd LIKE "*\\\\.\\pipe\\chrome.nativeMessaging*"
    )
  | EVAL hour_of_day = DATE_EXTRACT("hour", @timestamp)
  | EVAL is_after_hours = CASE(hour_of_day < 7 OR hour_of_day > 20, true, false)
  | EVAL suspicious_parent = CASE(
      process.parent.name RLIKE "(?i)^(winword|excel|powerpnt|outlook|mshta|wscript|cscript|rundll32|powershell)\\.exe$", true,
      false
    )
  | STATS
      event_count = COUNT(*),
      users = VALUES(user.name),
      parents = VALUES(process.parent.name),
      parent_cmdlines = VALUES(process.parent.command_line),
      cmdlines = VALUES(cmd),
      after_hours_hits = SUM(CASE(is_after_hours == true, 1, 0)),
      suspicious_parent_hits = SUM(CASE(suspicious_parent == true, 1, 0))
    BY host.name, bucket = DATE_TRUNC(20 minutes, @timestamp)
  | WHERE event_count >= 1
  /* Discovery-focused rule: raise signal with context */
  | EVAL risk_score = event_count * 5 + after_hours_hits * 10 + suspicious_parent_hits * 15
  | WHERE risk_score >= 5
  | KEEP bucket, host.name, event_count, users, parents, cmdlines, after_hours_hits, suspicious_parent_hits, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - attack.discovery
  - attack.t1082
  - detection.threat-hunting
severity: low
risk_score: 20
references:
  - "https://ss64.com/nt/syntax-redirection.html"

# üîê Intent-based compliance mapping
nist: ["SI-4", "AU-12"]
pci_dss: ["10.2"]
gdpr: ["32.1.b"]

mitre_attack:
  TA0007:
    T1082: []
