rule_id: e04c9d9f-f0ba-4afc-a35d-c4976a338d5b
name: "Headless Process Launched Via Conhost.EXE"
description: |
  Detects child process execution where the parent process is conhost.exe and the parent
  command line includes the "--headless" flag. The --headless flag suppresses visible windows,
  allowing processes to run without user awareness. This behavior has been observed in
  fake browser update chains and unauthorized software execution.
  False positives: Unknown. Use as a hunting baseline and tune with allowlists if needed.
  Triage: Review the spawned child process, validate its binary path and signer, inspect
  the parent command line for installer/update lures, and correlate with persistence,
  network connections, or sustained CPU usage.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  // Filter for process creation events
  | WHERE event.category == "process" 
     OR event.code IN ("1", "4688") 
     OR event.dataset RLIKE "(?i).*process.*"
  // Selection: Parent is conhost.exe running in headless mode
  | WHERE (winlog.event_data.CallerProcessName == "conhost.exe" OR winlog.event_data.CallerProcessName RLIKE "(?i).*\\\\conhost\\\\.exe$")
    AND winlog.event_data.CommandLine LIKE "*--headless*"
  | EVAL hour_of_day = DATE_EXTRACT("hour", @timestamp)
  | EVAL is_after_hours = CASE(hour_of_day < 7 OR hour_of_day > 20, true, false)
  // Identify high-risk "LoLBin" children being hidden
  | EVAL suspicious_child = CASE(
      winlog.event_data.ProcessName RLIKE "(?i)^(powershell|pwsh|cmd|mshta|wscript|cscript|rundll32|regsvr32|certutil|curl|wget)\\\\.exe$", true,
      false
    )
  // Check for execution from common staging or temporary directories
  | EVAL suspicious_path = CASE(
      COALESCE(winlog.event_data.ProcessName, "") RLIKE "(?i).*\\\\\\\\(Users\\\\\\\\.*\\\\\\\\(AppData\\\\\\\\(Local\\\\\\\\Temp|Roaming)|Downloads)|Windows\\\\\\\\Temp|ProgramData|Users\\\\\\\\Public)\\\\\\\\.*", true,
      false
    )
  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      parents = VALUES(winlog.event_data.CallerProcessName),
      parent_cmdlines = VALUES(winlog.event_data.CommandLine),
      children = VALUES(winlog.event_data.ProcessName),
      child_executables = VALUES(winlog.event_data.ProcessName),
      child_cmdlines = VALUES(winlog.event_data.CommandLine),
      after_hours_hits = SUM(CASE(is_after_hours == true, 1, 0)),
      suspicious_child_hits = SUM(CASE(suspicious_child == true, 1, 0)),
      suspicious_path_hits = SUM(CASE(suspicious_path == true, 1, 0))
    BY 
      host.name, 
      bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  // Risk Scoring: Heavily weighted toward suspicious children and hidden execution
  | EVAL risk_score = event_count * 20
      + after_hours_hits * 15
      + suspicious_child_hits * 20
      + suspicious_path_hits * 15
  | WHERE risk_score >= 25
  | KEEP 
      agent_id, bucket, host.name, event_count, users, parents, parent_cmdlines, children, 
      child_executables, child_cmdlines, after_hours_hits, suspicious_child_hits, 
      suspicious_path_hits, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - attack.defense-evasion
  - attack.execution
  - attack.t1059.001
  - attack.t1059.003
  - detection.threat-hunting
severity: medium
risk_score: 55
references:
  - "https://www.huntress.com/blog/fake-browser-updates-lead-to-boinc-volunteer-computing-software"

# üîê Intent-based compliance mapping
nist: ["SI-4", "CM-7", "AU-12"]
pci_dss: ["10.2"]
gdpr: ["32.1.b"]

mitre_attack:
  TA0002:
    T1059: ["T1059.001", "T1059.003"]
