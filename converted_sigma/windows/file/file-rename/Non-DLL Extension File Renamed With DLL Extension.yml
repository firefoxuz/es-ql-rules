rule_id: d05181f9-bf23-49ab-bf4a-e6a732083a13
name: "Non-DLL Extension File Renamed With DLL Extension"
description: |
  Detects rename operations where the destination filename ends with ".dll" but the source filename
  was not already a ".dll". Malware sometimes renames payloads to .dll to blend in and evade simple
  extension-based detections.
  NOTE: Sigma expects SourceFilename/TargetFilename. In your field list those are not present, so this
  rule uses:
   - winlog.event_data.OriginalFileName as the target filename, and
   - event.original parsing as best-effort for source filename (if present in raw event).
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  // File rename telemetry (best-effort; depends on pipeline)
  | WHERE event.category == "file" OR event.type == "change" OR event.dataset RLIKE "(?i).*file.*"
  // Evaluate Target path
  | EVAL tgt = COALESCE(winlog.event_data.OriginalFileName, "")
  | WHERE tgt RLIKE "(?i).*\\\\.dll$"
  
  // Best-effort source checks via raw log content
  | EVAL raw = COALESCE(event.original, "")
  
  // filter_main_empty_source: Ignore events with no source path
  | WHERE NOT (raw RLIKE "(?i).*SourceFilename\\\\s*[:=]\\\\s*(''|\"\"|null).*")
  
  // filter_main_dll: SourceFilename was NOT already a .dll (exclude true dll->dll renames)
  | WHERE NOT (raw RLIKE "(?i).*SourceFilename\\\\s*[:=].*\\\\.dll\\\\b.*")
  
  // filter_main_installers: SourceFilename was NOT a .tmp file
  | WHERE NOT (raw RLIKE "(?i).*SourceFilename\\\\s*[:=].*\\\\.tmp\\\\b.*")
  
  // filter_main_tiworker: Handle TiWorker exclusions via path or raw log grep
  | WHERE NOT (
      (winlog.event_data.ProcessName LIKE "*:\\\\Windows\\\\WinSxS\\\\*" AND winlog.event_data.ProcessName RLIKE "(?i).*\\\\\\\\TiWorker\\\\.exe$")
      OR raw RLIKE "(?i).*Image\\\\s*[:=].*\\\\\\\\TiWorker\\\\.exe\\\\b.*"
    )
  
  // filter_main_upgrade: Ignore Windows Update staging
  | WHERE NOT (
      winlog.event_data.ProcessName RLIKE "(?i).*:\\\\\\\\Windows\\\\\\\\System32\\\\\\\\wuauclt\\\\.exe$"
      AND tgt LIKE "*:\\\\$WINDOWS.~BT\\\\Sources\\\\*"
    )
  
  // filter_main_generic: Program Files paths
  | WHERE NOT (
      winlog.event_data.ProcessName LIKE "*:\\\\Program Files (x86)\\\\*"
      OR winlog.event_data.ProcessName LIKE "*:\\\\Program Files\\\\*"
    )
  
  // filter_optional_squirrel: Ignore Squirrel installer temp files
  | WHERE NOT (raw RLIKE "(?i).*SourceFilename\\\\s*[:=].*\\\\\\\\SquirrelTemp\\\\\\\\temp.*")
  
  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      processes = VALUES(winlog.event_data.ProcessName),
      executables = VALUES(winlog.event_data.ProcessName),
      parents = VALUES(winlog.event_data.CallerProcessName),
      parent_executables = VALUES(winlog.event_data.CallerProcessName),
      target_paths = VALUES(tgt),
      raw_samples = VALUES(raw)
    BY 
      host.name, 
      bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  | KEEP 
      agent_id, bucket, host.name, event_count, users, processes, executables, parents, parent_executables, target_paths, raw_samples
  | SORT event_count DESC
enabled: false
tags:
  - attack.defense-evasion
  - attack.t1036.008
  - detection.threat-hunting
severity: medium
risk_score: 50
references:
  - "https://twitter.com/ffforward/status/1481672378639912960"
  - "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1036/T1036.md#atomic-test-1---system-file-copied-to-unusual-location"
nist: ["SI-4", "AU-12"]
pci_dss: ["10.2"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0005:
    T1036: ["T1036.008"]
