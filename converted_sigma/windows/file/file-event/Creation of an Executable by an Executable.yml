rule_id: 056875fd-4eae-4524-ac86-8b45015ce419
name: "Creation of an Executable by an Executable"
description: |
  Detects creation of an .exe file by a process that is itself an .exe. This can indicate droppers,
  installers, or malware staging payloads. This rule is very noisy in real environments, so it includes
  a broad set of filters for common installers/updaters and developer tools.
  Requirements: file event telemetry that captures the creating process (winlog.event_data.ProcessName) and the created file (winlog.event_data.OriginalFileName).
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  // File event telemetry
  | WHERE event.category == "file" OR event.dataset RLIKE "(?i).*file.*"
  // Evaluate paths to simplify logic
  | EVAL img = COALESCE(winlog.event_data.ProcessName, "")
  | EVAL tgt = COALESCE(winlog.event_data.OriginalFileName, "")
  // Selection: Image ends with .exe AND TargetFilename ends with .exe
  | WHERE img RLIKE "(?i).*\\\\.exe$" AND tgt RLIKE "(?i).*\\\\.exe$"

  // -------------------- filters -------------------- //

  // filter_main_generic_1
  | WHERE NOT (
    img RLIKE "(?i).*:\\\\\\\\Windows\\\\\\\\System32\\\\\\\\msiexec\\\\.exe$"
    OR img RLIKE "(?i).*:\\\\\\\\Windows\\\\\\\\system32\\\\\\\\cleanmgr\\\\.exe$"
    OR img RLIKE "(?i).*:\\\\\\\\Windows\\\\\\\\explorer\\\\.exe$"
    OR img RLIKE "(?i).*:\\\\\\\\WINDOWS\\\\\\\\system32\\\\\\\\dxgiadaptercache\\\\.exe$"
    OR img RLIKE "(?i).*:\\\\\\\\WINDOWS\\\\\\\\system32\\\\\\\\Dism\\\\.exe$"
    OR img RLIKE "(?i).*:\\\\\\\\Windows\\\\\\\\System32\\\\\\\\wuauclt\\\\.exe$"
  )

  // filter_main_update
  | WHERE NOT (
    img RLIKE "(?i).*:\\\\\\\\WINDOWS\\\\\\\\system32\\\\\\\\svchost\\\\.exe$"
    AND tgt LIKE "*:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\*"
  )

  // filter_main_upgrade
  | WHERE NOT (
    img RLIKE "(?i).*:\\\\\\\\Windows\\\\\\\\system32\\\\\\\\svchost\\\\.exe$"
    AND tgt LIKE "*:\\\\WUDownloadCache\\\\*"
    AND tgt LIKE "*\\\\WindowsUpdateBox.exe*"
  )

  // filter_main_windows_update_box
  | WHERE NOT (
    img LIKE "*:\\\\WINDOWS\\\\SoftwareDistribution\\\\Download\\\\*"
    AND img RLIKE "(?i).*\\\\\\\\WindowsUpdateBox\\\\.Exe$"
    AND tgt LIKE "*:\\\\$WINDOWS.~BT\\\\Sources\\\\*"
  )

  // filter_main_tiworker
  | WHERE NOT (
    img LIKE "*:\\\\Windows\\\\WinSxS\\\\*"
    AND img RLIKE "(?i).*\\\\\\\\TiWorker\\\\.exe$"
  )

  // filter_main_programfiles
  | WHERE NOT (
    (img LIKE "*:\\\\Program Files\\\\*" OR img LIKE "*:\\\\Program Files (x86)\\\\*")
    AND (tgt LIKE "*:\\\\Program Files\\\\*" OR tgt LIKE "*:\\\\Program Files (x86)\\\\*")
  )

  // filter_main_defender
  | WHERE NOT (
    img LIKE "*:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\*"
    OR img LIKE "*:\\\\Program Files\\\\Windows Defender\\\\*"
  )

  // filter_main_windows_apps
  | WHERE NOT (tgt LIKE "*\\\\AppData\\\\Local\\\\Microsoft\\\\WindowsApps\\\\*")

  // filter_main_teams
  | WHERE NOT (
    img RLIKE "(?i).*\\\\\\\\AppData\\\\\\\\Local\\\\\\\\Microsoft\\\\\\\\Teams\\\\\\\\Update\\\\.exe$"
    AND (
      tgt RLIKE "(?i).*\\\\\\\\AppData\\\\\\\\Local\\\\\\\\Microsoft\\\\\\\\Teams\\\\\\\\stage\\\\\\\\Teams\\\\.exe$"
      OR tgt RLIKE "(?i).*\\\\\\\\AppData\\\\\\\\Local\\\\\\\\Microsoft\\\\\\\\Teams\\\\\\\\stage\\\\\\\\Squirrel\\\\.exe$"
      OR tgt LIKE "*\\\\AppData\\\\Local\\\\Microsoft\\\\SquirrelTemp\\\\tempb\\\\*"
    )
  )

  // filter_main_mscorsvw
  | WHERE NOT (
    (img LIKE "*:\\\\Windows\\\\Microsoft.NET\\\\Framework\\\\*"
     OR img LIKE "*:\\\\Windows\\\\Microsoft.NET\\\\Framework64\\\\*"
     OR img LIKE "*:\\\\Windows\\\\Microsoft.NET\\\\FrameworkArm\\\\*"
     OR img LIKE "*:\\\\Windows\\\\Microsoft.NET\\\\FrameworkArm64\\\\*")
    AND img RLIKE "(?i).*\\\\\\\\mscorsvw\\\\.exe$"
    AND tgt LIKE "*:\\\\Windows\\\\assembly\\\\NativeImages_*"
  )

  // filter_main_vscode
  | WHERE NOT (
    img LIKE "*\\\\AppData\\\\Local\\\\*"
    AND img LIKE "*\\\\Microsoft VS Code\\\\Code.exe"
    AND tgt LIKE "*\\\\.vscode\\\\extensions\\\\*"
  )

  // filter_main_githubdesktop
  | WHERE NOT (
    img LIKE "*\\\\AppData\\\\Local\\\\GitHubDesktop\\\\Update.exe"
    AND tgt LIKE "*\\\\AppData\\\\Local\\\\SquirrelTemp\\\\*"
  )

  // filter_main_windows_temp
  | WHERE NOT (
    img LIKE "*:\\\\WINDOWS\\\\TEMP\\\\*"
    AND tgt LIKE "*:\\\\WINDOWS\\\\TEMP\\\\*"
  )

  // filter_optional_python
  | WHERE NOT (
    img LIKE "*\\\\Python27\\\\python.exe"
    AND (
      tgt LIKE "*\\\\Python27\\\\Lib\\\\site-packages\\\\*"
      OR tgt LIKE "*\\\\Python27\\\\Scripts\\\\*"
      OR tgt LIKE "*\\\\AppData\\\\Local\\\\Temp\\\\*"
    )
  )

  // filter_optional_squirrel
  | WHERE NOT (
    img LIKE "*\\\\AppData\\\\Local\\\\SquirrelTemp\\\\Update.exe"
    AND tgt LIKE "*\\\\AppData\\\\Local*"
  )

  // filter_main_temp_installers
  | WHERE NOT (
    img LIKE "*\\\\AppData\\\\Local\\\\Temp\\\\*"
    AND tgt LIKE "*\\\\AppData\\\\Local\\\\Temp\\\\*"
  )

  // filter_optional_chrome
  | WHERE NOT (
    img RLIKE "(?i).*\\\\\\\\ChromeSetup\\\\.exe$"
    AND tgt LIKE "*\\\\Google*"
  )

  // filter_main_dot_net (extra)
  | WHERE NOT (
    img LIKE "*:\\\\Windows\\\\Microsoft.NET\\\\Framework*"
    AND img RLIKE "(?i).*\\\\\\\\mscorsvw\\\\.exe$"
    AND tgt LIKE "*:\\\\Windows\\\\assembly*"
  )

  // -------------------- output -------------------- //
  | STATS
    event_count = COUNT(*),
    users = VALUES(winlog.event_data.TargetUserName),
    processes = VALUES(winlog.event_data.ProcessName),
    executables = VALUES(img),
    parents = VALUES(winlog.event_data.CallerProcessName),
    parent_executables = VALUES(winlog.event_data.CallerProcessName),
    targets = VALUES(tgt),
    cmdlines = VALUES(COALESCE(winlog.event_data.CommandLine, winlog.event_data.CommandLine, ""))
  BY 
    host.name, 
    bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  | KEEP 
    agent_id, bucket, 
    host.name, 
    event_count, 
    users, 
    processes, 
    executables, 
    parents, 
    parent_executables, 
    targets, 
    cmdlines
  | SORT event_count DESC
enabled: false
tags:
  - attack.resource-development
  - attack.t1587.001
  - detection.threat-hunting
severity: low
risk_score: 20
references:
  - "Internal Research"
nist: ["SI-4", "AU-12"]
pci_dss: ["10.2"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0042:
    T1587: ["T1587.001"]
