rule_id: 96414fe4-4a79-4fa1-860e-eb7aed930c5d
name: "Non-DLL Extension File Renamed With DLL Extension"
description: |
  Detects file rename operations where the destination filename ends with ".dll" but the source file
  did not already end with ".dll". Malware may rename payloads to .dll to blend in and evade simplistic
  extension-based detections.
  Requirements: Microsoft-Windows-Kernel-File Provider with rename telemetry (e.g., SourceFilename/TargetFilename).
  False positives: Likely from installers and temporary locations. Baselining/tuning recommended.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  // File rename telemetry (best-effort; depends on pipeline)
  | WHERE event.category == "file" OR event.type == "change" OR event.dataset RLIKE "(?i).*file.*"
  // Evaluate Target and Source paths to simplify logic
  | EVAL tgt = COALESCE(winlog.event_data.OriginalFileName, "")
  | EVAL src = COALESCE(winlog.event_data.OriginalFileName, "")
  // Selection: TargetFilename ends with .dll
  | WHERE tgt RLIKE "(?i).*\\\\.dll$"

  // filter_main_dll: SourceFilename was NOT already a .dll
  | WHERE NOT (src RLIKE "(?i).*\\\\.dll$")
  // filter_main_installers: SourceFilename was NOT a .tmp file
  | WHERE NOT (src RLIKE "(?i).*\\\\.tmp$")
  // filter_main_empty_source: Ensure it's an actual rename/move with a source
  | WHERE src != ""

  // filter_main_tiworker: Image contains \Windows\WinSxS\ and ends with \TiWorker.exe
  | WHERE NOT (
      winlog.event_data.ProcessName LIKE "*:\\\\Windows\\\\WinSxS\\\\*"
      AND winlog.event_data.ProcessName RLIKE "(?i).*\\\\\\\\TiWorker\\\\.exe$"
    )
  // filter_main_upgrade
  | WHERE NOT (
      winlog.event_data.ProcessName RLIKE "(?i).*:\\\\\\\\Windows\\\\\\\\System32\\\\\\\\wuauclt\\\\.exe$"
      AND tgt LIKE "*:\\\\$WINDOWS.~BT\\\\Sources\\\\*"
    )
  // filter_main_generic: Program Files paths
  | WHERE NOT (
      winlog.event_data.ProcessName LIKE "*:\\\\Program Files (x86)\\\\*"
      OR winlog.event_data.ProcessName LIKE "*:\\\\Program Files\\\\*"
    )
  // filter_optional_squirrel
  | WHERE NOT (src LIKE "*\\\\SquirrelTemp\\\\temp*")

  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      processes = VALUES(winlog.event_data.ProcessName),
      executables = VALUES(winlog.event_data.ProcessName),
      parents = VALUES(winlog.event_data.CallerProcessName),
      parent_executables = VALUES(winlog.event_data.CallerProcessName),
      source_paths = VALUES(src),
      target_paths = VALUES(tgt),
      raw_samples = VALUES(event.original)
    BY 
      host.name, 
      bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  | KEEP 
      agent_id, bucket, 
      host.name, 
      event_count, 
      users, 
      processes, 
      executables, 
      parents, 
      parent_executables, 
      source_paths, 
      target_paths, 
      raw_samples
  | SORT event_count DESC
enabled: false
tags:
  - attack.defense-evasion
  - attack.t1036.008
  - detection.threat-hunting
severity: medium
risk_score: 50
references:
  - "https://twitter.com/ffforward/status/1481672378639912960"
  - "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1036/T1036.md#atomic-test-1---system-file-copied-to-unusual-location"
nist: ["SI-4", "AU-12"]
pci_dss: ["10.2"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0005:
    T1036: ["T1036.008"]
