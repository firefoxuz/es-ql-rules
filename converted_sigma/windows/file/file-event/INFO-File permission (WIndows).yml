rule_id: 3be295c4-cd45-4de4-a6ba-cc01abffa60c
# 6) File Permission / Attribute Change (generic hunting)
name: "INFO - File Permission/Attribute Change (Windows) - Hunting"
description: |
  Informational baseline for file permission/attribute changes. Field availability varies by telemetry.
  Uses event.action/type and raw hints. Tune with your actual fields when available.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  // Filter strictly for file category events
  | WHERE event.category == "file"
  // Explicitly require permission, ACL, ownership, or attribute changes
  | WHERE (
      event.action RLIKE "(?i).*(permission|acl|owner|attribute|attrib|chmod).*"
      OR event.type RLIKE "(?i).*(permission|acl|owner|attribute).*"
      OR COALESCE(event.original, "") RLIKE "(?i).*(SecurityDescriptor|DACL|SACL|Attributes).*"
    )
  // Ensure the event actually contains a file path
  | WHERE winlog.event_data.OriginalFileName IS NOT NULL
  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      processes = VALUES(winlog.event_data.ProcessName),
      executables = VALUES(winlog.event_data.ProcessName),
      parents = VALUES(winlog.event_data.CallerProcessName),
      parent_executables = VALUES(winlog.event_data.CallerProcessName),
      paths = VALUES(winlog.event_data.OriginalFileName),
      raw_samples = VALUES(event.original)
    BY 
      host.name, 
      bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  | KEEP 
      agent_id, bucket, 
      host.name, 
      event_count, 
      users, 
      processes, 
      executables, 
      parents, 
      parent_executables, 
      paths, 
      raw_samples
  | SORT event_count DESC
enabled: false
tags:
  - informational
  - file-monitoring
severity: informational
risk_score: 1
references:
  - "https://www.elastic.co/guide/en/ecs/current/ecs-event.html"
nist: ["AU-12"]
pci_dss: ["10.2"]
gdpr: ["32.1.a"]
mitre_attack: {}