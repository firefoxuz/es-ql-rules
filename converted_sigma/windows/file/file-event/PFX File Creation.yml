rule_id: dfb7ab89-72e2-429f-860d-ef18089790e4
name: "PFX File Creation"
description: |
  Detects creation of PFX files (.pfx). PFX (Personal Information Exchange) bundles private keys and
  certificates, which can be targeted for certificate theft, impersonation, code signing abuse, or
  persistence via cert-based auth.
  Filters exclude common benign dev/automation locations and OneDrive CodeSigning.pfx.
  Requirements: file event telemetry where created/target file path is captured.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  // File event telemetry
  | WHERE event.category == "file" OR event.dataset RLIKE "(?i).*file .*"
  // Evaluate path to simplify logic
  | EVAL p = COALESCE(winlog.event_data.OriginalFileName, "")
  // Selection: TargetFilename ends with .pfx
  | WHERE p RLIKE "(?i).*\\\\.pfx$"
  
  // Filter: Legitimate OneDrive code signing sync
  | WHERE NOT (
      winlog.event_data.ProcessName IN (
        "C:\\Program Files\\Microsoft OneDrive\\OneDrive.exe",
        "C:\\Program Files (x86)\\Microsoft OneDrive\\OneDrive.exe"
      )
      AND p RLIKE "(?i).*\\\\OneDrive\\\\CodeSigning\\\\.pfx$"
    )
  
  // Filter: Legitimate Visual Studio operations
  | WHERE NOT (
      p RLIKE "(?i)^C:\\\\Program Files \\\\(x86\\\\)\\\\Microsoft Visual Studio\\\\.*"
      OR p RLIKE "(?i)^C:\\\\Program Files\\\\Microsoft Visual Studio\\\\.*"
    )
  
  // Filter: Legitimate CMake operations
  | WHERE NOT (p RLIKE "(?i)^C:\\\\Program Files\\\\CMake\\\\.*")
  
  | STATS
      event_count = COUNT(*),
      users = VALUES(winlog.event_data.TargetUserName),
      processes = VALUES(winlog.event_data.ProcessName),
      executables = VALUES(winlog.event_data.ProcessName),
      parents = VALUES(winlog.event_data.CallerProcessName),
      parent_executables = VALUES(winlog.event_data.CallerProcessName),
      file_paths = VALUES(winlog.event_data.OriginalFileName),
      cmdlines = VALUES(COALESCE(winlog.event_data.CommandLine, winlog.event_data.CommandLine, ""))
    BY 
      host.name, 
      bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  | KEEP 
      agent_id, bucket, 
      host.name, 
      event_count, 
      users, 
      processes, 
      executables, 
      parents, 
      parent_executables, 
      cmdlines, 
      file_paths
  | SORT event_count DESC
enabled: false
tags:
  - attack.credential-access
  - attack.t1552.004
  - detection.threat-hunting
severity: low
risk_score: 20
references:
  - "https://github.com/OTRF/detection-hackathon-apt29/issues/14"
  - "https://github.com/OTRF/ThreatHunter-Playbook/blob/2d4257f630f4c9770f78d0c1df059f891ffc3fec/docs/evals/apt29/detections/6.B.1_6392C9F1-D975-4F75-8A70-433DEDD7F622.md"
nist: ["IA-5", "SI-4", "AU-12"]
pci_dss: ["10.2"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0006:
    T1552: ["T1552.004"]
