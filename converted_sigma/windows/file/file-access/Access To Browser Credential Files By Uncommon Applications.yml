rule_id: 47d39839-7ee8-40b4-a2c3-f0f542c24e46
name: "Access To Browser Credential Files By Uncommon Applications"
description: |
  Detects file access requests to browser credential stores (IE WebCache, Firefox profile stores,
  Chromium Login Data/Local State) by uncommon processes. This can indicate credential stealing
  activity (infostealers). Requires heavy baselining before production use.
  Requirements: Microsoft-Windows-Kernel-File ETW provider (or equivalent file access telemetry).
  False positives: AV/EDR, backup tools, search/indexing tools (e.g., Everything), legit software
  installed outside C:\, and some forensic/IR tooling.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  // File access telemetry view 
  | WHERE event.category == "file"
   OR event.type == "access"
   OR event.dataset RLIKE "(?i).*file.*"
  // Evaluate path to simplify logic
  | EVAL p = COALESCE(winlog.event_data.OriginalFileName, "")
  // Selection: IE, Firefox, and Chromium credential stores
  | WHERE (
    // IE / Edge
    p RLIKE "(?i).*\\\\Appdata\\\\Local\\\\Microsoft\\\\Windows\\\\WebCache\\\\WebCacheV01\\\\.dat$"
    // Firefox
    OR p RLIKE "(?i).*\\\\cookies\\\\.sqlite$"
    OR p RLIKE "(?i).*\\\\places\\\\.sqlite$"
    OR p RLIKE "(?i).*release\\\\key3\\\\.db$"
    OR p RLIKE "(?i).*release\\\\key4\\\\.db$"
    OR p RLIKE "(?i).*release\\\\logins\\\\.json$"
    // Chromium (Using native LIKE with double-escaped backslashes)
    OR p LIKE "*\\\\User Data\\\\Default\\\\Login Data*"
    OR p LIKE "*\\\\User Data\\\\Local State*"
  )
  // Filter out legitimate System process
  | WHERE COALESCE(winlog.event_data.ProcessName, winlog.event_data.ProcessName, "") != "System"
  // Exclude common benign install paths
  | WHERE NOT (
    winlog.event_data.ProcessName RLIKE "(?i)^C:\\\\Program Files \\\\(x86\\\\)\\\\.*"
    OR winlog.event_data.ProcessName RLIKE "(?i)^C:\\\\Program Files\\\\.*"
    OR winlog.event_data.ProcessName RLIKE "(?i)^C:\\\\Windows\\\\System32\\\\.*"
    OR winlog.event_data.ProcessName RLIKE "(?i)^C:\\\\Windows\\\\SysWOW64\\\\.*"
  )
  // Optional: Filter out Windows Defender
  | WHERE NOT (
    winlog.event_data.ProcessName RLIKE "(?i)^C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\.*"
    AND winlog.event_data.ProcessName RLIKE "(?i).*\\\\(MpCopyAccelerator|MsMpEng)\\\\.exe$"
  )
  // Optional: Filter out Thor Scanner
  | WHERE NOT (
    winlog.event_data.ProcessName RLIKE "(?i).*\\\\thor(64)?\\\\.exe$"
    OR winlog.event_data.ProcessName IN ("thor.exe", "thor64.exe")
  )
  | STATS
    event_count = COUNT(*),
    users = VALUES(winlog.event_data.TargetUserName),
    processes = VALUES(winlog.event_data.ProcessName),
    executables = VALUES(winlog.event_data.ProcessName),
    parents = VALUES(winlog.event_data.CallerProcessName),
    parent_executables = VALUES(winlog.event_data.CallerProcessName),
    file_paths = VALUES(winlog.event_data.OriginalFileName)
  BY 
    host.name, 
    bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  | KEEP 
    agent_id, bucket, 
    host.name, 
    event_count, 
    users, 
    processes, 
    executables, 
    parents, 
    parent_executables, 
    file_paths
  | SORT event_count DESC
enabled: false
tags:
  - attack.credential-access
  - attack.t1003
  - detection.threat-hunting
severity: low
risk_score: 20
references:
  - "https://www.zscaler.com/blogs/security-research/ffdroider-stealer-targeting-social-media-platform-users"
  - "https://github.com/lclevy/firepwd"
nist: ["IA-5", "SI-4", "AU-12"]
pci_dss: ["10.2"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0006:
    T1003: []
