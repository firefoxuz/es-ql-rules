name: "Access To Sysvol Policies Share By Uncommon Process"
description: |
  Detects file access requests to the Windows SYSVOL Policies share (UNC paths containing \sysvol\ and \Policies\)
  by uncommon processes. Attackers may access SYSVOL to discover or retrieve sensitive data from Group Policy
  (e.g., legacy cpassword in GPP) or to perform credential-related reconnaissance.
  Requirements: Microsoft-Windows-Kernel-File ETW provider (or equivalent file access telemetry).
  False positives: Unknown. Use as hunting baseline and tune based on environment.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - winlogbeat-*
query_language: esql
query: |
  FROM winlogbeat-*
  /* file access telemetry view (best-effort; depends on your pipeline) */
  | WHERE event.category == "file"
     OR event.type == "access"
     OR event.dataset RLIKE "(?i)file"
  /* selection: UNC path starting with \\ and containing \sysvol\ and \Policies\ */
  | EVAL p = COALESCE(file.path, "")
  | WHERE p RLIKE "^\\\\\\\\"
    AND p LIKE "*\\sysvol\\*"
    AND p LIKE "*\\Policies\\*"
  /* filter_main_generic: common benign locations */
  | WHERE NOT (
      COALESCE(process.executable, "") LIKE "*:\\Program Files (x86)\\*"
      OR COALESCE(process.executable, "") LIKE "*:\\Program Files\\*"
      OR COALESCE(process.executable, "") LIKE "*:\\Windows\\explorer.exe*"
      OR COALESCE(process.executable, "") LIKE "*:\\Windows\\system32\\*"
      OR COALESCE(process.executable, "") LIKE "*:\\Windows\\SysWOW64\\*"
    )
  | STATS
      event_count = COUNT(*),
      users = VALUES(user.name),
      processes = VALUES(process.name),
      executables = VALUES(process.executable),
      parents = VALUES(process.parent.name),
      parent_executables = VALUES(process.parent.executable),
      file_paths = VALUES(file.path)
    BY host.name, bucket = DATE_TRUNC(20 minutes, @timestamp)
  | WHERE event_count >= 1
  | KEEP bucket, host.name, event_count, users, processes, executables, parents, parent_executables, file_paths
  | SORT event_count DESC
enabled: false
tags:
  - attack.credential-access
  - attack.t1552.006
  - detection.threat-hunting
severity: medium
risk_score: 50
references:
  - "https://github.com/vletoux/pingcastle"
nist: ["SI-4", "AU-12", "IA-5"]
pci_dss: ["10.2"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0006:
    T1552: ["T1552.006"]
