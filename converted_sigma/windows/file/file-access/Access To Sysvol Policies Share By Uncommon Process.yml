rule_id: 3871b734-99c9-43e8-8cd3-ff21a56c11be
name: "Access To Sysvol Policies Share By Uncommon Process"
description: |
  Detects file access requests to the Windows SYSVOL Policies share (UNC paths containing \sysvol\ and \Policies\)
  by uncommon processes. Attackers may access SYSVOL to discover or retrieve sensitive data from Group Policy
  (e.g., legacy cpassword in GPP) or to perform credential-related reconnaissance.
  Requirements: Microsoft-Windows-Kernel-File ETW provider (or equivalent file access telemetry).
  False positives: Unknown. Use as hunting baseline and tune based on environment.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  // File access telemetry view
  | WHERE event.category == "file"
   OR event.type == "access"
   OR event.dataset RLIKE "(?i).*file.*"
  // Evaluate path to simplify logic
  | EVAL p = COALESCE(winlog.event_data.OriginalFileName, "")
  // Selection: UNC path starting with \\ and containing \sysvol\ and \Policies\
  | WHERE p RLIKE "(?i)^\\\\\\\\\\\\\\\\.*"
  AND p LIKE "*\\\\sysvol\\\\*"
  AND p LIKE "*\\\\Policies\\\\*"
  // Filter out common benign locations
  | WHERE NOT (
    COALESCE(winlog.event_data.ProcessName, "") LIKE "*:\\\\Program Files (x86)\\\\*"
    OR COALESCE(winlog.event_data.ProcessName, "") LIKE "*:\\\\Program Files\\\\*"
    OR COALESCE(winlog.event_data.ProcessName, "") LIKE "*:\\\\Windows\\\\explorer.exe*"
    OR COALESCE(winlog.event_data.ProcessName, "") LIKE "*:\\\\Windows\\\\system32\\\\*"
    OR COALESCE(winlog.event_data.ProcessName, "") LIKE "*:\\\\Windows\\\\SysWOW64\\\\*"
  )
  | STATS
    event_count = COUNT(*),
    users = VALUES(winlog.event_data.TargetUserName),
    processes = VALUES(winlog.event_data.ProcessName),
    executables = VALUES(winlog.event_data.ProcessName),
    parents = VALUES(winlog.event_data.CallerProcessName),
    parent_executables = VALUES(winlog.event_data.CallerProcessName),
    file_paths = VALUES(winlog.event_data.OriginalFileName)
  BY 
    host.name, 
    bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  | KEEP 
    agent_id, bucket, 
    host.name, 
    event_count, 
    users, 
    processes, 
    executables, 
    parents, 
    parent_executables, 
    file_paths
  | SORT event_count DESC
enabled: false
tags:
  - attack.credential-access
  - attack.t1552.006
  - detection.threat-hunting
severity: medium
risk_score: 50
references:
  - "https://github.com/vletoux/pingcastle"
nist: ["SI-4", "AU-12", "IA-5"]
pci_dss: ["10.2"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0006:
    T1552: ["T1552.006"]
