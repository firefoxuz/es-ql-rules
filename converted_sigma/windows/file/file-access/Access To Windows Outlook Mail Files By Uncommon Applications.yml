rule_id: 00f5db5c-31f9-4f45-b886-65d112745ea9
name: "Access To Windows Outlook Mail Files By Uncommon Applications"
description: |
  Detects file access requests to Windows Mail/Outlook app mailbox storage locations (Unistore/UnistoreDB)
  by uncommon processes. This can indicate mailbox data access for theft, manipulation, or wiping.
  Requires heavy baselining before production usage.
  Requirements: Microsoft-Windows-Kernel-File ETW provider (or equivalent file access telemetry).
  False positives: AV/EDR, backup tools, search/indexing tools (e.g., Everything), legit software installed
  outside C:\, and some forensic/IR tooling.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
 FROM logs-winlog*
  // File access telemetry view
  | WHERE event.category == "file"
   OR event.type == "access"
   OR event.dataset RLIKE "(?i).*file.*"
  // Evaluate path to simplify logic
  | EVAL p = COALESCE(winlog.event_data.OriginalFileName, "")
  // Selection: Unistore data path OR UnistoreDB store.vol (Windows Mail/Contacts)
  | WHERE (
    p LIKE "*\\\\AppData\\\\Local\\\\Comms\\\\Unistore\\\\data*"
    OR p RLIKE "(?i).*\\\\AppData\\\\Local\\\\Comms\\\\UnistoreDB\\\\store\\\\.vol$"
  )
  // Filter out legitimate System process
  | WHERE COALESCE(winlog.event_data.ProcessName, winlog.event_data.ProcessName, "") != "System"
  // Exclude common benign install paths
  | WHERE NOT (
    winlog.event_data.ProcessName RLIKE "(?i)^C:\\\\Program Files \\\\(x86\\\\)\\\\.*"
    OR winlog.event_data.ProcessName RLIKE "(?i)^C:\\\\Program Files\\\\.*"
    OR winlog.event_data.ProcessName RLIKE "(?i)^C:\\\\Windows\\\\SystemSystem32\\\\.*"
    OR winlog.event_data.ProcessName RLIKE "(?i)^C:\\\\Windows\\\\SysWOW64\\\\.*"
  )
  // Optional: Filter out Windows Defender
  | WHERE NOT (
    winlog.event_data.ProcessName RLIKE "(?i)^C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\.*"
    AND winlog.event_data.ProcessName RLIKE "(?i).*\\\\(MpCopyAccelerator|MsMpEng)\\\\.exe$"
  )
  // Optional: Filter out Thor Scanner
  | WHERE NOT (
    winlog.event_data.ProcessName RLIKE "(?i).*\\\\thor(64)?\\\\.exe$"
    OR winlog.event_data.ProcessName IN ("thor.exe", "thor64.exe")
  )
  | STATS
    event_count = COUNT(*),
    users = VALUES(winlog.event_data.TargetUserName),
    processes = VALUES(winlog.event_data.ProcessName),
    executables = VALUES(winlog.event_data.ProcessName),
    parents = VALUES(winlog.event_data.CallerProcessName),
    parent_executables = VALUES(winlog.event_data.CallerProcessName),
    file_paths = VALUES(winlog.event_data.OriginalFileName)
  BY 
    host.name, 
    bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  | KEEP 
    agent_id, bucket, 
    host.name, 
    event_count, 
    users, 
    processes, 
    executables, 
    parents, 
    parent_executables, 
    file_paths
  | SORT event_count DESC
enabled: false
tags:
  - attack.defense-evasion
  - attack.t1070.008
  - detection.threat-hunting
severity: low
risk_score: 20
references:
  - "https://darkdefender.medium.com/windows-10-mail-app-forensics-39025f5418d2"
  - "https://github.com/redcanaryco/atomic-red-team/blob/58496ee3306e6e42a7054d36a94e6eb561ee3081/atomics/T1070.008/T1070.008.md#atomic-test-4---copy-and-modify-mailbox-data-on-windows"
nist: ["SI-4", "AU-12", "SI-7"]
pci_dss: ["10.2"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0005:
    T1070: ["T1070.008"]
