rule_id: e30b0575-edd5-4c29-a272-71417c056ab8
name: "File Creation Date Changed to Another Year"
description: |
  Detects potential timestomping where a file’s creation time is modified from a recent year (202x)
  to an older year (pre-2020). This can be used to make a backdoor look “old” and blend with OS files.
  Note: Many legitimate installers/updaters can also touch timestamps. Baseline first, then tune.
  This implementation relies on event.original containing the timestamp fields (e.g. CreationUtcTime / PreviousCreationUtcTime),
  which is common with ETW/Sysmon-style file-change telemetry pipelines.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
 FROM logs-winlog*
  // File change telemetry
  | WHERE event.category == "file" 
   OR event.type == "change" 
   OR event.dataset RLIKE "(?i).*file.*"
  // Selection: PreviousCreationUtcTime starts with 202 (recent)
  | WHERE COALESCE(event.original, "") RLIKE "(?i).*PreviousCreationUtcTime\\\\s*[:=]\\\\s*202.*"
  // Filter: CreationUtcTime also starts with 202 => ignore
  | WHERE NOT (
    COALESCE(event.original, "") RLIKE "(?i).*CreationUtcTime\\\\s*[:=]\\\\s*202.*"
  )
  // Filter: TargetFilename and Image in Program Files
  | WHERE NOT (
    COALESCE(winlog.event_data.OriginalFileName, "") RLIKE "(?i)^C:\\\\Program Files( \\\\(x86\\\\))?\\\\.*"
    AND COALESCE(winlog.event_data.ProcessName, "") RLIKE "(?i)^C:\\\\Program Files( \\\\(x86\\\\))?\\\\.*"
  )
  // Filter: Optional Updates
  | WHERE NOT (
    winlog.event_data.ProcessName IN (
      "C:\\Windows\\system32\\ProvTool.exe",
      "C:\\Windows\\System32\\usocoreworker.exe",
      "C:\\Windows\\ImmersiveControlPanel\\SystemSettings.exe"
    )
    OR (
      COALESCE(winlog.event_data.OriginalFileName, "") RLIKE "(?i)^C:\\\\ProgramData\\\\USOPrivate\\\\UpdateStore\\\\.*"
      AND COALESCE(winlog.event_data.OriginalFileName, "") RLIKE "(?i).*\\\\.(tmp|temp)$"
    )
  )
  // Filter: Optional CAB files
  | WHERE NOT (
    COALESCE(winlog.event_data.ProcessName, "") RLIKE "(?i)^C:\\\\WINDOWS\\\\System32\\\\.*"
    AND winlog.event_data.ProcessName RLIKE "(?i).*\\\\(TiWorker|svchost|sihclient)\\\\.exe$"
    AND COALESCE(winlog.event_data.OriginalFileName, "") RLIKE "(?i).*\\\\.cab$"
  )
  // Filter: Optional MSIExec
  | WHERE NOT (winlog.event_data.ProcessName == "C:\\Windows\\system32\\msiexec.exe")
  // Filter: Optional VCRedist
  | WHERE NOT (
    COALESCE(winlog.event_data.ProcessName, "") RLIKE "(?i)^C:\\\\Windows\\\\Temp\\\\.*"
    AND winlog.event_data.ProcessName RLIKE "(?i).*\\\\VCREDI~1\\\\.EXE$"
  )
  | STATS
    event_count = COUNT(*),
    users = VALUES(winlog.event_data.TargetUserName),
    processes = VALUES(winlog.event_data.ProcessName),
    executables = VALUES(winlog.event_data.ProcessName),
    parent_processes = VALUES(winlog.event_data.CallerProcessName),
    parent_executables = VALUES(winlog.event_data.CallerProcessName),
    file_paths = VALUES(winlog.event_data.OriginalFileName),
    raw_samples = VALUES(event.original)
  BY 
    host.name, 
    bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  | KEEP 
    agent_id, bucket, 
    host.name, 
    event_count, 
    users, 
    processes, 
    executables, 
    parent_processes, 
    parent_executables, 
    file_paths, 
    raw_samples
  | SORT event_count DESC
enabled: false
tags:
  - attack.defense-evasion
  - attack.t1070.006
  - detection.threat-hunting
severity: low
risk_score: 20
references:
  - "https://www.inversecos.com/2022/04/defence-evasion-technique-timestomping.html"
nist: ["SI-4", "AU-12"]
pci_dss: ["10.2"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0005:
    T1070: ["T1070.006"]
