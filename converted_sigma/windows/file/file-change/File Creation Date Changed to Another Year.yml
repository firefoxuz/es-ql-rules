name: "File Creation Date Changed to Another Year"
description: |
  Detects potential timestomping where a file’s creation time is modified from a recent year (202x)
  to an older year (pre-2020). This can be used to make a backdoor look “old” and blend with OS files.
  Note: Many legitimate installers/updaters can also touch timestamps. Baseline first, then tune.
  This implementation relies on event.original containing the timestamp fields (e.g. CreationUtcTime / PreviousCreationUtcTime),
  which is common with ETW/Sysmon-style file-change telemetry pipelines.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - winlogbeat-*
query_language: esql
query: |
  FROM winlogbeat-*
  /* file change telemetry (best-effort; depends on your pipeline) */
  | WHERE event.category == "file" OR event.type == "change" OR event.dataset RLIKE "(?i)file"
  /* selection: PreviousCreationUtcTime starts with 202 (recent) */
  | WHERE COALESCE(event.original, "") RLIKE "(?i)PreviousCreationUtcTime\\s*[:=]\\s*202"
  /* filter_main_creation_time: CreationUtcTime also starts with 202 => ignore */
  | WHERE NOT (COALESCE(event.original, "") RLIKE "(?i)CreationUtcTime\\s*[:=]\\s*202")
  /* filter_main_program_files: TargetFilename and Image in Program Files */
  | WHERE NOT (
      (COALESCE(file.path, "") RLIKE "(?i)^C:\\\\Program Files( \\(x86\\))?\\\\")
      AND (COALESCE(process.executable, "") RLIKE "(?i)^C:\\\\Program Files( \\(x86\\))?\\\\")
    )
  /* filter_optional_updates */
  | WHERE NOT (
      process.executable IN (
        "C:\\Windows\\system32\\ProvTool.exe",
        "C:\\Windows\\System32\\usocoreworker.exe",
        "C:\\Windows\\ImmersiveControlPanel\\SystemSettings.exe"
      )
      OR (
        COALESCE(file.path, "") RLIKE "(?i)^C:\\\\ProgramData\\\\USOPrivate\\\\UpdateStore\\\\"
        AND (COALESCE(file.path, "") RLIKE "(?i)\\.(tmp|temp)$")
      )
    )
  /* filter_optional_cab */
  | WHERE NOT (
      COALESCE(process.executable, "") RLIKE "(?i)^C:\\\\WINDOWS\\\\System32\\\\"
      AND (process.executable RLIKE "(?i)\\\\(TiWorker|svchost|sihclient)\\.exe$")
      AND (COALESCE(file.path, "") RLIKE "(?i)\\.cab$")
    )
  /* filter_optional_msiexec */
  | WHERE NOT (process.executable == "C:\\Windows\\system32\\msiexec.exe")
  /* filter_optional_vcredist */
  | WHERE NOT (
      COALESCE(process.executable, "") RLIKE "(?i)^C:\\\\Windows\\\\Temp\\\\"
      AND (process.executable RLIKE "(?i)\\\\VCREDI~1\\.EXE$")
    )
  | STATS
      event_count = COUNT(*),
      users = VALUES(user.name),
      processes = VALUES(process.name),
      executables = VALUES(process.executable),
      parent_processes = VALUES(process.parent.name),
      parent_executables = VALUES(process.parent.executable),
      file_paths = VALUES(file.path),
      raw_samples = VALUES(event.original)
    BY host.name, bucket = DATE_TRUNC(20 minutes, @timestamp)
  | WHERE event_count >= 1
  | KEEP bucket, host.name, event_count, users, processes, executables, parent_processes, parent_executables, file_paths, raw_samples
  | SORT event_count DESC
enabled: false
tags:
  - attack.defense-evasion
  - attack.t1070.006
  - detection.threat-hunting
severity: low
risk_score: 20
references:
  - "https://www.inversecos.com/2022/04/defence-evasion-technique-timestomping.html"
nist: ["SI-4", "AU-12"]
pci_dss: ["10.2"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0005:
    T1070: ["T1070.006"]
