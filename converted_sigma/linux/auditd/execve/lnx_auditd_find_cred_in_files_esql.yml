rule_id: c4402e8e-5516-4ad7-92fb-eb8a88b8aecd
name: "Credential Search in Files - Linux"
description: |
  Detects attempts to extract passwords from files using grep.
  Adversaries may search local file systems and remote file shares for files containing passwords.
  This pattern is commonly used in credential harvesting and post-exploitation activities.
  Note: May generate false positives from legitimate password reset or configuration activities.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - auditbeat-*
query_language: esql
query: |
  FROM auditbeat-*
  /* auditd execve telemetry */
  | WHERE event.action == "execve" OR (event.dataset RLIKE "(?i)auditd" AND event.type == "process_started")
  /* selection: grep commands searching for passwords */
  | WHERE COALESCE(process.command_line, "") RLIKE "(?i)grep.*password"
  | STATS
      event_count = COUNT(*),
      users = VALUES(user.name),
      processes = VALUES(process.name),
      command_lines = VALUES(process.command_line),
      executables = VALUES(process.executable),
      working_directories = VALUES(process.working_directory),
      hosts = VALUES(host.name),
      raw_samples = VALUES(event.original)
    BY host.name, user.name, bucket = DATE_TRUNC(20 minutes, @timestamp)
  | WHERE event_count >= 2
  | KEEP agent_id, bucket, host.name, user.name, event_count, users, processes, command_lines, executables, working_directories, hosts, raw_samples
  | SORT event_count DESC
enabled: false
tags:
  - attack.credential-access
  - attack.t1552.001
  - detection.threat-hunting
severity: high
risk_score: 70
references:
  - "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1552.001/T1552.001.md"
  - "https://attack.mitre.org/techniques/T1552/001/"
nist: ["SI-4", "AU-12", "IA-5"]
pci_dss: ["10.2", "8.2.1"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0006:
    T1552: ["T1552.001"]
