rule_id: 34fd2af3-dda5-4fba-a954-3dc3a17b586b
name: "System Firewall Modification Detection"
description: |
  Detects the removal or modification of system firewall rules on Linux.
  Adversaries may only delete or modify specific system firewall rules to bypass controls limiting network usage or access.
  Detection rules that match only on the disabling of firewalls will miss this technique.
  Covers iptables, firewall-cmd, ufw, and nft (nftables) firewall management tools.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - auditbeat-*
query_language: esql
query: |
  FROM auditbeat-*
  /* auditd execve telemetry */
  | WHERE event.action == "execve" OR (event.dataset RLIKE "(?i)auditd" AND event.type == "process_started")
  /* selection: firewall modification commands */
  | WHERE (
      /* iptables DROP rules */
      (process.name == "iptables" AND COALESCE(process.command_line, "") RLIKE "(?i)DROP")
      /* firewall-cmd remove */
      OR (process.name == "firewall-cmd" AND COALESCE(process.command_line, "") RLIKE "(?i)remove")
      /* ufw delete */
      OR (process.name == "ufw" AND COALESCE(process.command_line, "") RLIKE "(?i)delete")
      /* nft delete or flush */
      OR (process.name == "nft" AND COALESCE(process.command_line, "") RLIKE "(?i)(delete|flush)")
    )
  | STATS
      event_count = COUNT(*),
      users = VALUES(user.name),
      processes = VALUES(process.name),
      command_lines = VALUES(process.command_line),
      executables = VALUES(process.executable),
      parent_processes = VALUES(process.parent.name),
      hosts = VALUES(host.name),
      raw_samples = VALUES(event.original)
    BY host.name, user.name, bucket = DATE_TRUNC(20 minutes, @timestamp)
  | WHERE event_count >= 1
  | KEEP agent_id, bucket, host.name, user.name, event_count, users, processes, command_lines, executables, parent_processes, hosts, raw_samples
  | SORT event_count DESC
enabled: false
tags:
  - attack.defense-evasion
  - attack.t1562.004
  - detection.threat-hunting
severity: medium
risk_score: 65
references:
  - "https://www.trendmicro.com/en_us/research/22/c/cyclops-blink-sets-sights-on-asus-routers--.html"
  - "https://blog.aquasec.com/container-security-tnt-container-attack"
  - "https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/8/html/configuring_and_managing_networking/getting-started-with-nftables_configuring-and-managing-networking"
nist: ["SI-4", "AU-12", "SC-7", "AC-4"]
pci_dss: ["10.2", "1.3"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0005:
    T1562: ["T1562.004"]
