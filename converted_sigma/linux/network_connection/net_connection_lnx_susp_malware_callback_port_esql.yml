rule_id: d83eb453-0949-4824-877c-35b3833bf534
name: "Suspicious Malware Callback Ports"
description: |
  Detects connections to known malware callback ports (e.g. 4444, 2222, 51820).
  Ports often used by Sliver, Metasploit, WireGuard, etc. for C2.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - auditbeat-*
query_language: esql
query: |
  FROM auditbeat-*
  /* network connection events */
  | WHERE event.category == "network" AND (event.type == "start" OR event.action == "connection-attempt")
  /* selection: suspicious ports */
  | WHERE destination.port IN (888, 999, 2200, 2222, 4000, 4444, 6789, 8531, 50501, 51820)
  /* filter: exclude local ranges */
  | WHERE NOT CIDR_MATCH(destination.ip, "127.0.0.0/8", "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "169.254.0.0/16", "::1/128", "fe80::/10", "fc00::/7")
  | STATS
      event_count = COUNT(*),
      users = VALUES(user.name),
      processes = VALUES(process.name),
      destination_ips = VALUES(destination.ip),
      destination_ports = VALUES(destination.port),
      hosts = VALUES(host.name)
    BY host.name, user.name, bucket = DATE_TRUNC(20 minutes, @timestamp)
  | WHERE event_count >= 1
  | KEEP agent_id, bucket, host.name, user.name, event_count, users, processes, destination_ips, destination_ports, hosts
  | SORT event_count DESC
enabled: false
tags:
  - attack.command-and-control
  - attack.t1571
severity: high
risk_score: 70
references:
  - "https://attack.mitre.org/techniques/T1571/"
nist: ["SI-4", "AU-12", "SC-7"]
pci_dss: ["10.2", "1.1.5"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0011:
    T1571: []
