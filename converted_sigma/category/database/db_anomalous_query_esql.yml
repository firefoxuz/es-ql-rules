rule_id: b15d05de-e81a-4e3a-b7cf-e5127667dab8
name: "Suspicious SQL Query Detection"
description: |
  Detects suspicious SQL query keywords that are often used during reconnaissance, exfiltration or destructive activities.
  This includes operations like dropping tables, truncating data, dumping databases, and selecting wildcard fields.
  These patterns are commonly used in SQL injection attacks, data exfiltration, and database destruction.
  Note: This rule requires database query logging to be enabled. Must be able to capture SQL queries in logs.
  Baseline your environment to filter out legitimate administrative and monitoring activities.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
  - logs-*
query_language: esql
query: |
  FROM logs-winlog*, logs-*
  // Filter for database telemetry
  | WHERE event.category == "database" 
   OR event.dataset RLIKE "(?i).*(database|sql|mysql|postgres|oracle|mssql).*"
  // Selection: suspicious SQL keywords (drop, truncate, dump, select *)
  | WHERE COALESCE(message, event.original, query.text, "") RLIKE "(?i).*(\\\\bdrop\\\\b|\\\\btruncate\\\\b|\\\\bdump\\\\b|select\\\\s+\\\\*).*"
  // Filter out common false positives from monitoring/backup tools
  | WHERE NOT (
    COALESCE(process.name, "") RLIKE "(?i).*(nagios|zabbix|prometheus|grafana|datadog).*"
    OR COALESCE(user.name, "") RLIKE "(?i).*(monitoring|nagios|zabbix|backup).*"
  )
  | STATS
    event_count = COUNT(*),
    source_ips = VALUES(source.ip),
    databases = VALUES(database.name),
    queries = VALUES(query.text),
    messages = VALUES(message),
    raw_samples = VALUES(event.original)
  BY 
    host.name, 
    user.name,
    bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  | KEEP 
    agent_id, bucket, 
    host.name, 
    user.name, 
    event_count, 
    source_ips, 
    databases, 
    queries, 
    messages, 
    raw_samples
  | SORT event_count DESC
enabled: false
tags:
  - attack.exfiltration
  - attack.initial-access
  - attack.privilege-escalation
  - attack.persistence
  - attack.t1190
  - attack.t1505.001
  - detection.threat-hunting
severity: medium
risk_score: 60
references:
  - "https://github.com/sqlmapproject/sqlmap"
  - "https://owasp.org/www-community/attacks/SQL_Injection"
  - "https://attack.mitre.org/techniques/T1190/"
nist: ["SI-4", "AU-12", "AC-3", "SC-7"]
pci_dss: ["10.2", "6.5.1", "10.3"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0010:
    T1190: []
  TA0001:
    T1190: []
  TA0004:
    T1505: ["T1505.001"]
