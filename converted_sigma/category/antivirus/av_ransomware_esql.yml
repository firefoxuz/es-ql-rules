rule_id: 999fef25-f6eb-41e3-b4cb-d50817360e40
name: "Antivirus Ransomware Detection"
description: |
  Detects a highly relevant Antivirus alert that reports ransomware.
  This event must not be ignored just because the AV has blocked the malware but investigate, how it came there in the first place.
  Detects ransomware families like LockBit, Ryuk, WannaCry, Conti, GandCrab, and various file encryption malware.
  Note: Immediate investigation required as ransomware can spread rapidly across network.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  // Filter for antivirus event telemetry
  | WHERE event.category == "antivirus" 
   OR event.dataset RLIKE "(?i).*antivirus.*" 
   OR event.provider RLIKE "(?i).*(windows defender|mcafee|symantec|kaspersky|trend micro).*"
  // Check if signature contains ransomware indicators
  | WHERE COALESCE(message, event.original, "") RLIKE "(?i).*(BlackWorm|Chaos|Cobra|ContiCrypt|Crypter|CRYPTES|Cryptor|CylanCrypt|DelShad|Destructor|Filecoder|GandCrab|GrandCrab|Haperlock|Hiddentear|HydraCrypt|Krypt|Lockbit|Locker|Mallox|Phobos|Ransom|Ryuk|Ryzerlo|Stopcrypt|Tescrypt|TeslaCrypt|WannaCry|Xorist).*"
  | STATS
    event_count = COUNT(*),
    users = VALUES(user.name),
    file_paths = VALUES(file.path),
    signatures = VALUES(message),
    processes = VALUES(process.name),
    executables = VALUES(process.executable),
    parent_processes = VALUES(process.parent.name),
    raw_samples = VALUES(event.original)
  BY 
    host.name, 
    bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  | KEEP 
    agent_id, bucket, 
    host.name, 
    event_count, 
    users, 
    file_paths, 
    signatures, 
    processes, 
    executables, 
    parent_processes, 
    raw_samples
  | SORT event_count DESC
enabled: false
tags:
  - attack.impact
  - attack.t1486
  - detection.threat-hunting
severity: critical
risk_score: 95
references:
  - "https://www.nextron-systems.com/?s=antivirus"
  - "https://www.virustotal.com/gui/file/43b0f7872900bd234975a0877744554f4f355dc57505517abd1ef611e1ce6916"
  - "https://www.virustotal.com/gui/file/c312c05ddbd227cbb08958876df2b69d0f7c1b09e5689eb9d93c5b357f63eff7"
  - "https://www.virustotal.com/gui/file/20179093c59bca3acc6ce9a4281e8462f577ffd29fd7bf51cf2a70d106062045"
  - "https://www.virustotal.com/gui/file/554db97ea82f17eba516e6a6fdb9dc04b1d25580a1eb8cb755eeb260ad0bd61d"
  - "https://www.virustotal.com/gui/file/69fe77dd558e281621418980040e2af89a2547d377d0f2875502005ce22bc95c"
  - "https://www.virustotal.com/gui/file/6f0f20da34396166df352bf301b3c59ef42b0bc67f52af3d541b0161c47ede05"
nist: ["SI-4", "AU-12", "CP-9", "SI-3"]
pci_dss: ["10.2", "10.5", "5.1"]
gdpr: ["32.1.b", "32.1.c"]
mitre_attack:
  TA0040:
    T1486: []
