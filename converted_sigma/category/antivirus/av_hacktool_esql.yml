rule_id: f0830e0a-afa6-4feb-9871-a085880091be
name: "Antivirus Hacktool Detection"
description: |
  Detects a highly relevant Antivirus alert that reports a hack tool or other attack tool.
  This event must not be ignored just because the AV has blocked the malware but investigate, how it came there in the first place.
  Detects tools like Mimikatz, Impacket, SharpHound, Cobalt Strike, and various other penetration testing and attack tools.
  Note: This rule depends on antivirus logs being ingested with signature fields properly mapped.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  // Filter for antivirus event telemetry
  | WHERE event.category == "antivirus" 
   OR event.dataset RLIKE "(?i).*antivirus.*" 
   OR event.provider RLIKE "(?i).*(windows defender|mcafee|symantec|kaspersky|trend micro).*"
  // Check if signature starts with known patterns OR contains hacktool indicators
  | WHERE COALESCE(message, event.original, "") RLIKE "(?i)(^(ATK/|Exploit\\\\.Script\\\\.CVE|HKTL|HTOOL|PWS\\\\.|PWSX|SecurityTool).*|.*(Adfind|Brutel|BruteR|Cobalt|COBEACON|Cometer|DumpCreds|FastReverseProxy|Hacktool|Havoc|Impacket|Keylogger|Koadic|Mimikatz|Nighthawk|PentestPowerShell|Potato|PowerSploit|PowerSSH|PshlSpy|PSWTool|PWCrack|PWDump|Rozena|Rusthound|Sbelt|Seatbelt|SecurityTool|SharpDump|SharpHound|Shellcode|Sliver|Snaffler|SOAPHound|Splinter|Swrort|TurtleLoader).*)"
  | STATS
    event_count = COUNT(*),
    users = VALUES(user.name),
    file_paths = VALUES(file.path),
    signatures = VALUES(message),
    processes = VALUES(process.name),
    raw_samples = VALUES(event.original)
  BY 
    host.name, 
    bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  | KEEP 
    agent_id, bucket, 
    host.name, 
    event_count, 
    users, 
    file_paths, 
    signatures, 
    processes, 
    raw_samples
  | SORT event_count DESC
enabled: false
tags:
  - attack.execution
  - attack.t1204
  - detection.threat-hunting
severity: high
risk_score: 75
references:
  - "https://www.nextron-systems.com/2021/08/16/antivirus-event-analysis-cheat-sheet-v1-8-2/"
  - "https://www.nextron-systems.com/?s=antivirus"
nist: ["SI-4", "AU-12", "SI-3", "AC-2"]
pci_dss: ["10.2", "5.1", "11.4"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0002:
    T1204: []
