rule_id: 4863b1b2-31ab-47e3-bbcc-1115d088b891
name: "Antivirus Relevant File Paths Alerts"
description: |
  Detects an Antivirus alert in a highly relevant file path or with a relevant file name.
  This event must not be ignored just because the AV has blocked the malware but investigate, how it came there in the first place.
  Focuses on suspicious locations like PerfLogs, Public directories, web server paths, and script/executable file extensions.
  Note: Baseline your environment to tune for legitimate software updates and deployments.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  // Filter for antivirus event telemetry
  | WHERE event.category == "antivirus" 
   OR event.dataset RLIKE "(?i).*antivirus.*" 
   OR event.provider RLIKE "(?i).*(windows defender|mcafee|symantec|kaspersky|trend micro).*"
  // Check if the path is highly suspicious OR contains suspicious extensions
  | WHERE (
    COALESCE(file.path, "") RLIKE "(?i).*(:\\\\PerfLogs\\\\|:\\\\Temp\\\\|:\\\\Users\\\\Default\\\\|:\\\\Users\\\\Public\\\\|:\\\\Windows\\\\|/www/|\\\\inetpub\\\\|\\\\tsclient\\\\|apache|nginx|tomcat|weblogic).*"
    OR COALESCE(file.path, "") RLIKE "(?i).*\\\\.(asax|ashx|asmx|asp|aspx|bat|cfm|cgi|chm|cmd|dat|ear|gif|hta|jpeg|jpg|jsp|jspx|lnk|msc|php|pl|png|ps1|psm1|py|pyc|rb|scf|sct|sh|svg|txt|vbe|vbs|war|wll|wsf|wsh|xll|xml)$"
  )
  | STATS
    event_count = COUNT(*),
    users = VALUES(user.name),
    file_paths = VALUES(file.path),
    file_names = VALUES(file.name),
    signatures = VALUES(message),
    processes = VALUES(process.name),
    executables = VALUES(process.executable),
    raw_samples = VALUES(event.original)
  BY 
    host.name, 
    bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  | KEEP 
    agent_id, bucket, 
    host.name, 
    event_count, 
    users, 
    file_paths, 
    file_names, 
    signatures, 
    processes, 
    executables, 
    raw_samples
  | SORT event_count DESC
enabled: false
tags:
  - attack.resource-development
  - attack.t1588
  - detection.threat-hunting
severity: high
risk_score: 70
references:
  - "https://www.nextron-systems.com/?s=antivirus"
nist: ["SI-4", "AU-12", "SI-3", "CM-7"]
pci_dss: ["10.2", "5.1", "11.4"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0042:
    T1588: []
