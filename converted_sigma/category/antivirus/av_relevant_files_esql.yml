name: "Antivirus Relevant File Paths Alerts"
description: |
  Detects an Antivirus alert in a highly relevant file path or with a relevant file name.
  This event must not be ignored just because the AV has blocked the malware but investigate, how it came there in the first place.
  Focuses on suspicious locations like PerfLogs, Public directories, web server paths, and script/executable file extensions.
  Note: Baseline your environment to tune for legitimate software updates and deployments.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - winlogbeat-*
query_language: esql
query: |
  FROM winlogbeat-*
  /* antivirus event telemetry */
  | WHERE event.category == "antivirus" OR event.dataset RLIKE "(?i)antivirus" OR event.provider RLIKE "(?i)(windows defender|mcafee|symantec|kaspersky|trend micro)"
  /* selection_path: suspicious file paths */
  | WHERE (
      COALESCE(file.path, "") RLIKE "(?i)(:\\\\PerfLogs\\\\|:\\\\Temp\\\\|:\\\\Users\\\\Default\\\\|:\\\\Users\\\\Public\\\\|:\\\\Windows\\\\|/www/|\\\\inetpub\\\\|\\\\tsclient\\\\|apache|nginx|tomcat|weblogic)"
      /* selection_ext: OR suspicious file extensions */
      OR COALESCE(file.path, "") RLIKE "(?i)\\.(asax|ashx|asmx|asp|aspx|bat|cfm|cgi|chm|cmd|dat|ear|gif|hta|jpeg|jpg|jsp|jspx|lnk|msc|php|pl|png|ps1|psm1|py|pyc|rb|scf|sct|sh|svg|txt|vbe|vbs|war|wll|wsf|wsh|xll|xml)$"
    )
  | STATS
      event_count = COUNT(*),
      users = VALUES(user.name),
      file_paths = VALUES(file.path),
      file_names = VALUES(file.name),
      signatures = VALUES(message),
      processes = VALUES(process.name),
      executables = VALUES(process.executable),
      hosts = VALUES(host.name),
      raw_samples = VALUES(event.original)
    BY host.name, bucket = DATE_TRUNC(20 minutes, @timestamp)
  | WHERE event_count >= 1
  | KEEP bucket, host.name, event_count, users, file_paths, file_names, signatures, processes, executables, hosts, raw_samples
  | SORT event_count DESC
enabled: false
tags:
  - attack.resource-development
  - attack.t1588
  - detection.threat-hunting
severity: high
risk_score: 70
references:
  - "https://www.nextron-systems.com/?s=antivirus"
nist: ["SI-4", "AU-12", "SI-3", "CM-7"]
pci_dss: ["10.2", "5.1", "11.4"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0042:
    T1588: []
