rule_id: a99e0044-8a36-42b6-b53a-98cb921ca41c
name: "Antivirus Exploitation Framework Detection"
description: |
  Detects a highly relevant Antivirus alert that reports an exploitation framework.
  This event must not be ignored just because the AV has blocked the malware but investigate, how it came there in the first place.
  Detects frameworks like CobaltStrike, Metasploit, Sliver, and other exploitation tools.
  Note: This rule depends on antivirus logs being ingested into Elasticsearch with proper signature field mapping.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  // Filter for antivirus event telemetry
  | WHERE event.category == "antivirus" 
   OR event.dataset RLIKE "(?i).*antivirus.*" 
   OR event.provider RLIKE "(?i).*(windows defender|mcafee|symantec|kaspersky|trend micro).*"
  // Check if the signature contains exploitation framework indicators
  | WHERE COALESCE(message, event.original, "") RLIKE "(?i).*(Backdoor\\\\.Cobalt|Brutel|BruteR|CobaltStr|CobaltStrike|COBEACON|Cometer|Exploit\\\\.Script\\\\.CVE|IISExchgSpawnCMD|Metasploit|Meterpreter|MeteTool|Mpreter|MsfShell|PowerSploit|Razy|Rozena|Sbelt|Seatbelt|Sliver|Swrort).*"
  | STATS
    event_count = COUNT(*),
    users = VALUES(user.name),
    file_paths = VALUES(file.path),
    signatures = VALUES(message),
    processes = VALUES(process.name),
    raw_samples = VALUES(event.original)
  BY 
    host.name, 
    bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  | KEEP 
    agent_id, bucket, 
    host.name, 
    event_count, 
    users, 
    file_paths, 
    signatures, 
    processes, 
    raw_samples
  | SORT event_count DESC
enabled: false
tags:
  - attack.execution
  - attack.t1203
  - attack.command-and-control
  - attack.t1219.002
  - detection.threat-hunting
severity: critical
risk_score: 90
references:
  - "https://www.nextron-systems.com/?s=antivirus"
  - "https://www.virustotal.com/gui/file/925b0b28472d4d79b4bf92050e38cc2b8f722691c713fc28743ac38551bc3797"
  - "https://www.virustotal.com/gui/file/8f8daabe1c8ceb5710949283818e16c4aa8059bf2ce345e2f2c90b8692978424"
  - "https://www.virustotal.com/gui/file/d9669f7e3eb3a9cdf6a750eeb2ba303b5ae148a43e36546896f1d1801e912466"
nist: ["SI-4", "AU-12", "SI-3"]
pci_dss: ["10.2", "5.1", "11.4"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0002:
    T1203: []
  TA0011:
    T1219: ["T1219.002"]
