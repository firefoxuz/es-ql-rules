rule_id: e83f15b7-8d57-4ffc-99b7-6e94e36a52fb
name: "Antivirus Password Dumper Detection"
description: |
  Detects a highly relevant Antivirus alert that reports a password dumper.
  This event must not be ignored just because the AV has blocked the malware but investigate, how it came there in the first place.
  Detects credential dumping tools like Mimikatz, Rubeus, DCSync, LaZagne, and various other password extraction utilities.
  Note: This rule depends on antivirus logs with signature field mapping.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  // Filter for antivirus event telemetry
  | WHERE event.category == "antivirus" 
   OR event.dataset RLIKE "(?i).*antivirus.*" 
   OR event.provider RLIKE "(?i).*(windows defender|mcafee|symantec|kaspersky|trend micro).*"
  // Check if signature starts with PWS OR contains password dumper indicators
  | WHERE COALESCE(message, event.original, "") RLIKE "(?i)(^PWS.*|.*(Certify|DCSync|DumpCreds|DumpLsass|DumpPert|HTool/WCE|Kekeo|Lazagne|LsassDump|Mimikatz|MultiDump|Nanodump|NativeDump|Outflank|PShlSpy|PSWTool|PWCrack|PWDump|PWS\\\\.|PWSX|pypykatz|Rubeus|SafetyKatz|SecurityTool|SharpChrome|SharpDPAPI|SharpDump|SharpKatz|SharpS\\\\.|ShpKatz|TrickDump).*)"
  | STATS
    event_count = COUNT(*),
    users = VALUES(user.name),
    file_paths = VALUES(file.path),
    signatures = VALUES(message),
    processes = VALUES(process.name),
    executables = VALUES(process.executable),
    raw_samples = VALUES(event.original)
  BY 
    host.name, 
    bucket = DATE_TRUNC(20m, @timestamp)
  | WHERE event_count >= 1
  | KEEP 
    agent_id, bucket, 
    host.name, 
    event_count, 
    users, 
    file_paths, 
    signatures, 
    processes, 
    executables,
    raw_samples
  | SORT event_count DESC
enabled: false
tags:
  - attack.credential-access
  - attack.t1003
  - attack.t1558
  - attack.t1003.001
  - attack.t1003.002
  - detection.threat-hunting
severity: critical
risk_score: 90
references:
  - "https://www.nextron-systems.com/?s=antivirus"
  - "https://www.virustotal.com/gui/file/5fcda49ee7f202559a6cbbb34edb65c33c9a1e0bde9fa2af06a6f11b55ded619"
  - "https://www.virustotal.com/gui/file/a4edfbd42595d5bddb442c82a02cf0aaa10893c1bf79ea08b9ce576f82749448"
nist: ["SI-4", "AU-12", "IA-5", "AC-2"]
pci_dss: ["10.2", "8.2", "5.1"]
gdpr: ["32.1.b"]
mitre_attack:
  TA0006:
    T1003: ["T1003.001", "T1003.002"]
    T1558: []
