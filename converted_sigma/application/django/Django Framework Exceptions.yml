rule_id: fea22678-9ecf-4932-abb5-43088a3a3d91
# Django Framework Exceptions
# Detects suspicious Django security-related exceptions that may indicate exploitation attempts.
name: "Django Framework Exceptions"
description: |
  Detects suspicious Django web application framework exceptions that commonly appear during
  probing/exploitation attempts (host header attacks, suspicious redirects, oversized payloads,
  session tampering, file/path abuse, etc.).

  Data requirements:
  - Django application logs ingested to Elasticsearch (JSON logs preferred), ideally with:
      event.dataset / service.name, log.level, message/event.original, source.ip, url.path, user_agent.original
  - Works best when you also ingest reverse-proxy logs (nginx/apache) to correlate source IPs.

  False positives:
  - Application bugs / misconfigurations (especially DisallowedHost during deployment, bad ALLOWED_HOSTS, etc.)
  - Legitimate large uploads (RequestDataTooBig), malformed clients.

  Triage:
  - Identify exception type (matched keyword) + request path + source.ip + user agent.
  - Check frequency from same IP over short window.
  - Correlate with 4xx/5xx spikes, auth failures, suspicious endpoints (/admin, /api, /login, /.env, etc.).
type: esql
params: '{}'
schedule_interval: 5m
index:
  # Choose what matches your environment. Keep multiple if you mix sources.
  - logs-django-*
  - filebeat-*
  - logs-*
query_language: esql
query: |
  FROM logs-django-*, filebeat-*, logs-*
  | EVAL raw = COALESCE(event.original, message, log.original, "")
  /* Optional: scope to Django app logs if your indices are mixed */
  | WHERE (
      service.name RLIKE "(?i).*django.*"
      OR event.module RLIKE "(?i).*django.*"
      OR event.dataset RLIKE "(?i).*django.*"
      OR raw RLIKE "(?i)django"
      OR TRUE
    )
  /* selection: Django security-related exceptions */
  | WHERE raw RLIKE "(?i)\\b(SuspiciousOperation|DisallowedHost|DisallowedModelAdminLookup|DisallowedModelAdminToField|DisallowedRedirect|InvalidSessionKey|RequestDataTooBig|SuspiciousFileOperation|SuspiciousMultipartForm|SuspiciousSession|TooManyFieldsSent|PermissionDenied)\\b"
  /* quick noise filters (optional) */
  | WHERE NOT (raw RLIKE "(?i)csrf.*(failed|token)")   /* keep if you want CSRF too */
  /* Extract which exception matched (best-effort) */
  | EVAL exception_type = CASE(
      raw RLIKE "(?i)\\bDisallowedHost\\b", "DisallowedHost",
      raw RLIKE "(?i)\\bDisallowedRedirect\\b", "DisallowedRedirect",
      raw RLIKE "(?i)\\bRequestDataTooBig\\b", "RequestDataTooBig",
      raw RLIKE "(?i)\\bInvalidSessionKey\\b", "InvalidSessionKey",
      raw RLIKE "(?i)\\bSuspiciousFileOperation\\b", "SuspiciousFileOperation",
      raw RLIKE "(?i)\\bSuspiciousMultipartForm\\b", "SuspiciousMultipartForm",
      raw RLIKE "(?i)\\bSuspiciousSession\\b", "SuspiciousSession",
      raw RLIKE "(?i)\\bTooManyFieldsSent\\b", "TooManyFieldsSent",
      raw RLIKE "(?i)\\bPermissionDenied\\b", "PermissionDenied",
      raw RLIKE "(?i)\\bDisallowedModelAdminLookup\\b", "DisallowedModelAdminLookup",
      raw RLIKE "(?i)\\bDisallowedModelAdminToField\\b", "DisallowedModelAdminToField",
      raw RLIKE "(?i)\\bDisallowedModelAdminLookup\\b", "DisallowedModelAdminLookup",
      raw RLIKE "(?i)\\bDisallowedModelAdminToField\\b", "DisallowedModelAdminToField",
      raw RLIKE "(?i)\\bDisallowedModelAdminLookup\\b", "DisallowedModelAdminLookup",
      raw RLIKE "(?i)\\bSuspiciousOperation\\b", "SuspiciousOperation",
      "Other"
    )
  /* basic scoring: repeated hits + stronger exceptions */
  | EVAL base = CASE(
      exception_type IN ("DisallowedHost","SuspiciousFileOperation","SuspiciousMultipartForm","TooManyFieldsSent"), 20,
      exception_type IN ("RequestDataTooBig","InvalidSessionKey","DisallowedRedirect"), 15,
      exception_type IN ("PermissionDenied","SuspiciousSession","SuspiciousOperation"), 10,
      5
    )
  | STATS
      event_count = COUNT(*),
      exception_types = VALUES(exception_type),
      users = VALUES(user.name),
      source_ips = VALUES(COALESCE(source.ip, client.ip)),
      user_agents = VALUES(user_agent.original),
      urls = VALUES(url.full),
      paths = VALUES(url.path),
      hosts = VALUES(host.name),
      samples = VALUES(raw)
    BY bucket = DATE_TRUNC(10 minutes, @timestamp)
  /* Alerting threshold: tune to your environment */
  | WHERE event_count >= 3
  | EVAL risk_score = (event_count * 10) + (MAX(base))
  | WHERE risk_score >= 40
  | KEEP agent_id, bucket, event_count, exception_types, source_ips, users, user_agents, hosts, paths, urls, risk_score, samples
  | SORT risk_score DESC
enabled: false
tags:
  - attack.initial-access
  - attack.t1190
  - web
  - django
severity: medium
risk_score: 45
references:
  - "https://docs.djangoproject.com/en/1.11/ref/exceptions/"
  - "https://docs.djangoproject.com/en/1.11/topics/logging/#django-security"
nist: ["AU-6", "SI-4"]
pci_dss: ["10.2"]
mitre_attack:
  TA0001:   # Initial Access
    T1190: []  # Exploit Public-Facing Application
