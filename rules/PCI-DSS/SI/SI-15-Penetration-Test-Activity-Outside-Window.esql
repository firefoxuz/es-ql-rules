// PCI DSS Mapping: Requirement 11.4.1 - Penetration testing annually
// PCI DSS Rule ID: PCI-RULE-42
// Qoida nomi: Penetration Test Activity Outside Window
// Tavsif: Detects penetration testing tools/activity outside approved testing windows.

FROM metricbeat-*, auditbeat-*, filebeat-*
| WHERE @timestamp >= NOW() - 15 minutes
| WHERE (process.name IN ("metasploit", "burpsuite", "sqlmap", "nikto", "dirb")
        OR http.request.headers.user-agent RLIKE ".*(sqlmap|nikto|burp|metasploit|acunetix).*"
        OR url.path RLIKE ".*(\\.\\./|union select|<script>).*")
  AND host.name RLIKE ".*(cde|payment).*"
| WHERE labels.pentest_window != true OR labels.pentest_window IS NULL
| STATS attack_count = COUNT(*) BY source.ip, host.name, process.name
| WHERE attack_count >= 5
| EVAL severity = "high"
| KEEP @timestamp, source.ip, host.name, process.name, http.request.headers.user-agent, attack_count, severity
