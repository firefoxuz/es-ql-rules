// PCI DSS Mapping: Requirement 5.2.2 - Keep anti-malware current
// PCI DSS Rule ID: PCI-RULE-18
// Qoida nomi: Malware Signature Update Failed
// Tavsif: Identifies antivirus signature database update failures.

FROM updive-*-file-*
| WHERE @timestamp >= NOW() - 24 hours
| WHERE event.dataset == "updive-file.system.syslog"
| WHERE (message RLIKE ".*(2001|2003|2012).*"
        OR message RLIKE ".*(signature|definition).*update.*fail.*"
        OR message RLIKE ".*virus.*database.*out.*date.*")
  AND host.name RLIKE ".*(cde|payment|prod).*"
| STATS failure_count = COUNT(*) BY host.name
| WHERE failure_count >= 3
| EVAL rule_name = "PCI-RULE-18: Malware Signature Update Failed"
| EVAL severity = "high"
| KEEP host.name, failure_count, rule_name, severity
