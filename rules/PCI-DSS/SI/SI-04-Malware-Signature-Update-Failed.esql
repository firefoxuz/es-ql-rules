// PCI DSS Mapping: Requirement 5.2.2 - Keep anti-malware current
// PCI DSS Rule ID: PCI-RULE-18
// Qoida nomi: Malware Signature Update Failed
// Tavsif: Identifies antivirus signature database update failures.

FROM winlogbeat-*, filebeat-*
| WHERE @timestamp >= NOW() - 24 hours
| WHERE (event.code IN ("2001", "2003", "2012")
        OR message RLIKE ".*(signature|definition).*update.*fail.*"
        OR message RLIKE ".*virus.*database.*out.*date.*")
  AND host.name RLIKE ".*(cde|payment|prod).*"
| STATS failure_count = COUNT(*) BY host.name
| WHERE failure_count >= 3
| EVAL severity = "high"
| KEEP @timestamp, host.name, failure_count, message, severity
