// PCI DSS Mapping: Requirement 11.3.2 - Internal vulnerability scans
// PCI DSS Rule ID: PCI-RULE-21
// Qoida nomi: Vulnerability Scanner Detection Evasion
// Tavsif: Detects attempts to block or evade vulnerability scanning tools.

FROM updive-*, updive-*
| WHERE @timestamp >= NOW() - 15 minutes
| WHERE (source.ip IN ("10.50.100.10", "10.50.100.11")
        AND destination.port IN (0, 9999, 31337))
    OR (process.name IN ("iptables", "firewall-cmd") 
        AND process.args RLIKE ".*(DROP|REJECT).*(10\\.50\\.100).*")
| WHERE host.name RLIKE ".*(cde|payment).*"
| STATS evasion_count = COUNT(*) BY host.name, user.name
| WHERE evasion_count >= 1
| EVAL rule_name = "PCI-RULE-21: Vuln Scanner Evasion"
| EVAL severity = "high"
| KEEP @timestamp, host.name, user.name, source.ip, process.args, evasion_count, rule_name, severity