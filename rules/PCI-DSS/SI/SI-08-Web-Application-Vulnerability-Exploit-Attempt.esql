// PCI DSS Mapping: Requirement 6.4.1 - Protect against common vulnerabilities
// PCI DSS Rule ID: PCI-RULE-24
// Qoida nomi: Web Application Vulnerability Exploit Attempt
// Tavsif: Detects SQL injection, XSS, and other OWASP Top 10 exploit attempts on payment web apps.

FROM updive-*-file-*
| WHERE @timestamp >= NOW() - 10 minutes
| WHERE event.dataset == "updive-file.system.syslog"
| WHERE (message RLIKE ".*(UNION SELECT|DROP TABLE|javascript|/etc/passwd).*"
        OR message RLIKE ".*(OR 1=1|\\.\\./).*"
        OR message RLIKE ".*(SQL injection|XSS attempt|directory traversal).*")
  AND (message RLIKE ".*(payment|checkout|transaction|admin).*"
       OR host.name RLIKE ".*(payment-web|gateway-app).*")
| STATS attack_count = COUNT(*) BY source.ip, message, host.name
| WHERE attack_count >= 3
| EVAL rule_name = "PCI-RULE-24: Web App Exploit Attempt"
| EVAL severity = "critical"
| KEEP source.ip, host.name, message, attack_count, rule_name, severity
