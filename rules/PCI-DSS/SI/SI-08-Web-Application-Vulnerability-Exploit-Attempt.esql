// PCI DSS Mapping: Requirement 6.4.1 - Protect against common vulnerabilities
// PCI DSS Rule ID: PCI-RULE-24
// Qoida nomi: Web Application Vulnerability Exploit Attempt
// Tavsif: Detects SQL injection, XSS, and other OWASP Top 10 exploit attempts on payment web apps.

FROM updive-*, updive-*
| WHERE @timestamp >= NOW() - 10 minutes
| WHERE (http.request.body.content RLIKE ".*(UNION SELECT|'; DROP TABLE|<script>|javascript:|../../../etc/passwd).*"
        OR url.query RLIKE ".*(\\' OR 1=1|<script|\\.\\./).*"
        OR message RLIKE ".*(SQL injection|XSS attempt|directory traversal).*")
  AND (url.path RLIKE ".*(payment|checkout|transaction|admin).*"
       OR host.name RLIKE ".*(payment-web|gateway-app).*")
| STATS attack_count = COUNT(*) BY source.ip, url.path, host.name
| WHERE attack_count >= 3
| EVAL rule_name = "PCI-RULE-24: Web App Exploit Attempt"
| EVAL severity = "critical"
| KEEP @timestamp, source.ip, host.name, url.path, http.request.body.content, attack_count, rule_name, severity