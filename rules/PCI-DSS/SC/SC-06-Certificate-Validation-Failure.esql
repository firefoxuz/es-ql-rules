// PCI DSS Mapping: Requirement 4.2.1 - Validate certificates
// PCI DSS Rule ID: PCI-RULE-15
// Qoida nomi: Certificate Validation Failure
// Tavsif: Detects TLS connections with invalid, expired, or self-signed certificates on payment systems.

FROM updive-*, updive-*
| WHERE @timestamp >= NOW() - 15 minutes
| WHERE message RLIKE ".*(certificate|cert).*"
  AND message RLIKE ".*(invalid|expired|self-signed|untrusted).*"
  AND source.port IN (443, 8443)
  AND host.name RLIKE ".*(payment|gateway|pos).*"
| STATS 
    failed_count = COUNT(*)
  BY source.ip, host.name
| WHERE failed_count >= 1
| EVAL rule_name = "PCI-RULE-15: Certificate Validation Failure"
| EVAL severity = "high"
| KEEP source.ip, host.name, failed_count, rule_name, severity
