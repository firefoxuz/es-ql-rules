// PCI DSS Mapping: Requirement 4.2.1 - Validate certificates
// PCI DSS Rule ID: PCI-RULE-15
// Qoida nomi: Certificate Validation Failure
// Tavsif: Detects TLS connections with invalid, expired, or self-signed certificates on payment systems.

FROM metricbeat-*, filebeat-*
| WHERE @timestamp >= NOW() - 15 minutes
| WHERE (tls.server.x509.not_after < NOW()
        OR tls.established == false
        OR tls.server.x509.issuer.common_name == tls.server.x509.subject.common_name)
  AND destination.port IN (443, 8443)
  AND host.name RLIKE ".*(payment|gateway|pos).*"
| STATS 
    failed_count = COUNT(*),
    cert_issues = VALUES(tls.server.x509.subject.common_name)
  BY destination.ip, host.name
| WHERE failed_count >= 1
| EVAL severity = "high"
| KEEP @timestamp, destination.ip, host.name, tls.server.x509.subject.common_name, tls.server.x509.not_after, cert_issues, failed_count, severity
