// GDPR Mapping: Article 5(1)(f) - Integrity; Article 32(1)(d) - Ability to restore
// GDPR Rule ID: RULE-20
// Qoida nomi: Elastic Agent/Beat Stopped Unexpectedly
// Tavsif: Detects when Elastic Agent or Beats services stop outside of maintenance windows.
// MITRE ATT&CK: T1562.001 (Impair Defenses)

FROM updive-*, updive-*
| WHERE @timestamp >= NOW() - 5 minutes
| WHERE (monitor.status == "down" AND monitor.name RLIKE ".*(elastic-agent|filebeat|winlogbeat).*")
    OR (message RLIKE ".*(elastic-agent|beat).*stopped.*" AND event.action == "stopped-service")
| STATS down_count = COUNT(*) BY host.name, monitor.name
| WHERE down_count >= 1
| EVAL rule_name = "RULE-20: Elastic Agent/Beat Stopped Unexpectedly"
| EVAL severity = "high"
| KEEP @timestamp, host.name, monitor.name, monitor.status, down_count, rule_name, severity