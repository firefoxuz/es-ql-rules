name: Unexpected Port Open on CDE System
description: |
  Detects new listening ports on cardholder data environment (CDE) systems that are not in approved baseline.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - metricbeat-*
  - auditbeat-*
query_language: esql
query: |
  FROM metricbeat-*, auditbeat-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | WHERE destination.port IS NOT NULL 
    AND network.direction == "inbound"
    AND host.name RLIKE ".*(cde|payment|pos|gateway).*"
  | WHERE destination.port NOT IN (22, 443, 3306, 5432, 8443)
  | STATS 
      connection_count = COUNT(*),
      unique_sources = COUNT_DISTINCT(source.ip)
    BY destination.port, host.name, network.protocol
  | WHERE connection_count >= 3
  | EVAL severity = "high"
  | KEEP @timestamp, host.name, destination.port, network.protocol, connection_count, unique_sources, severity
enabled: false
tags:
  - system-communications
severity: high
risk_score: 75
# MITRE ATT&CK: tactic external_id -> technique external_id -> [subtechnique external_ids]
mitre_attack: {}
nist: []
gdpr: []
pci-dss: ["1.2.1", "1.4.2"]
hipaa: []
