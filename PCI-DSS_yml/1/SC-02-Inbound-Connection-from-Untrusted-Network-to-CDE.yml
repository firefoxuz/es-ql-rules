name: Inbound Connection from Untrusted Network to CDE
description: |
  Identifies inbound connections to CDE from IP addresses not in trusted network ranges.
type: esql
params: '{}'
schedule_interval: 15m
index:
  - metricbeat-*
query_language: esql
query: |
  FROM metricbeat-*
  | WHERE @timestamp >= NOW() - 15 minutes
  | WHERE network.direction == "inbound"
    AND host.name RLIKE ".*(cde|payment|cardholder).*"
    AND source.ip NOT RLIKE "^10\\.|^172\\.(1[6-9]|2[0-9]|3[0-1])\\.|^192\\.168\\."
  | WHERE source.ip NOT IN ("203.0.113.10", "198.51.100.50")
  | STATS 
      connection_count = COUNT(*),
      ports_accessed = VALUES(destination.port)
    BY source.ip, source.geo.country_name, host.name
  | WHERE connection_count >= 1
  | EVAL severity = "critical"
  | KEEP @timestamp, source.ip, source.geo.country_name, host.name, destination.port, ports_accessed, connection_count, severity
enabled: false
tags:
  - system-communications
severity: critical
risk_score: 90
# MITRE ATT&CK: tactic external_id -> technique external_id -> [subtechnique external_ids]
mitre_attack: {}
nist: []
gdpr: []
pci-dss: ["1.3.1"]
hipaa: []
