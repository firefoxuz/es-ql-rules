name: Network Scan from Unauthorized Source
description: |
  Detects network scanning activity from sources not approved as ASV or internal scanners.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - metricbeat-*
  - filebeat-*
query_language: esql
query: |
  FROM metricbeat-*, filebeat-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | WHERE (destination.port IN (0, 21, 22, 23, 25, 80, 110, 443, 445, 3306, 3389, 8080)
          OR message RLIKE ".*(port scan|nmap|masscan).*")
    AND source.ip NOT IN ("10.50.100.10", "10.50.100.11", "203.0.113.100")
  | STATS 
      unique_ports = COUNT_DISTINCT(destination.port),
      port_list = VALUES(destination.port)
    BY source.ip, destination.ip, host.name
  | WHERE unique_ports >= 10
  | EVAL severity = "medium"
  | KEEP @timestamp, source.ip, destination.ip, host.name, unique_ports, port_list, severity
enabled: false
tags:
  - system-integrity
severity: medium
risk_score: 50
# MITRE ATT&CK: tactic external_id -> technique external_id -> [subtechnique external_ids]
mitre_attack: {}
nist: []
gdpr: []
pci-dss: ["11.3.1"]
hipaa: []
