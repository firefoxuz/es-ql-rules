name: Unpatched Critical System in CDE
description: |
  Identifies systems in CDE running software versions with known critical vulnerabilities.
type: esql
params: '{}'
schedule_interval: 24h
index:
  - metricbeat-*
  - filebeat-*
query_language: esql
query: |
  FROM metricbeat-*, filebeat-*
  | WHERE @timestamp >= NOW() - 24 hours
  | WHERE (message RLIKE ".*(CVE-20(2[0-9]|1[8-9])-[0-9]{4,5}).*critical.*"
          OR message RLIKE ".*vulnerable.*version.*(apache|nginx|openssl|openssh|mysql).*")
    AND host.name RLIKE ".*(cde|payment|cardholder).*"
  | STATS vuln_count = COUNT(*) BY host.name, message
  | WHERE vuln_count >= 1
  | EVAL severity = "high"
  | KEEP @timestamp, host.name, message, vuln_count, severity
enabled: false
tags:
  - configuration
severity: high
risk_score: 75
# MITRE ATT&CK: tactic external_id -> technique external_id -> [subtechnique external_ids]
mitre_attack: {}
nist: ["SI-2"]
gdpr: []
pci-dss: ["6.3.3"]
hipaa: []
