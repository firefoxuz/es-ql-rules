name: Antivirus Disabled or Stopped
description: |
  Detects when antivirus/anti-malware software is disabled or stopped on CDE systems.
type: esql
params: '{}'
schedule_interval: 5m
index:
  - winlogbeat-*
  - filebeat-*
  - auditbeat-*
query_language: esql
query: |
  FROM winlogbeat-*, filebeat-*, auditbeat-*
  | WHERE @timestamp >= NOW() - 5 minutes
  | WHERE (event.code IN ("5001", "1116", "1117")
          OR message RLIKE ".*(antivirus|malware|defender).*stopped.*"
          OR process.args RLIKE ".*(sc stop|systemctl stop).*(av|clamav|defender).*")
    AND host.name RLIKE ".*(cde|payment|prod).*"
  | EVAL severity = "critical"
  | KEEP @timestamp, host.name, user.name, event.code, message, process.args, severity
enabled: false
tags:
  - audit
severity: critical
risk_score: 90
# MITRE ATT&CK: tactic external_id -> technique external_id -> [subtechnique external_ids]
mitre_attack: {}
nist: ["SI-3"]
gdpr: []
pci-dss: ["5.2.1"]
hipaa: []
