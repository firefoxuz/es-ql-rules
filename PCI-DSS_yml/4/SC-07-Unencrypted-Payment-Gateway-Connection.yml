name: Unencrypted Payment Gateway Connection
description: |
  Identifies connections to payment gateway without TLS encryption.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - metricbeat-*
query_language: esql
query: |
  FROM metricbeat-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | WHERE (destination.domain RLIKE ".*(paypal|stripe|authorize\\.net|firstdata).*"
          OR destination.ip IN ("64.14.227.5", "64.4.250.37"))
    AND network.protocol != "tls"
    AND destination.port NOT IN (443, 8443)
  | STATS 
      connection_count = COUNT(*),
      protocols = VALUES(network.protocol)
    BY source.ip, destination.domain, host.name
  | WHERE connection_count >= 1
  | EVAL severity = "critical"
  | KEEP @timestamp, source.ip, destination.domain, destination.ip, network.protocol, protocols, connection_count, severity
enabled: false
tags:
  - system-communications
severity: critical
risk_score: 90
# MITRE ATT&CK: tactic external_id -> technique external_id -> [subtechnique external_ids]
mitre_attack: {}
nist: ["SC-8", "SC-13"]
gdpr: []
pci-dss: ["4.2.1"]
hipaa: []
