name: Certificate Validation Failure
description: |
  Detects TLS connections with invalid, expired, or self-signed certificates on payment systems.
type: esql
params: '{}'
schedule_interval: 15m
index:
  - metricbeat-*
  - filebeat-*
query_language: esql
query: |
  FROM metricbeat-*, filebeat-*
  | WHERE @timestamp >= NOW() - 15 minutes
  | WHERE (tls.server.x509.not_after < NOW()
          OR tls.established == false
          OR tls.server.x509.issuer.common_name == tls.server.x509.subject.common_name)
    AND destination.port IN (443, 8443)
    AND host.name RLIKE ".*(payment|gateway|pos).*"
  | STATS 
      failed_count = COUNT(*),
      cert_issues = VALUES(tls.server.x509.subject.common_name)
    BY destination.ip, host.name
  | WHERE failed_count >= 1
  | EVAL severity = "high"
  | KEEP @timestamp, destination.ip, host.name, tls.server.x509.subject.common_name, tls.server.x509.not_after, cert_issues, failed_count, severity
enabled: false
tags:
  - system-communications
severity: high
risk_score: 75
# MITRE ATT&CK: tactic external_id -> technique external_id -> [subtechnique external_ids]
mitre_attack: {}
nist: ["SC-8", "SC-13"]
gdpr: []
pci-dss: ["4.2.1"]
hipaa: []
