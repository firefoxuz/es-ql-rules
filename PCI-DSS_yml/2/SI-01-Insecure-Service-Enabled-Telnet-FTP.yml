name: Insecure Service Enabled (Telnet, FTP)
description: |
  Detects insecure services (Telnet, FTP, rlogin) running on CDE systems.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - metricbeat-*
  - auditbeat-*
query_language: esql
query: |
  FROM metricbeat-*, auditbeat-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | WHERE (destination.port IN (21, 23, 512, 513, 514) 
          OR network.protocol IN ("telnet", "ftp"))
    AND host.name RLIKE ".*(cde|payment|cardholder).*"
  | STATS 
      connection_count = COUNT(*),
      unique_clients = COUNT_DISTINCT(source.ip)
    BY destination.port, network.protocol, host.name
  | WHERE connection_count >= 1
  | EVAL severity = "high"
  | KEEP @timestamp, host.name, destination.port, network.protocol, connection_count, unique_clients, severity
enabled: false
tags:
  - system-integrity
severity: high
risk_score: 75
# MITRE ATT&CK: tactic external_id -> technique external_id -> [subtechnique external_ids]
mitre_attack: {}
nist: []
gdpr: []
pci-dss: ["2.2.4"]
hipaa: []
