name: Unnecessary Service Running on CDE Host
description: |
  Identifies non-essential services running on dedicated payment processing hosts.
type: esql
params: '{}'
schedule_interval: 30m
index:
  - auditbeat-*
  - metricbeat-*
query_language: esql
query: |
  FROM auditbeat-*, metricbeat-*
  | WHERE @timestamp >= NOW() - 30 minutes
  | WHERE process.name IS NOT NULL
    AND host.name RLIKE ".*(payment-app|pos-terminal|card-processor).*"
    AND process.name IN ("httpd", "nginx", "apache2", "mysql", "postgres", "mongod", "redis", "memcached", "docker", "jenkins", "gitlab")
  | STATS 
      process_count = COUNT(*),
      services = VALUES(process.name)
    BY host.name
  | WHERE process_count >= 3
  | EVAL severity = "medium"
  | KEEP @timestamp, host.name, services, process_count, severity
enabled: false
tags:
  - system-integrity
severity: medium
risk_score: 50
# MITRE ATT&CK: tactic external_id -> technique external_id -> [subtechnique external_ids]
mitre_attack: {}
nist: []
gdpr: []
pci-dss: ["2.2.2"]
hipaa: []
