name: Firewall Rule Change Detected
description: |
  Detects modifications to firewall rules or iptables configurations on CDE systems.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - auditbeat-*
  - filebeat-*
  - winlogbeat-*
query_language: esql
query: |
  FROM auditbeat-*, filebeat-*, winlogbeat-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | WHERE (process.name IN ("iptables", "firewall-cmd", "ufw", "netsh") 
          AND process.args RLIKE ".*(add|delete|modify|allow|deny).*")
      OR (file.path RLIKE ".*/etc/sysconfig/iptables.*" AND event.action == "modified")
      OR (event.code == "4946" OR event.code == "4947")
  | WHERE host.name RLIKE ".*(cde|payment|firewall).*"
  | EVAL severity = "high"
  | KEEP @timestamp, host.name, user.name, process.name, process.args, file.path, event.code, severity
enabled: false
tags:
  - configuration
severity: high
risk_score: 75
# MITRE ATT&CK: tactic external_id -> technique external_id -> [subtechnique external_ids]
mitre_attack: {}
nist: ["CM-3"]
gdpr: []
pci-dss: ["1.2.1", "10.2.5"]
hipaa: []
