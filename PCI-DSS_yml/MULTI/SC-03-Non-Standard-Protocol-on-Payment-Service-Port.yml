name: Non-Standard Protocol on Payment Service Port
description: |
  Detects non-HTTPS/TLS traffic on ports designated for payment processing.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - metricbeat-*
query_language: esql
query: |
  FROM metricbeat-*
  | WHERE @timestamp >= NOW() - 10 minutes
  | WHERE destination.port IN (443, 8443, 8444, 9443)
    AND network.protocol NOT IN ("tls", "https")
    AND host.name RLIKE ".*(payment|gateway|pos).*"
  | STATS 
      packet_count = COUNT(*),
      protocols_seen = VALUES(network.protocol)
    BY source.ip, destination.ip, destination.port, host.name
  | WHERE packet_count >= 5
  | EVAL severity = "high"
  | KEEP @timestamp, source.ip, destination.ip, destination.port, network.protocol, protocols_seen, packet_count, severity
enabled: false
tags:
  - system-communications
severity: high
risk_score: 75
# MITRE ATT&CK: tactic external_id -> technique external_id -> [subtechnique external_ids]
mitre_attack: {}
nist: []
gdpr: []
pci-dss: ["1.4.2", "2.2.7"]
hipaa: []
