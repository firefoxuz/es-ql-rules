rule_id: ba115100-92d3-4481-9a27-e2b718ed2dec
#//RULE-HIPAA-28 — Malware/Phishing Protection Failure - §164.308(a)(5)(ii)(B)
#//Requirement: HIPAA Security Rule §164.308(a)(5)(ii)(B) - Protection from Malicious Software
#//Objective: Detect malware infections on ePHI systems despite training
#//Data sources: Antivirus logs, EDR logs, email security logs
#//ECS fields used: event.category, event.action, file.name, event.original
#//Healthcare field validation: Verify EHR/EMR fields exist in your indices (event.original  # FIXME: patient.id not available, encounter.id, etc.)
#//Tuning notes: Monitor malware detections; track phishing simulation results

name: "Malware Infection on ePHI System (Protection Training Gap)"
description: |
  Identifies malware infections, ransomware, or successful phishing attacks on
  systems containing ePHI, indicating failure of malicious software protection
  training under HIPAA §164.308(a)(5)(ii)(B). Detects malware execution on clinical
  workstations, ransomware encryption of medical records, phishing email clicks by
  healthcare staff, or trojan downloads on EHR servers. Training must cover
  recognizing and reporting malicious software. Malware on healthcare systems can
  lead to ePHI breaches and operational disruption. Monitor for infection indicators
  and assess training effectiveness.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - winlogbeat-*
  - auditbeat-*
  - filebeat-ehr-*
  - winlogbeat-*
  - filebeat-*
query_language: esql
query: |
  FROM winlogbeat-*, filebeat-*
  | WHERE (
      (event.category == "malware"
       AND event.action IN ("detected", "quarantined", "blocked")
       AND host.name RLIKE "(?i).*(emr|ehr|clinical|workstation|phi).*")
      OR
      (file.extension IN ("encrypted", "locked", "crypt", "wcry", "locky")
       AND event.action IN ("created", "modified")
       AND file.path RLIKE "(?i).*(patient|medical|phi).*")
      OR
      (event.category == "web"
       AND event.original RLIKE "(?i).*(phish|malicious|suspicious).*"
       AND user.name IS NOT NULL)
    )
  | STATS malware_incidents = COUNT(*),
          incident_types = VALUES(event.action),
          malware_names = VALUES(file.name),
          affected_users = VALUES(user.name),
          affected_systems = VALUES(host.name)
    BY host.name, user.name
  | WHERE malware_incidents > 0
  | EVAL severity_level = CASE(
      file.extension IN ("encrypted", "locked"), "critical",
      malware_incidents > 3, "high",
      "medium"
    )
  | EVAL risk_score = CASE(
      severity_level == "critical", 100,
      severity_level == "high", 90,
      80
    )
  | KEEP agent_id, host.name, user.name, malware_incidents, incident_types, malware_names, severity_level, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - hipaa
  - security_rule
  - section_164_308_a_5
  - malware
  - ransomware
  - phishing
  - security_training
severity: critical
risk_score: 95
references:
  - "45 CFR §164.308(a)(5)(ii)(B) - Protection from Malicious Software"
  - "45 CFR §164.308(a)(5)(ii)(A) - Security Reminders"
nist: ["AT-2"]
gdpr: []
pci_dss: ["5.1"]
hipaa: ["164.308.a.5.ii.B"]
mitre_attack:
  TA0001: 
    T1566: ["T1566.001"]
