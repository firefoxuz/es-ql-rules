rule_id: 97e5bfe8-8f5b-4764-a148-eb6a68ac402a
#//RULE-HIPAA-10 — ePHI Transmitted Over Unencrypted Connection - §164.312(e)(1)
#//Requirement: HIPAA Security Rule §164.312(e)(1) - Transmission Security
#//Objective: Detect unencrypted ePHI transmissions over networks
#//Data sources: Network logs, web access logs, email logs
#//ECS fields used: event.original, event.original, event.original, event.original
#//Healthcare field validation: Verify EHR/EMR fields exist in your indices (event.original  # FIXME: patient.id not available, encounter.id, etc.)
#//Tuning notes: Monitor for HTTP (not HTTPS), plain FTP, unencrypted email with PHI

name: "ePHI Transmitted Without Encryption (Cleartext)"
description: |
  Identifies transmission of electronic Protected Health Information over unencrypted
  network connections in violation of HIPAA §164.312(e)(1) encryption addressable
  requirement. Detects HTTP (port 80) traffic containing PHI patterns (MRN, patient
  names, diagnosis codes), plain FTP transfers of medical records, SMTP email with
  PHI content, or HL7 messages over non-TLS connections. Unencrypted transmission
  exposes ePHI to network sniffing and man-in-the-middle attacks. Monitor for
  cleartext protocols and verify TLS usage for all ePHI exchanges.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - winlogbeat-*
  - auditbeat-*
  - filebeat-ehr-*
  - filebeat-nginx-access-*
  - filebeat-*
query_language: esql
query: |
  FROM filebeat-nginx-access-*, filebeat-*
  | WHERE (
      (event.original == "http"
       AND event.original IN (80, 8080)
       AND (event.original RLIKE "(?i).*(patient|mrn|diagnosis|medication|dob|ssn).*"
        # NOTE: Generic keyword detection - high false positive rate. Consider structured field validation.
            OR event.original RLIKE "(?i).*(patient.*id|medical.*record|chart).*"))
      OR
      (event.original == 21
       AND event.original == "ftp"
       AND event.original != true)
      OR
      (event.original IN (25, 110)
       AND event.original RLIKE "(?i).*(patient|medical.*record|diagnosis|lab.*result).*")
    )
  | WHERE NOT CIDR_MATCH(source.ip, "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16")
  | STATS cleartext_transmissions = COUNT(*),
          protocols = VALUES(event.original),
          destinations = VALUES(event.original),
          data_volume_mb = SUM(event.original) / 1048576,
          urls = VALUES(event.original)
    BY event.original, event.original
  | WHERE cleartext_transmissions > 0
  | EVAL risk_score = CASE(
      protocols IN ("http", "ftp"), 100,
      data_volume_mb > 10, 95,
      cleartext_transmissions > 10, 90,
      85
    )
  | KEEP agent_id, event.original, event.original, cleartext_transmissions, data_volume_mb, protocols, urls, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - hipaa
  - security_rule
  - section_164_312_e
  - transmission_security
  - encryption
  - cleartext
severity: critical
risk_score: 100
references:
  - "45 CFR §164.312(e)(1) - Transmission Security"
  - "45 CFR §164.312(a)(2)(iv) - Encryption and Decryption"
nist: ["SC-8"]
gdpr: ["32"]
pci_dss: ["4.1"]
hipaa: ["164.312.e.1"]
mitre_attack:
  TA0040:
    T1040: []
