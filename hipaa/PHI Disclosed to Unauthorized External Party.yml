rule_id: 0a6b5c83-09a9-4b9f-a120-efc879e898d4
#//RULE-HIPAA-12 — PHI Disclosed Without Authorization - §164.502(a)
#//Requirement: HIPAA Privacy Rule §164.502(a) - Uses and Disclosures
#//Objective: Detect unauthorized PHI disclosures outside permitted exceptions
#//Data sources: Email logs, file transfer logs, fax logs, API logs
#//ECS fields used: event.original, event.original, file.path, event.action
#//Healthcare field validation: Verify EHR/EMR fields exist in your indices (event.original  # FIXME: patient.id not available, encounter.id, etc.)
#//Tuning notes: Maintain authorized recipient list; monitor external disclosures

name: "PHI Disclosed to Unauthorized External Party"
description: |
  Identifies disclosure of Protected Health Information to external parties without
  patient authorization or HIPAA-permitted exception under §164.502(a). Detects
  emails containing PHI sent to non-healthcare domains, file transfers of medical
  records to unauthorized IPs, fax transmissions with patient data to unverified
  numbers, or API data exports to third parties without Business Associate Agreements.
  PHI disclosures require authorization except for treatment, payment, healthcare
  operations, or specific regulatory exceptions. Monitor outbound PHI flows and
  correlate with authorized disclosure registry.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - winlogbeat-*
  - auditbeat-*
  - filebeat-ehr-*
  - filebeat-*
query_language: esql
query: |
  FROM filebeat-*
  | WHERE (
      (event.dataset RLIKE "(?i).*mail.*"
       AND event.original NOT RLIKE "(?i).*(hospital|clinic|health|medical|physician|doctor|insurance|gov|medicare|medicaid)\\..*"
       AND (event.original RLIKE "(?i).*(patient|medical.*record|diagnosis|lab.*result|prescription|discharge.*summary).*"
            OR event.original RLIKE "(?i).*(patient.*name|mrn|dob|ssn|diagnosis).*"))
      OR
      (event.action RLIKE "(?i).*(transfer|send|upload|export).*"
       AND file.path RLIKE "(?i).*(patient|medical|phi|record|chart|ccda).*"
       AND NOT CIDR_MATCH(event.original, "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16"))
      OR
      (event.original RLIKE "(?i).*/api/(export|patient|records).*"
       AND NOT event.original RLIKE ".*(authorized.*partner|baa.*vendor).*")
    )
  | WHERE NOT event.original RLIKE "(?i).*(authorization|consent|baa|business.*associate|hipaa.*exception|tpo).*"
  | STATS unauthorized_disclosures = COUNT(*),
          recipients = VALUES(event.original),
          destinations = VALUES(event.original),
          data_types = VALUES(file.name),
          users = VALUES(user.name)
    BY user.name, host.name
  | WHERE unauthorized_disclosures > 0
  | EVAL risk_score = CASE(
      unauthorized_disclosures > 10, 100,
      recipients NOT RLIKE "(?i).*(health|medical|clinic).*", 95,
      unauthorized_disclosures > 3, 90,
      85
    )
  | KEEP agent_id, user.name, host.name, unauthorized_disclosures, recipients, destinations, data_types, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - hipaa
  - privacy_rule
  - section_164_502
  - phi_disclosure
  - unauthorized_access
  - data_breach
severity: critical
risk_score: 100
references:
  - "45 CFR §164.502(a) - Uses and Disclosures of PHI"
  - "45 CFR §164.508 - Uses/Disclosures Requiring Authorization"
nist: ["AC-4"]
gdpr: ["6"]
pci_dss: []
hipaa: ["164.502.a"]
mitre_attack:
  TA0010:
    T1048: ["T1048.003"]