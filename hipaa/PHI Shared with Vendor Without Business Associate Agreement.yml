rule_id: 3d5cc3f5-0fbd-49eb-a683-1464a022148a
#//RULE-HIPAA-33 — Business Associate Agreement (BAA) Missing - §164.504(e)
#//Requirement: HIPAA Privacy Rule §164.504(e) - Business Associate Contracts
#//Objective: Detect PHI sharing with vendors without executed BAA
#//Data sources: Data sharing logs, API logs, vendor integration logs
#//ECS fields used: event.original, event.original, event.original, event.action
#//Healthcare field validation: Verify EHR/EMR fields exist in your indices (event.original  # FIXME: patient.id not available, encounter.id, etc.)
#//Tuning notes: Maintain BAA registry; monitor new vendor integrations

name: "PHI Shared with Vendor Without Business Associate Agreement"
description: |
  Identifies Protected Health Information transmitted to or processed by third-party
  vendors without executed Business Associate Agreement (BAA) as required by HIPAA
  §164.504(e). Detects PHI sent to cloud services, SaaS platforms, vendors, or
  contractors not in BAA registry, new API integrations with patient data, or data
  sharing agreements lacking HIPAA compliance provisions. BAA must be in place
  BEFORE any PHI access by Business Associate. Vendors without BAAs cannot legally
  receive or process PHI. Monitor for new vendor data flows and verify BAA coverage.
type: esql
params: '{}'
schedule_interval: 12h
index:
  - winlogbeat-*
  - auditbeat-*
  - filebeat-ehr-*
  - filebeat-*
query_language: esql
query: |
  FROM filebeat-*
  | WHERE (
      (event.original == "outbound"
       AND NOT CIDR_MATCH(event.original, "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16")
       AND (event.original RLIKE "(?i).*(patient|phi|medical|health.*record).*"
            OR event.original RLIKE "(?i).*/api/(patient|chart|clinical).*"))
      OR
      (event.action RLIKE "(?i).*(api.*call|webhook|integration|sync).*"
       AND event.original RLIKE "(?i).*(patient.*data|phi|medical).*")
    )
  | WHERE NOT event.original IN ("approved-baa-vendor1.com", "signed-ba2.health", "baa-vendor3.io")  // BAA registry
  | STATS phi_sharing_events = COUNT(*),
          vendors = VALUES(event.original),
          data_volume_mb = SUM(event.original) / 1048576,
          api_endpoints = VALUES(event.original)
    BY event.original, host.name
  | WHERE phi_sharing_events > 5
  | EVAL risk_score = CASE(
      data_volume_mb > 100, 100,
      phi_sharing_events > 50, 95,
      phi_sharing_events > 20, 90,
      85
    )
  | KEEP agent_id, event.original, host.name, phi_sharing_events, data_volume_mb, vendors, api_endpoints, risk_score
  | SORT risk_score DESC
enabled: false
tags:
  - hipaa
  - privacy_rule
  - section_164_504_e
  - business_associate
  - baa
  - vendor_management
  - hitech_act
severity: critical
risk_score: 100
references:
  - "45 CFR §164.504(e) - Business Associate Contracts"
  - "45 CFR §164.308(b)(1) - BA Contract Requirements"
  - "HITECH Act §13404 - BA Liability"
nist: ["SA-9"]
gdpr: ["28"]
pci_dss: ["12.8"]
hipaa: ["164.308.b", "164.504.e"]
mitre_attack:
  TA0010:
    T1567: ["T1567.002"]